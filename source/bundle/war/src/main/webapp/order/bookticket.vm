#set($layout="/front/default_new.vm")
#CSS(["dingdan.css"])

<form id="orderForm" method="post" action="${env.root}/order/makeorder.htm" onsubmit="javascript:return new Totalorders().checkForm1()" >
    <input type="hidden" value="$!product.marketPrice" id="Adult_mkprice">
	<input type="hidden" name="orderId" id="orderId" value="$!orderDO.orderId" />
    <input type="hidden" name="productId" id="productId" value="$!orderDO.productId" />
    <input type="hidden" name="productDetailId" id="productDetailId" value="$!orderDO.productDetailId" />
    <input type="hidden" name="gmtOrderStart" id="gmtOrderStart" value="$dateUtils.format($!orderDO.gmtOrderStart, 'yyyy-MM-dd')" />
    <input type="hidden" name="productType" id="productType" value="TICKET" />
	
	<!-- main开始 -->
    <div class="w950 dingdan">
    
    	<!-- dtl1开始 -->
    	<div class="L">
    		<div class="crumb">您当前的位置：门票 > $!product.destProvince > $!product.destCity > $!product.destAddr</div>
    		<div class="odrTtl"><span class="flag">预定</span><span class="greenTtl">【门票】$!product.name</span></div>
    
    		<h2 class="banner mgt20"><strong>订购产品</strong></h2>
    		<table class="mgt10 product">
    			<thead><tr><td>编号</td><td>名称</td><td>价格</td><td>使用日期</td><td>数量</td></tr></thead>
    			<tbody>
					<tr>
        				<td>$!product.productId</td>
        				<td>$!product.name</td>
                        <td>
    						￥<span id="price" style="color: red;">$!detail.price</span>
                            (市场价：<span style="text-decoration: line-through;">￥<span id="marketPrice">$!product.marketPrice</span></span>)
    					</td>
        				<td class="F10">$dateUtil.format($!orderDO.gmtOrderStart)</td>
        				<td class="F10"><input type="text" name="count" id="ticketNum" maxlength="3" class="wpx34" value="$!orderDO.count"/></td>
        			</tr>
				</tbody>
    		</table>
    		
    		<h2 class="banner mgt20"><strong>订单备注</strong></h2>
    		<table class="mgt10">
                <tr>
					<th></th>
                    <td>
						<textarea rows="1" id="memo" name="memo" style="width:500px;height:30px;"></textarea>
					</td>
				</tr>
    			<tr>
    				<th></th>
    				<td>
    					<button class="order">确认下单</button>
    					<div><input type="checkbox" checked="checked" id="odrProtocol" /><label for="odrProtocol">同意度假OK预订协议</label></div>
    				</td>
    			</tr>
    		</table>
    	</div>
    	<div class="R mgt10">
			<!--
    		<div class="share">
    			<div id="ckepop">
    
    				<span class="jiathis_txt">分享到：</span>
    				<a class="jiathis_button_icons_1"></a>
    				<a class="jiathis_button_icons_2"></a>
    				<a class="jiathis_button_icons_3"></a>
    				<a class="jiathis_button_icons_4"></a>
    			</div>
    		</div>
			-->
    		<div class="moneyTotal">
    
    			<h3>订单金额总计</h3>
    			<table>
    				<tr><th>市 场 价：</th><td><span class="through" id="orderMarketPrice">$product.marketPrice</span>元</td></tr>
    				<tr><th>OK 价：</th><td><span id="orderOkPrice"></span>元</td></tr>
    				<tr><th>累计节省：</th><td><span id="orderSavePrice"></span>元</td></tr>
    			</table>
    			<p>订单结算金额<br><b class="f22">￥<span id="orderPrice"></span></b></p>
    		</div>
    	</div>
    </div>
    <!-- main结束 -->
</form>
		
	
#XUI_JS(["core/xui-core-min.js","util/util-min.js"])

<script>
	var personInfoCount = 1;
	
	function submitForm(){
		var orderForm = document.getElementById('orderForm');
		orderForm.action = $element('webUrl').value + 'trek/order/order/saveorder.htm';
		
		$element('amount').value = $element('Order_Total').innerHTML;
		$element('adultNumber').value = $element('adultNum').value;
		$element('countChild').value = $element('childNum').value;
		if($element('Accident_Insurance').checked){
			$element('isNeedRiskInput').value = "y";
		}
		
		orderForm.submit();
	}

	function addPersonInfo(){
	    var index = personInfoCount;
		var personInfo = document.createElement('div');
		personInfo.id = 'personInfo' + index;
		var Contact = [];
		Contact.push('<table class="d_ywrxx"  cellpadding="0" cellspacing="0">');
		Contact.push('<tr><th><strong>游玩人信息</strong></th><th><i>*</i> 游玩人姓名：</th>');
		  Contact.push('<td><input type="text" name="contacts['+ index + '].name" id="name' + index + '" class="wpx184"/></td></tr>');
		Contact.push('<tr><th></th><th><i>*</i> 游玩人手机：</th>');
		  Contact.push('<td><input type="text" name="contacts[' + index + '].mobile" id="mobile' + index + '" class="wpx184" /></td></tr>');
		Contact.push('<tr><th></th><th><i>*</i> 证件类型：</th>');
		  Contact.push('<td><select name="contacts[' + index + '].certificateType" id="certificateType' + index + '" style="width: 184px;">');
		  Contact.push('<option value="ID">身份证</option><option value="PASSPORT">护照</option><option value="OFFICERPORT">军官证</option><option value="OTHER">其它</option></select></td></tr>');
		Contact.push('<tr><th></th><th><i>*</i> 证件号码：</th>');
		  Contact.push('<td><input type="text" name="contacts[' + index + '].certificateNumber" id="certificateNumber' + index + '" class="wpx184" /></td></tr>');
		Contact.push('<tr><th></th><th>E-mail：</th>');
		  Contact.push('<td><input type="text" name="contacts[' + index + '].email" id="email' + index + '" class="wpx1843" style="width: 184px;"/></td></tr>');
		Contact.push('<tr><th></th><th><a href="javascript:removePersonInfo(' + index + ')" id="removePersonInfo" class="removePersonInfo">- 删除游玩人</a></th>');
		  Contact.push('<td align="right"><a href="javascript:addPersonInfo()" id="addPersonInfo" class="addPersonInfo">+ 添加游玩人</a></td></tr>');
		Contact.push('</table>');
		
		personInfo.innerHTML = Contact.join('');
		$element('personInfos').appendChild(personInfo);
		personInfoCount++;
	}
	
	function removePersonInfo(index) {
		var personInfoId = 'personInfo' + index;
		var personInfo = $element(personInfoId);
		$element('personInfos').removeChild(personInfo);
	}

var EV = xui.util.Event,
	DOM = xui.util.Dom;
var Totalorders = function(){};
Totalorders.prototype = {
	bind:function(){
		var SELF = this;
		SELF.calculatePrice();
		EV.on($element('ticketNum'),'blur',function(){
			SELF.calculatePrice();
			xui.widgets.Tip.clear();
		})
		EV.on($element('add_person'),'click',function(){
			SELF.Creat_person();
		})
		EV.on($element('submit'),'click',function(){
				SELF.checkForm();
		})
		EV.on(DOM.getElementsByClassName('wpx184'),'keyup',function(){
			if(this.value == ""){
				xui.widgets.Tip.show(this.id,'带*号为必填项,请重新输入。');
			}else{
				xui.widgets.Tip._close(this.id+'china');
			}
		})
		EV.on(DOM.getElementsByClassName('wpx184'),'blur',function(){
			if(this.value == ""){
				xui.widgets.Tip.show(this.id,'带*号为必填项,请重新输入。');
			}else{
				xui.widgets.Tip._close(this.id+'china');
			}
		})
	},
	bind4:function(){
		EV.on(DOM.getElementsByClassName('wpx184'),'keyup',function(){
			if(this.value == ""){
				xui.widgets.Tip.show(this.id,'带*号为必填项,请重新输入。');
			}else{
				xui.widgets.Tip._close(this.id+'china');
			}
		})
	},
	/**
	*订单金额总计数据
	*/
	calculatePrice:function(){
		var ticketNum = this.defaultValue(parseInt($element('ticketNum').value), 0),
			price = this.defaultValue(Number($element('price').innerHTML), 0),
			marketPrice = this.defaultValue(Number($element('marketPrice').innerHTML), 0);
		$element('ticketNum').value = ticketNum;
		var okPrice = ticketNum * price;
		var marketPrice = ticketNum * marketPrice;
		this.initOrderPriceInfo(okPrice, marketPrice);
	},
	initOrderPriceInfo:function(okPrice, marketPrice){
		$element('orderOkPrice').innerHTML = okPrice;
		$element('orderMarketPrice').innerHTML = marketPrice;
		$element('orderSavePrice').innerHTML = marketPrice - okPrice;
		$element('orderPrice').innerHTML = okPrice;
	},
	defaultValue: function(obj, value) {
	    if ((obj == null) || (typeof(obj) == 'undefined') || isNaN(obj)) {
	      return value;
	    }
	    return obj;
	}
};					   
EV.onDOMReady(function(){
	var b = new Totalorders();
	b.bind();
});
</script>