/*pub-2|2011-11-18 11:06:06*/KISSY.add("editor/export",function(a){function e(g,h){var i=this;if(!(i instanceof e))return new e(g,h);a.isString(g)&&(g=a.one(g)),g=b._4e_wrap(g),h=h||{},h.pluginConfig=h.pluginConfig||{},i.cfg=h,h.pluginConfig=h.pluginConfig,i.cfg=h,a.app(i,a.EventTarget);var j=["htmldataprocessor","enterkey","clipboard"],k=d;i.use=function(b,d){b=b.split(",");if(!k)for(var f=0;f<j.length;f++){var l=j[f];a.inArray(l,b)||b.unshift(l)}return i.ready(function(){a.Editor.use("button,select",function(){a.use.call(i,b.join(","),function(){for(var a=0;a<b.length;a++)i.usePlugin(b[a]);d&&d.call(i);if(!k){i.setData(g.val());if(h.focus)i.focus();else{var e=i.getSelection();e&&e.removeAllRanges()}k=c}},{global:e})})}),i},i.use=i.use,i.Config.base=e.Config.base,i.Config.debug=e.Config.debug,i.Config.componentJsName=f,i.init(g)}var b=a.DOM,c=!0,d=!1,f;parseFloat(a.version)<1.2?f=function(){return"plugin-min.js?t="+encodeURIComponent("2011-11-17 20:54:46")}:f=function(a,b){return a+"/plugin-min.js"+(b?b:"?t="+encodeURIComponent("2011-11-17 20:54:46"))},a.app(e,a.EventTarget),e.Config.base=a.Config.base+"editor/plugins/",e.Config.debug=a.Config.debug,e.Config.componentJsName=f,a.Editor=e,a.Editor=e}),KISSY.add("editor",function(a){return a.Editor},{requires:["dd","overlay"]}),KISSY.Editor.add("utils",function(a){var b=!0,c=!1,d=null,e=KISSY,f=e.Node,g=e.DOM,h=e.UA,i=e.Event,j={debugUrl:function(b){return b=b.replace(/-min\.(js|css)/i,".$1"),a.Config.debug||(b=b.replace(/\.(js|css)/i,"-min.$1")),b.indexOf("?t")==-1&&(b.indexOf("?")!=-1?b+="&":b+="?",b+="t="+encodeURIComponent("2011-11-17 19:34:39")),a.Config.base+b},lazyRun:function(a,b,c){var d=a[b],e=a[c];a[b]=function(){return d.apply(this,arguments),a[b]=a[c],e.apply(this,arguments)}},getXY:function(a,b,c,d){var e=c.defaultView||c.parentWindow;a-=g.scrollLeft(e),b-=g.scrollTop(e);if(d){var f=d.defaultView||d.parentWindow;if(e!=f&&e.frameElement){var h=g._4e_getOffset(e.frameElement,d);a+=h.left,b+=h.top}}return{left:a,top:b}},tryThese:function(a){var b;for(var c=0,d=arguments.length;c<d;c++){var e=arguments[c];try{b=e();break}catch(f){}}return b},arrayCompare:function(a,d){if(!a&&!d)return b;if(!a||!d||a.length!=d.length)return c;for(var e=0;e<a.length;e++)if(a[e]!==d[e])return c;return b},getByAddress:function(a,c,e){var g=a.documentElement;for(var h=0;g&&h<c.length;h++){var i=c[h];if(!e){g=g.childNodes[i];continue}var j=-1;for(var k=0;k<g.childNodes.length;k++){var l=g.childNodes[k];if(e===b&&l.nodeType==3&&l.previousSibling&&l.previousSibling.nodeType==3)continue;j++;if(j==i){g=l;break}}}return g?new f(g):d},clearAllMarkers:function(a){for(var c in a)a[c]._4e_clearMarkers(a,b)},htmlEncodeAttr:function(a){return a.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},trim:function(a){return this.ltrim(this.rtrim(a))},mix:function(a){var b={};for(var c=0;c<arguments.length;c++){var d=arguments[c];b=e.mix(b,d)}return b},isCustomDomain:function(){if(!h.ie)return c;var a=document.domain,b=window.location.hostname;return a!=b&&a!="["+b+"]"},duplicateStr:function(a,b){return(new Array(b+1)).join(a)},throttle:function(a,b,c){c=c||150;if(c===-1)return function(){a.apply(b,arguments)};var d=(new Date).getTime();return function(){var e=(new Date).getTime();e-d>c&&(d=e,a.apply(b,arguments))}},buffer:function(a,b,c){c=c||0;var e=d;return function(){e&&clearTimeout(e);var d=arguments;e=setTimeout(function(){return a.apply(b,d)},c)}},isNumber:function(a){return/^\d+(.\d+)?$/.test(e.trim(a))},verifyInputs:function(a,d){for(var f=0;f<a.length;f++){var h=g._4e_wrap(a[f]),i=e.trim(h.val()),j=h.attr("data-verify"),k=h.attr("data-warning");if(j&&!(new RegExp(j)).test(i))return alert(k),c}return b},sourceDisable:function(a,b){a.on("sourcemode",b.disable,b),a.on("wysiwygmode",b.enable,b)},resetInput:function(a){var b=a.attr("placeholder");b&&!h.webkit?(a.addClass("ke-input-tip"),a.val(b)):h.webkit&&a.val("")},valInput:function(a,b){a.removeClass("ke-input-tip"),a.val(b)},placeholder:function(a,b){a.attr("placeholder",b);if(h.webkit)return;a.on("blur",function(){e.trim(a.val())||(a.addClass("ke-input-tip"),a.val(b))}),a.on("focus",function(){a.removeClass("ke-input-tip"),e.trim(a.val())==b&&a.val("")})},clean:function(b){b=b[0]||b;var c=e.makeArray(b.childNodes);for(var d=0;d<c.length;d++){var f=c[d];f.nodeType==a.NODE.NODE_TEXT&&!e.trim(f.nodeValue)&&b.removeChild(f)}},htmlEncode:function(a){return a?String(a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"):a},htmlDecode:function(a){return a?String(a).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&"):a},equalsIgnoreCase:function(a,b){return a.toLowerCase()==b.toLowerCase()},normParams:function(a){a=e.clone(a);for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];e.isFunction(c)&&(a[b]=c())}return a},doFormUpload:function(b,c,f){function s(){var a={responseText:"",responseXML:d};a.argument=b?b.argument:d;try{var c;h.ie?c=l.contentWindow.document:c=l.contentDocument||window.frames[k].document,c&&c.body&&(a.responseText=e.trim(g.text(c.body))),c&&c.XMLDocument?a.responseXML=c.XMLDocument:a.responseXML=c}catch(f){e.log("after data returns error ,maybe domain problem:"),e.log(f,"error")}i.remove(l,"load",s),b.callback&&b.callback(a),setTimeout(function(){g._4e_remove(l)},100)}var k=e.guid("form-upload-"),l=document.createElement("iframe");l.id=k,l.name=k,l.className="ke-hidden";var m="document.open();"+(j.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";h.ie&&(l.src=h.ie?"javascript:void(function(){"+encodeURIComponent(m)+"}())":""),e.log("doFormUpload : "+l.src),document.body.appendChild(l),h.ie&&(document.frames[k].name=k);var n=g._4e_unwrap(b.form),o={target:g.attr(n,"target"),method:g.attr(n,"method"),encoding:g.attr(n,"encoding"),enctype:g.attr(n,"enctype"),action:g.attr(n,"action")};g.attr(n,{target:k,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"}),f&&g.attr(n,"action",f);var p,q;if(c){p=[],c=a.Utils.normParams(c);for(var r in c)c.hasOwnProperty(r)&&(q=document.createElement("input"),q.type="hidden",q.name=r,q.value=c[r],n.appendChild(q),p.push(q))}i.on(l,"load",s),n.submit(),g.attr(n,o);if(p)for(var t=0,u=p.length;t<u;t++)g._4e_remove(p[t]);return l},extern:function(a,b){for(var c in b)a[c]=b[c]},map:function(a,b){for(var c=0;c<a.length;c++)a[c]=b(a[c]);return a},ieEngine:function(){if(!h.ie)return;return document.documentMode||h.ie}(),preventFocus:function(a){h.ie?a._4e_unselectable():a.attr("onmousedown","return false;")},isFlashEmbed:function(a){var b=a.attributes;return b.type=="application/x-shockwave-flash"||/\.swf(?:$|\?)/i.test(b.src||"")},addRes:function(){this.__res=this.__res||[];var a=this.__res;a.push.apply(a,e.makeArray(arguments))},destroyRes:function(){var a=this.__res||[];for(var b=0;b<a.length;b++){var c=a[b];e.isFunction(c)?c():(c.detach&&c.detach(),c.destroy&&c.destroy(),c.nodeType&&c.remove&&c.remove())}this.__res=[]}};a.Utils=j,a.Utils=j,h.ieEngine=j.ieEngine,j.extern(j,{debugUrl:j.debugUrl,lazyRun:j.lazyRun,getXY:j.getXY,tryThese:j.tryThese,arrayCompare:j.arrayCompare,getByAddress:j.getByAddress,clearAllMarkers:j.clearAllMarkers,htmlEncodeAttr:j.htmlEncodeAttr,ltrim:j.ltrim,rtrim:j.rtrim,trim:j.trim,mix:j.mix,isCustomDomain:j.isCustomDomain,duplicateStr:j.duplicateStr,buffer:j.buffer,isNumber:j.isNumber,verifyInputs:j.verifyInputs,sourceDisable:j.sourceDisable,resetInput:j.resetInput,placeholder:j.placeholder,clean:j.clean,htmlEncode:j.htmlEncode,htmlDecode:j.htmlDecode,equalsIgnoreCase:j.equalsIgnoreCase,normParams:j.normParams,throttle:j.throttle,doFormUpload:j.doFormUpload,map:j.map})}),KISSY.Editor.add("dom",function(a){function t(a){return a.replace(/-(\w)/g,function(a,b){return b.toUpperCase()})}var b=!0,c=!1,d=null,e=KISSY,f=e.DOM,g=e.UA,h=document,i=e.Node,j=a.Utils,k="getBoundingClientRect",l={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11},a.NODE=a.NODE,a.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16},a.POSITION=a.POSITION;var m=a.NODE,n=a.POSITION,o={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},p={hr:1},q=function(a){return a[0]||a},r=function(a){return a&&!a[0]?new i(a):a},s={_4e_wrap:r,_4e_unwrap:q,_4e_equals:function(a,d){return!a&&!d?b:!a||!d?c:(a=q(a),d=q(d),a===d)},_4e_isBlockBoundary:function(a,b){a=r(a);var c=e.mix(e.mix({},p),b||{});return o[a.css("display")]||c[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:c},_4e_index:function(a){a=q(a);var b=a.parentNode.childNodes;for(var c=0;c<b.length;c++)if(b[c]===a)return c;return-1},_4e_first:function(a,b){a=q(a);var c=a.firstChild,d=c&&new i(c);return d&&b&&!b(d)&&(d=d._4e_next(b)),d},_4e_move:function(a,b,c){a=q(a),f._4e_remove(a),b=q(b),c?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_name:function(a){a=q(a);var b=a.nodeName.toLowerCase();if(g.ie){var c=a.scopeName;c&&c!="HTML"&&(b=c.toLowerCase()+":"+b)}return b},_4e_isIdentical:function(a,d){if(a._4e_name()!=d._4e_name())return c;var e=a[0].attributes,f=d[0].attributes,g=e.length,h=f.length;if(g!=h)return c;for(var i=0;i<g;i++){var k=e[i],l=k.name;if(k.specified&&a.attr(l)!=d.attr(l))return c}if(j.ieEngine<8)for(i=0;i<h;i++){k=f[i],l=k.name;if(k.specified&&a.attr(l)!=d.attr(l))return c}return b},_4e_isEmptyInlineRemoveable:function(a){var d=q(a).childNodes;for(var f=0,g=d.length;f<g;f++){var h=d[f],i=h.nodeType;if(i==m.NODE_ELEMENT&&h.getAttribute("_ke_bookmark"))continue;if(i==m.NODE_ELEMENT&&!s._4e_isEmptyInlineRemoveable(h)||i==m.NODE_TEXT&&e.trim(h.nodeValue))return c}return b},_4e_moveChildren:function(a,b,c){var d=q(a);b=b[0]||b;if(d==b)return;var e;if(c)while(e=d.lastChild)b.insertBefore(d.removeChild(e),b.firstChild);else while(e=d.firstChild)b.appendChild(d.removeChild(e))},_4e_mergeSiblings:function(){function a(a,b,c){if(b[0]&&b[0].nodeType==m.NODE_ELEMENT){var d=[];while(b.attr("_ke_bookmark")||b._4e_isEmptyInlineRemoveable()){d.push(b),b=c?new i(b[0].nextSibling):new i(b[0].previousSibling);if(!b[0]||b[0].nodeType!=m.NODE_ELEMENT)return}if(a._4e_isIdentical(b)){var e=c?a[0].lastChild:a[0].firstChild;while(d.length)d.shift()._4e_move(a,!c);b._4e_moveChildren(a,!c),b._4e_remove(),e[0]&&e[0].nodeType==m.NODE_ELEMENT&&e._4e_mergeSiblings()}}}return function(c){if(!c[0])return;if(!l[c._4e_name()]&&c._4e_name()!="a")return;a(c,new i(c[0].nextSibling),b),a(c,new i(c[0].previousSibling))}}(),_4e_unselectable:g.gecko?function(a){a=q(a),a.style.MozUserSelect="none"}:g.webkit?function(a){a=q(a),a.style.KhtmlUserSelect="none"}:function(a){a=q(a);if(g.ie||g.opera){var b,c=0;a.setAttribute("unselectable","on");var d=a.getElementsByTagName("*");while(b=d[c++])switch(b.tagName.toLowerCase()){case"iframe":case"textarea":case"input":case"select":break;default:b.setAttribute("unselectable","on")}}},_4e_getOffset:function(a,b){a=q(a);var c,d=0,e=0,g=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,h=a.ownerDocument,i=h.documentElement;b=b||h;if(a[k]){a!==h.body&&i!==a&&(c=a[k](),d=c.left+(b===h?f.scrollLeft(g):0),e=c.top+(b===h?f.scrollTop(g):0));if(b){var j=b.defaultView||b.parentWindow;if(g!=j&&g.frameElement){var l=s._4e_getOffset(g.frameElement,b);d+=l.left,e+=l.top}}}return{left:d,top:e}},_4e_getFrameDocument:function(a){var b=q(a),c;try{c=b.contentWindow.document}catch(d){c=b.src,b.src=c,g.ie&&g.ie<7&&window.showModalDialog('javascript:document.write("<script>window.setTimeout(function(){window.close();},50);</script>")')}return b&&b.contentWindow.document},_4e_splitText:function(a,b){a=q(a);var c=a.ownerDocument;if(!a||a.nodeType!=m.NODE_TEXT)return;if(g.ie&&b==a.nodeValue.length){var d=c.createTextNode("");return f.insertAfter(d,a),new i(d)}var e=new i(a.splitText(b));if(!!c.documentMode){var h=c.createTextNode("");f.insertAfter(h,e[0]),f._4e_remove(h)}return e},_4e_parents:function(a,b){a=r(a);var c=[];do c[b?"push":"unshift"](a);while(a=a.parent());return c},_4e_clone:function(a,b,c){a=q(a);var d=a.cloneNode(b);if(!c){var e=function(a){if(a.nodeType!=m.NODE_ELEMENT)return;a.removeAttribute("id");var b=a.childNodes;for(var c=0;c<b.length;c++)e(b[c])};e(d)}return new i(d)},_4e_nextSourceNode:function(a,e,g,h){a=q(a);if(h&&!h.call){var j=h[0]||h;h=function(a){return a=a[0]||a,a!==j}}var k=!e&&a.firstChild,l=new i(a);if(!k){if(a.nodeType==m.NODE_ELEMENT&&h&&h(a,b)===c)return d;k=a.nextSibling}while(!k&&(l=l.parent())){if(h&&h(l,b)===c)return d;k=l[0].nextSibling}return k?(k=f._4e_wrap(k),h&&h(k)===c?d:g&&g!=k[0].nodeType?k._4e_nextSourceNode(c,g,h):k):d},_4e_previousSourceNode:function(a,e,g,h){a=q(a);if(h&&!h.call){var j=h[0]||h;h=function(a){return a=a[0]||a,a!==j}}var k=!e&&a.lastChild,l=new i(a);if(!k){if(a.nodeType==m.NODE_ELEMENT&&h&&h(a,b)===c)return d;k=a.previousSibling}while(!k&&(l=l.parent())){if(h&&h(l,b)===c)return d;k=l[0].previousSibling}return k?(k=f._4e_wrap(k),h&&h(k)===c?d:g&&k[0].nodeType!=g?k._4e_previousSourceNode(c,g,h):k):d},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=m.NODE_TEXT&&b.contains(a))return b;var c=a[0].nodeType==m.NODE_TEXT?a.parent():a;do if(c[0].nodeType!=m.NODE_TEXT&&c.contains(b))return c;while(c=c.parent());return d},_4e_ascendant:function(a,c,f){var g=q(a);f||(g=g.parentNode);if(c&&!e.isFunction(c)){var h=c;c=function(a){return a._4e_name()==h}}while(g&&g.nodeType!=9){if(!c||c(new i(g))===b)return new i(g);g=g.parentNode}return d},_4e_hasAttribute:j.ieEngine<9?function(a,b){a=q(a);var c=a.getAttributeNode(b);return!!c&&!!c.specified}:function(a,b){return a=q(a),a.hasAttribute(b)},_4e_hasAttributes:j.ieEngine<9?function(a){a=q(a);var d=a.attributes;for(var e=0;e<d.length;e++){var f=d[e];switch(f.name){case"class":if(a.getAttribute("class"))return b;break;default:if(f.specified)return b}}return c}:function(a){return a=q(a),g.gecko&&a.removeAttribute("_moz_dirty"),a.hasAttributes()},_4e_position:function(a,b){var c=q(a),d=q(b);if(c.compareDocumentPosition)return c.compareDocumentPosition(d);if(c==d)return n.POSITION_IDENTICAL;if(c.nodeType==m.NODE_ELEMENT&&d.nodeType==m.NODE_ELEMENT){if(c.contains){if(c.contains(d))return n.POSITION_CONTAINS+n.POSITION_PRECEDING;if(d.contains(c))return n.POSITION_IS_CONTAINED+n.POSITION_FOLLOWING}if("sourceIndex"in c)return c.sourceIndex<0||d.sourceIndex<0?n.POSITION_DISCONNECTED:c.sourceIndex<d.sourceIndex?n.POSITION_PRECEDING:n.POSITION_FOLLOWING}var e=a._4e_address(),f=b._4e_address(),g=Math.min(e.length,f.length);for(var h=0;h<=g-1;h++)if(e[h]!=f[h]){if(h<g)return e[h]<f[h]?n.POSITION_PRECEDING:n.POSITION_FOLLOWING;break}return e.length<f.length?n.POSITION_CONTAINS+n.POSITION_PRECEDING:n.POSITION_IS_CONTAINED+n.POSITION_FOLLOWING},_4e_address:function(a,b){a=q(a);var c=[],d=a.ownerDocument.documentElement,e=a;while(e&&e!=d){var f=e.parentNode,g=-1;if(f){for(var h=0;h<f.childNodes.length;h++){var i=f.childNodes[h];if(b&&i.nodeType==3&&i.previousSibling&&i.previousSibling.nodeType==3)continue;g++;if(i==e)break}c.unshift(g)}e=f}return c},_4e_breakParent:function(b,c){var d=a.Range,e=new d(b[0].ownerDocument);e.setStartAfter(b),e.setEndAfter(c);var f=e.extractContents();e.insertNode(b._4e_remove()),b[0].parentNode.insertBefore(f,b[0].nextSibling)},_4e_style:function(a,b,c){if(c!==undefined)a=r(a),a.css(b,c),a.attr("style")||a.removeAttr("style");else return a=q(a),a.style[t(b)]},_4e_remove:function(a,b){var c=q(a),d=c.parentNode;if(d){if(b)for(var e;e=c.firstChild;)d.insertBefore(c.removeChild(e),c);d.removeChild(c)}return a},_4e_trim:function(a){f._4e_ltrim(a),f._4e_rtrim(a)},_4e_ltrim:function(a){a=q(a);var b;while(b=a.firstChild){if(b.nodeType==m.NODE_TEXT){var c=j.ltrim(b.nodeValue),d=b.nodeValue.length;if(!c){a.removeChild(b);continue}c.length<d&&((new i(b))._4e_splitText(d-c.length),a.removeChild(a.firstChild))}break}},_4e_rtrim:function(a){a=q(a);var b;while(b=a.lastChild){if(b.type==m.NODE_TEXT){var c=j.rtrim(b.nodeValue),d=b.nodeValue.length;if(!c){a.removeChild(b);continue}c.length<d&&((new i(b))._4e_splitText(c.length),a.removeChild(a.lastChild))}break}!g.ie&&!g.opera&&(b=a.lastChild,b&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b))},_4e_appendBogus:function(a){a=q(a);var b=a.lastChild;while(b&&b.nodeType==m.NODE_TEXT&&!e.trim(b.nodeValue))b=b.previousSibling;if(!b||b.nodeType==m.NODE_TEXT||f._4e_name(b)!=="br"){var c=g.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");g.gecko&&c.setAttribute("type","_moz"),a.appendChild(c)}},_4e_previous:function(a,b){var c=q(a),d;do c=c.previousSibling,d=c&&new i(c);while(d&&b&&!b(d));return d},_4e_last:function(a,b){a=f._4e_wrap(a);var c=a[0].lastChild,d=c&&new i(c);return d&&b&&!b(d)&&(d=d._4e_previous(b)),d},_4e_next:function(a,b){var c=q(a),d;do c=c.nextSibling,d=c&&new i(c);while(d&&b&&!b(d));return d},_4e_outerHtml:function(a){a=q(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var c=a.ownerDocument.createElement("div");return c.appendChild(a.cloneNode(b)),c.innerHTML},_4e_setMarker:function(a,b,c,d){a=f._4e_wrap(a);var g=a.data("list_marker_id")||a.data("list_marker_id",e.guid()).data("list_marker_id"),h=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");return b[g]=a,h[c]=1,a.data(c,d)},_4e_clearMarkers:function(a,b,c){a=r(a);var d=a.data("list_marker_names"),e=a.data("list_marker_id");for(var f in d)a.removeData(f);a.removeData("list_marker_names"),c&&(a.removeData("list_marker_id"),delete b[e])},_4e_copyAttributes:function(a,b,c){a=q(a),b=r(b);var e=a.attributes;c=c||{};for(var h=0;h<e.length;h++){var i=e[h],j=i.name.toLowerCase(),k;if(j in c)continue;if(j=="checked"&&(k=f.attr(a,j)))b.attr(j,k);else if(i.specified||g.ie&&i.value&&j=="value")k=f.attr(a,j),k===d&&(k=i.nodeValue),b.attr(j,k)}a.style.cssText!==""&&(b[0].style.cssText=a.style.cssText)},_4e_isEditable:function(b){var c=f._4e_name(b),d=a.XHTML_DTD,e=!d.$nonEditable[c]&&(d[c]||d.span);return e&&e["#"]},_4e_scrollIntoView:function(a){a=r(a);var b=a[0].ownerDocument;a.scrollIntoView(b,!1)},_4e_getElementsByTagName:function(a,b,c){a=q(a),!g.ie&&c&&(b=c+":"+b);var d=[],e=a.getElementsByTagName(b);for(var f=0;f<e.length;f++)d.push(new i(e[f]));return d}},u=function(a){e.mix(f,a);for(var b in a)a.hasOwnProperty(b)&&function(b){i.prototype[b]=function(){var c=[].slice.call(arguments,0);return c.unshift(this),a[b].apply(d,c)}}(b)};j.extern(s,{_4e_wrap:s._4e_wrap,_4e_unwrap:s._4e_unwrap,_4e_equals:s._4e_equals,_4e_isBlockBoundary:s._4e_isBlockBoundary,_4e_getWin:s._4e_getWin,_4e_index:s._4e_index,_4e_first:s._4e_first,_4e_move:s._4e_move,_4e_name:s._4e_name,_4e_isIdentical:s._4e_isIdentical,_4e_isEmptyInlineRemoveable:s._4e_isEmptyInlineRemoveable,_4e_moveChildren:s._4e_moveChildren,_4e_mergeSiblings:s._4e_mergeSiblings,_4e_unselectable:s._4e_unselectable,_4e_getOffset:s._4e_getOffset,_4e_getFrameDocument:s._4e_getFrameDocument,_4e_splitText:s._4e_splitText,_4e_parents:s._4e_parents,_4e_clone:s._4e_clone,_4e_nextSourceNode:s._4e_nextSourceNode,_4e_previousSourceNode:s._4e_previousSourceNode,_4e_commonAncestor:s._4e_commonAncestor,_4e_ascendant:s._4e_ascendant,_4e_hasAttribute:s._4e_hasAttribute,_4e_hasAttributes:s._4e_hasAttributes,_4e_position:s._4e_position,_4e_address:s._4e_address,_4e_breakParent:s._4e_breakParent,_4e_style:s._4e_style,_4e_remove:s._4e_remove,_4e_trim:s._4e_trim,_4e_ltrim:s._4e_ltrim,_4e_rtrim:s._4e_rtrim,_4e_appendBogus:s._4e_appendBogus,_4e_last:s._4e_last,_4e_previous:s._4e_previous,_4e_next:s._4e_next,_4e_outerHtml:s._4e_outerHtml,_4e_setMarker:s._4e_setMarker,_4e_clearMarkers:s._4e_clearMarkers,_4e_getUniqueId:s._4e_getUniqueId,_4e_copyAttributes:s._4e_copyAttributes,_4e_isEditable:s._4e_isEditable,_4e_scrollIntoView:s._4e_scrollIntoView,_4e_getElementsByTagName:s._4e_getElementsByTagName}),u(s)}),KISSY.Editor.add("focusmanager",function(a){function l(){var a=this;a.iframeFocus=i,g=a,f&&clearTimeout(f),f=setTimeout(function(){a.fire("focus")},100)}function m(){var a=this;a.iframeFocus=j,g=k,f&&clearTimeout(f),f=setTimeout(function(){a.fire("blur")},100)}var b=KISSY,c=b.DOM,d=b.Event,e={},f,g,h={refreshAll:function(){for(var a in e){var b=e[a];b.document.designMode="off",b.document.designMode="on"}},currentInstance:function(){return g},getInstance:function(a){return e[a]},add:function(a){var b=c._4e_getWin(a.document);d.on(b,"focus",l,a),d.on(b,"blur",m,a)},register:function(a){e[a._UUID]=a},remove:function(a){delete e[a._UUID];var b=c._4e_getWin(a.document);d.remove(b,"focus",l,a),d.remove(b,"blur",m,a)}},i=!0,j=!1,k=null;h.refreshAll=h.refreshAll,a.focusManager=h,a.focusManager=h,a.getInstances=function(){return e},a.getInstances=a.getInstances}),KISSY.Editor.add("definition",function(a){function x(b,c,e){var g="",h=a.Utils.debugUrl("../theme/editor-iframe.css");if(e)for(var i=0;i<e.length;i++)g+='<link href="'+e[i]+'" rel="stylesheet"/>';return s+"<html>"+"<head>"+"<title>${title}</title>"+"<link "+"href='"+h+"'"+" rel='stylesheet'/>"+"<style>"+(c||"")+"</style>"+g+"</head>"+"<body class='ke-editor'>"+"&nbsp;"+(b?'<script id="ke_actscript" type="text/javascript">'+(d.isCustomDomain()?'document.domain="'+f.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+b+'");'+"</script>":"")+"</body>"+"</html>"}var b=!0,c=!1,d=a.Utils,e=null,f=document,g=KISSY,h=g.UA,i=h.ie,j=g.DOM,k=g.Node,l=g.Event,m="display",n="width",o="height",p="none",q=a.focusManager,r=d.tryThese,s="<!doctype html>",t='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">',u=".ke-textarea-wrap",v=".ke-editor-tools",w=".ke-editor-status",y=1,z="document.open();"+(d.isCustomDomain()?'document.domain="'+f.domain+'";':"")+"document.close();",A="<div  class='ke-editor-wrap'  > <div class='"+v.substring(1)+"'"+" ></div>"+"<div class='"+u.substring(1)+"'><"+"iframe "+' style="'+n+":100%;"+o+':100%;border:none;" '+" "+n+'="100%" '+" "+o+'="100%" '+' frameborder="0" '+' title="'+"kissy-editor"+'" '+(i?' src="javascript:void(function(){'+encodeURIComponent(z)+'}())"':"")+' allowTransparency="true" '+"></iframe></div>"+"<div class='"+w.substring(1)+"'></div>"+"</div>",B,C;B=a.SOURCE_MODE=0,C=a.WYSIWYG_MODE=1,a.SOURCE_MODE=B,a.WYSIWYG_MODE=C,g.augment(a,{init:function(c){var e=this;e.__commands={},e.__dialogs={},e.__plugins={},i&&j.addClass(f.body,"ke-ie"+i),h.trident?j.addClass(f.body,"ke-trident"+h.trident):h.gecko?j.addClass(f.body,"ke-gecko"):h.webkit&&j.addClass(f.body,"ke-webkit");var g=new k(A);e.editorWrap=g,e._UUID=y++,q.register(e),e.wrap=g.one(u),e.wrap=e.wrap,e.iframe=e.wrap.one("iframe"),e.iframe=e.iframe,e.toolBarDiv=g.one(v),e.toolBarDiv=e.toolBarDiv,e.textarea=c,e.textarea=e.textarea,e.statusDiv=g.one(w),e.statusDiv=e.statusDiv,d.preventFocus(e.toolBarDiv);var l=c._4e_style(n),r=c._4e_style(o);l&&(g.css(n,l),c.css(n,"100%")),e.textarea.css(m,p),g.insertAfter(c),e.wrap[0].appendChild(c[0]),r&&(e.wrap.css(o,r),c.css(o,"100%"));var s=e.iframe;c._4e_hasAttribute("tabindex")&&(s[0].tabIndex=h.webkit?-1:c[0].tabIndex),e.on("dataReady",function(){e._ready=b,a.fire("instanceCreated",{editor:e})}),h.gecko?s.on("load",e._setUpIFrame,e):e._setUpIFrame(),e.cfg.attachForm&&c[0].form&&e._attachForm()},destroy:function(){if(this.__destroyed)return;var b=this,c=b.editorWrap,d=b.textarea,e=b.document,f=b.iframe[0].contentWindow;b.sync(),a.focusManager.remove(b),l.remove(e),l.remove(e.documentElement),l.remove(e.body),l.remove(f),b.iframe.detach();var g=b.__plugins;for(var h in g)if(g.hasOwnProperty(h)){var i=g[h];i.destroy&&i.destroy()}b.fire("destroy"),d.insertBefore(c),c.remove(),d.css({width:c[0].style.width,height:b.wrap.css("height")}),d.show(),b.__commands=b.__dialogs=b.__plugins=null,b.detach(),b.__destroyed=!0},_attachForm:function(){var a=this,b=a.textarea,c=new k(b[0].form);c.on("submit",a.sync,a),a.on("destroy",function(){c.detach("submit",a.sync,a)})},useDialog:function(b,c){var d=this,e=a.Overlay;e&&e.loading(),d.use(b,function(){var a=d.getDialog(b);if(!a){g.later(arguments.callee,50,!1,d);return}c(a),e&&e.unloading()})},showDialog:function(a,b,c){var d=this;b=b||[],d.useDialog(a,function(e){e.show.apply(e,b),c&&c(e),d.fire("dialogShow",{dialog:e.dialog,pluginDialog:e,dialogName:a})})},addDialog:function(a,b){this.__dialogs[a]=b},getDialog:function(a){return this.__dialogs[a]},destroyDialog:function(a){var b=this.__dialogs[a];b&&b.destroy(),this.__dialogs[a]=null},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this,c=b.__commands[a],d=g.makeArray(arguments);return d.shift(),d.unshift(b),c.exec.apply(c,d)},getMode:function(){return this.textarea.css("display")=="none"?C:B},getData:function(a){var b=this,c;return b.getMode()==C?b.document&&b.document.body?c=b.document.body.innerHTML:c="":c=b.textarea.val(),b.htmlDataProcessor&&(a?c=b.htmlDataProcessor.toHtml(c,"p"):c=b.htmlDataProcessor.toServer(c,"p")),c=g.trim(c),/^<p>((&nbsp;)|\s)*<\/p>$/.test(c)&&(c=""),c},setData:function(a){var b=this,c=a;b.htmlDataProcessor&&(c=b.htmlDataProcessor.toDataFormat(a,"p")),b.document.body.innerHTML=c,c||(b.document.body.innerHTML=c),b.getMode()!=C&&b.textarea.val(a)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(a){this.document.body.innerHTML=a},_prepareIFrameHtml:function(a){var b=this.cfg;return x(a,b.customStyle,b.customLink)},getSelection:function(){return a.Selection.getSelection(this.document)},focus:function(){var a=this,b=a.document,c=j._4e_getWin(b);h.ie||c&&c.parent&&c.parent.focus(),c&&c.focus(),b&&b.body.focus(),a.notifySelectionChange()},blur:function(){var a=this,b=j._4e_getWin(a.document);b.blur(),a.document&&a.document.body.blur()},addCustomStyle:function(a){var b=this,c=b.cfg,d=b.document;c.customStyle=c.customStyle||"",c.customStyle+="\n"+a;var e=d.createElement("style");d.getElementsByTagName("head")[0].appendChild(e),e.styleSheet?e.styleSheet.cssText=a:e.appendChild(d.createTextNode(a))},addCustomLink:function(a){var b=this,c=b.cfg,d=b.document;c.customLink=c.customLink||[],c.customLink.push(a);var e=d.createElement("link");e.rel="stylesheet",d.getElementsByTagName("head")[0].appendChild(e),e.href=a},removeCustomLink:function(a){var b=this,c=b.cfg,d=b.document,e=g.makeArray(d.getElementsByTagName("link"));for(var f=0;f<e.length;f++)e[f].href==a&&j._4e_remove(e[f]);c.customLink=c.customLink||[];var h=c.customLink,i=g.indexOf(a,h);i!=-1&&h.splice(i,1)},_setUpIFrame:function(){function g(){e=d.document,a.document=e,b.detach(),e.open("text/html","replace"),e.write(c),e.close()}var a=this,b=a.iframe,c=a._prepareIFrameHtml(a._UUID),d=b[0].contentWindow,e;try{e=d.document}catch(f){b[0].src=b[0].src;if(i<7){setTimeout(g,10);return}}g()},ready:function(a){var b=this;b._ready?a():b.on("dataReady",a)},addPlugin:function(a,b,c){var d=this;d.__plugins=d.__plugins,c=c||{},c.func=b,d.__plugins[a]=c},usePlugin:function(a){var b=this.__plugins[a];if(!b)return;if(b.status&&!b.duplicate)return;var c=this.Env.mods[a].requires||[];for(var d=0;d<c.length;d++)this.usePlugin(c[d]);b.func.call(b),b.status=1},_monitor:function(){var b=this;b._monitorId&&clearTimeout(b._monitorId),b._monitorId=setTimeout(function(){var c=b.getSelection();if(c&&!c.isInvalid){var d=c.getStartElement(),e=new a.ElementPath(d);if(!b.previousPath||!b.previousPath.compare(e))b.previousPath=e,b.fire("selectionChange",{selection:c,path:e,element:d})}},100)},notifySelectionChange:function(){var a=this;a.previousPath=e,a._monitor()},insertElement:function(d,f,g){var h=this;if(h.getMode()!==C)return;h.focus();var i,j=d._4e_name(),l=a.XHTML_DTD,m=a.RANGE,n=a.NODE,o=l.$block[j],p=h.getSelection(),q=p&&p.getRanges(),r,s,t,u;if(!q||q.length==0){var v=arguments,w=v.callee;setTimeout(function(){w.apply(h,v)},30);return}h.fire("save");for(var x=q.length-1;x>=0;x--){r=q[x],r.deleteContents(),i=!x&&d||d._4e_clone(b),f&&f(i);if(o)while((t=r.getCommonAncestor(c,b))&&(u=l[t._4e_name()])&&(!u||!u[j]))t._4e_name()in l.span?r.splitElement(t):r.checkStartOfBlock()&&r.checkEndOfBlock()?(r.setStartBefore(t),r.collapse(b),t._4e_remove()):r.splitBlock();r.insertNode(i),s||(s=i)}if(!s)return;var y=s._4e_nextSourceNode(b),z,A=h.document;u=a.XHTML_DTD,u.$inline[i._4e_name()]?(y=new k(A.createTextNode(" ")),y.insertAfter(s)):y?y._4e_name()=="br"&&u[y.parent()._4e_name()].p&&(z=new k("<p>&nbsp;</p>",e,A),y[0].parentNode.replaceChild(z[0],y[0]),y=z):(z=new k("<p>&nbsp;</p>",e,A),z.insertAfter(s),y=z),r.moveToPosition(s,m.POSITION_AFTER_END),y&&y[0].nodeType==n.NODE_ELEMENT&&r.moveToElementEditablePosition(y),p.selectRanges([r]),h.focus(),i&&i._4e_scrollIntoView(),h._saveLater(),g&&g(i)},insertHtml:function(b,d){var e=this;if(e.getMode()!==C)return;e.htmlDataProcessor&&(b=e.htmlDataProcessor.toDataFormat(b,null,d)),e.focus(),e.fire("save");var f=e.document,h=0;if(i){var l=f.selection;l.type=="Control"&&l.clear();try{l.createRange().pasteHTML(b)}catch(m){g.log("insertHtml error in ie")}}else try{f.execCommand("inserthtml",c,b)}catch(m){setTimeout(function(){if(e.getSelection().getRanges().length==0){var d=new a.Range(f),g=j._4e_first(f.body,function(a){return a[0].nodeType==1&&a._4e_name()!="br"});g||(g=new k(f.createElement("p")),f.body.appendChild(g[0])),d.setStartAt(g,a.RANGE.POSITION_AFTER_START),d.select()}f.execCommand("inserthtml",c,b)},h=100)}setTimeout(function(){e.getSelection().scrollIntoView()},h),e._saveLater(h)},_saveLater:function(a){var b=this;b.__saveTimer&&(clearTimeout(b.__saveTimer),b.__saveTimer=null),b.__saveTimer=setTimeout(function(){b.fire("save")},a||0)}}),a._initIFrame=function(a){function t(a){r(function(){n.designMode="on",setTimeout(function(){n.designMode="off",s.focus(),arguments.callee.retry||(arguments.callee.retry=b)},50)},function(){n.designMode="off",j.attr(s,"contentEditable",c),j.attr(s,"contentEditable",b),!a&&t(1)})}var d=q.getInstance(a),e=d.iframe,f=d.textarea[0],m=e[0].contentWindow,n=d.document,o=d.cfg,p=n.getElementById("ke_actscript");j._4e_remove(p);var s=n.body;i?(s.hideFocus=b,s.disabled=b,s.contentEditable=b,s.removeAttribute("disabled")):setTimeout(function(){h.gecko||h.opera?s.contentEditable=b:h.webkit?s.parentNode.contentEditable=b:n.designMode="on"},0),h.webkit&&(l.on(n,"click",function(a){var b=new k(a.target);g.inArray(b._4e_name(),["input","select"])&&a.preventDefault()}),l.on(n,"mouseup",function(a){var b=new k(a.target);g.inArray(b._4e_name(),["input","textarea"])&&a.preventDefault()}));if(h.gecko||i||h.opera){var u;u=(new k('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(f),u.on("focus",function(){d.focus()}),d.activateGecko=function(){h.gecko&&d.iframeFocus&&u[0].focus()},d.on("destroy",function(){u.detach(),u.remove()})}if(n.documentMode||h.gecko||h.opera){var v=n.documentElement;l.on(v,"mousedown",function(a){var b=new k(a.target);b[0]==v&&(h.gecko&&t(c),u[0].focus())})}l.on(m,"focus",function(){h.gecko?t(c):h.opera&&s.focus(),d.notifySelectionChange()}),h.gecko&&l.on(d.document,"mousedown",function(){d.iframeFocus||t(c)});if(i){l.on(n,"keydown",function(a){var b=a.keyCode;if(b in{8:1,46:1}){var c=d.getSelection(),e=c.getSelectedElement();if(e){d.fire("save");var f=c.getRanges()[0].createBookmark();e._4e_remove(),c.selectBookmarks([f]),d.fire("save"),a.preventDefault()}}});if(n.compatMode=="CSS1Compat"){var w={33:1,34:1};l.on(n,"keydown",function(a){a.keyCode in w&&setTimeout(function(){d.getSelection().scrollIntoView()},0)})}}setTimeout(function(){i&&setTimeout(function(){n&&(s.runtimeStyle.marginBottom="0px",s.runtimeStyle.marginBottom="")},1e3)},0),setTimeout(function(){d.fire("dataReady");var a=o.disableObjectResizing,b=o.disableInlineTableEditing;if(a||b)try{n.execCommand("enableObjectResizing",c,!a),n.execCommand("enableInlineTableEditing",c,!b)}catch(e){l.on(s,i?"resizestart":"resize",function(c){var d=new k(c.target);(a||d._4e_name()==="table"&&b)&&c.preventDefault()})}},10),h.webkit&&l.on(n,"mousedown",function(a){var b=new k(a.target);g.inArray(b._4e_name(),["img","hr","input","textarea","select"])&&d.getSelection().selectElement(b)}),h.gecko&&l.on(n,"dragstart",function(a){var b=new k(a.target);b._4e_name()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()}),q.add(d)},document.documentMode>7&&function(){var a=g.all("link");for(var b=0;b<a.length;b++){var c=new k(a[b]),d=c.attr("href");d.indexOf("editor-pkg-min-mhtml.css")!=-1&&c.attr("href",d.replace(/editor-pkg-min-mhtml\.css/g,"editor-pkg-min-datauri.css"))}}();var D=a.prototype;d.extern(D,{removeCustomLink:D.removeCustomLink,addCustomLink:D.addCustomLink,setData:D.setData,getData:D.getData,insertElement:D.insertElement,insertHtml:D.insertHtml,ready:D.ready,addCustomStyle:D.addCustomStyle,addCommand:D.addCommand,hasCommand:D.hasCommand,execCommand:D.execCommand,useDialog:D.useDialog,addDialog:D.addDialog,getDialog:D.getDialog,getMode:D.getMode,sync:D.sync,getSelection:D.getSelection,focus:D.focus,blur:D.blur,notifySelectionChange:D.notifySelectionChange})}),KISSY.Editor.add("zindex",function(){var a=KISSY,b=a.Editor;if(b.zIndexManager)return;b.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11e3,LOADING_CANCEL:12e3,SELECT:1200},b.baseZIndex=function(a){return(b.Config.baseZIndex||1e4)+a},b.baseZIndex=b.baseZIndex,b.zIndexManager=b.zIndexManager}),KISSY.Editor.add("dtd",function(a){a.XHTML_DTD=function(){function a(){var a=arguments[0],b=arguments.length-1;while(b>0)KISSY.mix(a,arguments[b--]);return a}var b={isindex:1,fieldset:1},c={input:1,button:1,select:1,textarea:1,label:1},d=a({a:1},c),e=a({iframe:1},d),f={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},g={ins:1,del:1,script:1,style:1},h=a({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},g),i=a({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},h),j=a({p:1},i),k=a({iframe:1},i,c),l={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1},m=a({a:1},k),n={tr:1},o={"#":1},p=a({param:1},l),q=a({form:1},b,e,f,j),r={li:1},s={style:1,script:1},t={base:1,link:1,meta:1,title:1},u=a(t,s),v={head:1,body:1},w={html:1},x={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:a(w,v,t),$block:x,$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:m,$body:a({script:1,style:1},x),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:v,head:u,style:o,body:q,base:{},link:{},meta:{},title:o,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:q,td:q,br:{},th:q,center:q,kbd:m,button:a(j,f),basefont:{},h5:m,h4:m,samp:m,h6:m,ol:r,h1:m,h3:m,option:o,h2:m,form:a(b,e,f,j),select:{optgroup:1,option:1},font:m,ins:m,menu:r,abbr:m,label:m,table:{thead:1,col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:m,script:o,tfoot:n,cite:m,li:q,input:{},iframe:q,strong:m,textarea:o,noframes:q,big:m,small:m,span:m,hr:{},dt:m,sub:m,optgroup:{option:1},param:{},bdo:m,"var":m,div:q,object:p,sup:m,dd:q,strike:m,area:{},dir:r,map:a({area:1,form:1,p:1},b,g,f),applet:p,dl:{dt:1,dd:1},del:m,isindex:{},fieldset:a({legend:1},l),thead:n,ul:r,acronym:m,b:m,a:k,blockquote:q,caption:m,i:m,u:m,tbody:n,s:m,address:a(e,j),tt:m,legend:m,q:m,pre:a(h,d),p:m,em:m,dfn:m}}(),a.XHTML_DTD=a.XHTML_DTD}),KISSY.Editor.add("elementpath",function(a){function l(a){var b=h,c=h,d=[],f=a;while(f&&f[0]){if(f[0].nodeType==e.NODE_ELEMENT){this.lastElement||(this.lastElement=f);var g=f._4e_name();c||(!b&&i[g]&&(b=f),j[g]&&(!b&&g=="div"&&!k(f)?b=f:c=f)),d.push(f);if(g=="body")break}f=f.parent()}this.block=this.block=b,this.blockLimit=this.blockLimit=c,this.elements=this.elements=d}var b=KISSY,c=b.DOM,d=a.XHTML_DTD,e=a.NODE,f=!0,g=!1,h=null,i={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},k=function(a){a=a[0]||a;var b=a.childNodes;for(var c=0,h=b.length;c<h;c++){var i=b[c];if(i.nodeType==e.NODE_ELEMENT&&d.$block[i.nodeName.toLowerCase()])return f}return g};l.prototype={compare:function(a){var b=this.elements,d=a&&a.elements;if(!d||b.length!=d.length)return g;for(var e=0;e<b.length;e++)if(!c._4e_equals(b[e],d[e]))return g;return f},contains:function(a){var b=this.elements;for(var c=0;c<b.length;c++)if(b[c]._4e_name()in a)return b[c];return h}},a.ElementPath=a.ElementPath=l;var m=l.prototype;a.Utils.extern(m,{compare:m.compare,contains:m.contains})}),KISSY.Editor.add("walker",function(a){function i(a,e){var i=this;if(this._.end)return d;var j,k=i.range,l,m=i.guard,n=i.type,o=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!i._.start){i._.start=1,k.trim();if(k.collapsed)return i.end(),d}if(!a&&!i._.guardLTR){var p=k.endContainer,q=new h(p[0].childNodes[k.endOffset]);this._.guardLTR=function(a,b){return a=g._4e_wrap(a),a&&a[0]&&(!b||!g._4e_equals(p,a))&&(!q[0]||!a._4e_equals(q))&&(a[0].nodeType!=f.NODE_ELEMENT||!b||a._4e_name()!="body")}}if(a&&!i._.guardRTL){var r=k.startContainer,s=k.startOffset>0&&new h(r[0].childNodes[k.startOffset-1]);i._.guardRTL=function(a,b){return a=g._4e_wrap(a),a&&a[0]&&(!b||!a._4e_equals(r))&&(!s[0]||!a._4e_equals(s))&&(a[0].nodeType!=f.NODE_ELEMENT||!b||a._4e_name()!="body")}}var t=a?i._.guardRTL:i._.guardLTR;m?l=function(a,b){return t(a,b)===c?c:m(a,b)}:l=t,i.current?j=this.current[o](c,n,l):a?(j=k.endContainer,k.endOffset>0?(j=new h(j[0].childNodes[k.endOffset-1]),l(j)===c&&(j=d)):j=l(j,b)===c?d:j._4e_previousSourceNode(b,n,l)):(j=k.startContainer,j=new h(j[0].childNodes[k.startOffset]),j&&j[0]?l(j)===c&&(j=d):j=l(k.startContainer,b)===c?d:k.startContainer._4e_nextSourceNode(b,n,l));while(j&&j[0]&&!i._.end){i.current=j;if(!i.evaluator||i.evaluator(j)!==c){if(!e)return j}else if(e&&i.evaluator)return c;j=j[o](c,n,l)}return i.end(),i.current=d}function j(a){var b,c=d;while(b=i.call(this,a))c=b;return c}function k(a){this.range=a,this._={}}var b=!0,c=!1,d=null,e=KISSY,f=a.NODE,g=e.DOM,h=e.Node;e.augment(k,{end:function(){this._.end=1},next:function(){return i.call(this)},previous:function(){return i.call(this,b)},checkForward:function(){return i.call(this,c,b)!==c},checkBackward:function(){return i.call(this,b,b)!==c},lastForward:function(){return j.call(this)},lastBackward:function(){return j.call(this,b)},reset:function(){delete this.current,this._={}}}),k.blockBoundary=function(a){return function(b){return b=g._4e_wrap(b),!b||b[0].nodeType!=f.NODE_ELEMENT||!b._4e_isBlockBoundary(a)}},k.listItemBoundary=function(){return this.blockBoundary({br:1})},k.bookmark=function(a,b){function c(a){return a&&a[0]&&a._4e_name()=="span"&&a.attr("_ke_bookmark")}return function(d){var e,g;return e=d&&d[0]&&d[0].nodeType==f.NODE_TEXT&&(g=d.parent())&&c(g),e=a?e:e||c(d),b^e}},k.whitespaces=function(a){return function(b){b=b[0]||b;var c=b&&b.nodeType==f.NODE_TEXT&&!e.trim(b.nodeValue);return a^c}},k.invisible=function(a){var b=k.whitespaces();return function(c){var d=b(c)||c[0].nodeType==f.NODE_ELEMENT&&!c[0].offsetHeight;return a^d}},a.Walker=k,a.Walker=k;var l=k.prototype;a.Utils.extern(l,{end:l.end,next:l.next,previous:l.previous,checkForward:l.checkForward,checkBackward:l.checkBackward,lastForward:l.lastForward,lastBackward:l.lastBackward,reset:l.reset}),a.Utils.extern(k,{blockBoundary:k.blockBoundary,listItemBoundary:k.listItemBoundary,bookmark:k.bookmark,whitespaces:k.whitespaces,invisible:k.invisible})}),KISSY.Editor.add("range",function(a){function q(a){var c=this;c.startContainer=d,c.startOffset=d,c.endContainer=d,c.endOffset=d,c.collapsed=b,c.document=a}function s(a){var b=a[0].nodeType!=f.NODE_TEXT&&a._4e_name()in m.$removeEmpty,c=!e.trim(a[0].nodeValue),d=!!a.parent().attr("_ke_bookmark");return b||c||d}function v(a){return!t(a)&&!u(a)}function w(a){var d=c,g=i.bookmark(b);return function(h){if(g(h))return b;if(h[0].nodeType==f.NODE_TEXT){if(e.trim(h[0].nodeValue).length)return c}else if(h[0].nodeType==f.NODE_ELEMENT&&!r[h._4e_name()])if(!a&&!l.ie&&h._4e_name()=="br"&&!d)d=b;else return c;return b}}function x(a,b){function c(a){return a&&a.nodeName=="span"&&a.getAttribute("_ke_bookmark")}return function(d){var e,f;return e=d&&!d.nodeName&&(f=d.parentNode)&&c(f),e=a?e:e||c(d),b^e}}function y(a){return function(b){b=b[0]||b;var c=b&&b.nodeType==f.NODE_TEXT&&!e.trim(b.nodeValue);return a^c}}a.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2},a.RANGE=a.RANGE;var b=!0,c=!1,d=null,e=KISSY,f=a.NODE,g=a.RANGE,h=a.POSITION,i=a.Walker,j=e.DOM,k=a.Utils.getByAddress,l=e.UA,m=a.XHTML_DTD,n=a.ElementPath,o=e.Node,p={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};q.prototype.toString=function(){var a=[],b=this;return a.push((b.startContainer[0].id||b.startContainer[0].nodeName)+":"+b.startOffset),a.push((b.endContainer[0].id||b.endContainer[0].nodeName)+":"+b.endOffset),a.join("<br/>")},e.augment(q,{updateCollapsed:function(){var a=this;a.collapsed=a.startContainer&&a.endContainer&&j._4e_equals(a.startContainer,a.endContainer)&&a.startOffset==a.endOffset},optimize:function(){var a=this,b=a.startContainer,c=a.startOffset;b[0].nodeType!=f.NODE_ELEMENT&&(c?c>=b[0].nodeValue.length&&a.setStartAfter(b):a.setStartBefore(b)),b=a.endContainer,c=a.endOffset,b[0].nodeType!=f.NODE_ELEMENT&&(c?c>=b[0].nodeValue.length&&a.setEndAfter(b):a.setEndBefore(b))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this,b=a.startContainer,c=a.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&a.setStartAt(b,g.POSITION_BEFORE_START),c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&a.setEndAt(c,g.POSITION_AFTER_END)},setStart:function(a,b){var c=this;a[0].nodeType==f.NODE_ELEMENT&&p[a._4e_name()]&&(a=a.parent(),b=a._4e_index()),c.startContainer=a,c.startOffset=b,c.endContainer||(c.endContainer=a,c.endOffset=b),c.updateCollapsed()},setEnd:function(a,b){var c=this;a[0].nodeType==f.NODE_ELEMENT&&p[a._4e_name()]&&(a=a.parent(),b=a._4e_index()+1),c.endContainer=a,c.endOffset=b,c.startContainer||(c.startContainer=a,c.startOffset=b),c.updateCollapsed()},setStartAt:function(a,b){var c=this;switch(b){case g.POSITION_AFTER_START:c.setStart(a,0);break;case g.POSITION_BEFORE_END:a[0].nodeType==f.NODE_TEXT?c.setStart(a,a[0].nodeValue.length):c.setStart(a,a[0].childNodes.length);break;case g.POSITION_BEFORE_START:c.setStartBefore(a);break;case g.POSITION_AFTER_END:c.setStartAfter(a)}c.updateCollapsed()},setEndAt:function(a,b){var c=this;switch(b){case g.POSITION_AFTER_START:c.setEnd(a,0);break;case g.POSITION_BEFORE_END:a[0].nodeType==f.NODE_TEXT?c.setEnd(a,a[0].nodeValue.length):c.setEnd(a,a[0].childNodes.length);break;case g.POSITION_BEFORE_START:c.setEndBefore(a);break;case g.POSITION_AFTER_END:c.setEndAfter(a)}c.updateCollapsed()},execContentsAction:function(a,c){var d=this,e=d.startContainer,g=d.endContainer,h=d.startOffset,i=d.endOffset,k,l,m=d.document,n;d.optimizeBookmark(),g[0].nodeType==f.NODE_TEXT?g=g._4e_splitText(i):g[0].childNodes.length>0&&(i>=g[0].childNodes.length?(g=new o(g[0].appendChild(m.createTextNode(""))),n=b):g=new o(g[0].childNodes[i])),e[0].nodeType==f.NODE_TEXT?(e._4e_splitText(h),e._4e_equals(g)&&(g=new o(e[0].nextSibling))):h?h>=e[0].childNodes.length?(l=new o(m.createTextNode("")),e.append(l),e=l,k=b):e=new o(e[0].childNodes[h].previousSibling):(l=new o(m.createTextNode("")),e.prepend(l),e=l,k=b);var p=e._4e_parents(),q=g._4e_parents(),r,s,t;for(r=0;r<p.length;r++){s=p[r],t=q[r];if(!s._4e_equals(t))break}var u=c,v,w,x,y;for(var z=r;z<p.length;z++){v=p[z],u&&!v._4e_equals(e)?w=u.appendChild(v._4e_clone()[0]):w=null,x=v[0].nextSibling;while(x){if(j._4e_equals(q[z],x)||j._4e_equals(g,x))break;y=x.nextSibling,a==2?u.appendChild(x.cloneNode(b)):(j._4e_remove(x),a==1&&u.appendChild(x)),x=y}w&&(u=w)}u=c;for(var A=r;A<q.length;A++){v=q[A],u&&a>0&&!v._4e_equals(g)?w=u.appendChild(v._4e_clone()[0]):w=null;if(!p[A]||!v.parent()._4e_equals(p[A].parent())){x=v[0].previousSibling;while(x){if(j._4e_equals(p[A],x)||j._4e_equals(e,x))break;y=x.previousSibling,a==2?u.insertBefore(x.cloneNode(b),u.firstChild):(j._4e_remove(x),a==1&&u.insertBefore(x,u.firstChild)),x=y}}w&&(u=w)}if(a==2){var B=d.startContainer[0];B.nodeType==f.NODE_TEXT&&B.nextSibling&&B.nextSibling.nodeType==f.NODE_TEXT&&(B.data+=B.nextSibling.data,B.parentNode.removeChild(B.nextSibling));var C=d.endContainer[0];C.nodeType==f.NODE_TEXT&&C.nextSibling&&C.nextSibling.nodeType==f.NODE_TEXT&&(C.data+=C.nextSibling.data,C.parentNode.removeChild(C.nextSibling))}else{if(s&&t&&(!e.parent()._4e_equals(s.parent())||!g.parent()._4e_equals(t.parent()))){var D=t._4e_index();k&&t.parent()._4e_equals(e.parent())&&D--,d.setStart(t.parent(),D)}d.collapse(b)}k&&e._4e_remove(),n&&g[0].parentNode&&g._4e_remove()},collapse:function(a){var c=this;a?(c.endContainer=c.startContainer,c.endOffset=c.startOffset):(c.startContainer=c.endContainer,c.startOffset=c.endOffset),c.collapsed=b},clone:function(){var a=this,b=new q(a.document);return b.startContainer=a.startContainer,b.startOffset=a.startOffset,b.endContainer=a.endContainer,b.endOffset=a.endOffset,b.collapsed=a.collapsed,b},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=f.NODE_ELEMENT||c.endContainer[0].nodeType!=f.NODE_ELEMENT)return d;var e=new a.Walker(c),g=x(b,undefined),h=y(b),i,j;return c.evaluator=function(a){return h(a)&&g(a)},i=e.next(),e.reset(),j=e.previous(),i&&i._4e_equals(j)?i:d},shrink:function(a,d){var e=this;if(!e.collapsed){a=a||g.SHRINK_TEXT;var h=e.clone(),j=e.startContainer,k=e.endContainer,l=e.startOffset,m=e.endOffset,n=1,o=1;j&&j[0].nodeType==f.NODE_TEXT&&(l?l>=j[0].nodeValue.length?h.setStartAfter(j):(h.setStartBefore(j),n=0):h.setStartBefore(j)),k&&k[0].nodeType==f.NODE_TEXT&&(m?m>=k[0].nodeValue.length?h.setEndAfter(k):(h.setEndAfter(k),o=0):h.setEndBefore(k));var p=new i(h);p.evaluator=function(b){return b=b[0]||b,b.nodeType==(a==g.SHRINK_ELEMENT?f.NODE_ELEMENT:f.NODE_TEXT)};var q;p.guard=function(d,e){return d=d[0]||d,a==g.SHRINK_ELEMENT&&d.nodeType==f.NODE_TEXT?c:e&&d==q?c:(!e&&d.nodeType==f.NODE_ELEMENT&&(q=d),b)};if(n){var r=p[a==g.SHRINK_ELEMENT?"lastForward":"next"]();r&&e.setStartAt(r,d?g.POSITION_AFTER_START:g.POSITION_BEFORE_START)}if(o){p.reset();var s=p[a==g.SHRINK_ELEMENT?"lastBackward":"previous"]();s&&e.setEndAt(s,d?g.POSITION_BEFORE_END:g.POSITION_AFTER_END)}return!!n||!!o}},getTouchedStartNode:function(){var a=this,b=a.startContainer;return a.collapsed||b[0].nodeType!=f.NODE_ELEMENT?b:b.childNodes[a.startOffset]||b},createBookmark2:function(a){var c=this,e=c.startContainer,g=c.endContainer,h=c.startOffset,i=c.endOffset,j,k;if(!e||!g)return{start:0,end:0};if(a){e[0].nodeType==f.NODE_ELEMENT&&(j=new o(e[0].childNodes[h]),j&&j[0]&&j[0].nodeType==f.NODE_TEXT&&h>0&&j[0].previousSibling.nodeType==f.NODE_TEXT&&(e=j,h=0));while(e[0].nodeType==f.NODE_TEXT&&(k=e._4e_previous())&&k[0].nodeType==f.NODE_TEXT)e=k,h+=k[0].nodeValue.length;if(!c.collapsed){g[0].nodeType==f.NODE_ELEMENT&&(j=new o(g[0].childNodes[i]),j&&j[0]&&j[0].nodeType==f.NODE_TEXT&&i>0&&j[0].previousSibling.nodeType==f.NODE_TEXT&&(g=j,i=0));while(g[0].nodeType==f.NODE_TEXT&&(k=g._4e_previous())&&k[0].nodeType==f.NODE_TEXT)g=k,i+=k[0].nodeValue.length}}return{start:e._4e_address(a),end:c.collapsed?d:g._4e_address(a),startOffset:h,endOffset:i,normalized:a,is2:b}},createBookmark:function(a){var c,f,h,i,j=this,k=j.collapsed;return c=new o("<span>",d,j.document),c.attr("_ke_bookmark",1),c.css("display","none"),c.html("&nbsp;"),a&&(h=e.guid("ke_bm_"),c.attr("id",h+"S")),k||(f=c._4e_clone(),f.html("&nbsp;"),a&&f.attr("id",h+"E"),i=j.clone(),i.collapse(),i.insertNode(f)),i=j.clone(),i.collapse(b),i.insertNode(c),f?(j.setStartAfter(c),j.setEndBefore(f)):j.moveToPosition(c,g.POSITION_AFTER_END),{startNode:a?h+"S":c,endNode:a?h+"E":f,serializable:a,collapsed:k}},moveToPosition:function(a,c){var d=this;d.setStartAt(a,c),d.collapse(b)},trim:function(a,c){var d=this,e=d.startContainer,g=d.startOffset,h=d.collapsed;if((!a||h)&&e[0]&&e[0].nodeType==f.NODE_TEXT){if(!g)g=e._4e_index(),e=e.parent();else if(g>=e[0].nodeValue.length)g=e._4e_index()+1,e=e.parent();else{var i=e._4e_splitText(g);g=e._4e_index()+1,e=e.parent(),j._4e_equals(d.startContainer,d.endContainer)?d.setEnd(i,d.endOffset-d.startOffset):j._4e_equals(e,d.endContainer)&&(d.endOffset+=1)}d.setStart(e,g);if(h){d.collapse(b);return}}var k=d.endContainer,l=d.endOffset;!c&&!h&&k[0]&&k[0].nodeType==f.NODE_TEXT&&(l?l>=k.nodeValue.length?(l=k._4e_index()+1,k=k.parent()):(k._4e_splitText(l),l=k._4e_index()+1,k=k.parent()):(l=k._4e_index(),k=k.parent()),d.setEnd(k,l))},insertNode:function(a){var d=this;d.optimizeBookmark(),d.trim(c,b);var e=d.startContainer,f=d.startOffset,g=e[0].childNodes[f]||null;e[0].insertBefore(a[0]||a,g),j._4e_equals(a.parent(),d.endContainer)&&d.endOffset++,d.setStartBefore(a)},moveToBookmark:function(a){var c=this;if(a.is2){var d=k(c.document,a.start,a.normalized),f=a.startOffset,g=a.end&&k(c.document,a.end,a.normalized),h=a.endOffset;c.setStart(d,f),g?c.setEnd(g,h):c.collapse(b)}else{var i=a.serializable,j=i?e.one("#"+a.startNode,c.document):a.startNode,l=i?e.one("#"+a.endNode,c.document):a.endNode;c.setStartBefore(j),j._4e_remove(),l&&l[0]?(c.setEndBefore(l),l._4e_remove()):c.collapse(b)}},getCommonAncestor:function(a,b){var c=this,d=c.startContainer,e=c.endContainer,g;return j._4e_equals(d,e)?a&&d[0].nodeType==f.NODE_ELEMENT&&c.startOffset==c.endOffset-1?g=new o(d[0].childNodes[c.startOffset]):g=d:g=d._4e_commonAncestor(e),b&&g[0].nodeType==f.NODE_TEXT?g.parent():g},enlarge:function(a){var h=this;switch(a){case g.ENLARGE_ELEMENT:if(h.collapsed)return;var k=h.getCommonAncestor(),l=new o(h.document.body),n,p,r,s,t,u=c,v,w,x=h.startContainer,y=h.startOffset;x[0].nodeType==f.NODE_TEXT?(y&&(x=!e.trim(x[0].nodeValue.substring(0,y)).length&&x,u=!!x),x&&((s=x[0].previousSibling)||(r=x.parent()))):(y&&(s=x[0].childNodes[y-1]||x[0].lastChild),s||(r=x));while(r||s){if(r&&!s){!t&&j._4e_equals(r,k)&&(t=b);if(!l.contains(r))break;if(!u||r.css("display")!="inline")u=c,t?n=r:h.setStartBefore(r);s=r[0].previousSibling}while(s){v=c;if(s.nodeType==f.NODE_TEXT)w=s.nodeValue,/[^\s\ufeff]/.test(w)&&(s=d),v=/[\s\ufeff]$/.test(w);else if(s.offsetWidth>0&&!s.getAttribute("_ke_bookmark"))if(u&&m.$removeEmpty[s.nodeName.toLowerCase()]){w=j.text(s);if(/[^\s\ufeff]/.test(w))s=d;else{var z=s.all||s.getElementsByTagName("*");for(var A=0,B;B=z[A++];)if(!m.$removeEmpty[B.nodeName.toLowerCase()]){s=d;break}}s&&(v=!!w.length)}else s=d;v&&(u?t?n=r:r&&h.setStartBefore(r):u=b);if(s){var C=s.previousSibling;if(!r&&!C){r=new o(s),s=d;break}s=C}else r=d}r&&(r=r.parent())}x=h.endContainer,y=h.endOffset,r=s=d,t=u=c,x[0].nodeType==f.NODE_TEXT?(x=!e.trim(x[0].nodeValue.substring(y)).length&&x,u=!x||!x[0].nodeValue.length,x&&((s=x[0].nextSibling)||(r=x.parent()))):(s=x[0].childNodes[y],s||(r=x));while(r||s){if(r&&!s){!t&&j._4e_equals(r,k)&&(t=b);if(!l.contains(r))break;if(!u||r.css("display")!="inline")u=c,t?p=r:r&&h.setEndAfter(r);s=r[0].nextSibling}while(s){v=c;if(s.nodeType==f.NODE_TEXT)w=s.nodeValue,/[^\s\ufeff]/.test(w)&&(s=d),v=/^[\s\ufeff]/.test(w);else if(s.offsetWidth>0&&!s.getAttribute("_ke_bookmark"))if(u&&m.$removeEmpty[s.nodeName.toLowerCase()]){w=j.text(s);if(/[^\s\ufeff]/.test(w))s=d;else{z=s.all||s.getElementsByTagName("*");for(A=0;B=z[A++];)if(!m.$removeEmpty[B.nodeName.toLowerCase()]){s=d;break}}s&&(v=!!w.length)}else s=d;v&&u&&(t?p=r:h.setEndAfter(r));if(s){C=s.nextSibling;if(!r&&!C){r=new o(s),s=d;break}s=C}else r=d}r&&(r=r.parent())}n&&p&&(k=n.contains(p)?p:n,h.setStartBefore(k),h.setEndAfter(k));break;case g.ENLARGE_BLOCK_CONTENTS:case g.ENLARGE_LIST_ITEM_CONTENTS:var D=new q(h.document);l=new o(h.document.body),D.setStartAt(l,g.POSITION_AFTER_START),D.setEnd(h.startContainer,h.startOffset);var E=new i(D),F,G,H=i.blockBoundary(a==g.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:d),I=function(a){var b=H(a);return b||(F=a),b},J=function(a){var b=I(a);return!b&&a[0]&&a._4e_name()=="br"&&(G=a),b};E.guard=I,r=E.lastBackward(),F=F||l,h.setStartAt(F,F._4e_name()!="br"&&(!r&&h.checkStartOfBlock()||r&&F.contains(r))?g.POSITION_AFTER_START:g.POSITION_AFTER_END),D=h.clone(),D.collapse(),D.setEndAt(l,g.POSITION_BEFORE_END),E=new i(D),E.guard=a==g.ENLARGE_LIST_ITEM_CONTENTS?J:I,F=d,r=E.lastForward(),F=F||l,h.setEndAt(F,!r&&h.checkEndOfBlock()||r&&F.contains(r)?g.POSITION_BEFORE_END:g.POSITION_BEFORE_START),G&&h.setEndAfter(G)}},checkStartOfBlock:function(){var a=this,d=a.startContainer,h=a.startOffset;if(h&&d[0].nodeType==f.NODE_TEXT){var j=e.trim(d[0].nodeValue.substring(0,h));if(j.length)return c}a.trim();var k=new n(a.startContainer),l=a.clone();l.collapse(b),l.setStartAt(k.block||k.blockLimit,g.POSITION_AFTER_START);var m=new i(l);return m.evaluator=w(b),m.checkBackward()},checkEndOfBlock:function(){var a=this,b=a.endContainer,d=a.endOffset;if(b[0].nodeType==f.NODE_TEXT){var h=e.trim(b[0].nodeValue.substring(d));if(h.length)return c}a.trim();var j=new n(a.endContainer),k=a.clone();k.collapse(c),k.setEndAt(j.block||j.blockLimit,g.POSITION_BEFORE_END);var l=new i(k);return l.evaluator=w(c),l.checkForward()},deleteContents:function(){var a=this;if(a.collapsed)return;a.execContentsAction(0)},extractContents:function(){var a=this,b=a.document.createDocumentFragment();return a.collapsed||a.execContentsAction(1,b),b},checkBoundaryOfElement:function(a,b){var c=this.clone();c[b==g.START?"setStartAt":"setEndAt"](a,b==g.START?g.POSITION_AFTER_START:g.POSITION_BEFORE_END);var d=new i(c);return d.evaluator=s,d[b==g.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this,c=a.startContainer,d=a.endContainer,e=a.startOffset,g=a.endOffset,i;if(c[0].nodeType==f.NODE_ELEMENT){i=c[0].childNodes.length;if(i>e)c=new o(c[0].childNodes[e]);else if(i<1)c=c._4e_previousSourceNode();else{c=c[0];while(c.lastChild)c=c.lastChild;c=new o(c),c=c._4e_nextSourceNode()||c}}if(d[0].nodeType==f.NODE_ELEMENT){i=d[0].childNodes.length;if(i>g)d=(new o(d[0].childNodes[g]))._4e_previousSourceNode(b);else if(i<1)d=d._4e_previousSourceNode();else{d=d[0];while(d.lastChild)d=d.lastChild;d=new o(d)}}return c._4e_position(d)&h.POSITION_FOLLOWING&&(c=d),{startNode:c,endNode:d}},fixBlock:function(a,b){var c=this,d=c.createBookmark(),e=new o(c.document.createElement(b));c.collapse(a),c.enlarge(g.ENLARGE_BLOCK_CONTENTS),e[0].appendChild(c.extractContents()),e._4e_trim(),l.ie||e._4e_appendBogus();var f=e[0].childNodes;for(var h=0;h<f.length;h++){var i=f[h];i.nodeType==8&&c.insertNode(new o(i))}return c.insertNode(e),c.moveToBookmark(d),e},splitBlock:function(a){var f=this,h=new n(f.startContainer),i=new n(f.endContainer),k=h.blockLimit,m=i.blockLimit,o=h.block,p=i.block,q=d;if(!k._4e_equals(m))return d;a!="br"&&(o||(o=f.fixBlock(b,a),p=(new n(f.endContainer)).block),p||(p=f.fixBlock(c,a)));var r=o&&f.checkStartOfBlock(),s=p&&f.checkEndOfBlock();return f.deleteContents(),o&&j._4e_equals(o,p)&&(s?(q=new n(f.startContainer),f.moveToPosition(p,g.POSITION_AFTER_END),p=d):r?(q=new n(f.startContainer),f.moveToPosition(o,g.POSITION_BEFORE_START),o=d):(p=f.splitElement(o),!l.ie&&!e.inArray(o._4e_name(),["ul","ol"])&&o._4e_appendBogus())),{previousBlock:o,nextBlock:p,wasStartOfBlock:r,wasEndOfBlock:s,elementPath:q}},splitElement:function(a){var b=this;if(!b.collapsed)return d;b.setEndAt(a,g.POSITION_BEFORE_END);var e=b.extractContents(),f=a._4e_clone(c);return f[0].appendChild(e),f.insertAfter(a),b.moveToPosition(a,g.POSITION_AFTER_END),f},moveToElementEditablePosition:function(d,e){var h=this,i,j=a.XHTML_DTD;if(j.$empty[d._4e_name()])return c;while(d&&d[0].nodeType==f.NODE_ELEMENT){i=d._4e_isEditable();if(i)h.moveToPosition(d,e?g.POSITION_BEFORE_END:g.POSITION_AFTER_START);else if(j.$inline[d._4e_name()])return h.moveToPosition(d,e?g.POSITION_AFTER_END:g.POSITION_BEFORE_START),b;j.$empty[d._4e_name()]?d=d[e?"_4e_previous":"_4e_next"](v):d=d[e?"_4e_last":"_4e_first"](v);if(d&&d[0].nodeType==f.NODE_TEXT)return h.moveToPosition(d,e?g.POSITION_AFTER_END:g.POSITION_BEFORE_START),b}return i},selectNodeContents:function(a){this.setStart(a,0),this.setEnd(a,a[0].nodeType==f.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var r={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},t=new i.whitespaces,u=new i.bookmark;a.Range=q,a.Range=q;var z=q.prototype;a.Utils.extern(z,{updateCollapsed:z.updateCollapsed,optimize:z.optimize,setStartAfter:z.setStartAfter,setEndAfter:z.setEndAfter,setStartBefore:z.setStartBefore,setEndBefore:z.setEndBefore,optimizeBookmark:z.optimizeBookmark,setStart:z.setStart,setEnd:z.setEnd,setStartAt:z.setStartAt,setEndAt:z.setEndAt,execContentsAction:z.execContentsAction,collapse:z.collapse,clone:z.clone,getEnclosedNode:z.getEnclosedNode,shrink:z.shrink,getTouchedStartNode:z.getTouchedStartNode,createBookmark2:z.createBookmark2,createBookmark:z.createBookmark,moveToPosition:z.moveToPosition,trim:z.trim,insertNode:z.insertNode,moveToBookmark:z.moveToBookmark,getCommonAncestor:z.getCommonAncestor,enlarge:z.enlarge,checkStartOfBlock:z.checkStartOfBlock,checkEndOfBlock:z.checkEndOfBlock,deleteContents:z.deleteContents,extractContents:z.extractContents,checkBoundaryOfElement:z.checkBoundaryOfElement,getBoundaryNodes:z.getBoundaryNodes,fixBlock:z.fixBlock,splitBlock:z.splitBlock,splitElement:z.splitElement,moveToElementEditablePosition:z.moveToElementEditablePosition,selectNodeContents:z.selectNodeContents})}),KISSY.Editor.add("domiterator",function(a){function n(a){if(arguments.length<1)return;var d=this;d.range=a,d.forceBrBreak=c,d.enlargeBr=b,d.enforceRealBlocks=c,d._||(d._={})}var b=!0,c=!1,d=null,e=KISSY,f=e.UA,g=a.Walker,h=a.Range,i=a.RANGE,j=a.NODE,k=a.ElementPath,l=e.Node,m=e.DOM,o=/^[\r\n\t ]*$/;e.augment(n,{getNextParagraph:function(a){var n,p=this,q,r,s,t;if(!p._.lastNode){q=p.range.clone(),q.shrink(i.SHRINK_ELEMENT,b),q.enlarge(p.forceBrBreak||!p.enlargeBr?i.ENLARGE_LIST_ITEM_CONTENTS:i.ENLARGE_BLOCK_CONTENTS);var u=new g(q),v=g.bookmark(b,b);u.evaluator=v,p._.nextNode=u.next(),u=new g(q),u.evaluator=v;var w=u.previous();p._.lastNode=w._4e_nextSourceNode(b);if(p._.lastNode&&p._.lastNode[0].nodeType==j.NODE_TEXT&&!e.trim(p._.lastNode[0].nodeValue)&&p._.lastNode.parent()._4e_isBlockBoundary()){var x=new h(q.document);x.moveToPosition(p._.lastNode,i.POSITION_AFTER_END);if(x.checkEndOfBlock()){var y=new k(x.endContainer),z=y.block||y.blockLimit;p._.lastNode=z._4e_nextSourceNode(b)}}p._.lastNode||(p._.lastNode=p._.docEndMarker=new l(q.document.createTextNode("")),m.insertAfter(p._.lastNode[0],w[0])),q=d}var A=p._.nextNode;w=p._.lastNode,p._.nextNode=d;while(A){var B=c,C=A[0].nodeType!=j.NODE_ELEMENT,D=c;if(!C){var E=A._4e_name();if(A._4e_isBlockBoundary(p.forceBrBreak&&{br:1})){if(E=="br")C=b;else if(!q&&!A[0].childNodes.length&&E!="hr"){n=A,r=A._4e_equals(w);break}q&&(q.setEndAt(A,i.POSITION_BEFORE_START),E!="br"&&(p._.nextNode=A)),B=b}else{if(A[0].firstChild){q||(q=new h(p.range.document),q.setStartAt(A,i.POSITION_BEFORE_START)),A=new l(A[0].firstChild);continue}C=b}}else A[0].nodeType==j.NODE_TEXT&&o.test(A[0].nodeValue)&&(C=c);C&&!q&&(q=new h(p.range.document),q.setStartAt(A,i.POSITION_BEFORE_START)),r=(!B||C)&&A._4e_equals(w);if(q&&!B)while(!A[0].nextSibling&&!r){var F=A.parent();if(F._4e_isBlockBoundary(p.forceBrBreak&&{br:1})){B=b,r=r||F._4e_equals(w);break}A=F,C=b,r=A._4e_equals(w),D=b}C&&q.setEndAt(A,i.POSITION_AFTER_END),A=A._4e_nextSourceNode(D,d,w),r=!A;if(r||B&&q)break}if(!n){if(!q)return p._.docEndMarker&&p._.docEndMarker._4e_remove(),p._.nextNode=d,d;var G=new k(q.startContainer),H=G.blockLimit,I={div:1,th:1,td:1};n=G.block;if((!n||!n[0])&&!p.enforceRealBlocks&&I[H._4e_name()]&&q.checkStartOfBlock()&&q.checkEndOfBlock())n=H;else if(!n||p.enforceRealBlocks&&n._4e_name()=="li")n=new l(p.range.document.createElement(a||"p")),n[0].appendChild(q.extractContents()),n._4e_trim(),q.insertNode(n),s=t=b;else if(n._4e_name()!="li"){if(!q.checkStartOfBlock()||!q.checkEndOfBlock()){n=n._4e_clone(c),n[0].appendChild(q.extractContents()),n._4e_trim();var J=q.splitBlock();s=!J.wasStartOfBlock,t=!J.wasEndOfBlock,q.insertNode(n)}}else r||(p._.nextNode=n._4e_equals(w)?d:q.getBoundaryNodes().endNode._4e_nextSourceNode(b,d,w))}if(s){var K=new l(n[0].previousSibling);K[0]&&K[0].nodeType==j.NODE_ELEMENT&&(K._4e_name()=="br"?K._4e_remove():K[0].lastChild&&m._4e_name(K[0].lastChild)=="br"&&m._4e_remove(K[0].lastChild))}if(t){var L=g.bookmark(c,b),M=new l(n[0].lastChild);M[0]&&M[0].nodeType==j.NODE_ELEMENT&&M._4e_name()=="br"&&(f.ie||M._4e_previous(L)||M._4e_next(L))&&M._4e_remove()}return p._.nextNode||(p._.nextNode=r||n._4e_equals(w)?d:n._4e_nextSourceNode(b,d,w)),n}}),h.prototype.createIterator=function(){return new n(this)}}),KISSY.Editor.add("selection",function(a){function p(a){var c=this;c.document=c.document=a,c._={cache:{}};if(m){var d=c.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!=a||d.parentElement&&d.parentElement().ownerDocument!=a)c.isInvalid=b}}function u(a){var b=new p(a);return!b||b.isInvalid?d:b}function v(e){function u(a){return a._4e_outerHtml().match(t)}function x(b){var c=a.XHTML_DTD;return b._4e_isBlockBoundary()&&c.$empty[b._4e_name()]}var g=e.document,k=new i(g.body),n=new i(g.documentElement);if(f.ie){f.ieEngine<8&&n.on("click",function(a){var b=new i(a.target);b._4e_name()==="html"&&e.getSelection().getNative().createRange().select()});var o,p,q=1;n.on("mousedown",function(){q=0}),n.on("mouseup",function(){q=1}),k.on("focusin",function(a){var b=new i(a.target);if(b._4e_name()!="body")return;if(o){try{q&&o.select()}catch(c){}o=d}}),k.on("focus",function(){p=b,s()}),k.on("beforedeactivate",function(a){if(a.relatedTarget)return;r(),q=1}),e.on("blur",function(){try{var a=document.documentElement||document.body,b=a.scrollTop,c=a.scrollLeft;g&&g.selection.empty(),a.scrollTop=b,a.scrollLeft=c}catch(d){}}),k.on("mousedown",function(){r()}),k.on("mouseup",function(){p=b,setTimeout(function(){s(b)},0)});function r(){p=c}function s(a){if(p){var c=e.document,d=e.getSelection(),f=d&&d.getType(),g=d&&c.selection;if(a&&g&&f==j.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage")){setTimeout(function(){s(b)},50);return}var h;if(g&&g.type&&g.type!="Control"&&(h=g.createRange())&&(h=h.parentElement())&&(h=h.nodeName)&&h.toLowerCase()in{input:1,textarea:1})return;o=g&&d.getRanges()[0],e._monitor()}}k.on("keydown",r),k.on("keyup",function(){p=b,s()}),h.on(g,"selectionchange",s)}else h.on(g,"mouseup",e._monitor,e),h.on(g,"keyup",e._monitor,e);var t=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<!--[\s\S]*?-->))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,v=a.Walker.whitespaces(b),w=function(a){return v(a)&&a&&a[0].nodeType!=8};e.on("selectionChange",function(a){var d=a.path,f=a.selection,g=f&&f.getRanges()[0],h=d.blockLimit;if(!g||!g.collapsed||d.block)return;if(h._4e_name()=="body"){var i=g.fixBlock(b,"p");if(i){if(u(i)){var j=i._4e_next(w);j&&j[0].nodeType==l.NODE_ELEMENT&&!x[j]?(g.moveToElementEditablePosition(j),i._4e_remove()):(j=i._4e_previous(w),j&&j[0].nodeType==l.NODE_ELEMENT&&!x[j]&&(g.moveToElementEditablePosition(j,u(j)?c:b),i._4e_remove()))}g.select(),m||e.notifySelectionChange()}}})}a.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var b=!0,c=!1,d=null,e=KISSY,f=e.UA,g=e.DOM,h=e.Event,i=e.Node,j=a.SELECTION,k=a.RANGE,l=a.NODE,m=f.ie,n=a.Walker,o=a.Range,q={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};e.augment(p,{getNative:m?function(){var a=this,b=a._.cache;return b.nativeSel||(b.nativeSel=a.document.selection)}:function(){var a=this,b=a._.cache;return b.nativeSel||(b.nativeSel=g._4e_getWin(a.document).getSelection())},getType:m?function(){var a=this,b=a._.cache;if(b.type)return b.type;var c=j.SELECTION_NONE;try{var d=a.getNative(),e=d.type;e=="Text"&&(c=j.SELECTION_TEXT),e=="Control"&&(c=j.SELECTION_ELEMENT),d.createRange().parentElement&&(c=j.SELECTION_TEXT)}catch(f){}return b.type=c}:function(){var a=this,b=a._.cache;if(b.type)return b.type;var c=j.SELECTION_TEXT,d=a.getNative();if(!d)c=j.SELECTION_NONE;else if(d.rangeCount==1){var e=d.getRangeAt(0),f=e.startContainer;f==e.endContainer&&f.nodeType==l.NODE_ELEMENT&&Number(e.endOffset-e.startOffset)==1&&q[f.childNodes[e.startOffset].nodeName.toLowerCase()]&&(c=j.SELECTION_ELEMENT)}return b.type=c},getRanges:m?function(){var a=function(a,b){a=a.duplicate(),a.collapse(b);var e=a.parentElement(),f=e.childNodes,g;for(var h=0;h<f.length;h++){var i=f[h];if(i.nodeType==l.NODE_ELEMENT){g=a.duplicate(),g.moveToElementText(i);var j=g.compareEndPoints("StartToStart",a),k=g.compareEndPoints("EndToStart",a);g.collapse();if(j>0)break;if(!j||k==1&&j==-1)return{container:e,offset:h};if(!k)return{container:e,offset:h+1};g=d}}g||(g=a.duplicate(),g.moveToElementText(e),g.collapse(c)),g.setEndPoint("StartToStart",a);var m=String(g.text).replace(/\r\n|\r/g,"\n").length;try{while(m>0)m-=f[--h].nodeValue.length}catch(n){m=0}return m===0?{container:e,offset:h}:{container:f[h],offset:-m}};return function(c){var d=this,e=d._.cache;if(e.ranges&&!c)return e.ranges;var f=d.getNative(),g=f&&f.createRange(),h=d.getType(),k;if(!f)return[];if(h==j.SELECTION_TEXT){k=new o(d.document);var l=a(g,b);return k.setStart(new i(l.container),l.offset),l=a(g),k.setEnd(new i(l.container),l.offset),e.ranges=[k]}if(h==j.SELECTION_ELEMENT){var m=e.ranges=[];for(var n=0;n<g.length;n++){var p=g.item(n),q=p.parentNode,r=0;k=new o(d.document);for(;r<q.childNodes.length&&q.childNodes[r]!=p;r++);k.setStart(new i(q),r),k.setEnd(new i(q),r+1),m.push(k)}return m}return e.ranges=[]}}():function(a){var b=this,c=b._.cache;if(c.ranges&&!a)return c.ranges;var d=[],e=b.getNative();if(!e)return[];for(var f=0;f<e.rangeCount;f++){var g=e.getRangeAt(f),h=new o(b.document);h.setStart(new i(g.startContainer),g.startOffset),h.setEnd(new i(g.endContainer),g.endOffset),d.push(h)}return c.ranges=d},getStartElement:function(){var a=this,c=a._.cache;if(c.startElement!==undefined)return c.startElement;var e,f=a.getNative();switch(a.getType()){case j.SELECTION_ELEMENT:return this.getSelectedElement();case j.SELECTION_TEXT:var h=a.getRanges()[0];if(h&&!h.collapsed){h.optimize();while(b){var k=h.startContainer,n=h.startOffset;if(n==(k[0].nodeType===l.NODE_ELEMENT?k[0].childNodes.length:k[0].nodeValue.length)&&!k._4e_isBlockBoundary())h.setStartAfter(k);else break}e=h.startContainer;if(e[0].nodeType!=l.NODE_ELEMENT)return e.parent();e=new i(e[0].childNodes[h.startOffset]);if(!e[0]||e[0].nodeType!=l.NODE_ELEMENT)return h.startContainer;var o=e[0].firstChild;while(o&&o.nodeType==l.NODE_ELEMENT)e=new i(o),o=o.firstChild;return e}m?(h=f.createRange(),h.collapse(b),e=h.parentElement()):(e=f.anchorNode,e&&e.nodeType!=l.NODE_ELEMENT&&(e=e.parentNode))}return c.startElement=e?g._4e_wrap(e):d},getSelectedElement:function(){var a=this,b,c=a._.cache;if(c.selectedElement!==undefined)return c.selectedElement;if(m){var d=a.getNative().createRange();b=d.item&&d.item(0)}return b||(b=function(){var b=a.getRanges()[0],c,d;for(var e=2;e&&!((c=b.getEnclosedNode())&&c[0].nodeType==l.NODE_ELEMENT&&q[c._4e_name()]&&(d=c));e--)b.shrink(k.SHRINK_ELEMENT);return d&&d[0]}()),c.selectedElement=g._4e_wrap(b)},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this,d=c.document;if(m){try{b=d.body.createControlRange(),b.addElement(a[0]),b.select()}catch(e){b=d.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}c.reset()}else{b=d.createRange(),b.selectNode(a[0]);var f=c.getNative();f.removeAllRanges(),f.addRange(b),c.reset()}},selectRanges:function(a){var b=this;if(m){if(a.length>1){var c=a[a.length-1];a[0].setEnd(c.endContainer,c.endOffset),a.length=1}a[0]&&a[0].select(),b.reset()}else{var d=b.getNative();if(!d)return;d.removeAllRanges();for(var e=0;e<a.length;e++){var g=a[e],h=b.document.createRange(),i=g.startContainer;g.collapsed&&f.gecko&&f.gecko<1.09&&i[0].nodeType==l.NODE_ELEMENT&&!i[0].childNodes.length&&i[0].appendChild(b.document.createTextNode("")),h.setStart(i[0],g.startOffset),h.setEnd(g.endContainer[0],g.endOffset),d.addRange(h)}b.reset()}},createBookmarks2:function(a){var b=[],c=this.getRanges();for(var d=0;d<c.length;d++)b.push(c[d].createBookmark2(a));return b},createBookmarks:function(a,c){var d=this,f=[],h=d.document,i;c=c||d.getRanges();var j=c.length;for(var k=0;k<j;k++){f.push(i=c[k].createBookmark(a,b)),a=i.serializable;var l=a?e.one("#"+i.startNode,h):i.startNode,m=a?e.one("#"+i.endNode,h):i.endNode;for(var n=k+1;n<j;n++){var o=c[n],p=o.startContainer,q=o.endContainer;g._4e_equals(p,l.parent())&&o.startOffset++,g._4e_equals(p,m.parent())&&o.startOffset++,g._4e_equals(q,l.parent())&&o.endOffset++,g._4e_equals(q,m.parent())&&o.endOffset++}}return f},selectBookmarks:function(a){var b=this,c=[];for(var d=0;d<a.length;d++){var e=new o(b.document);e.moveToBookmark(a[d]),c.push(e)}return b.selectRanges(c),b},getCommonAncestor:function(){var a=this.getRanges(),b=a[0].startContainer,c=a[a.length-1].endContainer;return b._4e_commonAncestor(c)},scrollIntoView:function(){var a=this.getStartElement();a&&a._4e_scrollIntoView()},removeAllRanges:function(){var a=this.getNative();m?a&&a.clear():a&&a.removeAllRanges()}});var r={table:1,tbody:1,tr:1},s=n.whitespaces(b),t=/\ufeff|\u00a0/;o.prototype.select=o.prototype.select=m?function(a){var c=this,d=c.collapsed,e,f;if(c.startContainer[0]===c.endContainer[0]&&c.endOffset-c.startOffset==1){var h=c.startContainer[0].childNodes[c.startOffset];if(h.nodeType==l.NODE_ELEMENT){(new p(c.document)).selectElement(new i(h));return}}(c.startContainer[0].nodeType==l.NODE_ELEMENT&&c.startContainer._4e_name()in r||c.endContainer[0].nodeType==l.NODE_ELEMENT&&c.endContainer._4e_name()in r)&&c.shrink(k.SHRINK_ELEMENT,b);var j=c.createBookmark(),m=j.startNode,n;d||(n=j.endNode);var o=c.document.body.createTextRange();o.moveToElementText(m[0]),o.moveStart("character",1);if(n){var q=c.document.body.createTextRange();q.moveToElementText(n[0]),o.setEndPoint("EndToEnd",q),o.moveEnd("character",-1)}else{var u=m[0].nextSibling;while(u&&!s(u))u=u.nextSibling;e=!(u&&u.nodeValue&&u.nodeValue.match(t))&&(a||!m[0].previousSibling||m[0].previousSibling&&g._4e_name(m[0].previousSibling)=="br"),f=new i(c.document.createElement("span")),f.html("&#65279;"),f.insertBefore(m),e&&g.insertBefore(c.document.createTextNode("\ufeff"),m[0]||m)}c.setStartBefore(m),m._4e_remove(),d?(e?(o.moveStart("character",-1),o.select(),c.document.selection.clear()):o.select(),f&&(c.moveToPosition(f,k.POSITION_BEFORE_START),f._4e_remove())):(c.setEndBefore(n),n._4e_remove(),o.select())}:function(){var a=this,c=a.startContainer;a.collapsed&&c[0].nodeType==l.NODE_ELEMENT&&!c[0].childNodes.length&&c[0].appendChild(a.document.createTextNode(""));var d=a.document.createRange();d.setStart(c[0],a.startOffset);try{d.setEnd(a.endContainer[0],a.endOffset)}catch(e){if(e.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0)a.collapse(b),d.setEnd(a.endContainer[0],a.endOffset);else throw e}var f=u(a.document).getNative();f.removeAllRanges(),f.addRange(d)},p.getSelection=u,a.Selection=p,a.Selection=p;var w=p.prototype;a.Utils.extern(w,{getNative:w.getNative,getType:w.getType,getRanges:w.getRanges,getStartElement:w.getStartElement,getSelectedElement:w.getSelectedElement,reset:w.reset,selectElement:w.selectElement,selectRanges:w.selectRanges,createBookmarks2:w.createBookmarks2,createBookmarks:w.createBookmarks,getCommonAncestor:w.getCommonAncestor,scrollIntoView:w.scrollIntoView,selectBookmarks:w.selectBookmarks,removeAllRanges:w.removeAllRanges}),a.on("instanceCreated",function(a){var b=a.editor;v(b)})}),KISSY.Editor.add("styles",function(a){function u(a){return!a.attr("_ke_bookmark")}function v(a,b){for(var c in a){if(!a.hasOwnProperty(c))continue;e.isString(a[c])?a[c]=a[c].replace(t,function(a,c){return b[c]}):v(a[c],b)}}function w(a,b){b&&(a=e.clone(a),v(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type=c=="#"||q[c]?h.STYLE_BLOCK:r[c]?h.STYLE_OBJECT:h.STYLE_INLINE,this._={definition:a}}function x(a,b){var c=this,d=b?c.removeFromRange:c.applyToRange;a.body.focus();var e=new j(a),f=e.getRanges();for(var g=0;g<f.length;g++)d.call(c,f[g]);e.selectRanges(f)}function y(a,b,c){var d,e=a.element;return e=="*"&&(e="span"),d=new n(b.createElement(e)),c&&c._4e_copyAttributes(d),z(d,a)}function z(a,b){var c=b._.definition,d=c.attributes,e=w.getStyleText(c);if(d)for(var f in d)a.attr(f,d[f]);return e&&(a[0].style.cssText=e),a}function A(a){var c=a.createBookmark(b),d=a.createIterator();d.enforceRealBlocks=b,d.enlargeBr=b;var e,f=a.document;while(e=d.getNextParagraph()){var g=y(this,f,e);E(e,g)}a.moveToBookmark(c)}function B(a,b,c){var d="",e="";return a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){return b&&(d=b),c&&(e=c),""}),d+a.replace(b,c)+e}function C(a,b){var c=a.html();c=B(c,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),c=c.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),c=c.replace(/([ \t\n\r]+|&nbsp;)/g," "),c=c.replace(/<br\b[^>]*>/gi,"\n");if(o.ie){var d=a[0].ownerDocument.createElement("div");d.appendChild(b[0]),b[0].outerHTML="<pre>"+c+"</pre>",b=new n(d.firstChild),b._4e_remove()}else b.html(c);return b}function D(a){var b=/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,c=B(a._4e_outerHtml(),b,function(a,b,c){return b+"</pre>"+c+"<pre>"}),d=[];return c.replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,b){d.push(b)}),d}function E(a,b){var c=b._4e_name=="pre",d=a._4e_name=="pre",e=c&&!d,f=!c&&d;e?b=C(a,b):f?b=G(D(a),b):a._4e_moveChildren(b),a[0].parentNode.replaceChild(b[0],a[0]),c&&F(b)}function F(a){var c;if(!(c=a._4e_previousSourceNode(b,k.NODE_ELEMENT))||c._4e_name()!="pre")return;var d=B(c.html(),/\n$/,"")+"\n\n"+B(a.html(),/^\n/,"");o.ie?a[0].outerHTML="<pre>"+d+"</pre>":a.html(d),c._4e_remove()}function G(a,b){var c=b[0].ownerDocument.createDocumentFragment();for(var d=0;d<a.length;d++){var e=a[d];e=e.replace(/(\r\n|\r)/g,"\n"),e=B(e,/^[ \t]*\n/,""),e=B(e,/\n$/,""),e=B(e,/^[ \t]+|[ \t]+$/g,function(a,b){return a.length==1?"&nbsp;":b?" "+(new Array(a.length)).join("&nbsp;"):(new Array(a.length)).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return(new Array(a.length)).join("&nbsp;")+" "});var f=b._4e_clone();f.html(e),c.appendChild(f[0])}return c}function H(e){var f=this,h=e.document;if(e.collapsed){var j=y(this,h,undefined);e.insertNode(j),e.moveToPosition(j,i.POSITION_BEFORE_END);return}var p=this.element,q=this._.definition,r,s=a.XHTML_DTD[p]||(r=b,a.XHTML_DTD.span),t=e.createBookmark();e.enlarge(i.ENLARGE_ELEMENT),e.trim();var v=e.createBookmark(),w=v.startNode,x=v.endNode,z=w,A;while(z&&z[0]){var B=c;if(g._4e_equals(z,x))z=d,B=b;else{var C=z[0].nodeType,D=C==k.NODE_ELEMENT?z._4e_name():d;if(D&&z.attr("_ke_bookmark")){z=z._4e_nextSourceNode(b);continue}if(!D||s[D]&&(z._4e_position(x)|(l.POSITION_PRECEDING|l.POSITION_IDENTICAL|l.POSITION_IS_CONTAINED))==l.POSITION_PRECEDING+l.POSITION_IDENTICAL+l.POSITION_IS_CONTAINED&&(!q.childRule||q.childRule(z))){var E=z.parent();if(E&&p=="a"&&E._4e_name()==p){var F=y(f,h,undefined);E._4e_moveChildren(F),E[0].parentNode.replaceChild(F[0],E[0]),F._4e_mergeSiblings()}else if(E&&E[0]&&((a.XHTML_DTD[E._4e_name()]||a.XHTML_DTD.span)[p]||r)&&(!q.parentRule||q.parentRule(E))){!A&&(!D||!a.XHTML_DTD.$removeEmpty[D]||(z._4e_position(x)|(l.POSITION_PRECEDING|l.POSITION_IDENTICAL|l.POSITION_IS_CONTAINED))==l.POSITION_PRECEDING+l.POSITION_IDENTICAL+l.POSITION_IS_CONTAINED)&&(A=new m(h),A.setStartBefore(z));if(C==k.NODE_TEXT||C==k.NODE_ELEMENT&&!z[0].childNodes.length){var G=z,H;while((B=!G._4e_next(u))&&(H=G.parent(),s[H._4e_name()])&&(H._4e_position(w)|l.POSITION_FOLLOWING|l.POSITION_IDENTICAL|l.POSITION_IS_CONTAINED)==l.POSITION_FOLLOWING+l.POSITION_IDENTICAL+l.POSITION_IS_CONTAINED&&(!q.childRule||q.childRule(H)))G=H;A.setEndAfter(G)}}else B=b}else B=b;z=z._4e_nextSourceNode()}if(B&&A&&!A.collapsed){var I=y(f,h,undefined),J=A.getCommonAncestor(),K={styles:{},attrs:{},blockedStyles:{},blockedAttrs:{}},L,M,N;while(I&&J&&I[0]&&J[0]){if(J._4e_name()==p){for(L in q.attributes){if(K.blockedAttrs[L]||!(N=J.attr(M)))continue;I.attr(L)==N?I.removeAttr(L):K.blockedAttrs[L]=1}for(M in q.styles){if(K.blockedStyles[M]||!(N=J._4e_style(M)))continue;I._4e_style(M)==N?I._4e_style(M,""):K.blockedStyles[M]=1}if(!I._4e_hasAttributes()){I=d;break}}J=J.parent()}I?(I[0].appendChild(A.extractContents()),Q(f,I),A.insertNode(I),I._4e_mergeSiblings(),o.ie||I[0].normalize()):(I=new n(h.createElement("span")),I[0].appendChild(A.extractContents()),A.insertNode(I),Q(f,I),I._4e_remove(!0)),A=d}}w._4e_remove(),x._4e_remove(),e.moveToBookmark(t),e.shrink(i.SHRINK_TEXT)}function I(a){a.enlarge(i.ENLARGE_ELEMENT);var b=a.createBookmark(),c=b.startNode;if(a.collapsed){var e=new p(c.parent()),f;for(var h=0,j;h<e.elements.length&&(j=e.elements[h]);h++){if(j==e.block||j==e.blockLimit)break;if(this.checkElementRemovable(j)){var l=a.checkBoundaryOfElement(j,i.END),m=!l&&a.checkBoundaryOfElement(j,i.START);if(m||l)f=j,f.match=m?"start":"end";else{j._4e_mergeSiblings();if(j._4e_name()!=this.element){var o=N(this);R(j,o[j._4e_name()]||o["*"])}else O(this,j)}}}if(f&&f[0]){var q=c;for(h=0;;h++){var r=e.elements[h];if(g._4e_equals(r,f))break;if(r.match)continue;r=r._4e_clone(),r[0].appendChild(q[0]),q=r}g[f.match=="start"?"insertBefore":"insertAfter"](g._4e_unwrap(q),g._4e_unwrap(f))}}else{var s=b.endNode,t=this;function u(){var a=new p(c.parent()),b=new p(s.parent()),e=d,f=d;for(var g=0;g<a.elements.length;g++){var h=a.elements[g];if(h==a.block||h==a.blockLimit)break;t.checkElementRemovable(h)&&(e=h)}for(g=0;g<b.elements.length;g++){h=b.elements[g];if(h==b.block||h==b.blockLimit)break;t.checkElementRemovable(h)&&(f=h)}f&&s._4e_breakParent(f),e&&c._4e_breakParent(e)}u();var v=new n(c[0].nextSibling);while(v[0]!==s[0]){var w=v._4e_nextSourceNode();if(v[0]&&v[0].nodeType==k.NODE_ELEMENT&&this.checkElementRemovable(v)){if(v._4e_name()==this["element"])O(this,v);else{var x=N(this);R(v,x[v._4e_name()]||x["*"])}w[0].nodeType==k.NODE_ELEMENT&&w.contains(c)&&(u(),w=new n(c[0].nextSibling))}v=w}}a.moveToBookmark(b)}function J(a){a=String(a);var b={};return a.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d}),b}function K(a,d){typeof a=="string"&&(a=J(a)),typeof d=="string"&&(d=J(d));for(var e in a)if(!(e in d)||d[e]!=a[e]&&a[e]!="inherit"&&d[e]!="inherit")return c;return b}function L(a,b){var d="";if(b!==c){var e=document.createElement("span");e.style.cssText=a,d=e.style.cssText||""}else d=a;return d.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function M(a){var b=a._AC;if(b)return b;b={};var c=0,d=a.attributes;if(d)for(var e in d)c++,b[e]=d[e];var f=w.getStyleText(a);return f&&(b.style||c++,b.style=f),b._length=c,a._AC=b}function N(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;if(c){e.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var f=c[d],g,h,i,j;typeof f=="string"?g=f.toLowerCase():(g=f.element?f.element.toLowerCase():a.element,i=f.attributes,j=f.styles),h=b[g]||(b[g]={});if(i){var k=h.attributes=h.attributes||new Array;for(var l in i)i.hasOwnProperty(l)&&k.push([l.toLowerCase(),i[l]])}if(j){var m=h.styles=h.styles||new Array;for(var n in j)j.hasOwnProperty(n)&&m.push([n.toLowerCase(),j[n]])}}}return b}function O(a,c){var d=a._.definition,g=N(a),h=f.mix(d.attributes,(g[c._4e_name()]||g["*"]||{}).attributes),i=f.mix(d.styles,(g[c._4e_name()]||g["*"]||{}).styles),j=e.isEmptyObject(h)&&e.isEmptyObject(i);for(var k in h)if(h.hasOwnProperty(k))if(k!="class"&&!a._.definition.fullMatch||c.attr(k)==P(k,h[k]))j=j||!!c._4e_hasAttribute(k),c.removeAttr(k);else continue;for(var l in i)if(i.hasOwnProperty(l)){if(a._.definition.fullMatch&&c._4e_style(l)!=P(l,i[l],b))continue;j=j||!!c._4e_style(l),c._4e_style(l,"")}S(c)}function P(a,b,c){var d=new n("<span>");return d[c?"_4e_style":"attr"](a,b),d[c?"_4e_style":"attr"](a)}function Q(a,b){var c=N(a),d=b.all(a.element);for(var e=d.length;--e>=0;)O(a,new n(d[e]));for(var f in c)if(f!=a["element"]){d=b.all(f);for(e=d.length-1;e>=0;e--){var g=new n(d[e]);R(g,c[f])}}}function R(a,b){var c,e=b&&b.attributes;if(e)for(c=0;c<e.length;c++){var f=e[c][0],g;if(g=a.attr(f)){var h=e[c][1];(h===d||h.test&&h.test(g)||typeof h=="string"&&g==h)&&a[0].removeAttribute(f)}}var i=b&&b.styles;if(i)for(c=0;c<i.length;c++){var j=i[c][0],k;if(k=a.css(j)){var l=i[c][1];(l===d||l.test&&l.test(g)||typeof l=="string"&&k==l)&&a.css(j,"")}}S(a)}function S(a){if(!a._4e_hasAttributes()){var c=a[0].firstChild,d=a[0].lastChild;a._4e_remove(b),c&&(c.nodeType==k.NODE_ELEMENT&&g._4e_mergeSiblings(c),d&&c!=d&&d.nodeType==k.NODE_ELEMENT&&g._4e_mergeSiblings(d))}}var b=!0,c=!1,d=null,e=KISSY,f=a.Utils,g=e.DOM,h={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},i=a.RANGE,j=a.Selection,k=a.NODE,l=a.POSITION,m=a.Range,n=e.Node,o=e.UA,p=a.ElementPath,q={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},r={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},s=/\s*(?:;\s*|$)/g,t=/#\((.+?)\)/g;a.STYLE=h,w.prototype={apply:function(a){x.call(this,a,c)},remove:function(a){x.call(this,a,b)},applyToRange:function(a){var b=this;return(b.applyToRange=this.type==h.STYLE_INLINE?H:b.type==h.STYLE_BLOCK?A:b.type==h.STYLE_OBJECT?d:d).call(b,a)},removeFromRange:function(a){var b=this;return(b.removeFromRange=b.type==h.STYLE_INLINE?I:d).call(b,a)},applyToObject:function(a){z(a,this)},checkElementRemovable:function(a,e){if(!a)return c;var f=this._.definition,g,h;if(a._4e_name()==this.element){if(!e&&!a._4e_hasAttributes())return b;g=M(f);if(!g._length)return b;for(var i in g){if(i=="_length")continue;var j=a.attr(i)||"";if(i=="style"?K(g[i],L(j,c)):g[i]==j){if(!e)return b}else if(e)return c}if(e)return b}var k=N(this),l=k[a._4e_name()]||k["*"];if(l){if(!(g=l.attributes)&&!(h=l.styles))return b;if(g)for(var m=0;m<g.length;m++){i=g[m][0];var n=a.attr(i);if(n){var o=g[m][1];if(o===d||typeof o=="string"&&n==o||o.test&&o.test(n))return b}}if(h)for(m=0;m<h.length;m++){var p=h[m][0],q=a.css(p);if(q){var r=h[m][1];if(r===d||typeof r=="string"&&q==r||r.test&&r.test(q))return b}}}return c},checkActive:function(a){switch(this.type){case h.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,b);case h.STYLE_OBJECT:case h.STYLE_INLINE:var d=a.elements;for(var e=0,f;e<d.length;e++){f=d[e];if(this.type==h.STYLE_INLINE&&(g._4e_equals(f,a.block)||g._4e_equals(f,a.blockLimit)))continue;if(!(this.type!=h.STYLE_OBJECT||f._4e_name()in r))continue;if(this.checkElementRemovable(f,b))return b}}return c}},w.getStyleText=function(a){var b=a._ST;if(b)return b;b=a.styles;var c=a.attributes&&a.attributes.style||"",d="";c.length&&(c=c.replace(s,";"));for(var e in b){var f=b[e],g=(e+":"+f).replace(s,";");f=="inherit"?d+=g:c+=g}return c.length&&(c=L(c)),c+=d,a._ST=c},a.Style=w,a.Style=w;var T=w.prototype;a.Utils.extern(T,{apply:T.apply,remove:T.remove,applyToRange:T.applyToRange,removeFromRange:T.removeFromRange,applyToObject:T.applyToObject,checkElementRemovable:T.checkElementRemovable,checkActive:T.checkActive})}),KISSY.Editor.add("htmlparser",function(){function h(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)-->)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var a=KISSY,b=null,c=function(){},d=a.Editor,e=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,f={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},g=d.XHTML_DTD;a.augment(h,{onTagOpen:c,onTagClose:c,onText:c,onCDATA:c,onComment:c,parse:function(a){var c,d,h=0,i;while(c=this._.htmlPartsRegex.exec(a)){var j=c.index;if(j>h){var k=a.substring(h,j);i?i.push(k):this.onText(k)}h=this._.htmlPartsRegex.lastIndex;if(d=c[1]){d=d.toLowerCase(),i&&g.$cdata[d]&&(this.onCDATA(i.join("")),i=b);if(!i){this.onTagClose(d);continue}}if(i){i.push(c[0]);continue}if(d=c[3]){d=d.toLowerCase();if(/="/.test(d))continue;var l={},m,n=c[4],o=!!n&&n.charAt(n.length-1)=="/";if(n)while(m=e.exec(n)){var p=m[1].toLowerCase(),q=m[2]||m[3]||m[4]||"";!q&&f[p]?l[p]=p:l[p]=q}this.onTagOpen(d,l,o),!i&&g.$cdata[d]&&(i=[]);continue}(d=c[2])&&this.onComment(d)}a.length>h&&this.onText(a.substring(h,a.length))}}),d.HtmlParser=h,d.HtmlParser=h}),KISSY.Editor.add("htmlparser-basicwriter",function(){function e(){this._={output:[]}}var a=KISSY,b=a.Editor,c=b.Utils,d=!1;a.augment(e,{openTag:function(a){this._.output.push("<",a)},openTagClose:function(a,b){b?this._.output.push(" />"):this._.output.push(">")},attribute:function(a,b){typeof b=="string"&&(b=c.htmlEncodeAttr(b)),this._.output.push(" ",a,'="',b,'"')},closeTag:function(a){this._.output.push("</",a,">")},text:function(a){this._.output.push(a)},comment:function(a){this._.output.push("<!--",a,"-->")},write:function(a){this._.output.push(a)},reset:function(){this._.output=[],this._.indent=d},getHtml:function(a){var b=this._.output.join("");return a&&this.reset(),b}}),b.HtmlParser.BasicWriter=e,b.HtmlParser.BasicWriter=e;var f=e.prototype;b.Utils.extern(f,{openTag:f.openTag,openTagClose:f.openTagClose,attribute:f.attribute,closeTag:f.closeTag,text:f.text,comment:f.comment,write:f.write,reset:f.reset,getHtml:f.getHtml})}),KISSY.Editor.add("htmlparser-htmlwriter",function(){function f(){f.superclass.constructor.call(this),this.indentationChars="\t",this.selfClosingEnd=" />",this.lineBreakChars="\n",this.forceSimpleAmpersand=e,this.sortAttributes=d,this._.indent=e,this._.indentation="",this._.rules={};var a=b.XHTML_DTD;for(var g in c.mix({},a.$nonBodyContent,a.$block,a.$listItem,a.$tableContent))this.setRules(g,{indent:d,breakBeforeOpen:d,breakAfterOpen:d,breakBeforeClose:!a[g]["#"],breakAfterClose:d});this.setRules("br",{breakAfterOpen:d}),this.setRules("title",{indent:e,breakAfterOpen:e}),this.setRules("style",{indent:e,breakBeforeClose:d}),this.setRules("pre",{indent:e})}var a=KISSY,b=a.Editor,c=b.Utils,d=!0,e=!1;a.extend(f,b.HtmlParser.BasicWriter,{openTag:function(a){var b=this._.rules[a];this._.indent?this.indentation():b&&b.breakBeforeOpen&&(this.lineBreak(),this.indentation()),this._.output.push("<",a)},openTagClose:function(a,b){var c=this._.rules[a];b?this._.output.push(this.selfClosingEnd):(this._.output.push(">"),c&&c.indent&&(this._.indentation+=this.indentationChars)),c&&c.breakAfterOpen&&this.lineBreak()},attribute:function(a,b){typeof b=="string"&&(this.forceSimpleAmpersand&&(b=b.replace(/&amp;/g,"&")),b=c.htmlEncodeAttr(b)),this._.output.push(" ",a,'="',b,'"')},closeTag:function(a){var b=this._.rules[a];b&&b.indent&&(this._.indentation=this._.indentation.substr(this.indentationChars.length)),this._.indent?this.indentation():b&&b.breakBeforeClose&&(this.lineBreak(),this.indentation()),this._.output.push("</",a,">"),b&&b.breakAfterClose&&this.lineBreak()},text:function(a){this._.indent&&(this.indentation(),a=c.ltrim(a)),this._.output.push(a)},comment:function(a){this._.indent&&this.indentation(),this._.output.push("<!--",a,"-->")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars),this._.indent=d},indentation:function(){this._.output.push(this._.indentation),this._.indent=e},setRules:function(a,b){var d=this._.rules[a];d?d=c.mix(d,b):this._.rules[a]=b}}),b.HtmlParser.HtmlWriter=f,b.HtmlParser.HtmlWriter=f;var g=f.prototype;b.Utils.extern(g,{openTag:g.openTag,openTagClose:g.openTagClose,attribute:g.attribute,closeTag:g.closeTag,text:g.text,comment:g.comment,lineBreak:g.lineBreak,indentation:g.indentation,setRules:g.setRules})}),KISSY.Editor.add("htmlparser-fragment",function(){function e(){this.children=[],this.parent=c,this._={isBlockLike:a,hasInlineStarted:b}}var a=!0,b=!1,c=null,d=KISSY.Editor,f={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},g=KISSY,h=d.Utils,i=d.NODE,j=d.XHTML_DTD,k=h.mix({table:1,ul:1,ol:1,dl:1},j.table,j.ul,j.ol,j.dl),l=j.$list,m=j.$listItem;e.FromHtml=function(c,g){function u(a){var b;if(p.length>0)for(var c=0;c<p.length;c++){var d=p[c],e=d.name,f=j[e],g=r.name&&j[r.name];(!g||g[e])&&(!a||!f||f[a]||!j[a])&&(b||(v(),b=1),d=d.clone(),d.parent=r,r=d,p.splice(c,1),c--)}}function v(){while(q.length)r.add(q.shift())}function w(a,b,c){b=b||r||o;if(g&&!b.type){var d,e;a.attributes&&(e=a.attributes._ke_real_element_type)?d=e:d=a.name;if(d&&!(d in j.$body)&&!(d in j.$nonBodyContent)){var f=r;r=b;var k={li:"ul",dt:"dl",dd:"dl"};n.onTagOpen(k[d]||g,{}),b=r,c&&(r=f)}}if(a._.isBlockLike&&a.name!="pre"){var l=a.children.length,m=a.children[l-1],p;m&&m.type==i.NODE_TEXT&&((p=h.rtrim(m.value))?m.value=p:a.children.length=l-1)}b.add(a),a.returnPoint&&(r=a.returnPoint,delete a.returnPoint)}var n=new d.HtmlParser,o=new e,p=[],q=[],r=o,s=b,t;n.onTagOpen=function(c,e,g){var h=new d.HtmlParser.Element(c,e);h.isUnknown&&g&&(h.isEmpty=a);if(j.$removeEmpty[c]){p.push(h);return}if(String(c)==="pre")s=a;else if(String(c)==="br"&&s){r.add(new d.HtmlParser.Text("\n"));return}if(String(c)==="br"){q.push(h);return}var i=r.name,o=i&&(j[i]||(r._.isBlockLike?j.div:j.span));if(o&&!h.isUnknown&&!r.isUnknown&&!o[c]){var x=b,y;if(c in l&&i in l){var z=r.children,A=z[z.length-1];A&&A.name in m||w(A=new d.HtmlParser.Element("li"),r),t=r,y=A}else c==i?w(r,r.parent):(w(r,r.parent,a),!f[i]&&i in j.$inline&&p.unshift(r),x=a);y?r=y:r=r.returnPoint||r.parent;if(x){n.onTagOpen.apply(this,arguments);return}}u(c),v(),h.parent=r,h.returnPoint=t,t=0,h.isEmpty?w(h):r=h},n.onTagClose=function(a){for(var c=p.length-1;c>=0;c--)if(a==p[c].name){p.splice(c,1);return}var d=[],e=[],f=r;while(f.type&&f.name!=a)f._.isBlockLike||e.unshift(f),d.push(f),f=f.parent;if(f.type){for(c=0;c<d.length;c++){var h=d[c];w(h,h.parent)}r=f,r.name=="pre"&&(s=b),f._.isBlockLike&&v(),w(f,f.parent),f==r&&(r=r.parent),p=p.concat(e)}a=="body"&&(g=b)},n.onText=function(a){if(!r._.hasInlineStarted&&!s){a=h.ltrim(a);if(a.length===0)return}v(),u(),g&&(!r.type||r.name=="body")&&h.trim(a)&&this.onTagOpen(g,{}),s||(a=a.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," ")),r.add(new d.HtmlParser.Text(a))},n.onCDATA=function(a){r.add(new d.HtmlParser.cdata(a))},n.onComment=function(a){r.add(new d.HtmlParser.Comment(a))},n.parse(c),v();while(r.type){var x=r.parent,y=r;g&&(!x.type||x.name=="body")&&!j.$body[y.name]&&(r=x,n.onTagOpen(g,{}),x=r),x.add(y),r=x}return o},g.augment(e,{add:function(a){var b=this.children.length,d=b>0&&this.children[b-1]||c;if(d){if(a._.isBlockLike&&d.type==i.NODE_TEXT){d.value=h.rtrim(d.value);if(d.value.length===0){this.children.pop(),this.add(a);return}}d.next=a}a.previous=d,a.parent=this,this.children.push(a),this._.hasInlineStarted=a.type==i.NODE_TEXT||a.type==i.NODE_ELEMENT&&!a._.isBlockLike},writeHtml:function(b,f){var g;this.filterChildren=function(){var b=new d.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,b,f,a);var c=b.getHtml();this.children=(new e.FromHtml(c)).children,g=1},this.filterChildren=this.filterChildren,!this.name&&f&&f.onFragment(this),this.writeChildrenHtml(b,g?c:f)},writeChildrenHtml:function(a,b){for(var c=0;c<this.children.length;c++)this.children[c].writeHtml(a,b)}}),d.HtmlParser.Fragment=e,d.HtmlParser.Fragment=e,e.FromHtml=e.FromHtml;var n=e.prototype;d.Utils.extern(n,{add:n.add,writeHtml:n.writeHtml,writeChildrenHtml:n.writeChildrenHtml})}),KISSY.Editor.add("htmlparser-element",function(){function e(b,c){this.name=b,this.attributes=c||(c={}),this.children=[];var d=c._ke_real_element_type||b,e=a.XHTML_DTD,f=!!(e.$nonBodyContent[d]||e.$block[d]||e.$listItem[d]||e.$tableContent[d]||e.$nonEditable[d]||d=="br"),g=!!e.$empty[b];this.isEmpty=g,this.isUnknown=!e[b],this._={isBlockLike:f,hasInlineStarted:g||!f}}var a=KISSY.Editor,b=!0,c=!1,d=null,f=KISSY,g=a.NODE,h=function(a,b){return a=a[0],b=b[0],a<b?-1:a>b?1:0};f.augment(e,{type:g.NODE_ELEMENT,add:a.HtmlParser.Fragment.prototype.add,clone:function(){return new e(this.name,this.attributes)},writeHtml:function(e,f){var i=this.attributes,j=this,k=j.name,l,m,n,o;j.filterChildren=function(){if(!o){var b=new a.HtmlParser.BasicWriter;a.HtmlParser.Fragment.prototype.writeChildrenHtml.call(j,b,f),j.children=(new a.HtmlParser.Fragment.FromHtml(b.getHtml())).children,o=1}},j.filterChildren=j.filterChildren;if(f){while(b){if(!(k=f.onElementName(k)))return;j.name=k;if(!(j=f.onElement(j)))return;j.parent=this.parent;if(j.name==k)break;if(j.type!=g.NODE_ELEMENT){j.writeHtml(e,f);return}k=j.name;if(!k){this.writeChildrenHtml.call(j,e,o?d:f);return}}i=j.attributes}e.openTag(k,i);var p=[];for(var q=0;q<2;q++)for(l in i){m=l,n=i[l];if(q==1)p.push([l,n]);else if(f){while(b){if(!(m=f.onAttributeName(l))){delete i[l];break}if(m!=l)delete i[l],l=m;else break}m&&((n=f.onAttribute(j,m,n))===c?delete i[m]:i[m]=n)}}e.sortAttributes&&p.sort(h);var r=p.length;for(q=0;q<r;q++){var s=p[q];e.attribute(s[0],s[1])}e.openTagClose(k,j.isEmpty),j.isEmpty||(this.writeChildrenHtml.call(j,e,o?d:f),e.closeTag(k))},writeChildrenHtml:function(b,c){a.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}}),a.HtmlParser.Element=e,a.HtmlParser.Element=e;var i=e.prototype;a.Utils.extern(i,{type:i.type,add:i.add,clone:i.clone,writeHtml:i.writeHtml,writeChildrenHtml:i.writeChildrenHtml})}),KISSY.Editor.add("htmlparser-filter",function(){function f(a){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}},a&&this.addRules(a,10)}function g(a,b){for(var c=0;a&&c<b.length;c++){var d=b[c];a=a.replace(d[0],d[1])}return a}function h(a,b,c){typeof b=="function"&&(b=[b]);var d,e,f=a.length,g=b&&b.length;if(g){for(d=0;d<f&&a[d].pri<c;d++);for(e=g-1;e>=0;e--){var h=b[e];h&&(h.pri=c,a.splice(d,0,h))}}}function i(a,b,c){if(b)for(var d in b){var e=a[d];a[d]=j(e,b[d],c),e||a.$length++}}function j(a,b,c){return b?(b.pri=c,a?(a.splice?h(a,b,c):(a.pri>c?a=[b,a]:a=[a,b],a.filter=k),a):(b.filter=b,b)):undefined}function k(a){var c=a.type||a instanceof b.HtmlParser.Fragment;for(var e=0;e<this.length;e++){if(c)var f=a.type,g=a.name;var h=this[e],i=h.apply(window,arguments);if(i===d)return i;if(c){if(i&&(i.name!=g||i.type!=f))return i}else if(typeof i!="string")return i;i!=undefined&&(a=i)}return a}var a=KISSY,b=a.Editor,c=b.NODE,d=!1,e=null;a.augment(f,{addRules:function(a,b){typeof b!="number"&&(b=10),h(this._.elementNames,a.elementNames,b),h(this._.attributeNames,a.attributeNames,b),i(this._.elements,a.elements,b),i(this._.attributes,a.attributes,b),this._.text=j(this._.text,a.text,b)||this._.text,this._.comment=j(this._.comment,a.comment,b)||this._.comment,this._.root=j(this._.root,a.root,b)||this._.root},onElementName:function(a){return g(a,this._.elementNames)},onAttributeName:function(a){return g(a,this._.attributeNames)},onText:function(a){var b=this._.text;return b?b.filter(a):a},onComment:function(a,b){var c=this._.comment;return c?c.filter(a,b):a},onFragment:function(a){var b=this._.root;return b?b.filter(a):a},onElement:function(a){var b=[this._.elements["^"],this._.elements[a.name],this._.elements.$],c,f;for(var g=0;g<3;g++){c=b[g];if(c){f=c.filter(a,this);if(f===d)return e;if(f&&f!=a)return this.onNode(f);if(a.parent&&!a.name)break}}return a},onNode:function(a){var d=a.type;return d==c.NODE_ELEMENT?this.onElement(a):d==c.NODE_TEXT?new b.HtmlParser.Text(this.onText(a.value)):e},onAttribute:function(a,b,c){var e=this._.attributes[b];if(e){var f=e.filter(c,a,this);if(f===d)return d;if(typeof f!="undefined")return f}return c}}),b.HtmlParser.Filter=f;var l=f.prototype;b.Utils.extern(l,{addRules:l.addRules,onElementName:l.onElementName,onAttributeName:l.onAttributeName,onText:l.onText,onComment:l.onComment,onFragment:l.onFragment,onElement:l.onElement,onNode:l.onNode,onAttribute:l.onAttribute}),b.HtmlParser.Filter=f}),KISSY.Editor.add("htmlparser-text",function(){function e(a){this.value=a,this._={isBlockLike:d}}var a=KISSY,b=a.Editor,c=b.NODE,d=!1;a.augment(e,{type:c.NODE_TEXT,writeHtml:function(a,b){var c=this.value;if(b&&!(c=b.onText(c,this)))return;a.text(c)}}),b.HtmlParser.Text=e,b.HtmlParser.Text=e}),KISSY.Editor.add("htmlparser-cdata",function(a){a.HtmlParser.cdata=function(a){this.value=a},a.HtmlParser.cdata.prototype={type:a.NODE.NODE_TEXT,writeHtml:function(a){a.write(this.value)}}}),KISSY.Editor.add("htmlparser-comment",function(){function c(a){this.value=a,this._={isBlockLike:!1}}var a=KISSY.Editor,b=a.NODE;a.HtmlParser.Comment=c,a.HtmlParser.Comment=c,c.prototype={constructor:c,type:b.NODE_COMMENT,writeHtml:function(a,b){var c=this.value;if(b){if(!(c=b.onComment(c,this)))return;if(typeof c!="string"){c.parent=this.parent,c.writeHtml(a,b);return}}a.comment(c)}}}),KISSY.Editor.add("button",function(){function k(a){return a&&a.indexOf("<")==-1?a:0}var a=KISSY,b=a.Editor,c="on",d="off",e="disabled",f="ke-triplebutton",g="ke-triplebutton-on",h="ke-triplebutton-off",i="ke-triplebutton-active",j="ke-triplebutton-disabled";if(b.TripleButton){a.log("TripleButton attach twice","warn");return}var l=a.UIBase.create([a.UIBase.Box.Render||a.UIBase.Box],{_updateHref:function(){var a=this;a.get("el").attr("href","javascript:void('"+(k(a.get("text"))||k(a.get("title")))+"')")},bindUI:function(){var a=this,b=a.get("el");b.on("click",a._action,a),b.on("mousedown",function(){a.get("state")==d&&b.addClass(i)}),b.on("mouseup mouseleave",function(){a.get("state")==d&&b.hasClass(i)&&setTimeout(function(){b.removeClass(i)},300)})},_uiSetTitle:function(){var a=this;a.get("el").attr("title",a.get("title")),a._updateHref()},_uiSetContentCls:function(a){var b=this,c=b.get("el");a!==undefined&&(c.html("<span class='ke-toolbar-item "+a+"' />"),c._4e_unselectable())},_uiSetText:function(a){var b=this,c=b.get("el");c.html(a),b._updateHref()},_uiSetState:function(a){this["_"+a]()},disable:function(){var a=this;a._savedState=a.get("state"),a.set("state",e)},enable:function(){var a=this;a.get("state")==e&&a.set("state",a._savedState)},_action:function(a){var b=this;b.fire(b.get("state")+"Click",{TripleEvent:a}),b.fire("click",{TripleClickType:b.get("state")+"Click"}),a&&a.preventDefault()},bon:function(){this.set("state",c)},boff:function(){this.set("state",d)},_on:function(){var a=this.get("el");a.removeClass(h+" "+j),a.addClass(g)},_off:function(){var a=this.get("el");a.removeClass(g+" "+j),a.addClass(h)},_disabled:function(){var a=this.get("el");a.removeClass(h+" "+g),a.addClass(j)}},{ATTRS:{state:{value:d},elCls:{value:[f,h].join(" ")},elTagName:{value:"a"},title:{},contentCls:{},text:{}}});l.ON=c,l.OFF=d,l.DISABLED=e,l.ON_CLASS=g,l.OFF_CLASS=h,l.DISABLED_CLASS=j,b.TripleButton=l,b.prototype.addButton=function(c,d){var e=this,f=e,g=new l({render:e.toolBarDiv,autoRender:!0,title:d.title,text:d.text,contentCls:d.contentCls}),h={btn:g,editor:e,cfg:d,call:function(){var b=a.makeArray(arguments),c=b.shift();return d[c].apply(h,b)},reload:function(c){a.mix(d,c),g.enable(),e.on("selectionChange",function(){if(e.getMode()==b.SOURCE_MODE)return;d.selectionChange&&d.selectionChange.apply(h,arguments)}),g.on("click",function(a){var b=a.TripleClickType;d[b]&&d[b].apply(h,arguments),a&&a.halt()}),d.mode==b.WYSIWYG_MODE&&(f.on("wysiwygmode",g.enable,g),f.on("sourcemode",g.disable,g)),d.init&&d.init.call(h)},destroy:function(){d.destroy&&d.destroy.call(h),g.destroy()}};return d.loading?g.disable():h.reload(undefined),h}},{attach:!1}),KISSY.Editor.add("select",function(){function k(a){var b=this;k.superclass.constructor.call(b,a),b._init()}function r(a){return a&&a.indexOf("<")==-1?a:0}var a=KISSY,b=a.Node,c=a.Event,d=a.DOM,e=a.Editor,f="title",g="ke-select-active",h="ke-menu-selected",i="<span class='ke-select-wrap'><a class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>",j="<div>";if(e.Select){a.log("ke select attach more");return}var l="ke-select-disabled",m=1,n=0;k.DISABLED=n,k.ENABLED=m;var o=e.XHTML_DTD;k.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},title:{},items:{},emptyText:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){var a=this.el.parent();while(a){var c=a._4e_name();if(o[c]&&o[c].div)return a;a=a.parent()}return new b(document.body)}},state:{value:m}},k.decorate=function(a){var b=a.width(),c=[],e=a.all("option");for(var f=0;f<e.length;f++){var g=e[f];c.push({name:d.html(g),value:d.attr(g,"value")})}return new k({width:b+"px",title:a.attr("title"),el:a,items:c,cls:"ke-combox",value:a.val()})};var p=e.Utils.addRes,q=e.Utils.destroyRes;a.extend(k,a.Base,{_init:function(){var a=this,c=a.get("container"),d=a.get("el"),g=new b(i),h=g.one("a"),j=a.get(f)||"",k=a.get("cls"),l=g.one(".ke-select-text"),m=g.one(".ke-select-text-inner"),n=g.one(".ke-select-drop");a.get("value")!==undefined?m.html(a._findNameByV(a.get("value"))):m.html(j),l.css("width",a.get("width")),g._4e_unselectable(),j&&g.attr(f,j),h.attr("href","javascript:void('"+r(j)+"')"),k&&g.addClass(k),d?d[0].parentNode.replaceChild(g[0],d[0]):c&&g.appendTo(c),g.on("click",a._click,a),a.el=g,a.title=m,a._focusA=g.one("a.ke-select"),e.Utils.lazyRun(this,"_prepare","_real"),a.on("afterValueChange",a._valueChange,a),a.on("afterStateChange",a._stateChange,a)},_findNameByV:function(a){var b=this,c=b.get(f)||"",d=b.get("items");if(b.get("showValue"))return a||c;for(var e=0;e<d.length;e++){var g=d[e];if(g.value==a){c=g.name;break}}return c},_valueChange:function(a){var b=a.newVal,c=this,d=c._findNameByV(b);c.title.html(d)},_itemsChange:function(a){var c=this,d,e=a.newVal,f=c._selectList;f.html("");if(e&&e.length)for(var g=0;g<e.length;g++)var h=e[g],i=(new b("<a class='ke-select-menu-item' href='javascript:void(\""+r(h.name)+"\")' data-value='"+h.value+"'>"+h.name+"</a>",h.attrs)).appendTo(f)._4e_unselectable();else(d=c.get("emptyText"))&&(new b("<a class='ke-select-menu-item' href='javascript:void(\""+r(d)+"\")'>"+d+"</a>")).appendTo(f)._4e_unselectable();c.as=f.all("a")},val:function(a){var b=this;return a!==undefined?(b.set("value",a),b):b.get("value")},_resize:function(){var a=this,b=a.menu;b.get("visible")&&a._real()},_prepare:function(){function o(a){var c=new b(a.target);if(d.contains(c)||d._4e_equals(c))return;m.hide()}var a=this,d=a.el,i=a.get("popUpWidth"),k=a._focusA,l,m=new e.Overlay({autoRender:!0,render:a.get("menuContainer"),content:j,focus4e:!1,elCls:"ke-menu",width:i?i:d.width(),zIndex:e.baseZIndex(e.zIndexManager.SELECT),focusMgr:!1}),n=a.get("items");p.call(a,m),l=m.get("contentEl").one("div"),a.menu=m,c.on(window,"resize",a._resize,a),p.call(a,function(){c.remove(window,"resize",a._resize,a)}),a.get(f)&&(new b("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+a.get("title")+"</div>")).appendTo(l),a._selectList=(new b("<div>")).appendTo(l),a._itemsChange({newVal:n}),m.on("show",function(){k.addClass(g)}),m.on("hide",function(){k.removeClass(g)}),c.on(document,"click",o),p.call(a,function(){c.remove(document,"click",o)}),a.get("doc")&&c.on(a.get("doc"),"click",o),l.on("click",a._select,a),a.as=a._selectList.all("a"),c.on(l[0],"mouseenter",function(){a.as.removeClass(h)}),p.call(a,l),a.on("afterItemsChange",a._itemsChange,a),a.menuNode=l},_stateChange:function(a){var b=a.newVal,c=this.el;b==m?c.removeClass(l):c.addClass(l)},enable:function(){this.set("state",m)},disable:function(){this.set("state",n)},_select:function(a){a&&a.halt();var c=this,d=c.menu,e=c.menuNode,f=new b(a.target),g=f._4e_ascendant(function(a){return e.contains(a)&&a._4e_name()=="a"},!0);if(!g||!g._4e_hasAttribute("data-value"))return;var h=c.get("value"),i=g.attr("data-value");c.set("value",i),c.fire("click",{newVal:i,prevVal:h,name:g.html()}),d.hide()},_real:function(){var b=this,c=b.el,e=c.offset(),f=a.clone(e),g=b.menu.get("el").height(),h=b.menu.get("el").width(),i=d.scrollTop(),j=d.scrollLeft(),k=d.viewportHeight(),l=d.viewportWidth(),m=j+l-60,n=i+k,o=e.top+(c.height()-2),p=e.left+c.width()-2,q=b.get("align"),r=q[0],s=q[1];s=="b"?(e.top=o,e.top+g>n&&f.top-i>n-o&&(e.top=f.top-g)):(e.top=f.top-g,e.top<i&&f.top-i<n-o&&(e.top=o)),r=="l"?e.left+h>m&&p-j>m-f.left&&(e.left=p-h):(e.left=p-h,e.left<j&&p-j<m-f.left&&(e.left=f.left)),b.menu.set("xy",[e.left,e.top]),b.menu.show()},_click:function(a){if(this.loading)return;a&&a.preventDefault();var b=this,c=b.el,d=b.get("value");if(c.hasClass(l))return;if(b._focusA.hasClass(g)){b.menu&&b.menu.hide();return}b.loading=!0,e.use("overlay",function(){b.loading=!1,b.fire("select"),b._prepare();if(d&&b.menu){var a=b.as;a.each(function(a){a.attr("data-value")==d?a.addClass(h):a.removeClass(h)})}})},destroy:function(){q.call(this),this.el.detach(),this.el.remove()}}),e.Select=k,e.prototype.addSelect=function(c,d){var f=this,g=f;d=a.mix({container:f.toolBarDiv,doc:g.document,menuContainer:new b(document.body)},d);var h=new k(d),i={btn:h,editor:f,cfg:d,call:function(){var b=a.makeArray(arguments),c=b.shift();return d[c].apply(i,b)},reload:function(b){a.mix(d,b),h.enable(),f.on("selectionChange",function(){if(f.getMode()==e.SOURCE_MODE)return;d.selectionChange&&d.selectionChange.apply(i,arguments)}),h.on("click",function(a){var b=a.type;d[b]&&d[b].apply(i,arguments),a&&a.halt()}),d.mode==e.WYSIWYG_MODE&&(g.on("wysiwygmode",h.enable,h),g.on("sourcemode",h.disable,h)),d.init&&d.init.call(i)},destroy:function(){d.destroy&&d.destroy.call(i),h.destroy()}};return d.loading?h.disable():i.reload(undefined),i}},{attach:!1}),KISSY.Editor.add("bubbleview",function(){function g(a,b){var c=a.get("y"),d=c+a.get("el")[0].offsetHeight,e=b.get("y"),f=e+b.get("el")[0].offsetHeight;return!(d<e||f<c)}function h(a){var b;for(var c in f){var d=f[c];d.bubble&&a!=d.bubble&&d.bubble.get("visible")&&g(a,d.bubble)&&(b?b.get("y")<d.bubble.get("y")&&(b=d.bubble):b=d.bubble)}return b}function i(a){var b=f[a];return b.bubble||(b.bubble=new e({autoRender:!0}),b.cfg.init&&b.cfg.init.call(b.bubble)),b.bubble}var a=KISSY,b=a.Editor,c=a.Event,d=a.DOM;if(b.BubbleView){a.log("attach bubbleview more","warn");return}var e=a.UIBase.create(b.Overlay,[],{renderUI:function(){var a=this.get("el");a.addClass("ke-bubbleview-bubble")},show:function(){var a=this,b=a._selectedEl,c=b._4e_getOffset(document);c.top+=b.height()+5,a.set("xy",[c.left,c.top]);var d=h(a);!d||(c.top=d.get("y")+d.get("el")[0].offsetHeight),e.superclass.show.call(a),a.set("xy",[c.left,c.top])},destructor:function(){b.Utils.destroyRes.call(this)}},{ATTRS:{focus4e:{value:!1},zIndex:{value:b.baseZIndex(b.zIndexManager.BUBBLE_VIEW)}}}),f={};e.destroy=function(a){var b=f[a];b&&b.bubble&&(b.bubble.destroy(),b.bubble=null)},e.attach=function(b){function m(){l&&l.hide()}var e=b.pluginName,g=f[e];a.mix(b,g.cfg,!1);var h=b.pluginContext,j=b.func,k=b.editor,l=b.bubble;k.on("selectionChange",function(a){var b=a.path,c=b.elements,d,f;if(b&&c){f=b.lastElement;if(!f)return;d=j(f),d?(l=i(e),l._selectedEl=d,l._plugin=h,l.hide(),setTimeout(function(){l.show()},10)):l&&(l._selectedEl=l._plugin=null,l.hide())}}),k.on("sourcemode blur",m),c.on(d._4e_getWin(k.document),"scroll",m)},e.register=function(a){var b=a.pluginName;f[b]=f[b]||{cfg:a},c.on(document,"click",function(){a.bubble&&a.bubble.hide()}),a.editor&&e.attach(a)},b.BubbleView=e},{attach:!1,requires:["overlay"]}),KISSY.Editor.add("clipboard",function(a){var b=KISSY,c=b.Editor,d=b.Node,e=b.UA,f=c.Range,g=c.RANGE,h=b.Event;c.Paste||function(){function a(a){var b=this;b.editor=a,b._init()}function n(a){if(!e.ie||a.document.compatMode=="BackCompat")return;var b=a.getSelection(),c;if(b.getType()==m.SELECTION_ELEMENT&&(c=b.getSelectedElement())){var f=b.getRanges()[0],g=new d(a.document.createTextNode(""));g.insertBefore(c),f.setStartBefore(g),f.setEndAfter(c),b.selectRanges([f]),setTimeout(function(){c.parent()&&(g.remove(),b.selectElement(c))},0)}}function q(a,b){p=1;var c=!0;try{c=b.queryCommandEnabled(a)?!0:!1}catch(d){}return p=0,c}b.augment(a,{_init:function(){var a=this,b=a.editor;h.on(b.document.body,e.webkit?"paste":e.gecko?"paste":"beforepaste",a._paste,a),h.on(b.document.body,"contextmenu",function(){p=1,setTimeout(function(){p=0},10)}),b.addCommand("copy",new l("copy")),b.addCommand("cut",new l("cut")),b.addCommand("paste",new l("paste"))},_paste:function(a){if(p)return;b.log(a.type+" : "+" paste event happen");var c=this,h=c.editor,i=h.document;if(i.getElementById("ke_pastebin")){b.log(a.type+" : trigger more than once ...");return}var j=h.getSelection(),k=new f(i),l=new d(e.webkit?"<body></body>":"<div></div>",null,i);l.attr("id","ke_pastebin"),e.webkit&&l[0].appendChild(i.createTextNode("\u00a0")),i.body.appendChild(l[0]),l.css({position:"absolute",top:j.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"}),l.css("left","-1000px");var m=j.createBookmarks();k.setStartAt(l,g.POSITION_AFTER_START),k.setEndAt(l,g.POSITION_BEFORE_END),k.select(!0),setTimeout(function(){l._4e_remove();var a;l=e.webkit&&(a=l._4e_first())&&a.hasClass("Apple-style-span")?a:l,j.selectBookmarks(m);var c=l.html();if(!(c=b.trim(c.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))))return;b.log("paster "+c);var d=h.fire("paste",{html:c,holder:l});d!==undefined&&(c=d);var f=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(c)&&(f=h.htmlDataProcessor.wordFilter),h.insertHtml(c,f)},0)}}),c.Paste=a;var i=function(a,b){var c=a.document,f=new d(c.body),g=!1,h=function(){g=!0};return f.on(b,h),(e.ie>7?c:c.selection.createRange()).execCommand(b),f.detach(b,h),g},j=e.ie?function(a,b){return i(a,b)}:function(a,b){try{return a.document.execCommand(b)}catch(c){return!1}},k={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},l=function(a){this.type=a,this.canUndo=this.type=="cut"};l.prototype={exec:function(a){this.type=="cut"&&n(a);var b=j(a,this.type);return b||alert(k[this.type]),b}};var m=c.Selection,o={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},p;c.on("contextmenu",function(a){var b=a.contextmenu,c=b.cfg.editor,e=b.elDom,f={copy:0,cut:0,paste:0};for(var g in f){if(!f.hasOwnProperty(g))return;f[g]=e.one(".ke-paste-"+g),function(a){var g=f[a];g||(g=(new d("<a href='#'class='ke-paste-"+a+"'>"+o[a]+"</a>")).appendTo(e),g.on("click",function(d){d.halt();if(g.hasClass("ke-menuitem-disable"))return;b.hide(),setTimeout(function(){c.execCommand(a)},30)})),f[a]=g}(g);var h=f[g];q(g,c.document)?h.removeClass("ke-menuitem-disable"):h.addClass("ke-menuitem-disable")}})}(),a.ready(function(){new c.Paste(a)})},{attach:!1}),KISSY.Editor.add("color",function(a){a.addPlugin("color",function(){var b=KISSY,c=b.Editor,d=a.cfg.pluginConfig,e=[];!1!==d.forecolor&&function(){var b={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},d=a.addButton("color",{styles:b,mode:c.WYSIWYG_MODE,title:"\u6587\u672c\u989c\u8272",loading:!0,contentCls:"ke-toolbar-color"});c.use("colorsupport",function(){d.reload(c.ColorSupport)}),e.push(function(){d.destroy()})}(),!1!==d.bgcolor&&function(){var b={element:"span",styles:{"background-color":"#(color)"},overrides:[{element:"*",styles:{"background-color":null}}]},d=a.addButton("color",{styles:b,title:"\u80cc\u666f\u989c\u8272",mode:c.WYSIWYG_MODE,loading:!0,contentCls:"ke-toolbar-bgcolor"});c.use("colorsupport",function(){d.reload(c.ColorSupport)}),e.push(function(){d.destroy()})}(),this.destroy=function(){for(var a=0;a<e.length;a++)e[a]()}})},{attach:!1}),KISSY.Editor.add("colorsupport",function(){function h(){if(g)return;g="<div class='ke-color-panel'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\">\u6e05\u9664</a>";for(var a=0;a<3;a++){g+="<div class='ke-color-palette'><table>";var b=f[a],c=b.length/8;for(var d=0;d<c;d++){g+="<tr>";for(var e=0;e<8;e++){var h="#"+b[8*d+e];g+="<td>",g+="<a href='javascript:void(0);' class='ke-color-a' style='background-color:"+h+"'"+"></a>",g+="</td>"}g+="</tr>"}g+="</table></div>"}g+="<div><a class='ke-button ke-color-others'>\u5176\u4ed6\u989c\u8272</a></div></div>"}var a=KISSY,b=a.Editor,c=a.Node,d=a.Event,e=a.DOM;e.addStyleSheet(".ke-color-panel a {display: block;color:black;text-decoration: none;}.ke-color-panel a:hover {color:black;text-decoration: none;}.ke-color-panel a:active {color:black;}.ke-color-palette {    margin: 5px 8px 8px;}.ke-color-palette table {    border: 1px solid #666666;    border-collapse: collapse;}.ke-color-palette td {    border-right: 1px solid #666666;    height: 18px;    width: 18px;}a.ke-color-a {    height: 18px;    width: 18px;}a.ke-color-a:hover {    border: 1px solid #ffffff;    height: 16px;    width: 16px;}a.ke-color-remove {  padding:3px 8px;  margin:2px 0 3px 0;}a.ke-color-remove:hover {    background-color: #D6E9F8;}","ke-color-plugin");var f=[["000","444","666","999","CCC","EEE","F3F3F3","FFF"],["F00","F90","FF0","0F0","0FF","00F","90F","F0F"],["F4CCCC","FCE5CD","FFF2CC","D9EAD3","D0E0E3","CFE2F3","D9D2E9","EAD1DC","EA9999","F9CB9C","FFE599","B6D7A8","A2C4C9","9FC5E8","B4A7D6","D5A6BD","E06666","F6B26B","FFD966","93C47D","76A5AF","6FA8DC","8E7CC3","C27BAD","CC0000","E69138","F1C232","6AA84F","45818E","3D85C6","674EA7","A64D79","990000","B45F06","BF9000","38761D","134F5C","0B5394","351C75","741B47","660000","783F04","7F6000","274E13","0C343D","073763","20124D","4C1130"]],g,i=b.Utils.addRes,j=b.Utils.destroyRes;b.ColorSupport={offClick:function(a){var c=this,d=c.cfg;b.use("overlay",function(){d._prepare.call(c,a)})},onClick:function(){this.colorWin&&this.colorWin.hide()},_prepare:function(){var a=this,c=a.cfg,e=document,f=a.btn,j=a.editor,k;h(),a.colorWin=new b.Overlay({elCls:"ks-popup",content:g,focus4e:!1,autoRender:!0,width:"170px",zIndex:b.baseZIndex(b.zIndexManager.POPUP_MENU)});var l=a.colorWin;k=l.get("contentEl"),k.on("click",c._selectColor,a),d.on(e,"click",c._hidePanel,a),d.on(j.document,"click",c._hidePanel,a),l.on("show",f.bon,f),l.on("hide",f.boff,f);var m=k.one(".ke-color-others");m.on("click",function(b){b.halt(),l.hide(),j.showDialog("color/dialog",[a])}),c._prepare=c._show,c._show.call(a),i.call(a,k,l,m)},_show:function(){var a=this,b=a.btn.get("el"),c=a.colorWin,d=parseInt(c.get("width")),f=30,g=e.viewportWidth();c.align(b,["bl","tl"],[0,2]),c.get("x")+d>g-f&&c.set("x",g-f-d),c.show()},_hidePanel:function(a){var b=this,d=b.btn.get("el"),e=new c(a.target),f=b.colorWin;if(d._4e_equals(e)||d.contains(e))return;f.hide()},_selectColor:function(a){a.halt();var b=this,d=b.cfg,e=new c(a.target);e._4e_name()=="a"&&!e.hasClass("ke-button")&&(d._applyColor.call(b,e._4e_style("background-color")),b.colorWin.hide())},_applyColor:function(a){var c=this,d=c.editor,e=d.document,f=c.cfg.styles;d.fire("save"),a?(new b.Style(f,{color:a})).apply(e):(new b.Style(f,{color:"inherit"})).remove(e),d.fire("save")},destroy:function(){j.call(this);var a=this,b=a.editor,c=a.cfg,e=document;d.remove(e,"click",c._hidePanel,a),b.destroyDialog("color/dialog")}}},{attach:!1}),KISSY.Editor.add("contextmenu",function(){function g(a){this.cfg=a,b.Utils.lazyRun(this,"_prepareShow","_realShow")}function i(b,e){for(var f=0;f<e.length;f++){var g=e[f];if(a.isFunction(g)){if(g(new c(b)))return!0}else if(d.test(b,g))return!0}return!1}var a=KISSY,b=a.Editor,c=a.Node,d=a.DOM,e=a.Event,f="<div>";if(b.ContextMenu){a.log("attach ContextMenu twice","warn");return}g.ATTRS={editor:{}};var h=[];g.register=function(a){var d=new g(a),f=a.editor,j=f.document;return h.push({doc:j,rules:a.rules||[],instance:d}),j.ke_contextmenu||(j.ke_contextmenu=1,e.on(j,"mousedown",g.hide),f.on("sourcemode",g.hide,j),e.on(j.body,"contextmenu",function(a){g.hide.call(this);var d=new c(a.target);while(d){var e=d._4e_name(),f=!1;if(e=="body")break;for(var k=0;k<h.length;k++){var l=h[k].instance,m=h[k].rules,n=h[k].doc;if(j===n&&i(d[0],m)){a.preventDefault(),f=!0;var o=a.pageX,p=a.pageY;if(!o){var q=d._4e_getOffset();o=q.left,p=q.top}setTimeout(function(){l.show(b.Utils.getXY(o,p,j,document))},30);break}}if(f)break;d=d.parent()}})),d},g.hide=function(){var a=this;for(var b=0;b<h.length;b++){var c=h[b].instance,d=h[b].doc;a===d&&c.hide()}};var j=b.Overlay;a.augment(g,{_init:function(){var a=this,b=a.cfg,d=b.funcs;a.el=new j({content:f,autoRender:!0,width:b.width,elCls:"ke-menu"}),a.elDom=a.el.get("contentEl").one("div");var e=a.elDom;for(var g in d){var h=new c("<a href='#'>"+g+"</a>");e[0].appendChild(h[0]),function(b,c){b._4e_unselectable(),b.on("click",function(d){d.halt();if(b.hasClass("ke-menuitem-disable"))return;a.hide(),setTimeout(c,30)})}(h,d[g])}},destroy:function(){var a=this;a.el&&(a.elDom.children().detach(),a.el.destroy())},hide:function(){this.el&&this.el.hide()},_realShow:function(d){var e=this;b.fire("contextmenu",{contextmenu:e}),this.el.set("xy",[d.left,d.top]);var f=e.cfg,g=f.statusChecker;if(g){var h=e.elDom.children("a");for(var i=0;i<h.length;i++){var j=new c(h[i]),k=g[a.trim(j.text())];k&&(k(f.editor)?j.removeClass("ke-menuitem-disable"):j.addClass("ke-menuitem-disable"))}}this.el.show()},_prepareShow:function(){this._init()},show:function(a){this._prepareShow(a)}}),b.ContextMenu=g},{attach:!1,requires:["overlay"]}),KISSY.Editor.add("draft",function(a){var b=KISSY,c=b.Editor;a.addPlugin("draft",function(){var b=this;c.use("draft/support",function(){c.storeReady(function(){var d=new c.Draft(a);b.destroy=function(){d.destroy()}})})})},{attach:!1}),KISSY.Editor.add("draft/support",function(){function i(a,b,c){a+="";while(a.length<b)a=c+a;return a}function j(b){return a.isNumber(b)&&(b=new Date(b)),b instanceof Date?[b.getFullYear(),"-",i(b.getMonth()+1,2,"0"),"-",i(b.getDate(),2,"0")," ",i(b.getHours(),2,"0"),":",i(b.getMinutes(),2,"0"),":",i(b.getSeconds(),2,"0")].join(""):b}function k(a){this.editor=a,this._init()}var a=KISSY,b=a.Editor,c=a.Node,d=5,e=a.Event,f=5,g=a.JSON,h="ke-draft-save20110503",l=b.Utils.addRes,m=b.Utils.destroyRes;a.augment(k,{_getSaveKey:function(){var a=this,b=a.editor,c=b.cfg.pluginConfig;return c.draft&&c.draft.saveKey||h},_getDrafts:function(){var a=b.localStorage,c=this;if(!c.drafts){var d=a.getItem(c._getSaveKey()),e=[];d&&(e=a==window.localStorage?g.parse(decodeURIComponent(d)):d),c.drafts=e}return c.drafts},_init:function(){var a=this,g=a.editor,h=g.statusDiv,i=g.cfg.pluginConfig;i.draft=i.draft||{},a.draftInterval=i.draft.interval=i.draft.interval||f,a.draftLimit=i.draft.limit=i.draft.limit||d;var j=(new c("<div class='ke-draft'><span class='ke-draft-title'>\u5185\u5bb9\u6b63\u6587\u6bcf"+i.draft.interval+"\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002"+"</span>"+"</div>")).appendTo(h);a.timeTip=(new c("<span class='ke-draft-time'/>")).appendTo(j);var k=(new c("<a href='#' onclick='return false;' class='ke-button ke-draft-save-btn' style='vertical-align:middle;padding:1px 9px;'><span class='ke-draft-mansave'></span><span>\u7acb\u5373\u4fdd\u5b58</span></a>")).appendTo(j),m=new b.Select({container:j,menuContainer:document.body,doc:g.document,width:"85px",popUpWidth:"225px",align:["r","t"],emptyText:"&nbsp;&nbsp;&nbsp;\u5c1a\u65e0\u7f16\u8f91\u5668\u5386\u53f2\u5b58\u5728",title:"\u6062\u590d\u7f16\u8f91\u5386\u53f2"});a.versions=m,m.on("select",function(){m.detach("select",arguments.callee),a.sync()}),k._4e_unselectable(),k.on("click",function(b){a.save(!1),b.halt()}),l.call(a,k),g.textarea[0].form&&function(){function d(){a.save(!0)}var b=g.textarea,c=b[0].form;e.on(c,"submit",d),l.call(a,function(){e.remove(c,"submit",d)})}();var n=setInterval(function(){a.save(!0)},a.draftInterval*60*1e3);l.call(a,function(){clearInterval(n)}),m.on("click",a.recover,a),l.call(a,m),a.holder=j;if(i.draft.helpHtml){var o=new b.TripleButton({elCls:"ke-draft-help",title:"\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9",text:"\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9",render:j});o.render(),o.on("click",function(b){a._help&&a._help.get("visible")?a._help.hide():a._prepareHelp(),b&&b.halt()}),l.call(a,o),b.Utils.lazyRun(a,"_prepareHelp","_realHelp"),a.helpBtn=o.get("el")}l.call(a,j)},_prepareHelp:function(){function m(a){a&&a.halt();var d=new c(a.target);if(d[0]==h[0]||h.contains(d))return;b._help.hide()}var b=this,d=b.editor,f=d.cfg.pluginConfig,g=f.draft,h=b.helpBtn,i=new c(g.helpHtml||""),j="height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;",k=new c("<div style='"+j+"border-top-color:#CED5E0;"+"'>"+"<div style='"+j+"left:-8px;"+"top:-10px;"+"border-top-color:white;"+"'>"+"</div>"+"</div>");i.append(k),i.css({border:"1px solid #ACB4BE","text-align":"left"}),b._help=new a.Overlay({content:i,autoRender:!0,width:i.width()+"px",mask:!1}),b._help.get("el").css("border","none"),b._help.arrow=k,e.on([document,d.document],"click",m),l.call(b,b._help,function(){e.remove([document,d.document],"click",m)})},_realHelp:function(){var a=this._help,b=this.helpBtn,c=a.arrow;a.show();var d=b.offset();a.get("el").offset({left:d.left-a.get("el").width()+17,top:d.top-a.get("el").height()-7}),c.offset({left:d.left-2,top:d.top-8})},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var a=b.localStorage,c=this,d=c.draftLimit,e=c.timeTip,f=c.versions,h=c._getDrafts();h.length>d&&h.splice(0,h.length-d);var i=[],k,l;for(var m=0;m<h.length;m++)k=h[m],l=(k.auto?"\u81ea\u52a8":"\u624b\u52a8")+"\u4fdd\u5b58\u4e8e : "+j(k.date),i.push({name:l,value:m});f.set("items",i.reverse()),e.html(l),a.setItem(c._getSaveKey(),a==window.localStorage?encodeURIComponent(g.stringify(h)):h)},save:function(a){var b=this,c=b._getDrafts(),d=b.editor,e=d.getData(!0);if(!e)return;c[c.length-1]&&e==c[c.length-1].content&&(c.length-=1),b.drafts=c.concat({content:e,date:(new Date).getTime(),auto:a}),b.sync()},recover:function(a){var b=this,c=b.editor,d=b.versions,e=b._getDrafts(),f=a.newVal;d.reset("value"),confirm("\u786e\u8ba4\u6062\u590d "+j(e[f].date)+" \u7684\u7f16\u8f91\u5386\u53f2\uff1f")&&(c.fire("save"),c.setData(e[f].content),c.fire("save")),a&&a.halt()},destroy:function(){m.call(this)}}),b.Draft=k},{attach:!1,requires:["localstorage"]}),KISSY.Editor.add("dragupload",function(a){function r(a){var b=a.originalEvent,c=b.target;g._4e_name(c)=="img"&&c.src.match(/^file:\/\//)&&(p[c.src]=c)}function s(a,d){var e=new window.FileReader;e.onload=function(f){var g=a.name,h=f.target.result,j="----kissy-editor-2.1",m=new XMLHttpRequest;m.open("POST",l,!0),m.onreadystatechange=function(){if(m.readyState==4){if(m.status==200||m.status==304){if(m.responseText!=""){var a=window.JSON.parse(m.responseText);d[0].src=a.imgUrl}}else alert("\u670d\u52a1\u5668\u7aef\u51fa\u9519\uff01"),d._4e_remove(),b.log(m);m.onreadystatechange=null}};var n="\r\n--"+j+"\r\n";n+='Content-Disposition: form-data; name="'+i+'"; filename="'+encodeURIComponent(g)+'"\r\n',n+="Content-Type: "+(a.type||"application/octet-stream")+"\r\n\r\n",n+=h+"\r\n",k=c.Utils.normParams(k);for(var o in k)k.hasOwnProperty(o)&&(n+="--"+j+"\r\n",n+='Content-Disposition: form-data; name="'+o+'"\r\n\r\n',n+=k[o]+"\r\n");n+="--"+j+"--",m.setRequestHeader("Content-Type","multipart/form-data, boundary="+j),m.sendAsBinary("Content-Type: multipart/form-data; boundary="+j+"\r\nContent-Length: "+n.length+"\r\n"+n+"\r\n"),e.onload=null},e.readAsBinaryString(a)}var b=KISSY,c=b.Editor,d=b.Node,e=b.Event,f=b.UA,g=b.DOM,h=a.cfg.pluginConfig.dragupload||{},i=h.fileInput||"Filedata",j=h.sizeLimit||Number.MAX_VALUE,k=h.serverParams||{},l=h.serverUrl||"",m=h.suffix||"png,jpg,jpeg,gif",n=new RegExp(m.split(/,/).join("|")+"$","i"),o=a.document;if(f.ie)return;var p={},q=!1;e.on(o,"dragenter",function(){q||(e.on(o,"DOMNodeInserted",r),q=!0)}),e.on(o,"drop",function(a){e.remove(o,"DOMNodeInserted",r),q=!1,a.halt(),a=a.originalEvent,b.log(a);var f,h;b.isEmptyObject(p)?(h=o.elementFromPoint(a.clientX,a.clientY),f=h.lastChild):(b.each(p,function(a){g._4e_name(a)=="img"&&(f=a.nextSibling,h=a.parentNode,g._4e_remove(a))}),p={});var i=a.dataTransfer;i.dropEffect="copy";var k=i.files;if(!k)return;for(var l=0;l<k.length;l++){var m=k[l],t=m.name,u=m.size;if(!t.match(n))continue;if(u/1e3>j)continue;var v=new d("<img src='"+(c.Config.base+"../theme/loading.gif")+"'"+"/>"),w=v[0];h.insertBefore(w,f);var x=w.parentNode,y=g._4e_name(x);(y=="head"||y=="html")&&g.insertBefore(w,o.body.firstChild),s(m,v)}}),window.XMLHttpRequest&&!XMLHttpRequest.prototype.sendAsBinary&&(XMLHttpRequest.prototype.sendAsBinary=function(a,b){var c=new(window.BlobBuilder||window.WebKitBlobBuilder),d=a.length,e=new window.Uint8Array(d);for(var f=0;f<d;f++)e[f]=a.charCodeAt(f);c.append(e.buffer),this.send(c.getBlob(b))})},{attach:!1}),KISSY.Editor.add("elementpaths",function(a){var b=KISSY.Editor,c=KISSY,d=c.Node,e=c.DOM;b.ElementPaths||function(){function a(a){this.cfg=a,this._cache=[],this._init()}e.addStyleSheet(".elementpath {   padding: 0 5px;    text-decoration: none;}.elementpath:hover {    background: #CCFFFF;    text-decoration: none;}","ke-ElementPaths"),c.augment(a,{_init:function(){var a=this,c=a.cfg,e=c.editor;a.holder=new d("<span>"),a.holder.appendTo(e.statusDiv),e.on("selectionChange",a._selectionChange,a),b.Utils.sourceDisable(e,a)},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},_selectionChange:function(a){var b=this,c=b.cfg,e=c.editor,f=b.holder,g=a.path,h=g.elements,i,j,k=b._cache;for(j=0;j<k.length;j++)k[j].detach("click"),k[j]._4e_remove();b._cache=[];for(j=0;j<h.length;j++){i=h[j];var l=new d("<a href='#' class='elementpath'>"+(i.attr("_ke_real_element_type")||i._4e_name())+"</a>");b._cache.push(l),function(a){l.on("click",function(b){b.halt(),e.focus(),setTimeout(function(){e.getSelection().selectElement(a)},50)})}(i),f.prepend(l)}},destroy:function(){this.holder.remove()}}),b.ElementPaths=a}(),a.addPlugin("elementpaths",function(){var c=new b.ElementPaths({editor:a});this.destroy=function(){c.destroy()}})},{attach:!1}),KISSY.Editor.add("enterkey",function(a){var b=KISSY,c=b.Editor,d=b.UA,e=/^h[1-6]$/,f=c.XHTML_DTD,g=b.Node,h=b.Event,i=c.Walker,j=c.ElementPath;c.enterBlock||function(){function a(a){var b=a.getSelection().getRanges();for(var c=b.length-1;c>0;c--)b[c].deleteContents();return b[0]}function k(c){var h=a(c),k=h.document;if(h.checkStartOfBlock()&&h.checkEndOfBlock()){var l=new j(h.startContainer),m=l.block;if(m&&(m._4e_name()=="li"||m.parent()._4e_name()=="li"))return c.hasCommand("outdent")?(c.fire("save"),c.execCommand("outdent"),c.fire("save"),!0):!1}var n="p",o=h.splitBlock(n);if(!o)return!0;var p=o.previousBlock,q=o.nextBlock,r=o.wasStartOfBlock,s=o.wasEndOfBlock,t;q?(t=q.parent(),t._4e_name()=="li"&&(q._4e_breakParent(t),q._4e_move(q._4e_next(),!0))):p&&(t=p.parent())&&t._4e_name()=="li"&&(p._4e_breakParent(t),h.moveToElementEditablePosition(p._4e_next()),p._4e_move(p._4e_previous()));if(!r&&!s)q._4e_name()=="li"&&(t=q._4e_first(i.invisible(!0)))&&b.inArray(t._4e_name(),["ul","ol"])&&(d.ie?new g(k.createTextNode("\u00a0")):new g(k.createElement("br"))).insertBefore(t),q&&h.moveToElementEditablePosition(q);else{var u;if(p){if(p._4e_name()=="li"||!e.test(p._4e_name()))u=p._4e_clone()}else q&&(u=q._4e_clone());u||(u=new g("<"+n+">",null,k));var v=o.elementPath;if(v)for(var w=0,x=v.elements.length;w<x;w++){var y=v.elements[w];if(y._4e_equals(v.block)||y._4e_equals(v.blockLimit))break;f.$removeEmpty[y._4e_name()]&&(y=y._4e_clone(),u._4e_moveChildren(y),u.append(y))}d.ie||u._4e_appendBogus(),h.insertNode(u),d.ie&&r&&(!s||!p[0].childNodes.length)&&(h.moveToElementEditablePosition(s?p:u),h.select()),h.moveToElementEditablePosition(r&&!s?q:u)}if(!d.ie)if(q){var z=new g(k.createElement("span"));z.html("&nbsp;"),h.insertNode(z),z._4e_scrollIntoView(),h.deleteContents()}else u._4e_scrollIntoView();return h.select(),!0}function l(a){var b=a.document;h.on(b,"keydown",function(b){var c=b.keyCode;if(c===13&&!b.shiftKey){a.fire("save");var d=a.execCommand("enterBlock");a.fire("save"),d!==!1&&b.preventDefault()}})}l.enterBlock=k,c.EnterKey=l}(),a.addCommand("enterBlock",{exec:c.EnterKey.enterBlock}),c.EnterKey(a)},{attach:!1}),KISSY.Editor.add("fakeobjects",function(a){var b=KISSY.Editor,c=KISSY,d=c.Node,e=b.NODE,f=b.Config.base+"../theme/spacer.gif",g=b.HtmlParser,h=c.Editor,i=a.htmlDataProcessor,j=i&&i.htmlFilter,k={elements:{$:function(a){var b=a.attributes,c=b&&b._ke_realelement,d=c&&new g.Fragment.FromHtml(decodeURIComponent(c)),e=d&&d.children[0];if(e&&a.attributes._ke_resizable){var f=a.attributes.style;if(f){var h=/(?:^|\s)width\s*:\s*(\d+)/i.exec(f),i=h&&h[1];h=/(?:^|\s)height\s*:\s*(\d+)/i.exec(f);var j=h&&h[1];i&&(e.attributes.width=i),j&&(e.attributes.height=j)}}return e}}};j&&j.addRules(k),i&&c.mix(i,{createFakeParserElement:function(a,b,d,e,h){var i,j=new g.BasicWriter;a.writeHtml(j),i=j.getHtml();var k=a.attributes.style||"";a.attributes.width&&(k="width:"+a.attributes.width+"px;"+k),a.attributes.height&&(k="height:"+a.attributes.height+"px;"+k);var l=c.trim(a.attributes["class"]),m={"class":b+" "+l,src:f,_ke_realelement:encodeURIComponent(i),_ke_real_node_type:a.type,style:k,align:a.attributes.align||""};return h&&delete h.width,h&&delete h.height,h&&c.mix(m,h,!1),d&&(m._ke_real_element_type=d),e&&(m._ke_resizable=e),new g.Element("img",m)}}),a.createFakeElement||c.augment(h,{createFakeElement:function(a,b,e,g,h,i){var j=a.attr("style")||"";a.attr("width")&&(j="width:"+a.attr("width")+"px;"+j),a.attr("height")&&(j="height:"+a.attr("height")+"px;"+j);var k=this,l=c.trim(a.attr("class")),m={"class":b+" "+l,src:f,_ke_realelement:encodeURIComponent(h||a._4e_outerHtml()),_ke_real_node_type:a[0].nodeType,style:j};return i&&delete i.width,i&&delete i.height,i&&c.mix(m,i,!1),e&&(m._ke_real_element_type=e),g&&(m._ke_resizable=g),new d("<img/>",m,k.document)},restoreRealElement:function(a){if(a.attr("_ke_real_node_type")!=e.NODE_ELEMENT)return null;var b=decodeURIComponent(a.attr("_ke_realelement")),c=new d("<div>",null,this.document);return c.html(b),c._4e_first(function(a){return a[0].nodeType==e.NODE_ELEMENT})._4e_remove()}})},{attach:!1,requires:["htmldataprocessor"]}),KISSY.Editor.add("flash",function(a){var b=KISSY,c=b.Editor,d="ke_flash",e="flash",f=a.htmlDataProcessor,g=a.cfg.pluginConfig,h=f&&f.dataFilter;h&&h.addRules({elements:{object:function(a){var b=a.attributes,g,h=b.classid&&String(b.classid).toLowerCase();if(!h){for(g=0;g<a.children.length;g++)if(a.children[g].name=="embed")return c.Utils.isFlashEmbed(a.children[g])?f.createFakeParserElement(a,d,e,!0):null;return null}return f.createFakeParserElement(a,d,e,!0)},embed:function(a){return c.Utils.isFlashEmbed(a)?f.createFakeParserElement(a,d,e,!0):null}}},5),a.addPlugin("flash",function(){var b;if(!g.flash||g.flash.btn!==!1)b=a.addButton("flash",{contentCls:"ke-toolbar-flash",title:"\u63d2\u5165Flash",mode:c.WYSIWYG_MODE,loading:!0});c.use("flash/support",function(){var d=new c.Flash(a);b&&b.reload({offClick:function(){d.show()},destroy:function(){d.destroy()}})}),this.destroy=function(){b.destroy()}})},{attach:!1,requires:["fakeobjects"]}),KISSY.Editor.add("flash/support",function(){function k(a){var b=this;b.editor=a,b._init()}function m(a){return a._4e_name()==="img"&&!!a.hasClass(h)&&a}var a=KISSY,b=a.Editor,c=a.UA,d=a.Event,e=b.ContextMenu,f=a.Node,g=b.BubbleView,h="ke_flash",i="flash",j=b.Utils.flash;a.augment(k,{_config:function(){var a=this;a._cls=h,a._type=i,a._contextMenu=n,a._flashRules=["img."+h]},_init:function(){this._config();var a=this,b=a.editor,c={},f=a._contextMenu;if(f)for(var h in f)(function(b){c[b]=function(){f[b](a)}})(h);a._contextMenu=e.register({editor:b,rules:a._flashRules,width:"120px",funcs:c}),g.attach({pluginName:a._type,editor:a.editor,pluginContext:a}),d.on(b.document,"dblclick",a._dbclick,a)},_getFlashUrl:function(a){return j.getUrl(a)},_updateTip:function(a,b){var c=this,d=c.editor,e=d.restoreRealElement(b);if(!e)return;var f=c._getFlashUrl(e);a.html(f),a.attr("href",f)},_dbclick:function(a){var b=this,c=new f(a.target);c._4e_name()==="img"&&c.hasClass(b._cls)&&(b.show(null,c),a.halt())},show:function(a,b){var c=this,d=c.editor;d.showDialog(c._type+"/dialog",[b])},destroy:function(){var a=this,b=a.editor;a._contextMenu.destroy(),g.destroy(a._type),d.remove(b.document,"dblclick",a._dbclick,a),b.destroyDialog(a._type+"/dialog")}}),b.Flash=k;var l=' <a class="ke-bubbleview-url" target="_blank" href="#"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>';k.registerBubble=function(a,d,e){g.register({pluginName:a,func:e,init:function(){var a=this,e=a.get("contentEl");e.html(d+l);var f=e.one(".ke-bubbleview-url"),g=e.one(".ke-bubbleview-change"),h=e.one(".ke-bubbleview-remove");b.Utils.preventFocus(e),g.on("click",function(b){a._plugin.show(null,a._selectedEl),b.halt()}),h.on("click",function(b){var d=a._plugin;if(c.webkit){var e=d.editor.getSelection().getRanges();e&&e[0]&&(e[0].collapse(!0)||!0)&&e[0].select()}a._selectedEl._4e_remove(),a.hide(),d.editor.notifySelectionChange(),b.halt()}),b.Utils.addRes.call(a,g,h),a.on("show",function(){var b=a._selectedEl,c=a._plugin;if(!b)return;c._updateTip(f,b)})}})},k.registerBubble("flash","Flash \u7f51\u5740\uff1a ",m),k.checkFlash=m;var n={"Flash\u5c5e\u6027":function(a){var b=a.editor,c=b.getSelection(),d=c&&c.getStartElement(),e=m(d);e&&a.show(null,e)}};k.CLS_FLASH=h,k.TYPE_FLASH=i,k.Insert=function(a,b,c,d,e,f){var g=j.createSWF(b,{attrs:c},a.document),h=g.el,i=a.createFakeElement?a.createFakeElement(h,d||"ke_flash",e||"flash",!0,g.html,c):h;a.insertElement(i,null,f)},b.Flash=k},{attach:!1,requires:["bubbleview","contextmenu","flashutils"]}),KISSY.Editor.add("flashbridge",function(){function d(a){this._init(a)}function i(){var a,b="ShockwaveFlash";if(navigator.plugins&&navigator.mimeTypes.length)a=(navigator.plugins["Shockwave Flash"]||{}).description;else if(window.ActiveXObject)try{a=(new ActiveXObject(b+"."+b)).GetVariable("$version")}catch(c){}return a?j(a):undefined}function j(a){return a.match(/(\d)+/g)}function k(b){var c=a.isString(b)?j(b):b,d=b;return a.isArray(c)&&(d=parseFloat(c[0]+"."+l(c[1],3)+l(c[2],5))),d||0}function l(a,b){var c=(a+"").length;while(c++<b)a="0"+a;return a}var a=KISSY,b=a.Editor;if(b.FlashBridge){a.log("KE.FlashBridge attach more","warn");return}var c={};a.augment(d,a.EventTarget,{_init:function(d){var e=this,f=a.guid("flashbridge-"),g="KISSY.Editor.FlashBridge.EventHandler";d.flashVars=d.flashVars||{},d.attrs=d.attrs||{},d.params=d.params||{};var h=d.flashVars,i=d.attrs,j=d.params;a.mix(i,{id:f,width:"100%",height:"100%"},!1),a.mix(j,{allowScriptAccess:"always",allowNetworking:"all",scale:"noScale"},!1),a.mix(h,{shareData:!1,useCompression:!1},!1);var k={YUISwfId:f,YUIBridgeCallback:g};d.ajbridge&&(k={swfID:f,jsEntry:g}),a.mix(h,k),c[f]=e,e.id=f,e.swf=b.Utils.flash.createSWFRuntime(d.movie,d),e._expose(d.methods)},_expose:function(b){var c=this;for(var d=0;d<b.length;d++){var e=b[d];(function(b){c[b]=function(){return c._callSWF(b,a.makeArray(arguments))}})(e)}},_callSWF:function(a,b){var c=this;b=b||[];try{if(c.swf[a])return c.swf[a].apply(c.swf,b)}catch(d){var e="";return b.length!==0&&(e="'"+b.join("', '")+"'"),(new Function("self","return self.swf."+a+"("+e+");"))(c)}},_eventHandler:function(b){var c=this,d=b.type;d==="log"?a.log(b.message):d&&c.fire(d,b)},_destroy:function(){delete c[this.id]}}),d.EventHandler=function(b,d){a.log("flash fire event : "+d.type);var e=c[b];e&&setTimeout(function(){e._eventHandler.call(e,d)},100)},b.FlashBridge=d;var e=a.UA,f,g,h=!0;e.fpv=function(a){if(a||h)h=!1,f=i(),g=k(f);return f},e.fpvGEQ=function(a,b){return h&&e.fpv(b),!!g&&g>=k(a)}},{attach:!1}),KISSY.Editor.add("flashutils",function(){var a=KISSY,b=a.Editor,c=b.Utils.flash;if(c){a.log("flashUtils attach more");return}var d=a.DOM,e=a.Node,f=a.UA;c={getUrl:function(a){var c="",e=b.NODE;if(a._4e_name()=="object"){var f=a[0].childNodes;for(var g=0;g<f.length;g++){if(f[g].nodeType!=e.NODE_ELEMENT)continue;(d.attr(f[g],"name")||"").toLowerCase()=="movie"?c=d.attr(f[g],"value"):d._4e_name(f[g])=="embed"?c=d.attr(f[g],"src"):d._4e_name(f[g])=="object"&&(c=d.attr(f[g],"data"))}}else a._4e_name()=="embed"&&(c=a.attr("src"));return c},createSWF:function(b,c,d){var f=c.attrs||{},g=c.flashVars,h="",i="",j=c.params||{},k="";d=d||document,a.mix(f,{wmode:"transparent"});for(var l in f)f.hasOwnProperty(l)&&(h+=l+"='"+f[l]+"' ");a.mix(j,{quality:"high",movie:b,wmode:"transparent"});for(var m in j)j.hasOwnProperty(m)&&(i+="<param name='"+m+"' value='"+j[m]+"'/>");if(g){for(var n in g)g.hasOwnProperty(n)&&(k+="&"+n+"="+encodeURIComponent(g[n]));k=k.substring(1)}var o="<object "+h+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" >'+i+(k?'<param name="flashVars" value="'+k+'"/>':"")+"<embed "+h+" "+(k?'FlashVars="'+k+'"':"")+' pluginspage="http://www.macromedia.com/go/getflashplayer" '+' quality="high" '+' src="'+b+'" '+' type="application/x-shockwave-flash"/>'+"</object>";return{el:new e(o,null,d),html:o}},createSWFRuntime2:function(a,b,d){d=d||document;var g=(new e("<div style='width:0;height:0;overflow:hidden;'>",null,d)).appendTo(d.body),h=c.createSWF.apply(this,arguments).el.appendTo(g);return f.ie||(h=h.one("object")),h[0]},createSWFRuntime:function(b,c,g){var h=c.attrs||{},i=c.flashVars||{},j=c.params||{},k="",l="",m="";g=g||document,h.id=h.id||a.guid("ke-runtimeflash-");for(var n in h)h.hasOwnProperty(n)&&(k+=n+"='"+h[n]+"' ");for(var o in j)j.hasOwnProperty(o)&&(l+="<param name='"+o+"' value='"+j[o]+"'/>");for(var p in i)i.hasOwnProperty(p)&&(m+="&"+p+"="+encodeURIComponent(i[p]));m=m.substring(1);if(f.ie)var q="<object "+k+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" >'+l+'<param name="movie" value="'+b+'" />'+(m?'<param name="flashVars" value="'+m+'" />':"")+"</object>";else q="<object type='application/x-shockwave-flash' data='"+b+"'"+" "+k+">"+l+(m?'<param name="flashVars" value="'+m+'"/>':"")+"</object>";var r=c.holder;return r||(r=(new e("<div style='"+(c.style?c.style:"width:1px;height:1px;position:absolute;NaN")+"'>",null,g)).appendTo(g.body),setTimeout(function(){r.offset({left:d.scrollLeft(),top:d.scrollTop()})},100)),r.html(q),g.getElementById(h.id)}},b.Utils.flash=c},{attach:!1}),KISSY.Editor.add("font",function(a){a.addPlugin("font",function(){function b(a){var b=[];for(var c=0;c<a.length;c++)b.push({name:a[c],value:a[c]});return b}var c=KISSY,d=c.Editor,e=d.Style,f=d.TripleButton,g=a.cfg.pluginConfig,h=g["font-size"],i,j,k,l=[];if(h!==!1){h=h||{},c.mix(h,{items:b(["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px"]),width:"55px"},!1);var m={},n=[],o={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]};for(u=0;u<h.items.length;u++){i=h.items[u],j=i.name,k=i.attrs;var p=i.value;m[p]=new e(o,{size:p}),n.push({name:j,value:p,attrs:k})}g["font-size"]=h}var q=g["font-family"];if(q!==!1){q=q||{},c.mix(q,{items:[{name:"\u5b8b\u4f53",value:"SimSun"},{name:"\u9ed1\u4f53",value:"SimHei"},{name:"\u96b6\u4e66",value:"LiSu"},{name:"\u6977\u4f53",value:"KaiTi_GB2312"},{name:"\u5fae\u8f6f\u96c5\u9ed1",value:"Microsoft YaHei"},{name:"Georgia",value:"Georgia"},{name:"Times New Roman",value:"Times New Roman"},{name:"Impact",value:"Impact"},{name:"Courier New",value:"Courier New"},{name:"Arial",value:"Arial"},{name:"Verdana",value:"Verdana"},{name:"Tahoma",value:"Tahoma"}],width:"130px"},!1);var r={},s=[],t={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},u;g["font-family"]=q;for(u=0;u<q.items.length;u++){i=q.items[u],j=i.name,k=i.attrs||{};var v=i.value;k.style=k.style||"",k.style+=";font-family:"+v,r[v]=new e(t,{family:v}),s.push({name:j,value:v,attrs:k})}}var w={click:function(b){var c=this,d=b.newVal,e=b.prevVal,f=c.cfg.styles;a.focus(),a.fire("save");var g=f[d];d==e?(g.remove(a.document),c.btn.set("value","")):g.apply(a.document),a.fire("save")},selectionChange:function(a){var b=this,c=a.path,d=c.elements,e=b.cfg.styles;for(var f=0,g;f<d.length;f++){g=d[f];for(var h in e)if(e[h].checkElementRemovable(g,!0)){b.btn.set("value",h);return}}b.btn.reset("value")}};!1!==g["font-size"]&&l.push(a.addSelect("font-size",c.mix({title:"\u5927\u5c0f",width:"30px",mode:d.WYSIWYG_MODE,showValue:!0,popUpWidth:h.width,items:n,styles:m},w))),!1!==g["font-family"]&&l.push(a.addSelect("font-family",c.mix({title:"\u5b57\u4f53",width:"110px",mode:d.WYSIWYG_MODE,popUpWidth:q.width,items:s,styles:r},w)));var x={mode:d.WYSIWYG_MODE,offClick:function(){var a=this,b=a.editor,c=a.cfg.style;b.fire("save"),c.apply(b.document),b.fire("save"),b.notifySelectionChange(),b.focus()},onClick:function(){var a=this,b=a.editor,c=a.cfg.style;b.fire("save"),c.remove(b.document),b.fire("save"),b.notifySelectionChange(),b.focus()},selectionChange:function(a){var b=this,c=b.cfg.style,d=b.btn,e=a.path;c.checkActive(e)?d.set("state",f.ON):d.set("state",f.OFF)}};!1!==g["font-bold"]&&l.push(a.addButton("font-bold",c.mix({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",style:new e({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})},x))),!1!==g["font-italic"]&&l.push(a.addButton("font-italic",c.mix({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",style:new e({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})},x))),!1!==g["font-underline"]&&l.push(a.addButton("font-underline",c.mix({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",style:new e({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})},x)));if(!1!==g["font-strikeThrough"]){var y=(g["font-strikeThrough"]||{}).style||{element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"},{element:"strike"}]};l.push(a.addButton("font-underline",c.mix({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",style:new e(y)},x)))}this.destroy=function(){for(var a=0;a<l.length;a++){var b=l[a];b.destroy()}}})},{attach:!1}),KISSY.Editor.add("format",function(a){a.addPlugin("format",function(){var b=KISSY,c=b.Editor,d=[],e={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},f={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},g={},h=c.Style;for(var i in e)e[i]&&(g[e[i]]=new h({element:e[i]}),d.push({name:i,value:e[i],attrs:{style:"font-size:"+f[e[i]]}}));var j=a.addSelect("font-family",{items:d,title:"\u6807\u9898",width:"100px",mode:c.WYSIWYG_MODE,popUpWidth:"120px",click:function(b){var c=this,d=b.newVal,e=b.prevVal;a.fire("save"),d!=e?g[d].apply(a.document):(g.p.apply(a.document),c.btn.set("value","p")),a.fire("save")},selectionChange:function(a){var b=this,c=a.path;for(var d in g)if(g[d].checkActive(c)){b.btn.set("value",d);return}}});this.destroy=function(){j.destroy()}})},{attach:!1}),KISSY.Editor.add("htmldataprocessor",function(a){function o(a){return a.replace(m,function(a,b,c){return"<"+b+c.replace(n,function(a,b){return c.indexOf("_ke_saved_"+b)==-1?" _ke_saved_"+a+" "+a:a})+">"})}var b=b,c=KISSY,d=c.Editor,e=c.Node,f=c.UA,g=d.NODE,h=d.HtmlParser,i=new h.Filter,j=new h.Filter,k=new h.Filter,l=d.XHTML_DTD;if(a.htmlDataProcessor)return;(function(){var a=d.HtmlParser.Fragment.prototype,b=d.HtmlParser.Element.prototype;a.onlyChild=b.onlyChild=function(){var a=this.children,b=a.length,c=b==1&&a[0];return c||null},b.removeAnyChildWithName=function(a){var b=this.children,c=[],d;for(var e=0;e<b.length;e++){d=b[e];if(!d.name)continue;d.name==a&&(c.push(d),b.splice(e--,1)),c=c.concat(d.removeAnyChildWithName(a))}return c},b.getAncestor=function(a){var b=this.parent;while(b&&(!b.name||!b.name.match(a)))b=b.parent;return b},a.firstChild=b.firstChild=function(a){var b;for(var c=0;c<this.children.length;c++){b=this.children[c];if(a(b))return b;if(b.name){b=b.firstChild(a);if(b)return b}}return null},b.addStyle=function(a,b,c){var d,e="";if(typeof b=="string")e+=a+":"+b+";";else{if(typeof a=="object")for(var f in a)a.hasOwnProperty(f)&&(e+=f+":"+a[f]+";");else e+=a;c=b}this.attributes||(this.attributes={}),d=this.attributes.style||"",d=(c?[e,d]:[d,e]).join(";"),this.attributes.style=d.replace(/^;|;(?=;)/,"")},l.parentOf=function(a){var b={};for(var c in this)c.indexOf("$")==-1&&this[c][a]&&(b[c]=1);return b}})(),function(){function e(a){var c=a.attributes&&a.attributes.style||"";return/mso-list\s*:\s*Ignore/i.test(c)?!0:b}function g(a,b){var c=new d.HtmlParser.Element("ke:listbullet"),e;return a?a[2]?(isNaN(a[1])?/^[a-z]+$/.test(a[1])?a="lower-alpha":/^[A-Z]+$/.test(a[1])?a="upper-alpha":a="decimal":a="decimal",e="ol"):(/[l\u00B7\u2002]/.test(a[1])?a="disc":/[\u006F\u00D8]/.test(a[1])?a="circle":/[\u006E\u25C6]/.test(a[1])?a="square":a="disc",e="ul"):(a="decimal",e="ol"),c.attributes={"ke:listtype":e,style:"list-style-type:"+a+";"},c.add(new d.HtmlParser.Text(b)),c}function h(a){var d=a.attributes,e;if((e=a.removeAnyChildWithName("ke:listbullet"))&&e.length&&(e=e[0])){a.name="ke:li",d.style&&(d.style=m([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(a){var b=a.split(" ");a=b[3]||b[1]||b[0],a=parseInt(a,10),!o&&q&&a>q&&(o=a-q),d["ke:margin"]=q=a}]],b)(d.style,a)||"");var f=e.attributes,g=f.style;return a.addStyle(g),c.mix(d,f),!0}return!1}function m(a,b){return function(c,d){var e=[];String(c).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(c,f,g){f=f.toLowerCase(),f=="font-family"&&(g=g.replace(/["']/g,""));var h,i,j,k;for(var l=0;l<a.length;l++)if(a[l]){h=a[l][0],i=a[l][1],j=a[l][2],k=a[l][3];if(f.match(h)&&(!i||g.match(i))){f=k||f,b&&(j=j||g),typeof j=="function"&&(j=j(g,d,f)),j&&j.push&&(f=j[0],j=j[1]),typeof j=="string"&&e.push([f,j]);return}}!b&&e.push([f,g])});for(var f=0;f<e.length;f++)e[f]=e[f].join(":");return e.length?e.join(";")+";":!1}}function n(a){var c=a.children,e,f,g,h,i,j,k,l;for(var n=0;n<c.length;n++){e=c[n];if("ke:li"==e.name){e.name="li",f=e,g=f.attributes,h=f.attributes["ke:listtype"],i=parseInt(g["ke:indent"],10)||o&&Math.ceil(g["ke:margin"]/o)||1,g.style&&(g.style=m([["list-style-type",h=="ol"?"decimal":"disc"]],b)(g.style)||"");if(!k)k=new d.HtmlParser.Element(h),k.add(f),c[n]=k;else{if(i>l)k=new d.HtmlParser.Element(h),k.add(f),j.add(k);else if(i<l){var p=l-i,q;while(p--&&(q=k.parent))k=q.parent;k.add(f)}else k.add(f);c.splice(n--,1)}j=f,l=i}else k=null}o=0}var a=m([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],b),o,q=0,r=l.parentOf("ol"),s={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren(),n(a)},elements:{p:function(a){a.filterChildren();if(h(a))return b},$:function(a){var b=a.name||"";if(b.indexOf(":")!=-1&&!/^ke/.test(b)){if(b=="v:imagedata"){var c=a.attributes["o:href"];c&&(a.attributes.src=a.attributes["o:href"],delete a.attributes["o:href"]);var d=a.attributes["o:title"];d&&(a.attributes.title=d,delete a.attributes["o:title"]),a.name="img";return}delete a.name}b in r&&(a.filterChildren(),n(a))},span:function(a){if(!f.gecko&&e(a.parent))return!1;if(!f.gecko&&e(a)){var b=a.firstChild(function(a){return a.value||a.name=="img"}),c=b&&(b.value||"l."),d=c.match(/^([^\s]+?)([.)]?)$/);return g(d,c)}}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(b){var c=a(b);return c?c:!1}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},t={comment:f.ie?function(){return!1}:function(a,b){var c=a.match(/<img.*?>/),e=a.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/);if(e){var h=e[1]||c&&"l.",i=h&&h.match(/>([^\s]+?)([.)]?)</);return g(i,h)}if(f.gecko&&c){var j=d.HtmlParser.Fragment.FromHtml(c[0]).children[0],k=b.previous,l=k&&k.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/),m=l&&l[1];return m&&(j.attributes.src=m),j}return!1}},u={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{$:function(a){var b=a.attributes;if(b){var c=["name","href","src"],d;for(var e=0;e<c.length;e++)d="_ke_saved_"+c[e],d in b&&delete b[c[e]]}return a},embed:function(a){var b=a.parent;if(b&&b.name=="object"){var c=b.attributes.width,d=b.attributes.height;c&&(a.attributes.width=c),d&&(a.attributes.height=d)}},param:function(a){return a.children=[],a.isEmpty=!0,a},a:function(a){if(!a.children.length&&c.isEmptyObject(a.attributes))return!1},span:function(a){if(!a.children.length&&c.isEmptyObject(a.attributes))return!1}},attributes:{style:function(a){if(!c.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,p.length)==p?(a.substr(p.length,3)=="{C}"?a=a.substr(p.length+3):a=a.substr(p.length),new d.HtmlParser.cdata(decodeURIComponent(a))):a}};f.ie&&(u.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})}),i.addRules(u),j.addRules(s),k.addRules(s),k.addRules(t)}(),function(){function b(a){var b=a.children.length,d=a.children[b-1];while(d&&d.type==g.NODE_TEXT&&!c.trim(d.value))d=a.children[--b];return d}function e(a){var c=b(a);return!c||c.type==g.NODE_ELEMENT&&c.name=="br"||a.name=="form"&&c.name=="input"}function h(c,d){var e=c.children,h=b(c);h&&((d||!f.ie)&&h.type==g.NODE_ELEMENT&&h.name=="br"&&e.pop(),h.type==g.NODE_TEXT&&a.test(h.value)&&e.pop())}function l(a){h(a,!0),e(a)&&(f.ie?a.add(new d.HtmlParser.Text("\u00a0")):(a.add(new d.HtmlParser.Text("&nbsp;")),a.add(new d.HtmlParser.Element("br",{}))))}function m(a){h(a,!1),e(a)&&a.add(new d.HtmlParser.Text("\u00a0"))}var a=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,n=d.XHTML_DTD,o=d.Utils.mix({},n.$block,n.$listItem,n.$tableContent),p;for(p in o)"br"in n[p]||delete o[p];delete o.td,delete o.pre;var q={elements:{}},r={elements:{}};for(p in o)q.elements[p]=l,r.elements[p]=m;j.addRules(q),i.addRules(r),k.addRules(q)}(),function(){i.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})}();var m=/<(a|area|img|input)\b([^>]*)>/gi,n=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,p="{ke_protected}";a.htmlDataProcessor={wordFilter:k,dataFilter:j,htmlFilter:i,toHtml:function(a,b){var c=new h.HtmlWriter,d=h.Fragment.FromHtml(a,b);return d.writeHtml(c,i),c.getHtml(!0)},toDataFormat:function(a,b,c){c=c||j,f.gecko&&(a=a.replace(/(<!--\[if[^<]*?\])-->([\S\s]*?)<!--(\[endif\]-->)/gi,"$1$2$3")),a=o(a);var d=new e("<div>");d.html("a"+a),a=d.html().substr(1);var g=new h.BasicWriter,i=h.Fragment.FromHtml(a,b);return g.reset(),i.writeHtml(g,c),a=g.getHtml(!0),a},toServer:function(a,b){var c=new h.BasicWriter,d=h.Fragment.FromHtml(a,b);return d.writeHtml(c,i),c.getHtml(!0)}}},{attach:!1}),KISSY.Editor.add("image",function(a){a.addPlugin("image",function(){var b=KISSY,c=b.Editor,d=b.UA,e=b.Node,f=b.Event,g=function(a){return a._4e_name()==="img"&&!/(^|\s+)ke_/.test(a[0].className)&&a},h={},i=c.Utils.addRes,j=c.Utils.destroyRes,k='  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>',l=a.addButton("image",{contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",mode:c.WYSIWYG_MODE,offClick:function(){this.call("show")},_updateTip:function(a,b){var c=b.attr("_ke_saved_src")||b.attr("src");a.html(c),a.attr("href",c)},show:function(a,b){var c=this.editor;c.showDialog("image/dialog",[b])}});i.call(h,l,function(){a.destroyDialog("image/dialog")}),c.use("contextmenu",function(){function d(a){var b=new e(a.target);a.halt(),g(b)&&l.call("show",null,b)}var b={"\u56fe\u7247\u5c5e\u6027":function(a){var b=a.getSelection(),c=b&&b.getStartElement(),d=g(c);d&&l.call("show",null,d)}};f.on(a.document,"dblclick",d),i.call(h,function(){f.remove(a.document,"dblclick",d)});var j={};for(var k in b)(function(c){j[c]=function(){b[c](a)}})(k);var m=c.ContextMenu.register({editor:a,rules:[g],width:"120px",funcs:j});i.call(h,m)}),c.use("bubbleview",function(){c.BubbleView.register({pluginName:"image",pluginContext:l,editor:a,func:g,init:function(){var a=this,b=a.get("contentEl");b.html("\u56fe\u7247\u7f51\u5740\uff1a "+k);var e=b.one(".ke-bubbleview-url"),f=b.one(".ke-bubbleview-change"),g=b.one(".ke-bubbleview-remove");c.Utils.preventFocus(b),f.on("click",function(b){a._plugin.call("show",null,a._selectedEl),b.halt()}),g.on("click",function(b){var c=a._plugin;if(d.webkit){var e=c.editor.getSelection().getRanges();e&&e[0]&&(e[0].collapse(!0)||!0)&&e[0].select()}a._selectedEl._4e_remove(),a.hide(),c.editor.notifySelectionChange(),b.halt()}),c.Utils.addRes.call(a,f,g),a.on("show",function(){var b=a._selectedEl,c=a._plugin;if(!b)return;c.call("_updateTip",e,b)})}}),i.call(h,function(){c.BubbleView.destroy("image")})}),this.destroy=function(){j.call(h)}})},{attach:!1}),KISSY.Editor.add("indent",function(a){a.addPlugin("indent",function(){var b=KISSY.Editor,c=a.addButton("outdent",{title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",mode:b.WYSIWYG_MODE,contentCls:"ke-toolbar-outdent",type:"outdent",loading:!0}),d=a.addButton("indent",{title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",mode:b.WYSIWYG_MODE,contentCls:"ke-toolbar-indent",type:"indent",loading:!0});b.use("indent/support",function(){c.reload(b.IndentSupport),d.reload(b.IndentSupport)}),a.addCommand("indent",{exec:function(){d.call("offClick")}}),a.addCommand("outdent",{exec:function(){c.call("offClick")}}),this.destroy=function(){c.destroy(),d.destroy()}})},{attach:!1}),KISSY.Editor.add("indent/support",function(){function k(a){this.type=a,this.indentCssProperty="margin-left",this.indentOffset=40,this.indentUnit="px"}function l(a){return a[0].nodeType==h.NODE_ELEMENT&&a._4e_name()=="li"}function m(c,d){var h=c.startContainer,k=c.endContainer;while(h&&!h.parent()._4e_equals(d))h=h.parent();while(k&&!k.parent()._4e_equals(d))k=k.parent();if(!h||!k)return;var l=h,m=[],n=!1;while(!n)l._4e_equals(k)&&(n=!0),m.push(l),l=l.next();if(m.length<1)return;var o=d._4e_parents(!0);for(var p=0;p<o.length;p++)if(b[o[p]._4e_name()]){d=o[p];break}var q=this.type=="indent"?1:-1,r=m[0],s=m[m.length-1],t={},u=a.ListUtils.listToArray(d,t),v=u[s.data("listarray_index")].indent;for(p=r.data("listarray_index");p<=s.data("listarray_index");p++){u[p].indent+=q;var w=u[p].parent;u[p].parent=new f(w[0].ownerDocument.createElement(w._4e_name()))}for(p=s.data("listarray_index")+1;p<u.length&&u[p].indent>v;p++)u[p].indent+=q;var x=a.ListUtils.arrayToList(u,t,null,"p",0),y=[];if(this.type=="outdent"){var z;if((z=d.parent())&&z._4e_name()=="li"){var A=x.listNode.childNodes,B=A.length,C;for(p=B-1;p>=0;p--)(C=new f(A[p]))&&C._4e_name()=="li"&&y.push(C)}}x&&(e.insertBefore(x.listNode[0]||x.listNode,d[0]||d),d._4e_remove());if(y&&y.length)for(p=0;p<y.length;p++){var D=y[p],E=D;while((E=E.next())&&E._4e_name()in b)g.ie&&!D._4e_first(function(a){return i(a)&&j(a)})&&D[0].appendChild(c.document.createTextNode("\u00a0")),D[0].appendChild(E[0]);e.insertAfter(D[0],z[0])}a.Utils.clearAllMarkers(t)}function n(a){var b=a.createIterator();b.enforceRealBlocks=!0,b.enlargeBr=!0;var c;while(c=b.getNextParagraph())o.call(this,c)}function o(a){var b=parseInt(a._4e_style(this.indentCssProperty),10);return isNaN(b)&&(b=0),b+=(this.type=="indent"?1:-1)*this.indentOffset,b<0?!1:(b=Math.max(b,0),b=Math.ceil(b/this.indentOffset,undefined)*this.indentOffset,a.css(this.indentCssProperty,b?b+this.indentUnit:""),a[0].style.cssText===""&&a.removeAttr("style"),!0)}var a=KISSY.Editor,b={ol:1,ul:1},c=KISSY,d=a.Walker,e=c.DOM,f=c.Node,g=c.UA,h=a.NODE,i=d.whitespaces(!0),j=d.bookmark(!1,!0);c.augment(k,{exec:function(a){var c=a.getSelection(),e=c&&c.getRanges()[0],f=e.startContainer,g=e.endContainer,i=e.getCommonAncestor(),j=i;while(j&&(j[0].nodeType!=h.NODE_ELEMENT||!b[j._4e_name()]))j=j.parent();if(j&&f[0].nodeType==h.NODE_ELEMENT&&f._4e_name()in b){var k=new d(e);k.evaluator=l,e.startContainer=k.next()}j&&g[0].nodeType==h.NODE_ELEMENT&&g._4e_name()in b&&(k=new d(e),k.evaluator=l,e.endContainer=k.previous());var p=c.createBookmarks(!0);if(j){var q=j._4e_first();while(q&&q._4e_name()!="li")q=q.next();var r=e.startContainer,s=q[0]==r[0]||q.contains(r);(!s||!o.call(this,j))&&m.call(this,e,j)}else n.call(this,e);c.selectBookmarks(p)}}),a.IndentSupport={init:function(){var a=this,b=a.cfg;a.indentCommand=new k(b.type)},offClick:function(){var a=this,b=a.editor;b.fire("save"),setTimeout(function(){a.indentCommand.exec(b),b.fire("save"),b.notifySelectionChange()},10)},selectionChange:function(a){var c=this,d=c.cfg;if(d.type!="outdent")return;var e=a.path,f=e.blockLimit,g=c.btn;if(e.contains(b))g.boff();else{var h=e.block||f;h&&h._4e_style(c.indentCommand.indentCssProperty)?g.boff():g.disable()}}}},{attach:!1}),KISSY.Editor.add("justify",function(a){a.addPlugin("justify",function(){var b=KISSY,c=b.Editor,d=c.TripleButton,e=/(-moz-|-webkit-|start|auto)/gi,f="left",g={mode:c.WYSIWYG_MODE,offClick:function(){this.call("_change")},onClick:function(){this.call("_change")},_change:function(){var a=this,b=a.editor,c=b.getSelection(),e=a.btn.get("state");if(!c)return;var f=c.createBookmarks(),g=c.getRanges(),h,i;b.fire("save");for(var j=g.length-1;j>=0;j--){h=g[j].createIterator(),h.enlargeBr=!0;while(i=h.getNextParagraph())i.removeAttr("align"),e==d.OFF?i.css("text-align",a.cfg.v):i.css("text-align","")}b.notifySelectionChange(),c.selectBookmarks(f),b.fire("save")},selectionChange:function(a){var b=this,c=b.btn,d=a.path,g=d.block||d.blockLimit;if(!g||g._4e_name()==="body"){c.boff();return}var h=g.css("text-align").replace(e,"")||f;h==b.cfg.v?c.bon():c.boff()}},h=a.addButton("alignleft",b.mix({contentCls:"ke-toolbar-alignleft",title:"\u5de6\u5bf9\u9f50",v:"left"},g)),i=a.addButton("aligncenter",b.mix({contentCls:"ke-toolbar-aligncenter",title:"\u5c45\u4e2d\u5bf9\u9f50",v:"center"},g)),j=a.addButton("alignright",b.mix({contentCls:"ke-toolbar-alignright",title:"\u53f3\u5bf9\u9f50",v:"right"},g));this.destroy=function(){h.destroy(),i.destroy(),j.destroy()}})},{attach:!1}),KISSY.Editor.add("link",function(a){a.addPlugin("link",function(){function i(a){return a._4e_ascendant(function(a){return a._4e_name()==="a"},!0)}function j(a){var b=a.attributes,c={};for(var d=0;d<b.length;d++){var e=b[d];e.specified&&(c[e.name]=e.value)}return a.style.cssText&&(c.style=a.style.cssText),c}var b=KISSY,c=b.Editor,d=b.Node,e=c.Style,f="_ke_saved_href",g={element:"a",attributes:{href:"#(href)",title:"#(title)",_ke_saved_href:"#(_ke_saved_href)",target:"#(target)"}},h='\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>',k={},l=c.Utils.addRes,m=c.Utils.destroyRes,n=a.addButton("link",{contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5",mode:c.WYSIWYG_MODE,_getSelectedLink:function(){var a=this,b=a.editor,c=b.getSelection(),d=c&&c.getStartElement();return d&&(d=i(d)),d},_getSelectionLinkUrl:function(){var a=this,b=a.cfg,c=b._getSelectedLink.call(a);if(c)return c.attr(f)||c.attr("href")},_removeLink:function(a){var b=this,c=b.editor;c.fire("save");var d=c.getSelection(),f=d.getRanges()[0];if(f&&f.collapsed){var h=d.createBookmarks();a._4e_remove(!0),d.selectBookmarks(h)}else if(f){var i=j(a[0]);(new e(g,i)).remove(c.document)}c.fire("save"),c.notifySelectionChange()},_link:function(a,b){var c=this,h=c.editor;a[f]=a.href;if(b)h.fire("save"),b.attr(a),h.fire("save");else{var i=h.getSelection(),j=i&&i.getRanges()[0];if(!j||j.collapsed){var k=new d("<a>"+a.href+"</a>",a,h.document);h.insertElement(k)}else{h.fire("save");var l=new e(g,a);l.apply(h.document),h.fire("save")}}h.notifySelectionChange()},offClick:function(){var a=this;a.editor.showDialog("link/dialog",[a])},destroy:function(){this.editor.destroyDialog("link/dialog")}});l.call(k,n),c.use("bubbleview",function(){c.BubbleView.register({pluginName:"link",editor:a,pluginContext:n,func:i,init:function(){var a=this,b=a.get("contentEl");b.html(h);var d=b.one(".ke-bubbleview-url"),e=b.one(".ke-bubbleview-change"),g=b.one(".ke-bubbleview-remove");c.Utils.preventFocus(b),e.on("click",function(b){var c=a._plugin;c.call("offClick"),b.halt()}),g.on("click",function(b){var c=a._plugin;c.call("_removeLink",a._selectedEl),b.halt()}),l.call(a,e,g),a.on("show",function(){var b=a._selectedEl;if(!b)return;var c=b.attr(f)||b.attr("href");d.html(c),d.attr("href",c)})}}),l.call(k,function(){c.BubbleView.destroy("link")})}),this.destroy=function(){m.call(k)}})},{attach:!1}),KISSY.Editor.add("list",function(a){a.addPlugin("list",function(){var b=KISSY.Editor,c=a.addButton("ul",{title:"\u9879\u76ee\u5217\u8868",mode:b.WYSIWYG_MODE,contentCls:"ke-toolbar-ul",loading:!0,type:"ul"}),d=a.addButton("ol",{title:"\u7f16\u53f7\u5217\u8868",mode:b.WYSIWYG_MODE,contentCls:"ke-toolbar-ol",loading:!0,type:"ol"});b.use("list/support",function(){c.reload(b.ListSupport),d.reload(b.ListSupport)}),this.destroy=function(){c.destroy(),d.destroy()}})},{attach:!1}),KISSY.Editor.add("list/support",function(){function n(a){this.type=a}var a=KISSY.Editor,b={ol:1,ul:1},c=["ol","ul"],d=KISSY,e=a.RANGE,f=a.ElementPath,g=a.Walker,h=a.NODE,i=d.UA,j=d.Node,k=d.DOM,l={listToArray:function(a,c,d,e,f){if(!b[a._4e_name()])return[];e||(e=0),d||(d=[]);for(var g=0,i=a[0].childNodes.length;g<i;g++){var k=new j(a[0].childNodes[g]);if(k._4e_name()!="li")continue;var m={parent:a,indent:e,element:k,contents:[]};f?m.grandparent=f:(m.grandparent=a.parent(),m.grandparent&&m.grandparent._4e_name()=="li"&&(m.grandparent=m.grandparent.parent())),c&&k._4e_setMarker(c,"listarray_index",d.length),d.push(m);for(var n=0,o=k[0].childNodes.length,p;n<o;n++)p=new j(k[0].childNodes[n]),p[0].nodeType==h.NODE_ELEMENT&&b[p._4e_name()]?l.listToArray(p,c,d,e+1,m.grandparent):m.contents.push(p)}return d},arrayToList:function(a,c,d,e){d||(d=0);if(!a||a.length<d+1)return null;var f=a[d].parent[0].ownerDocument,g=f.createDocumentFragment(),m=null,n=d,o=Math.max(a[d].indent,0),p=null;for(;;){var q=a[n];if(q.indent==o){if(!m||a[n].parent._4e_name()!=m._4e_name())m=a[n].parent._4e_clone(!1,!0),g.appendChild(m[0]);p=m[0].appendChild(q.element._4e_clone(!1,!0)[0]);for(var r=0;r<q.contents.length;r++)p.appendChild(q.contents[r]._4e_clone(!0,!0)[0]);n++}else if(q.indent==Math.max(o,0)+1){var s=l.arrayToList(a,null,n,e);p.appendChild(s.listNode),n=s.nextIndex}else{if(q.indent!=-1||!!d||!q.grandparent)return null;b[q.grandparent._4e_name()]?p=q.element._4e_clone(!1,!0)[0]:q.grandparent._4e_name()!="td"?(p=f.createElement(e),q.element._4e_copyAttributes(new j(p))):p=f.createDocumentFragment();for(r=0;r<q.contents.length;r++){var t=q.contents[r]._4e_clone(!0,!0);p.nodeType==h.NODE_DOCUMENT_FRAGMENT&&q.element._4e_copyAttributes(new j(t)),p.appendChild(t[0])}p.nodeType==h.NODE_DOCUMENT_FRAGMENT&&n!=a.length-1&&(p.lastChild&&p.lastChild.nodeType==h.NODE_ELEMENT&&p.lastChild.getAttribute("type")=="_moz"&&k._4e_remove(p.lastChild),k._4e_appendBogus(p));if(p.nodeType==h.NODE_ELEMENT&&k._4e_name(p)==e&&p.firstChild){k._4e_trim(p);var u=p.firstChild;if(u.nodeType==h.NODE_ELEMENT&&k._4e_isBlockBoundary(u)){var v=f.createDocumentFragment();k._4e_moveChildren(p,v),p=v}}var w=k._4e_name(p);!i.ie&&(w=="div"||w=="p")&&k._4e_appendBogus(p),g.appendChild(p),m=null,n++}if(a.length<=n||Math.max(a[n].indent,0)<o)break}if(c){var x=new j(g.firstChild);while(x&&x[0])x[0].nodeType==h.NODE_ELEMENT&&x._4e_clearMarkers(c,!0),x=x._4e_nextSourceNode()}return{listNode:g,nextIndex:n}}},m=/^h[1-6]$/;n.prototype={changeListType:function(a,b,c,d){var e=l.listToArray(b.root,c,undefined,undefined,undefined),f=[];for(var g=0;g<b.contents.length;g++){var h=b.contents[g];h=h._4e_ascendant("li",!0);if(!h||!h[0]||h.data("list_item_processed"))continue;f.push(h),h._4e_setMarker(c,"list_item_processed",!0)}var i=new j(b.root[0].ownerDocument.createElement(this.type));for(g=0;g<f.length;g++){var m=f[g].data("listarray_index");e[m].parent=i}var n=l.arrayToList(e,c,null,"p"),o,p=n.listNode.childNodes.length;for(g=0;g<p&&(o=new j(n.listNode.childNodes[g]));g++)o._4e_name()==this.type&&d.push(o);k.insertBefore(k._4e_unwrap(n.listNode),k._4e_unwrap(b.root)),b.root._4e_remove()},createList:function(a,b,c){var d=b.contents,e=b.root[0].ownerDocument,f=[];if(d.length==1&&d[0][0]===b.root[0]){var g=new j(e.createElement("div"));d[0][0].nodeType!=h.NODE_TEXT&&d[0]._4e_moveChildren(g),d[0][0].appendChild(g[0]),d[0]=g}var k=b.contents[0].parent();for(var l=0;l<d.length;l++)k=k._4e_commonAncestor(d[l].parent());for(l=0;l<d.length;l++){var n=d[l],o;while(o=n.parent()){if(o[0]===k[0]){f.push(n);break}n=o}}if(f.length<1)return;var p=new j(f[f.length-1][0].nextSibling),q=new j(e.createElement(this.type));c.push(q);while(f.length){var r=f.shift(),s=new j(e.createElement("li"));m.test(r._4e_name())?s[0].appendChild(r[0]):(r._4e_copyAttributes(s),r._4e_moveChildren(s),r._4e_remove()),q[0].appendChild(s[0]),i.ie||s._4e_appendBogus()}p[0]?q.insertBefore(p):k.append(q)},removeList:function(a,b,c){function u(c){(s=new j(r[c?"firstChild":"lastChild"]))&&(s[0].nodeType!=h.NODE_ELEMENT||!s._4e_isBlockBoundary())&&(t=b.root[c?"_4e_previous":"_4e_next"](g.whitespaces(!0)))&&(s[0].nodeType!=h.NODE_ELEMENT||!t._4e_isBlockBoundary({br:1}))&&k[c?"insertBefore":"insertAfter"](a.document.createElement("br"),k._4e_unwrap(s))}var d=l.listToArray(b.root,c,undefined,undefined,undefined),e=[];for(var f=0;f<b.contents.length;f++){var i=b.contents[f];i=i._4e_ascendant("li",!0);if(!i||i.data("list_item_processed"))continue;e.push(i),i._4e_setMarker(c,"list_item_processed",!0)}var m=null;for(f=0;f<e.length;f++){var n=e[f].data("listarray_index");d[n].indent=-1,m=n}for(f=m+1;f<d.length;f++)if(d[f].indent>Math.max(d[f-1].indent,0)){var o=d[f-1].indent+1-d[f].indent,p=d[f].indent;while(d[f]&&d[f].indent>=p)d[f].indent+=o,f++;f--}var q=l.arrayToList(d,c,null,"p"),r=q.listNode,s,t;u(!0),u(undefined),k.insertBefore(k._4e_unwrap(r),k._4e_unwrap(b.root)),b.root._4e_remove()},exec:function(c){var d=c.getSelection(),i=d&&d.getRanges();if(!i||i.length<1)return;var j=d.createBookmarks(!0),k=[],l={};while(i.length>0){var m=i.shift(),n=m.getBoundaryNodes(),o=n.startNode,p=n.endNode;o[0].nodeType==h.NODE_ELEMENT&&o._4e_name()=="td"&&m.setStartAt(n.startNode,e.POSITION_AFTER_START),p[0].nodeType==h.NODE_ELEMENT&&p._4e_name()=="td"&&m.setEndAt(n.endNode,e.POSITION_BEFORE_END);var q=m.createIterator(),r;q.forceBrBreak=!1;while(r=q.getNextParagraph()){if(r.data("list_block"))continue;r._4e_setMarker(l,"list_block",1);var s=new f(r),t=s.elements,u=t.length,v=null,w=!1,x=s.blockLimit,y;for(var z=u-1;z>=0&&(y=t[z]);z--)if(b[y._4e_name()]&&x.contains(y)){x.removeData("list_group_object");var A=y.data("list_group_object");A?A.contents.push(r):(A={root:y,contents:[r]},k.push(A),y._4e_setMarker(l,"list_group_object",A)),w=!0;break}if(w)continue;var B=x||s.block;B.data("list_group_object")?B.data("list_group_object").contents.push(r):(A={root:B,contents:[r]},B._4e_setMarker(l,"list_group_object",A),k.push(A))}}var C=[];while(k.length>0)A=k.shift(),this.state=="off"?b[A.root._4e_name()]?this.changeListType(c,A,l,C):(a.Utils.clearAllMarkers(l),this.createList(c,A,C)):this.state=="on"&&b[A.root._4e_name()]&&this.removeList(c,A,l);for(z=0;z<C.length;z++){v=C[z];var D=this;function E(a){var b=v[a?"_4e_previous":"_4e_next"](g.whitespaces(!0));b&&b[0]&&b._4e_name()==D.type&&(b._4e_remove(),b._4e_moveChildren(v,a?!0:!1))}E(undefined),E(!0)}a.Utils.clearAllMarkers(l),d.selectBookmarks(j)}};var o={init:function(){var a=this,b=a.cfg;a.listCommand=new n(b.type)},selectionChange:function(a){var b=this,e=b.cfg,f=e.type,g=a.path,h,i=b.btn,j=g.blockLimit,k=g.elements;if(!j)return;if(k)for(var l=0;l<k.length&&(h=k[l])&&h[0]!==j[0];l++){var m=d.indexOf(k[l]._4e_name(),c);if(m!==-1){if(c[m]===f){i.bon();return}break}}i.boff()},offClick:function(){this.call("_change")},onClick:function(){this.call("_change")},_change:function(){var a=this,b=a.editor,c=a.btn;b.fire("save"),a.listCommand.state=c.get("state"),a.listCommand.exec(b),b.fire("save"),b.notifySelectionChange()}};a.ListUtils=l,a.ListSupport=o},{attach:!1}),KISSY.Editor.add("localstorage",function(){function d(){b.fire("storeReady")}var a=KISSY,b=a.Editor;b.localStorage=null;if(!!b.storeReady){a.log("localstorage attach more","warn");return}b.storeReady=function(a){b.on("storeReady",a)};function c(){b.storeReady=function(a){a()},b.detach("storeReady")}b.on("storeReady",c);if(!a.UA.ie&&window.localStorage){b.localStorage=window.localStorage,d();return}var e=b.Utils.debugUrl("localstorage/swfstore.swf?t="+ +(new Date)),f=new b.FlashBridge({movie:e,flashVars:{useCompression:!0},methods:["setItem","removeItem","getItem","setMinDiskSpace","getValueOf"]});a.use("overlay",function(){f.swf.height=138;var c=new a.Overlay({headerContent:"\u8bf7\u70b9\u5141\u8bb8",width:"0px",elStyle:{overflow:"hidden"},content:"<h1 style='border:1px solid black;border-bottom:none;background:white;text-align:center;'>\u8bf7\u70b9\u51fb\u5141\u8bb8</h1>",zIndex:b.baseZIndex(b.zIndexManager.STORE_FLASH_SHOW)});c.render(),c.get("contentEl").append(f.swf),c.center(),c.show(),f.on("pending",function(){c.set("width",215),c.center(),c.show(),setTimeout(function(){f.retrySave()},1e3)}),f.on("save",function(){c.set("width",0)})});var g=f.setItem;a.mix(f,{_ke:1,getItem:function(a){return this.getValueOf(a)},retrySave:function(){this.setItem(this.lastSave.k,this.lastSave.v)},setItem:function(a,b){this.lastSave={k:a,v:b},g.call(this,a,b)}}),f.on("contentReady",function(){b.localStorage=f,d()})},{attach:!1,requires:["flashutils","flashbridge"]}),KISSY.Editor.add("maximize",function(a){a.addPlugin("maximize",function(){var b=KISSY,c=b.Editor,d=b.UA,e="ke-toolbar-maximize";if(d.gecko<1.92)return;var f=a.addButton("maximize",{title:"\u5168\u5c4f",contentCls:e,loading:!0});c.use("maximize/support",function(){f.reload(c.Maximize)}),this.destroy=function(){f.destroy()}})},{attach:!1}),KISSY.Editor.add("maximize/support",function(){var a=KISSY.Editor,b=KISSY,c=b.UA,d=b.Node,e=b.Event,f=b.DOM,g;f.addStyleSheet(".ke-toolbar-padding {padding:5px;}","ke-maximize");var h="ke-toolbar-maximize",i="ke-toolbar-restore",j="\u5168\u5c4f",k="ke-toolbar-padding",l="\u53d6\u6d88\u5168\u5c4f",m={},n=function(){g||(g=(new d("<iframe  class='ke-maximize-shim' style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'>")).prependTo(document.body))};b.mix(m,{onClick:function(){var a=this,b=a.editor;a._resize&&e.remove(window,"resize",a._resize),a.call("_saveEditorStatus"),a.call("_restoreState"),a.btn.boff(),setTimeout(function(){a.call("_restoreEditorStatus"),b.notifySelectionChange(),b.fire("restoreWindow")},30)},_restoreState:function(){var a=this,b=document,d=a.editor,e=a._savedParents;if(e){for(var l=0;l<e.length;l++){var m=e[l];m.el.css("position",m.position)}a._savedParents=null}d.wrap.css({height:a.iframeHeight}),f.css(b.body,{width:"",height:"",overflow:""}),b.documentElement.style.overflow="",d.editorWrap.css({position:"static",width:a.editorWrapWidth}),g.css({left:"-99999px",top:"-99999px"}),window.scrollTo(a.scrollLeft,a.scrollTop);var n=a.btn.get("el");n.one("span").removeClass(i).addClass(h),n.attr("title",j),c.ie<8&&a.editor.toolBarDiv.removeClass(k)},_saveSate:function(){var a=this,b=a.editor,d=[],e=b.editorWrap;a.iframeHeight=b.wrap._4e_style("height"),a.editorWrapWidth=e._4e_style("width"),a.scrollLeft=f.scrollLeft(),a.scrollTop=f.scrollTop(),window.scrollTo(0,0);var g=e.parent();while(g){var j=g.css("position");j!="static"&&(d.push({el:g,position:j}),g.css("position","static")),g=g.parent()}a._savedParents=d;var m=a.btn.get("el");m.one("span").removeClass(h).addClass(i),m.attr("title",l),c.ie<8&&a.editor.toolBarDiv.addClass(k)},_saveEditorStatus:function(){var a=this,b=a.editor;a.savedRanges=null;if(!c.gecko||!b.iframeFocus)return;var d=b.getSelection();a.savedRanges=d&&d.getRanges()},_restoreEditorStatus:function(){var a=this,b=a.editor,d=b.getSelection(),e=a.savedRanges;b.activateGecko(),e&&d&&d.selectRanges(e);if(b.iframeFocus&&d){var f=d.getStartElement();f&&f[0]&&f._4e_scrollIntoView()}c.ie<8&&a.btn.get("el").one("span").css("background-image","")},_maximize:function(b){var d=this,e=document,h=d.editor,i=h.editorWrap,j=f.viewportHeight(),k=f.viewportWidth(),l=h.statusDiv?h.statusDiv[0].offsetHeight:0,m=h.toolBarDiv[0].offsetHeight;c.ie?e.body.style.overflow="hidden":f.css(e.body,{width:0,height:0,overflow:"hidden"}),e.documentElement.style.overflow="hidden",i.css({position:"absolute",zIndex:a.baseZIndex(a.zIndexManager.MAXIMIZE),width:k+"px"}),g.css({zIndex:a.baseZIndex(a.zIndexManager.MAXIMIZE-5),height:j+"px",width:k+"px"}),i.offset({left:0,top:0}),g.css({left:0,top:0}),h.wrap.css({height:j-l-m+"px"}),b!==!0&&arguments.callee.call(d,!0)},_real:function(){var b=this,c=b.editor;b.call("_saveEditorStatus"),b.call("_saveSate"),b.call("_maximize"),b._resize=b._resize||a.Utils.buffer(b.cfg._maximize,b,100),e.on(window,"resize",b._resize),b.btn.bon(),setTimeout(function(){b.call("_restoreEditorStatus"),c.notifySelectionChange(),c.fire("maximizeWindow")},30)},offClick:function(){var a=this;n(),a.call("_real")},destroy:function(){}}),a.Maximize=m},{attach:!1}),KISSY.Editor.add("music",function(a){a.addPlugin("music",function(){function g(a){return a=a||"",a.indexOf(d)!=-1}var b=KISSY,c=b.Editor,d="niftyplayer.swf",e=a.htmlDataProcessor,f=e&&e.dataFilter,h="ke_music",i="music";f&&f.addRules({elements:{object:function(a){var b=a.attributes,d,f=b.classid&&String(b.classid).toLowerCase();if(!f){for(d=0;d<a.children.length;d++)if(a.children[d].name=="embed"){if(!c.Utils.isFlashEmbed(a.children[d]))return null;if(g(a.children[d].attributes.src))return e.createFakeParserElement(a,h,i,!0)}return null}for(d=0;d<a.children.length;d++){var j=a.children[d];if(j.name=="param"&&j.attributes.name.toLowerCase()=="movie"&&g(j.attributes.value))return e.createFakeParserElement(a,h,i,!0)}},embed:function(a){if(!c.Utils.isFlashEmbed(a))return null;if(g(a.attributes.src))return e.createFakeParserElement(a,h,i,!0)}}},4);var j=a.addButton("music",{contentCls:"ke-toolbar-music",title:"\u63d2\u5165\u97f3\u4e50",mode:c.WYSIWYG_MODE,loading:!0});c.use("music/support",function(){var b=new c.MusicInserter(a);j.reload({offClick:function(){b.show()},destroy:function(){b.destroy()}})}),this.destroy=function(){j.destroy()}})},{attach:!1,requires:["fakeobjects"]}),KISSY.Editor.add("music/support",function(){function i(b){i.superclass.constructor.apply(this,arguments);var d=b.cfg.disableObjectResizing;d||c.on(b.document.body,e.ie?"resizestart":"resize",function(b){var c=new a.Node(b.target);c.hasClass(f)&&b.preventDefault()})}function j(a){return a._4e_name()==="img"&&!!a.hasClass(f)&&a}function k(a){return a.replace(/^.+niftyplayer\.swf\?file=/,"")}var a=KISSY,b=a.Editor,c=a.Event,d=b.Flash,e=a.UA,f="ke_music",g="music",h=["img."+f];a.extend(i,d,{_config:function(){var a=this;a._cls=f,a._type=g,a._contextMenu=l,a._flashRules=h},_getFlashUrl:function(){return k(i.superclass._getFlashUrl.apply(this,arguments))}}),d.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",j),b.MusicInserter=i;var l={"\u97f3\u4e50\u5c5e\u6027":function(a){var b=a.editor,c=b.getSelection(),d=c&&c.getStartElement(),e=d&&j(d);e&&a.show(null,e)}}},{attach:!1,requires:["flash/support"]}),KISSY.Editor.add("overlay/focus",function(){function e(){}var a=KISSY,b=a.UA,c=a.Editor,d=c.focusManager;c.namespace("UIBase");if(c.UIBase.Focus){a.log("ke uibase focus attach more","warn");return}e.ATTRS={focus4e:{value:!0}},e.prototype={_uiSetFocus4e:function(a){var b=this;a?(b.on("show",b._show4FocusExt,b),b.on("hide",b._hide4FocusExt,b)):(b.detach("show",b._show4FocusExt,b),b.detach("hide",b._hide4FocusExt,b))},__syncUI:function(){},__renderUI:function(){},__bindUI:function(){var b=this;b._focus4e=(new a.Node("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(b.get("el"))},_show4FocusExt:function(){var a=this;a._focusEditor=d.currentInstance();var c=a._focusEditor;if(b.ie&&c){window.focus(),document.body.focus(),a._focus4e[0].focus();var e=c.document.selection,f=e.createRange();if(f&&f.item&&f.item(0).ownerDocument==c.document){var g=document.body.createTextRange();g.moveToElementText(a.get("el")._4e_first()[0]),g.collapse(!0),g.select()}}},_hide4FocusExt:function(){var a=this._focusEditor;a&&a.focus()}},c.UIBase.Focus=e},{attach:!1}),KISSY.Editor.add("overlay",function(){var a=KISSY,b=a.UIBase,c=a.Editor;if(c.Overlay){a.log("ke overlay attach more");return}a.use("overlay");var d=b.create(a.Overlay,[c.UIBase.Focus],{syncUI:function(){var a=this;c.Utils.preventFocus(a.get("contentEl"))}},{ATTRS:{zIndex:{value:c.baseZIndex(c.zIndexManager.OVERLAY)}}}),e=b.create(a.Dialog,[c.UIBase.Focus],{show:function(){this.center();var b=this.get("y");b-a.DOM.scrollTop()>200&&(b=a.DOM.scrollTop()+200,this.set("y",b)),e.superclass.show.call(this)}},{ATTRS:{constrain:{value:!0},zIndex:{value:c.baseZIndex(c.zIndexManager.OVERLAY)}}});c.Overlay=d,c.Dialog=e;var f;c.Overlay.loading=function(){f||(f=new c.Overlay({x:0,focus4e:!1,width:a.UA.ie==6?a.DOM.docWidth():"100%",y:0,zIndex:c.baseZIndex(c.zIndexManager.LOADING),elCls:"ke-global-loading"})),f.set("height",a.DOM.docHeight()),f.show(),f.loading()},c.Overlay.unloading=function(){f&&f.hide()}},{requires:["overlay/focus"]}),KISSY.Editor.add("pagebreak",function(a){a.addPlugin("pagebreak",function(){var b=KISSY,c=b.Editor,d=b.Node,e=a.htmlDataProcessor,f=e&&e.dataFilter,g="ke_pagebreak",h="div";f&&f.addRules({elements:{div:function(a){var b=a.attributes,c=b&&b.style,d=c&&a.children.length==1&&a.children[0],f=d&&d.name=="span"&&d.attributes.style;if(f&&/page-break-after\s*:\s*always/i.test(c)&&/display\s*:\s*none/i.test(f))return e.createFakeParserElement(a,g,h)}}});var i='<div style="page-break-after: always; "><span style="DISPLAY:none">&nbsp;</span></div>',j=a.addButton("page-break",{title:"\u5206\u9875",mode:c.WYSIWYG_MODE,contentCls:"ke-toolbar-pagebreak",offClick:function(){var a=this.editor,b=new d(i,null,a.document),c=a.createFakeElement?a.createFakeElement(b,g,h,!1,i):b,e=a.getSelection(),f=e&&e.getRanges()[0];if(!f)return;a.fire("save");var j=f.startContainer,k=j;while(j._4e_name()!=="body")k=j,j=j.parent();f.collapse(!0),f.splitElement(k),c.insertAfter(k),a.fire("save")}});this.destroy=function(){j.destroy()}})},{attach:!1,requires:["fakeobjects"]}),KISSY.Editor.add("preview",function(a){a.addPlugin("preview",function(){var b=a.addButton("preview",{title:"\u9884\u89c8",contentCls:"ke-toolbar-preview",offClick:function(){var a=this,b=a.editor,c=640,d=420,e=80;try{var f=window.screen;c=Math.round(f.width*.8),d=Math.round(f.height*.7),e=Math.round(f.width*.1)}catch(g){}var h=b._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+b.getData(!0)+"\n</body>").replace(/\${title}/,"\u9884\u89c8"),i="",j=window.open(i,"","toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+c+",height="+d+",left="+e),k=j.document;k.open(),k.write(h),k.close(),j.focus()}});this.destroy=function(){b.destroy()}})},{attach:!1}),KISSY.Editor.add("progressbar",function(){function e(){e.superclass.constructor.apply(this,arguments),this._init()}var a=KISSY,b=a.Editor;if(b.ProgressBar)return;var c=a.DOM,d=a.Node;c.addStyleSheet(".ke-progressbar {border:1px solid #D6DEE6;position:relative;margin-left:auto;margin-right:auto;background-color: #EAEFF4;background: -webkit-gradient(linear, left top, left bottom, from(#EAEFF4), .to(#EBF0F3)); background: -moz-linear-gradient(top, #EAEFF4, #EBF0F3);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#EAEFF4', endColorstr = '#EBF0F3');}.ke-progressbar-inner {border:1px solid #3571B4;background-color:#6FA5DB;padding:1px;}.ke-progressbar-inner-bg {height:100%;background-color: #73B1E9;background: -webkit-gradient(linear, left top, left bottom, from(#73B1E9), .to(#3F81C8)); background: -moz-linear-gradient(top, #73B1E9, #3F81C8);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#73B1E9', endColorstr = '#3F81C8');}.ke-progressbar-title {width:30px;top:0;left:40%;line-height:1.2;position:absolute;}","ke_progressbar"),e.ATTRS={container:{},width:{},height:{},progress:{value:0}},a.extend(e,a.Base,{destroy:function(){var a=this;a.detach(),a.el.remove()},_init:function(){var a=this,b=a.get("height"),c=new d("<div class='ke-progressbar'  style='width:"+a.get("width")+";"+"height:"+b+";'"+"></div>"),e=a.get("container"),f=(new d("<div style='overflow:hidden;'><div class='ke-progressbar-inner' style='height:"+(parseInt(b)-4)+"px'>"+"<div class='ke-progressbar-inner-bg'></div>"+"</div>"+"</div>")).appendTo(c),g=(new d("<span class='ke-progressbar-title'></span>")).appendTo(c);e&&c.appendTo(e),a.el=c,a._title=g,a._p=f,a.on("afterProgressChange",a._progressChange,a),a._progressChange({newVal:a.get("progress")})},_progressChange:function(a){var b=this,c=a.newVal;b._p.css("width",c+"%"),b._title.html(c+"%")}}),b.ProgressBar=e},{attach:!1}),KISSY.Editor.add("removeformat",function(a){a.addPlugin("removeformat",function(){function j(a,b){for(var c=0;c<b.length;c++)a.removeAttr(b[c])}var b=KISSY,c=b.Editor,d=c.RANGE,e=c.ElementPath,f=c.NODE,g="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",h="class,style,lang,width,height,align,hspace,valign".split(/,/),i=new RegExp("^(?:"+g.replace(/,/g,"|")+")$","i"),k=a.addButton("removeformat",{title:"\u6e05\u9664\u683c\u5f0f",mode:c.WYSIWYG_MODE,contentCls:"ke-toolbar-removeformat",offClick:function(){var a=this,b=a.editor;b.focus(),i.lastIndex=0;var c=b.getSelection().getRanges();b.fire("save");for(var g=0,k;k=c[g];g++){if(k.collapsed)continue;k.enlarge(d.ENLARGE_ELEMENT);var l=k.createBookmark(),m=l.startNode,n=l.endNode,o=function(a){var b=new e(a),c=b.elements;for(var d=1,f;f=c[d];d++){if(f._4e_equals(b.block)||f._4e_equals(b.blockLimit))break;i.test(f._4e_name())&&a._4e_breakParent(f)}};o(m),o(n);var p=m._4e_nextSourceNode(!0,f.NODE_ELEMENT);while(p){if(p._4e_equals(n))break;var q=p._4e_nextSourceNode(!1,f.NODE_ELEMENT);if(p._4e_name()!="img"||!p.attr("_ke_realelement"))i.test(p._4e_name())?p._4e_remove(!0):j(p,h);p=q}k.moveToBookmark(l)}b.getSelection().selectRanges(c),b.fire("save")}});this.destroy=function(){k.destroy()}})},{attach:!1}),KISSY.Editor.add("resize",function(a){var b=KISSY,c=b.Node;b.use("dd",function(){var d=b.Draggable,e=a.statusDiv,f=a.textarea,g=new c("<div class='ke-resizer'>"),h=a.cfg.pluginConfig.resize||{};h=h.direction||["x","y"],g.appendTo(e),a.on("maximizeWindow",function(){g.css("display","none")}),a.on("restoreWindow",function(){g.css("display","")}),g._4e_unselectable();var i=new d({node:g,cursor:"se-resize"}),j=0,k=0,l=0,m=0,n=a.wrap,o=a.editorWrap;i.on("dragstart",function(){j=n.height(),k=o.width(),l=f.height(),m=f.width()}),i.on("drag",function(a){var c=a.left-this.startNodePos.left,d=a.top-this.startNodePos.top;b.inArray("y",h)&&(n.height(j+d),f.height(l+d)),b.inArray("x",h)&&(o.width(k+c),f.width(m+c))}),a.on("destroy",function(){i.destroy(),g.remove()})})},{attach:!1}),KISSY.Editor.add("separator",function(a){a.addPlugin("separator",function(){var b=(new KISSY.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(a.toolBarDiv);a.on("destroy",function(){b.remove()})},{duplicate:!0})},{attach:!1}),KISSY.Editor.add("smiley",function(a){a.addPlugin("smiley",function(){var b=KISSY.Editor,c=a.addButton("smiley",{contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",mode:b.WYSIWYG_MODE,loading:!0});b.use("smiley/support",function(){c.reload(b.SmileySupport)}),this.destroy=function(){c.destroy()}})},{attach:!1}),KISSY.Editor.add("smiley/support",function(){function f(){if(e)return e;e="<div class='ke-smiley-sprite'>";for(var a=0;a<=98;a++)e+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+a+".gif'>"+"</a>";return e+="</div>",e}var a=KISSY,b=a.Event,c=a.Editor,d=a.DOM;d.addStyleSheet('.ke-smiley-sprite { background: url("http://a.tbcdn.cn/sys/wangwang/smiley/sprite.png") no-repeat scroll -1px 0 transparent; height: 235px; width: 288px; margin: 5px;zoom: 1; overflow: hidden;}.ke-smiley-sprite a {   width: 24px;height: 24px; border: 1px solid white; float: left;}.ke-smiley-sprite a:hover { border: 1px solid #808080;}',"smiley");var e,g=c.Utils.addRes,h=c.Utils.destroyRes;c.SmileySupport={_selectSmiley:function(b){b.halt();var c=this,d=c.editor,e=new a.Node(b.target),f;if(e._4e_name()=="a"&&(f=e.attr("data-icon"))){var g=new a.Node("<img alt='' src='"+f+"'/>",null,d.document);d.insertElement(g),this.smileyWin.hide()}},_hidePanel:function(b){var c=this,d=c.btn.get("el"),e=new a.Node(b.target),f=c.smileyWin;if(d._4e_equals(e)||d.contains(e))return;f.hide()},_prepare:function(){var a=this,d=a.cfg,e=a.btn,h=a.editor,i=f();a.smileyWin=new c.Overlay({content:i,focus4e:!1,width:"297px",autoRender:!0,elCls:"ks-popup",zIndex:c.baseZIndex(c.zIndexManager.POPUP_MENU),mask:!1});var j=a.smileyWin;a.smileyPanel=j.get("contentEl"),j.on("show",e.bon,e),j.on("hide",e.boff,e),a.smileyPanel.on("click",d._selectSmiley,a),b.on(document,"click",d._hidePanel,a),b.on(h.document,"click",d._hidePanel,a),a.cfg._prepare=a.cfg._real,g.call(a,a.smileyWin,a.smileyPanel,function(){b.remove(document,"click",d._hidePanel,a),b.remove(h.document,"click",d._hidePanel,a)}),a.call("_real")},_real:function(){var a=this,b=a.btn.get("el"),c=b.offset();c.top+=b.height()+5,c.left+a.smileyPanel.width()>d.viewportWidth()-60&&(c.left=d.viewportWidth()-a.smileyPanel.width()-60),a.smileyWin.set("xy",[c.left,c.top]),a.smileyWin.show()},offClick:function(){var a=this;c.use("overlay",function(){a.call("_prepare")})},onClick:function(){this.smileyWin&&this.smileyWin.hide()},destroy:function(){var a=this;h.call(a)}}},{attach:!1}),KISSY.Editor.add("sourcearea",function(a){a.addPlugin("sourcearea",function(){function h(){var b=a.textarea;b.on("keydown",function(c){if(c.ctrlKey&&c.keyCode==87){c.halt();var e=b.attr("wrap")=="off"?"soft":"off";if(!d.ie){b.detach();var f=b._4e_clone();a.textarea=f,f.attr("wrap",e),f.val(b.val()),b[0].parentNode.replaceChild(f[0],b[0]),h(),b=null}else b.attr("wrap",e)}})}var b=KISSY,c=b.Editor,d=b.UA;if(d.gecko<1.92)return;var e=c.SOURCE_MODE,f=c.WYSIWYG_MODE,g=a.addButton("sourcearea",{title:"\u6e90\u7801",contentCls:"ke-toolbar-source",loading:!0});c.use("sourcearea/support",function(){g.reload({init:function(){var a=this,b=a.btn,c=a.editor;c.on("wysiwygmode",b.boff,b),c.on("sourcemode",b.bon,b)},offClick:function(){var a=this,b=a.editor;b.execCommand("sourceAreaSupport",e)},onClick:function(){var a=this,b=a.editor;b.execCommand("sourceAreaSupport",f)}}),a.addCommand("sourceAreaSupport",c.SourceAreaSupport)}),this.destroy=function(){g.destroy()},h()})},{attach:!1}),KISSY.Editor.add("sourcearea/support",function(){function f(){var a=this;a.mapper={};var b=a.mapper;b[d]=a._show,b[e]=a._hide}var a=KISSY,b=a.Editor,c=a.UA,d=b.SOURCE_MODE,e=b.WYSIWYG_MODE;a.augment(f,{exec:function(a,b){var c=this.mapper;c[b]&&c[b].call(this,a)},_show:function(a){var b=a.textarea;b.val(a.getData(!0)),this._showSource(a),a.fire("sourcemode")},_showSource:function(a){var b=a.textarea,d=a.iframe;b.css("display",""),d.css("display","none"),c.ieEngine<8&&b.css("height",a.wrap.css("height")),b[0].focus()},_hideSource:function(a){var b=a.textarea,c=a.iframe;c.css("display",""),b.css("display","none")},_hide:function(a){var b=a.textarea;this._hideSource(a),a.fire("save"),a.setData(b.val()),a.fire("wysiwygmode"),a.fire("save"),c.gecko&&a.activateGecko()}}),b.SourceAreaSupport=new f},{attach:!1}),KISSY.Editor.add("table",function(a){a.addPlugin("table",function(){var b=KISSY,c=b.Editor,d=b.UA,e=b.trim,f="ke_show_border",g=(d.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th","{","border : #d3d3d3 1px dotted","}"]).join(""),h=g.replace(/%2/g,f),i=a.htmlDataProcessor,j=i&&i.dataFilter,k=i&&i.htmlFilter;j&&j.addRules({elements:{table:function(a){var b=a.attributes,c=b["class"],d=parseInt(b.border,10);if(!d||d<=0)b["class"]=(c||"")+" "+f}}}),k&&k.addRules({elements:{table:function(a){var b=a.attributes,c=b["class"];c&&(b["class"]=e(c.replace(f,"").replace(/\s{2}/," ")))}}});var l=a.addButton("table",{contentCls:"ke-toolbar-table",mode:c.WYSIWYG_MODE,title:"\u63d2\u5165\u8868\u683c",loading:!0});c.use("table/support",function(){var b=new c.TableUI(a);l.reload({offClick:function(){b._tableShow()},destroy:function(){b.destroy()}})}),this.destroy=function(){l.destroy()},a.addCustomStyle(h)})},{attach:!1}),KISSY.Editor.add("table/support",function(){function i(a){var b=this,c={};for(var e in w)(function(d){c[d]=function(){a.fire("save"),w[d](b),a.fire("save")}})(e);var h=d.ContextMenu.register({editor:a,statusChecker:v,rules:f,width:"120px",funcs:c});g.call(b,h),b.editor=a}function k(a){function h(a){if(f.length>0)return;a[0].nodeType==e.NODE_ELEMENT&&j.test(a._4e_name())&&!a.data("selected_cell")&&(a._4e_setMarker(g,"selected_cell",!0),f.push(a))}var b=a.createBookmarks(),c=a.getRanges(),f=[],g={};for(var i=0;i<c.length;i++){var k=c[i];if(k.collapsed){var l=k.getCommonAncestor(),m=l._4e_ascendant("td",!0)||l._4e_ascendant("th",!0);m&&f.push(m)}else{var n=new Walker(k),o;n.guard=h;while(o=n.next()){var p=o.parent();p&&j.test(p._4e_name())&&!p.data("selected_cell")&&(p._4e_setMarker(g,"selected_cell",!0),f.push(p))}}}return d.Utils.clearAllMarkers(g),a.selectBookmarks(b),f}function l(a){var d=a.cells;for(var e=0;e<d.length;e++)d[e].innerHTML="",b.ie||(new c(d[e]))._4e_appendBogus()}function m(a,b){var c=a.getStartElement()._4e_ascendant("tr");if(!c)return;var d=c._4e_clone(!0);d.insertBefore(c),l(b?d[0]:c[0])}function n(a){if(a instanceof d.Selection){var b=k(a),e=b.length,f=[],g,h,i;for(var j=0;j<e;j++){var l=b[j].parent(),m=l[0].rowIndex;!j&&(h=m-1),f[m]=l,j==e-1&&(i=m+1)}var o=l._4e_ascendant("table"),p=o[0].rows,q=p.length;g=new c(i<q&&o[0].rows[i]||h>0&&o[0].rows[h]||o[0].parentNode);for(j=f.length;j>=0;j--)f[j]&&n(f[j]);return g}return a instanceof c&&(o=a._4e_ascendant("table"),o[0].rows.length==1?o._4e_remove():a._4e_remove()),0}function o(a,d){var e=a.getStartElement(),f=e._4e_ascendant("td",!0)||e._4e_ascendant("th",!0);if(!f)return;var g=f._4e_ascendant("table"),h=f[0].cellIndex;for(var i=0;i<g[0].rows.length;i++){var j=g[0].rows[i];if(j.cells.length<h+1)continue;f=new c(j.cells[h].cloneNode(!1)),b.ie||f._4e_appendBogus();var k=new c(j.cells[h]);d?f.insertBefore(k):f.insertAfter(k)}}function p(a){var b=[],d=a[0]&&a[0]._4e_ascendant("table"),e,f,g,h;for(e=0,f=a.length;e<f;e++)b.push(a[e][0].cellIndex);b.sort();for(e=1,f=b.length;e<f;e++)if(b[e]-b[e-1]>1){g=b[e-1]+1;break}g||(g=b[0]>0?b[0]-1:b[b.length-1]+1);var i=d[0].rows;for(e=0,f=i.length;e<f;e++){h=i[e].cells[g];if(h)break}return h?new c(h):d._4e_previous()}function q(a){if(a instanceof d.Selection){var b=k(a),e=p(b);for(var f=b.length-1;f>=0;f--)b[f]&&q(b[f]);return e}if(a instanceof c){var g=a._4e_ascendant("table");if(!g)return null;var h=a[0].cellIndex;for(f=g[0].rows.length-1;f>=0;f--){var i=new c(g[0].rows[f]);if(!h&&i[0].cells.length==1){n(i);continue}i[0].cells[h]&&i[0].removeChild(i[0].cells[h])}}return null}function r(a,b){var c=new d.Range(a[0].ownerDocument);c.moveToElementEditablePosition(a,b?!0:undefined)||(c.selectNodeContents(a),c.collapse(b?!1:!0)),c.select(!0)}function s(a){var b=a.getSelection(),c=b&&b.getStartElement(),d=c&&c._4e_ascendant("table",!0);if(!d)return undefined;var e=c._4e_ascendant(function(a){var b=a._4e_name();return d.contains(a)&&(b=="td"||b=="th")},!0),f=c._4e_ascendant(function(a){var b=a._4e_name();return d.contains(a)&&b=="tr"},!0);return{table:d,td:e,tr:f}}function t(a){var b=s(a);return b&&b.td}function u(a){var b=s(a);return b&&b.tr}var a=KISSY,b=a.UA,c=a.Node,d=a.Editor,e=d.NODE,f=["tr","th","td","tbody","table"],g=d.Utils.addRes,h=d.Utils.destroyRes;a.augment(i,{_tableShow:function(a,b,c){var d=this.editor;d.showDialog("table/dialog",[b,c])},destroy:function(){h.call(this),this.editor.destroyDialog("table/dialog")}});var j=/^(?:td|th)$/,v={"\u8868\u683c\u5c5e\u6027":s,"\u5220\u9664\u8868\u683c":t,"\u5220\u9664\u5217":t,"\u5220\u9664\u884c":u,"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":u,"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":u,"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":t,"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":t},w={"\u8868\u683c\u5c5e\u6027":function(a){var b=a.editor,c=s(b);if(!c)return;a._tableShow(null,c.table,c.td)},"\u5220\u9664\u8868\u683c":function(a){var b=a.editor,c=b.getSelection(),d=c&&c.getStartElement(),e=d&&d._4e_ascendant("table",!0);if(!e)return;c.selectElement(e);var f=c.getRanges()[0];f.collapse(),c.selectRanges([f]);var g=e.parent();g[0].childNodes.length==1&&g._4e_name()!="body"&&g._4e_name()!="td"?g._4e_remove():e._4e_remove()},"\u5220\u9664\u884c ":function(a){var b=a.editor.getSelection();r(n(b),undefined)},"\u5220\u9664\u5217 ":function(a){var b=a.editor.getSelection(),c=q(b);c&&r(c,!0)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(a){var b=a.editor.getSelection();m(b,!0)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(a){var b=a.editor.getSelection();m(b,undefined)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(a){var b=a.editor.getSelection();o(b,!0)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(a){var b=a.editor.getSelection();o(b,undefined)}};d.TableUI=i},{attach:!1,requires:["contextmenu"]}),KISSY.Editor.add("tabs",function(){function h(a){this.cfg=a,this._init()}var a=KISSY,b=a.Editor,c=a.Node,d="li",e="div",f="rel",g="ke-tab-selected";if(b.Tabs){a.log("ke tabs attach more","warn");return}a.augment(h,a.EventTarget,{_init:function(){var b=this,h=b.cfg,i=h.tabs,j=h.contents,k=j.children(e),l=i.children(d);i.on("click",function(e){e&&e.preventDefault();var h=new c(e.target);if(h=h._4e_ascendant(function(a){return a._4e_name()===d&&i.contains(a)},!0)){l.removeClass(g);var j=h.attr(f);h.addClass(g),k.hide(),k.item(a.indexOf(h[0],l)).show(),b.fire(j)}})},getTab:function(b){var g=this,h=g.cfg,i=h.tabs,j=h.contents,k=j.children(e),l=i.children(d);for(var m=0;m<l.length;m++){var n=new c(l[m]),o=new c(k[m]);if(a.isNumber(b)&&b==m||a.isString(b)&&b==n.attr(f))return{tab:n,content:o}}},remove:function(a){var b=this.getTab(a);b.tab.remove(),b.content.remove()},_getActivate:function(){var a=this,b=a.cfg,e=b.tabs,h=e.children(d);for(var i=0;i<h.length;i++){var j=new c(h[i]);if(j.hasClass(g))return j.attr(f)}},activate:function(a){if(arguments.length==0)return this._getActivate();var b=this,c=b.cfg,f=c.tabs,h=c.contents,i=h.children(e),j=f.children(d);j.removeClass(g),i.hide();var k=this.getTab(a);k.tab.addClass(g),k.content.show()},destroy:function(){var a=this,b=a.cfg,c=b.tabs;c.detach(),c.remove()}}),b.Tabs=h},{attach:!1}),KISSY.Editor.add("templates",function(a){a.addPlugin("templates",function(){var b=KISSY,c=b.Editor,d=b.Node,e=b.DOM;e.addStyleSheet(".ke-tpl {    border: 2px solid #EEEEEE;    width: 95%;    margin: 20px auto;}.ke-tpl-list {    border: 1px solid #EEEEEE;    margin: 5px;    padding: 7px;    display: block;    text-decoration: none;    zoom: 1;}.ke-tpl-list:hover, .ke-tpl-selected {    background-color: #FFFACD;    text-decoration: none;    border: 1px solid #FF9933;}","ke-templates");var f=a.addButton("templates",{contentCls:"ke-toolbar-template",title:"\u6a21\u677f",mode:c.WYSIWYG_MODE,offClick:function(){var a=this;c.use("overlay",function(){a.cfg._prepare.call(a)})},_prepare:function(){var a=this,b=a.editor,e=b.cfg.pluginConfig.templates||[],f="<div class='ke-tpl'>";for(var g=0;g<e.length;g++){var h=e[g];f+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+h.demo+"</a>"}f+="</div>";var i=new c.Dialog({width:500,mask:!0,autoRender:!0,headerContent:"\u5185\u5bb9\u6a21\u677f",bodyContent:f}),j=i.get("el").all(".ke-tpl-list");j.on("click",function(a){a.halt();var c=new d(a.target),f=c._4e_index();f!=-1&&b.insertHtml(e[f].html),i.hide()}),a.ui=i,a.cfg.show.call(a),a.cfg._prepare=a.cfg.show},show:function(){this.ui.show()}});this.destroy=function(){f.destroy()}})},{attach:!1}),KISSY.Editor.add("undo",function(a){var b=KISSY,c=b.Editor,d={redo:1,undo:-1},e={mode:c.WYSIWYG_MODE,init:function(){var a=this,b=a.editor;b.on("afterSave afterRestore",a.cfg._respond,a),a.btn.disable()},offClick:function(){var a=this;a.editor.fire("restore",{d:d[a.cfg.flag]})}},f=b.mix({flag:"undo",_respond:function(a){var b=this,c=a.index,d=b.btn;c>0?d.boff():d.disable()}},e,!1),g=b.mix({flag:"redo",_respond:function(a){var b=this,c=a.history,d=a.index,e=b.btn;d<c.length-1?e.boff():e.disable()}},e,!1);a.addPlugin("undo",function(){var b=a.addButton("undo",{title:"\u64a4\u9500",loading:!0,contentCls:"ke-toolbar-undo"}),d=a.addButton("undo",{title:"\u91cd\u505a",loading:!0,contentCls:"ke-toolbar-redo"});c.use("undo/support",function(){new c.UndoManager(a),b.reload(f),d.reload(g)}),this.destroy=function(){b.destroy(),d.destroy()}})},{attach:!1}),KISSY.Editor.add("undo/support",function(){function g(a){var b=a._getRawData(),c=this,d;b&&(d=a.getSelection()),c.contents=b,c.bookmarks=d&&d.createBookmarks2(!0)}function h(a){var c=this;c.history=[],c.index=-1,c.editor=a,c.bufferRunner=b.Utils.buffer(c.save,c,500),c._init()}var a=KISSY,b=a.Editor,c=b.Utils.arrayCompare,d=a.UA,e=a.Event,f=30;a.augment(g,{equals:function(a){var b=this,d=b.contents,e=a.contents;if(d!=e)return!1;var f=b.bookmarks,g=a.bookmarks;if(f||g){if(!f||!g||f.length!=g.length)return!1;for(var h=0;h<f.length;h++){var i=f[h],j=g[h];if(i.startOffset!=j.startOffset||i.endOffset!=j.endOffset||!c(i.start,j.start)||!c(i.end,j.end))return!1}}return!0}});var i={16:1,17:1,18:1},j={37:1,38:1,39:1,40:1,33:1,34:1},k=90,l=89;a.augment(h,{_keyMonitor:function(){var a=this,b=a.editor,c=b.document;e.on([c,b.textarea],"keydown",function(a){var c=a.keyCode;if(c in j||c in i)return;if(c===k&&(a.ctrlKey||a.metaKey)){b.fire("restore",{d:-1}),a.halt();return}if(c===l&&(a.ctrlKey||a.metaKey)){b.fire("restore",{d:1}),a.halt();return}b.fire("save",{buffer:1})})},_init:function(){var a=this,c=a.editor;c.on("save",function(d){if(c.getMode()!=b.WYSIWYG_MODE)return;d.buffer?a.bufferRunner():a.save()}),c.on("restore",function(d){if(c.getMode()!=b.WYSIWYG_MODE)return;a.restore(d)}),a._keyMonitor(),setTimeout(function(){a.save()},0)},save:function(){var a=this,b=a.history,c=a.index;b.length>c+1&&b.splice(c+1,b.length-c-1);var d=a.editor,e=b[b.length-1],h=new g(d);if(!e||!e.equals(h))b.length===f&&b.shift(),b.push(h),a.index=c=b.length-1,d.fire("afterSave",{history:b,index:c})},restore:function(a){var b=a.d,c=this,e=c.history,f=c.editor,g=e[c.index+b];if(g){f._setRawData(g.contents);if(g.bookmarks)f.getSelection().selectBookmarks(g.bookmarks);else if(d.ie){var h=f.document.body.createTextRange();h.collapse(!0),h.select()}var i=f.getSelection();i&&i.scrollIntoView(),c.index+=b,f.fire("afterRestore",{history:e,index:c.index}),f.notifySelectionChange()}}}),b.UndoManager=h},{attach:!1});