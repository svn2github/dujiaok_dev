/*pub-2|2011-11-18 11:06:46*/KISSY.Editor.add("image/dialog",function(a){function J(){function N(a){return a.files?a.files[0].size:0}n=new c.Dialog({autoRender:!0,width:500,headerContent:"\u56fe\u7247",bodyContent:l,footerContent:m,mask:!0}),H.call(G,n);var a=n.get("el"),k=a.one(".ke-img-cancel"),A=a.one(".ke-img-insert"),D=c.Utils.verifyInputs,I=a.one(".ke-img-setting");y=a.one(".ke-img-upload-form"),w=a.one(".ke-img-local-url"),o=new c.Tabs({tabs:a.one("ul.ke-tabs"),contents:a.one("div.ke-image-tabs-content-wrap")}),H.call(G,o),w.val(z),p=a.one(".ke-img-url"),q=a.one(".ke-img-height"),r=a.one(".ke-img-width"),t=a.one(".ke-img-ratio"),s=c.Select.decorate(a.one(".ke-img-align")),u=a.one(".ke-img-margin");var J=c.Utils.placeholder;J(p,i),J(q,j),J(r,j),q.on("keyup",function(){var a=parseInt(q.val());if(!a||!t[0].checked||t[0].disabled||!v)return;r.val(Math.floor(a*v))}),H.call(G,q,p,r),r.on("keyup",function(){var a=parseInt(r.val());if(!a||!t[0].checked||t[0].disabled||!v)return;q.val(Math.floor(a/v))}),H.call(G,r),k.on("click",function(a){n.hide(),a.halt()}),H.call(G,k);var L=(new g("<a class='ke-button' style='position:absolute;z-index:"+c.baseZIndex(c.zIndexManager.LOADING_CANCEL)+";"+"left:-9999px;"+"top:-9999px;"+"'>\u53d6\u6d88\u4e0a\u4f20</a>")).appendTo(document.body),M=null;L.on("click",function(a){a&&a.halt(),n.unloading(),M&&(h.remove(M,"load"),d.remove(M)),L.css({left:-9999,top:-9999}),M=null}),H.call(G,L),A.on("click",function(d){d&&d.halt();if(o.activate()=="local"&&C){if(!D(I.all("input")))return;if(w.val()==z){alert("\u8bf7\u5148\u9009\u62e9\u6587\u4ef6!");return}if(!E.test(w.val())){alert(F),y[0].reset(),w.val(z);return}var e=N(x[0]);if(P&&P<e/1e3){alert("\u4e0a\u4f20\u56fe\u7247\u6700\u5927\uff1a"+P/1e3+"M");return}n.loading(),M=c.Utils.doFormUpload({form:y,callback:function(a){M=null,L.css({left:-9999,top:-9999});var c=b.trim(a.responseText).replace(/\r|\n/g,"");n.unloading();try{c=f.parse(c)}catch(d){b.log(c),c=null}c||(c={error:"\u670d\u52a1\u5668\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5"});if(c.error){alert(c.error);return}p.val(c.imgUrl),(new Image).src=c.imgUrl,K()}},C.serverParams,C.serverUrl);var g=n.get("el"),h=g.offset(),i=g[0].offsetWidth,j=g[0].offsetHeight;L.css({left:h.left+i/2.5,top:h.top+j/1.5})}else{if(!D(a.all("input")))return;K()}}),H.call(G,A);if(C){C.extraHtml&&a.one(".ke-img-up-extraHtml").html(C.extraHtml);var O=a.one(".ke-image-up"),P=C&&C.sizeLimit;x=(new g("<input type='file' style='position:absolute;cursor:pointer;left:"+(e.ie?"360":"369")+"px;"+"z-index:2;"+"top:0px;"+"height:26px;' "+"size='1' "+"name='"+(C.fileInput||"Filedata")+"'/>")).insertAfter(w),P&&(z="\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7 "+P/1e3+" M"),w.val(z),x.css("opacity",0),x.on("mouseenter",function(){O.addClass("ke-button-hover")}),x.on("mouseleave",function(){O.removeClass("ke-button-hover")}),x.on("change",function(){var a=x.val();w.val(a.replace(/.+[\/\\]/,""))}),H.call(G,x),B.remote===!1&&o.remove("remote")}else o.remove("local")}function K(){var b=p.val(),c=parseInt(q.val()),d=parseInt(r.val()),e=s.val(),f=parseInt(u.val()),h="";c&&(h+="height:"+c+"px;"),d&&(h+="width:"+d+"px;"),e&&(h+="float:"+e+";"),isNaN(f)||(h+="margin:"+f+"px;"),n.hide();if(A)a.fire("save"),A.attr({src:b,_ke_saved_src:b,style:h}),a.fire("save");else{var i=new g("<img "+(h?"style='"+h+"'":"")+" src='"+b+"' "+"_ke_saved_src='"+b+"' alt='' />",null,a.document);a.insertElement(i,function(a){a.on("abort error",function(){a.detach(),a[0].src=b})})}}function L(a){var b="remote",d=c.Utils.resetInput,e=c.Utils.valInput;A=a;if(A&&B.remote!==!1){e(p,A.attr("src"));var f=A.width(),g=A.height();e(q,g),e(r,f),s.val(A.css("float")||"none");var h=parseInt(A._4e_style("margin"))||0;u.val(h),t[0].disabled=!1,v=f/g}else o.getTab("local")&&(b="local"),d(p),d(q),d(r),s.val("none"),u.val(k),t[0].disabled=!0,v=null;y[0].reset(),w.val(z),o.activate(b)}var b=KISSY,c=b.Editor,d=b.DOM,e=b.UA,f=b.JSON,g=b.Node,h=b.Event,i="http://",j="\u81ea\u52a8",k=0,l="<div class='ke-image-wrap'><ul class='ke-tabs ks-clear'><li rel='remote'>\u7f51\u7edc\u56fe\u7247</li><li rel='local'>\u672c\u5730\u4e0a\u4f20</li></ul><div style='padding:12px 20px 5px 20px;'><div class='ke-image-tabs-content-wrap' ><div><label><span class='ke-image-title'>\u56fe\u7247\u5730\u5740\uff1a </span><input  data-verify='^(https?:/)?/[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp:// \u6216 /' class='ke-img-url ke-input' style='width:390px;' /></label></div><div style='position:relative;'><form class='ke-img-upload-form' method='post'><p style='zoom:1;'><input class='ke-input ke-img-local-url' readonly='readonly' style='margin-right: 15px; vertical-align: middle; width: 368px;color:#969696;'/><a style='padding:3px 11px;position:absolute;left:390px;top:0px;z-index:1;' class='ke-image-up ke-button'>\u6d4f\u89c8...</a></p><div class='ke-img-up-extraHtml'></div></form></div></div><table style='width:100%;margin-top:8px;' class='ke-img-setting'><tr><td><label>\u5bbd\u5ea6\uff1a <input  data-verify='^("+j+"|((?!0$)\\d+))?$' "+" data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' "+"class='ke-img-width ke-input' "+"style='vertical-align:middle;width:60px' "+"/> \u50cf\u7d20 </label>"+"</td>"+"<td>"+"<label>"+"\u9ad8\u5ea6\uff1a "+"<input "+" data-verify='^("+j+"|((?!0$)\\d+))?$' "+" data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' "+"class='ke-img-height ke-input' "+"style='vertical-align:middle;width:60px' "+"/> \u50cf\u7d20 </label>"+"<label>"+"<input "+"type='checkbox' "+"class='ke-img-ratio' "+"style='vertical-align:middle;"+"margin-left:5px;"+"' "+"checked='checked'/>"+" \u9501\u5b9a\u9ad8\u5bbd\u6bd4"+"</label>"+"</td>"+"</tr>"+"<tr>"+"<td>"+"<label>"+"\u5bf9\u9f50\uff1a"+"<select class='ke-img-align' title='\u5bf9\u9f50'>"+"<option value='none'>\u65e0</option>"+"<option value='left'>\u5de6\u5bf9\u9f50</option>"+"<option value='right'>\u53f3\u5bf9\u9f50</option>"+"</select>"+"</label>"+"</td>"+"<td><label>"+"\u95f4\u8ddd\uff1a "+"<input "+""+" data-verify='^\\d+$' "+" data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6574\u6570' "+"class='ke-img-margin ke-input' style='width:60px' value='"+k+"'/> \u50cf\u7d20"+"</label>"+"</td>"+"</tr>"+"</table>"+"</div>"+"</div>",m="<div style='padding:5px 20px 20px;'><a class='ke-img-insert ke-button' style='margin-right:30px;'>\u786e\u5b9a</a> <a  class='ke-img-cancel ke-button'>\u53d6\u6d88</a></div>",n,o,p,q,r,s,t,u,v,w,x,y,z="\u8bf7\u70b9\u51fb\u6d4f\u89c8\u4e0a\u4f20\u56fe\u7247",A,B=a.cfg.pluginConfig.image||{},C=B.upload||null,D=C&&C.suffix||"png,jpg,jpeg,gif",E=new RegExp(D.split(/,/).join("|")+"$","i"),F="\u53ea\u5141\u8bb8\u540e\u7f00\u540d\u4e3a"+D+"\u7684\u56fe\u7247",G={},H=c.Utils.addRes,I=c.Utils.destroyRes;c.use("overlay,tabs,select",function(){J(),a.addDialog("image/dialog",{show:function(a){L(a),n.show()},hide:function(){n.hide()},destroy:function(){I.call(G)},dialog:n})})},{attach:!1});