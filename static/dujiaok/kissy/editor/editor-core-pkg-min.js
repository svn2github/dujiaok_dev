/*
 Constructor for kissy editor,dependency moved to independent module
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2
 @buildtime: 2011-11-29 15:10:44
*/
KISSY.add("editor/export",function(w){function C(z,u){var t=this;if(!(t instanceof C))return new C(z,u);if(w.isString(z))z=w.one(z);z=D._4e_wrap(z);u=u||{};u.pluginConfig=u.pluginConfig||{};t.cfg=u;u.pluginConfig=u.pluginConfig;t.cfg=u;w.app(t,w.EventTarget);var g=["htmldataprocessor","enterkey","clipboard"],d=q;t.use=function(b,f){b=b.split(",");if(!d)for(var o=0;o<g.length;o++){var A=g[o];w.inArray(A,b)||b.unshift(A)}t.ready(function(){w.Editor.use("button,select",function(){w.use.call(t,b.join(","),
function(){for(var a=0;a<b.length;a++)t.usePlugin(b[a]);f&&f.call(t);if(!d){t.setData(z.val());if(u.focus)t.focus();else(a=t.getSelection())&&a.removeAllRanges();d=H}},{global:C})})});return t};t.use=t.use;t.Config.base=C.Config.base;t.Config.debug=C.Config.debug;t.Config.componentJsName=v;t.init(z)}var D=w.DOM,H=true,q=false,v;v=parseFloat(w.version)<1.2?function(){return"plugin-min.js?t="+encodeURIComponent("2011-11-29 15:10:44")}:function(z,u){return z+"/plugin-min.js"+(u?u:"?t="+encodeURIComponent("2011-11-29 15:10:44"))};
w.app(C,w.EventTarget);C.Config.base=w.Config.base+"editor/plugins/";C.Config.debug=w.Config.debug;C.Config.componentJsName=v;w.Editor=C;w.Editor=C});KISSY.add("editor",function(w){return w.Editor},{requires:["dd","overlay"]});
KISSY.Editor.add("utils",function(w){var C=null,D=KISSY,H=D.Node,q=D.DOM,v=D.UA,z=D.Event,u;u=v.ie?document.documentMode||v.ie:void 0;var t={debugUrl:function(g){g=g.replace(/-min\.(js|css)/i,".$1");w.Config.debug||(g=g.replace(/\.(js|css)/i,"-min.$1"));if(g.indexOf("?t")==-1){g+=g.indexOf("?")!=-1?"&":"?";g+="t="+encodeURIComponent("2011-11-26 21:29:45")}return w.Config.base+g},lazyRun:function(g,d,b){var f=g[d],o=g[b];g[d]=function(){f.apply(this,arguments);g[d]=g[b];return o.apply(this,arguments)}},
getXY:function(g,d,b,f){b=b.defaultView||b.parentWindow;g-=q.scrollLeft(b);d-=q.scrollTop(b);if(f)if(b!=(f.defaultView||f.parentWindow)&&b.frameElement){f=q._4e_getOffset(b.frameElement,f);g+=f.left;d+=f.top}return{left:g,top:d}},tryThese:function(){for(var g,d=0,b=arguments.length;d<b;d++){var f=arguments[d];try{g=f();break}catch(o){}}return g},arrayCompare:function(g,d){if(!g&&!d)return true;if(!g||!d||g.length!=d.length)return false;for(var b=0;b<g.length;b++)if(g[b]!==d[b])return false;return true},
getByAddress:function(g,d,b){g=g.documentElement;for(var f=0;g&&f<d.length;f++){var o=d[f];if(b)for(var A=-1,a=0;a<g.childNodes.length;a++){var e=g.childNodes[a];if(!(b===true&&e.nodeType==3&&e.previousSibling&&e.previousSibling.nodeType==3)){A++;if(A==o){g=e;break}}}else g=g.childNodes[o]}return g?new H(g):C},clearAllMarkers:function(g){for(var d in g)g[d]._4e_clearMarkers(g,true)},htmlEncodeAttr:function(g){return g.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(g){return g.replace(/^\s+/,
"")},rtrim:function(g){return g.replace(/\s+$/,"")},trim:function(g){return this.ltrim(this.rtrim(g))},mix:function(){for(var g={},d=0;d<arguments.length;d++)g=D.mix(g,arguments[d]);return g},isCustomDomain:function(){if(!v.ie)return false;var g=document.domain,d=window.location.hostname;return g!=d&&g!="["+d+"]"},buffer:function(g,d,b){b=b||0;var f=C;return function(){f&&clearTimeout(f);var o=arguments;f=setTimeout(function(){return g.apply(d,o)},b)}},isNumber:function(g){return/^\d+(.\d+)?$/.test(D.trim(g))},
verifyInputs:function(g){for(var d=0;d<g.length;d++){var b=q._4e_wrap(g[d]),f=D.trim(t.valInput(b)),o=b.attr("data-verify");b=b.attr("data-warning");if(o&&!RegExp(o).test(f)){alert(b);return false}}return true},sourceDisable:function(g,d){g.on("sourcemode",d.disable,d);g.on("wysiwygmode",d.enable,d)},resetInput:function(g){var d=g.attr("placeholder");if(d&&v.ie){g.addClass("ke-input-tip");g.val(d)}else v.ie||g.val("")},valInput:function(g,d){if(d===undefined)return g.hasClass("ke-input-tip")?"":g.val();
else{g.removeClass("ke-input-tip");g.val(d)}},placeholder:function(g,d){g.attr("placeholder",d);if(v.ie){g.on("blur",function(){if(!D.trim(g.val())){g.addClass("ke-input-tip");g.val(d)}});g.on("focus",function(){g.removeClass("ke-input-tip");D.trim(g.val())==d&&g.val("")})}},htmlEncode:function(g){return!g?g:String(g).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(g){g=D.clone(g);for(var d in g)if(g.hasOwnProperty(d)){var b=g[d];if(D.isFunction(b))g[d]=
b()}return g},doFormUpload:function(g,d,b){function f(){var j={responseText:"",responseXML:C};j.argument=g?g.argument:C;try{var l;if((l=v.ie?A.contentWindow.document:A.contentDocument||window.frames[o].document)&&l.body)j.responseText=D.trim(q.text(l.body));j.responseXML=l&&l.XMLDocument?l.XMLDocument:l}catch(r){D.log("after data returns error ,maybe domain problem:");D.log(r,"error")}z.remove(A,"load",f);g.callback&&g.callback(j);setTimeout(function(){q._4e_remove(A)},100)}var o=D.guid("form-upload-"),
A=document.createElement("iframe");A.id=o;A.name=o;A.className="ke-hidden";var a="document.open();"+(t.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(v.ie)A.src=v.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";D.log("doFormUpload : "+A.src);document.body.appendChild(A);if(v.ie)document.frames[o].name=o;a=q._4e_unwrap(g.form);var e={target:q.attr(a,"target"),method:q.attr(a,"method"),encoding:q.attr(a,"encoding"),enctype:q.attr(a,"enctype"),action:q.attr(a,
"action")};q.attr(a,{target:o,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});b&&q.attr(a,"action",b);var k;if(d){k=[];d=w.Utils.normParams(d);for(var i in d)if(d.hasOwnProperty(i)){b=document.createElement("input");b.type="hidden";b.name=i;b.value=d[i];a.appendChild(b);k.push(b)}}z.on(A,"load",f);a.submit();q.attr(a,e);if(k){d=0;for(i=k.length;d<i;d++)q._4e_remove(k[d])}return A},map:function(g,d){for(var b=0;b<g.length;b++)g[b]=d(g[b]);return g},ieEngine:u,preventFocus:function(g){v.ie?
g._4e_unselectable():g.attr("onmousedown","return false;")},isFlashEmbed:function(g){g=g.attributes;return g.type=="application/x-shockwave-flash"||/\.swf(?:$|\?)/i.test(g.src||"")},addRes:function(){var g=this.__res=this.__res||[];g.push.apply(g,D.makeArray(arguments))},destroyRes:function(){for(var g=this.__res||[],d=0;d<g.length;d++){var b=g[d];if(D.isFunction(b))b();else{b.detach&&b.detach();b.destroy&&b.destroy();b.nodeType&&b.remove&&b.remove()}}this.__res=[]}};return w.Utils=t});
KISSY.Editor.add("dom",function(w){function C(a){return a.replace(/-(\w)/g,function(e,k){return k.toUpperCase()})}var D=KISSY,H=D.DOM,q=D.UA,v=D.Node,z=w.Utils,u={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};w.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};w.NODE=w.NODE;w.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};w.POSITION=w.POSITION;var t=w.NODE,g=w.POSITION,d={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},b={hr:1},f=function(a){return a[0]||a},o=function(a){if(a&&!a[0])return new v(a);return a},A={_4e_wrap:o,_4e_unwrap:f,_4e_equals:function(a,e){if(!a&&!e)return true;if(!a||!e)return false;a=f(a);e=f(e);
return a===e},_4e_isBlockBoundary:function(a,e){a=o(a);var k=D.mix(D.mix({},b),e||{});return d[a.css("display")]||k[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=f(a);for(var e=a.parentNode.childNodes,k=0;k<e.length;k++)if(e[k]===a)return k;return-1},_4e_first:function(a,e){a=f(a);var k=a.firstChild;if((k=k&&new v(k))&&e&&!e(k))k=k._4e_next(e);return k},_4e_move:function(a,e,k){a=f(a);H._4e_remove(a);
e=f(e);k?e.insertBefore(a,e.firstChild):e.appendChild(a)},_4e_name:function(a){a=f(a);var e=a.nodeName.toLowerCase();if(q.ie)if((a=a.scopeName)&&a!="HTML")e=a.toLowerCase()+":"+e;return e},_4e_isIdentical:function(a,e){if(a._4e_name()!=e._4e_name())return false;var k=a[0].attributes,i=e[0].attributes,j=k.length,l=i.length;if(j!=l)return false;for(var r=0;r<j;r++){var p=k[r],x=p.name;if(p.specified&&a.attr(x)!=e.attr(x))return false}if(z.ieEngine<8)for(r=0;r<l;r++){p=i[r];x=p.name;if(p.specified&&
a.attr(x)!=e.attr(x))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=f(a).childNodes;for(var e=0,k=a.length;e<k;e++){var i=a[e],j=i.nodeType;if(!(j==t.NODE_ELEMENT&&i.getAttribute("_ke_bookmark")))if(j==t.NODE_ELEMENT&&!A._4e_isEmptyInlineRemoveable(i)||j==t.NODE_TEXT&&D.trim(i.nodeValue))return false}return true},_4e_moveChildren:function(a,e,k){a=f(a);e=e[0]||e;if(a!=e)if(k)for(;k=a.lastChild;)e.insertBefore(a.removeChild(k),e.firstChild);else for(;k=a.firstChild;)e.appendChild(a.removeChild(k))},
_4e_mergeSiblings:function(){function a(e,k,i){if(k[0]&&k[0].nodeType==t.NODE_ELEMENT){for(var j=[];k.attr("_ke_bookmark")||k._4e_isEmptyInlineRemoveable();){j.push(k);k=i?new v(k[0].nextSibling):new v(k[0].previousSibling);if(!k[0]||k[0].nodeType!=t.NODE_ELEMENT)return}if(e._4e_isIdentical(k)){for(var l=i?e[0].lastChild:e[0].firstChild;j.length;)j.shift()._4e_move(e,!i);k._4e_moveChildren(e,!i);k._4e_remove();l[0]&&l[0].nodeType==t.NODE_ELEMENT&&l._4e_mergeSiblings()}}}return function(e){if(e[0])if(u[e._4e_name()]||
e._4e_name()=="a"){a(e,new v(e[0].nextSibling),true);a(e,new v(e[0].previousSibling))}}}(),_4e_unselectable:q.gecko?function(a){a=f(a);a.style.MozUserSelect="none"}:q.webkit?function(a){a=f(a);a.style.KhtmlUserSelect="none"}:function(a){a=f(a);if(q.ie||q.opera){var e=0;a.setAttribute("unselectable","on");for(var k=a.getElementsByTagName("*");a=k[e++];)switch(a.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:a.setAttribute("unselectable","on")}}},_4e_getOffset:function(a,
e){a=f(a);var k,i=0;k=0;var j=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,l=a.ownerDocument,r=l.documentElement;e=e||l;if(a.getBoundingClientRect){if(a!==l.body&&r!==a){k=a.getBoundingClientRect();i=k.left+(e===l?H.scrollLeft(j):0);k=k.top+(e===l?H.scrollTop(j):0)}if(e)if(j!=(e.defaultView||e.parentWindow)&&j.frameElement){j=A._4e_getOffset(j.frameElement,e);i+=j.left;k+=j.top}}return{left:i,top:k}},_4e_splitText:function(a,e){a=f(a);var k=a.ownerDocument;if(!(!a||a.nodeType!=t.NODE_TEXT)){if(q.ie&&
e==a.nodeValue.length){var i=k.createTextNode("");H.insertAfter(i,a);return new v(i)}i=new v(a.splitText(e));if(k.documentMode){k=k.createTextNode("");H.insertAfter(k,i[0]);H._4e_remove(k)}return i}},_4e_parents:function(a,e){a=o(a);var k=[];do k[e?"push":"unshift"](a);while(a=a.parent());return k},_4e_clone:function(a,e,k){a=f(a);a=a.cloneNode(e);if(!k){var i=function(j){if(j.nodeType==t.NODE_ELEMENT){j.removeAttribute("id");j=j.childNodes;for(var l=0;l<j.length;l++)i(j[l])}};i(a)}return new v(a)},
_4e_nextSourceNode:function(a,e,k,i){a=f(a);if(i&&!i.call){var j=i[0]||i;i=function(r){r=r[0]||r;return r!==j}}e=!e&&a.firstChild;var l=new v(a);if(!e){if(a.nodeType==t.NODE_ELEMENT&&i&&i(a,true)===false)return null;e=a.nextSibling}for(;!e&&(l=l.parent());){if(i&&i(l,true)===false)return null;e=l[0].nextSibling}if(!e)return null;e=H._4e_wrap(e);if(i&&i(e)===false)return null;if(k&&k!=e[0].nodeType)return e._4e_nextSourceNode(false,k,i);return e},_4e_previousSourceNode:function(a,e,k,i){a=f(a);if(i&&
!i.call){var j=i[0]||i;i=function(r){r=r[0]||r;return r!==j}}e=!e&&a.lastChild;var l=new v(a);if(!e){if(a.nodeType==t.NODE_ELEMENT&&i&&i(a,true)===false)return null;e=a.previousSibling}for(;!e&&(l=l.parent());){if(i&&i(l,true)===false)return null;e=l[0].previousSibling}if(!e)return null;e=H._4e_wrap(e);if(i&&i(e)===false)return null;if(k&&e[0].nodeType!=k)return e._4e_previousSourceNode(false,k,i);return e},_4e_commonAncestor:function(a,e){if(a._4e_equals(e))return a;if(e[0].nodeType!=t.NODE_TEXT&&
e.contains(a))return e;var k=a[0].nodeType==t.NODE_TEXT?a.parent():a;do if(k[0].nodeType!=t.NODE_TEXT&&k.contains(e))return k;while(k=k.parent());return null},_4e_ascendant:function(a,e,k){a=f(a);if(!k)a=a.parentNode;if(e&&!D.isFunction(e)){var i=e;e=function(j){return j._4e_name()==i}}for(;a&&a.nodeType!=9;){if(!e||e(new v(a))===true)return new v(a);a=a.parentNode}return null},_4e_hasAttribute:z.ieEngine<9?function(a,e){a=f(a);var k=a.getAttributeNode(e);return!!(k&&k.specified)}:function(a,e){a=
f(a);return a.hasAttribute(e)},_4e_hasAttributes:z.ieEngine<9?function(a){a=f(a);for(var e=a.attributes,k=0;k<e.length;k++){var i=e[k];switch(i.name){case "class":if(a.getAttribute("class"))return true;break;default:if(i.specified)return true}}return false}:function(a){a=f(a);q.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,e){var k=f(a),i=f(e);if(k.compareDocumentPosition)return k.compareDocumentPosition(i);if(k==i)return g.POSITION_IDENTICAL;if(k.nodeType==
t.NODE_ELEMENT&&i.nodeType==t.NODE_ELEMENT){if(k.contains){if(k.contains(i))return g.POSITION_CONTAINS+g.POSITION_PRECEDING;if(i.contains(k))return g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING}if("sourceIndex"in k)return k.sourceIndex<0||i.sourceIndex<0?g.POSITION_DISCONNECTED:k.sourceIndex<i.sourceIndex?g.POSITION_PRECEDING:g.POSITION_FOLLOWING}k=a._4e_address();i=e._4e_address();for(var j=Math.min(k.length,i.length),l=0;l<=j-1;l++)if(k[l]!=i[l]){if(l<j)return k[l]<i[l]?g.POSITION_PRECEDING:g.POSITION_FOLLOWING;
break}return k.length<i.length?g.POSITION_CONTAINS+g.POSITION_PRECEDING:g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING},_4e_address:function(a,e){a=f(a);for(var k=[],i=a.ownerDocument.documentElement,j=a;j&&j!=i;){var l=j.parentNode,r=-1;if(l){for(var p=0;p<l.childNodes.length;p++){var x=l.childNodes[p];if(!(e&&x.nodeType==3&&x.previousSibling&&x.previousSibling.nodeType==3)){r++;if(x==j)break}}k.unshift(r)}j=l}return k},_4e_breakParent:function(a,e){var k=new w.Range(a[0].ownerDocument);k.setStartAfter(a);
k.setEndAfter(e);var i=k.extractContents();k.insertNode(a._4e_remove());a[0].parentNode.insertBefore(i,a[0].nextSibling)},_4e_style:function(a,e,k){if(k!==undefined){a=o(a);a.css(e,k);a.attr("style")||a.removeAttr("style")}else{a=f(a);return a.style[C(e)]}},_4e_remove:function(a,e){var k=f(a),i=k.parentNode;if(i){if(e)for(var j;j=k.firstChild;)i.insertBefore(k.removeChild(j),k);i.removeChild(k)}return a},_4e_trim:function(a){H._4e_ltrim(a);H._4e_rtrim(a)},_4e_ltrim:function(a){a=f(a);for(var e;e=
a.firstChild;){if(e.nodeType==t.NODE_TEXT){var k=z.ltrim(e.nodeValue),i=e.nodeValue.length;if(k){if(k.length<i){(new v(e))._4e_splitText(i-k.length);a.removeChild(a.firstChild)}}else{a.removeChild(e);continue}}break}},_4e_rtrim:function(a){a=f(a);for(var e;e=a.lastChild;){if(e.type==t.NODE_TEXT){var k=z.rtrim(e.nodeValue),i=e.nodeValue.length;if(k){if(k.length<i){(new v(e))._4e_splitText(k.length);a.removeChild(a.lastChild)}}else{a.removeChild(e);continue}}break}if(!q.ie&&!q.opera)(e=a.lastChild)&&
e.nodeType==1&&e.nodeName.toLowerCase()=="br"&&e.parentNode.removeChild(e)},_4e_appendBogus:function(a){a=f(a);for(var e=a.lastChild;e&&e.nodeType==t.NODE_TEXT&&!D.trim(e.nodeValue);)e=e.previousSibling;if(!e||e.nodeType==t.NODE_TEXT||H._4e_name(e)!=="br"){e=q.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");q.gecko&&e.setAttribute("type","_moz");a.appendChild(e)}},_4e_previous:function(a,e){var k=f(a),i;do i=(k=k.previousSibling)&&new v(k);while(i&&e&&!e(i));return i},
_4e_last:function(a,e){a=H._4e_wrap(a);var k=a[0].lastChild;if((k=k&&new v(k))&&e&&!e(k))k=k._4e_previous(e);return k},_4e_next:function(a,e){var k=f(a),i;do i=(k=k.nextSibling)&&new v(k);while(i&&e&&!e(i));return i},_4e_outerHtml:function(a){a=f(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var e=a.ownerDocument.createElement("div");e.appendChild(a.cloneNode(true));return e.innerHTML},_4e_setMarker:function(a,e,k,i){a=H._4e_wrap(a);var j=a.data("list_marker_id")||a.data("list_marker_id",
D.guid()).data("list_marker_id"),l=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");e[j]=a;l[k]=1;return a.data(k,i)},_4e_clearMarkers:function(a,e,k){a=o(a);var i=a.data("list_marker_names"),j=a.data("list_marker_id"),l;for(l in i)a.removeData(l);a.removeData("list_marker_names");if(k){a.removeData("list_marker_id");delete e[j]}},_4e_copyAttributes:function(a,e,k){a=f(a);e=o(e);var i=a.attributes;k=k||{};for(var j=0;j<i.length;j++){var l=i[j],r=l.name.toLowerCase(),
p;if(!(r in k))if(r=="checked"&&(p=H.attr(a,r)))e.attr(r,p);else if(l.specified||q.ie&&l.value&&r=="value"){p=H.attr(a,r);if(p===null)p=l.nodeValue;e.attr(r,p)}}if(a.style.cssText!=="")e[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=H._4e_name(a);var e=w.XHTML_DTD;return(a=!e.$nonEditable[a]&&(e[a]||e.span))&&a["#"]},_4e_scrollIntoView:function(a){a=o(a);a.scrollIntoView(a[0].ownerDocument,false)},_4e_getElementsByTagName:function(a,e,k){a=f(a);if(!q.ie&&k)e=k+":"+e;k=[];a=a.getElementsByTagName(e);
for(e=0;e<a.length;e++)k.push(new v(a[e]));return k}};(function(a){D.mix(H,a);for(var e in a)a.hasOwnProperty(e)&&function(k){v.prototype[k]=function(){var i=[].slice.call(arguments,0);i.unshift(this);return a[k].apply(null,i)}}(e)})(A)});
KISSY.Editor.add("focusmanager",function(w){function C(){var f=this;f.iframeFocus=g;t=f;u&&clearTimeout(u);u=setTimeout(function(){f.fire("focus")},100)}function D(){var f=this;f.iframeFocus=d;t=b;u&&clearTimeout(u);u=setTimeout(function(){f.fire("blur")},100)}var H=KISSY,q=H.DOM,v=H.Event,z={},u,t;H={refreshAll:function(){for(var f in z){var o=z[f];o.document.designMode="off";o.document.designMode="on"}},currentInstance:function(){return t},getInstance:function(f){return z[f]},add:function(f){var o=
q._4e_getWin(f.document);v.on(o,"focus",C,f);v.on(o,"blur",D,f)},register:function(f){z[f._UUID]=f},remove:function(f){delete z[f._UUID];var o=q._4e_getWin(f.document);v.remove(o,"focus",C,f);v.remove(o,"blur",D,f)}};var g=true,d=false,b=null;H.refreshAll=H.refreshAll;w.focusManager=H;w.focusManager=H;w.getInstances=function(){return z};w.getInstances=w.getInstances});
KISSY.Editor.add("definition",function(w){var C=true,D=false,H=w.Utils,q=document,v=KISSY,z=v.UA,u=z.ie,t=v.DOM,g=v.Node,d=v.Event,b=w.focusManager,f=H.tryThese,o=1,A="document.open();"+(H.isCustomDomain()?'document.domain="'+q.domain+'";':"")+"document.close();",a="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"' ></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(u?' src="javascript:void(function(){'+encodeURIComponent(A)+'}())"':"")+' allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>",e,k;e=w.SOURCE_MODE=0;k=w.WYSIWYG_MODE=1;w.SOURCE_MODE=e;w.WYSIWYG_MODE=k;v.augment(w,{init:function(i){var j=this;j.__commands={};j.__dialogs={};j.__plugins={};u&&t.addClass(q.body,"ke-ie"+u);if(z.trident)t.addClass(q.body,"ke-trident"+z.trident);else if(z.gecko)t.addClass(q.body,"ke-gecko");else z.webkit&&t.addClass(q.body,
"ke-webkit");var l=new g(a);j.editorWrap=l;j._UUID=o++;b.register(j);j.wrap=l.one(".ke-textarea-wrap");j.wrap=j.wrap;j.iframe=j.wrap.one("iframe");j.iframe=j.iframe;j.toolBarDiv=l.one(".ke-editor-tools");j.toolBarDiv=j.toolBarDiv;j.textarea=i;j.textarea=j.textarea;j.statusDiv=l.one(".ke-editor-status");j.statusDiv=j.statusDiv;H.preventFocus(j.toolBarDiv);var r=i._4e_style("width"),p=i._4e_style("height");if(r){l.css("width",r);i.css("width","100%")}j.textarea.css("display","none");l.insertAfter(i);
j.wrap[0].appendChild(i[0]);if(p){j.wrap.css("height",p);i.css("height","100%")}l=j.iframe;if(i._4e_hasAttribute("tabindex"))l[0].tabIndex=z.webkit?-1:i[0].tabIndex;j.on("dataReady",function(){j._ready=C;w.fire("instanceCreated",{editor:j})});z.gecko?l.on("load",j._setUpIFrame,j):j._setUpIFrame();j.cfg.attachForm&&i[0].form&&j._attachForm()},destroy:function(){if(!this.__destroyed){var i=this.editorWrap,j=this.textarea,l=this.document,r=this.iframe[0].contentWindow;this.sync();w.focusManager.remove(this);
d.remove(l);d.remove(l.documentElement);d.remove(l.body);d.remove(r);this.iframe.detach();l=this.__plugins;for(var p in l)if(l.hasOwnProperty(p)){r=l[p];r.destroy&&r.destroy()}this.fire("destroy");j.insertBefore(i);i.remove();j.css({width:i[0].style.width,height:this.wrap.css("height")});j.show();this.__commands=this.__dialogs=this.__plugins=null;this.detach();this.__destroyed=true}},_attachForm:function(){var i=this,j=new g(i.textarea[0].form);j.on("submit",i.sync,i);i.on("destroy",function(){j.detach("submit",
i.sync,i)})},useDialog:function(i,j){var l=this,r=w.Overlay;r&&r.loading();l.use(i,function(){var p=l.getDialog(i);if(p){j(p);r&&r.unloading()}else v.later(arguments.callee,50,false,l)})},showDialog:function(i,j,l){var r=this;j=j||[];r.useDialog(i,function(p){p.show.apply(p,j);l&&l(p);r.fire("dialogShow",{dialog:p.dialog,pluginDialog:p,dialogName:i})})},addDialog:function(i,j){this.__dialogs[i]=j},getDialog:function(i){return this.__dialogs[i]},destroyDialog:function(i){var j=this.__dialogs[i];j&&
j.destroy();this.__dialogs[i]=null},addCommand:function(i,j){this.__commands[i]=j},hasCommand:function(i){return this.__commands[i]},execCommand:function(i){var j=this.__commands[i],l=v.makeArray(arguments);l.shift();l.unshift(this);return j.exec.apply(j,l)},getMode:function(){return this.textarea.css("display")=="none"?k:e},getData:function(i){var j;j=this.getMode()==k?this.document&&this.document.body?this.document.body.innerHTML:"":this.textarea.val();if(this.htmlDataProcessor)j=i?this.htmlDataProcessor.toHtml(j,
"p"):this.htmlDataProcessor.toServer(j,"p");j=v.trim(j);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(j))j="";return j},setData:function(i){var j=i;if(this.htmlDataProcessor)j=this.htmlDataProcessor.toDataFormat(i,"p");this.document.body.innerHTML=j;if(!j)this.document.body.innerHTML=j;this.getMode()!=k&&this.textarea.val(i)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(i){this.document.body.innerHTML=i},_prepareIFrameHtml:function(i){var j=
this.cfg,l=j.customStyle;j=j.customLink;var r="",p=w.Utils.debugUrl("../theme/editor-iframe.css");if(j)for(var x=0;x<j.length;x++)r+='<link href="'+j[x]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+p+"' rel='stylesheet'/><style>"+(l||"")+"</style>"+r+"</head><body class='ke-editor'>&nbsp;"+(i?'<script id="ke_actscript" type="text/javascript">'+(H.isCustomDomain()?'document.domain="'+q.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+i+'");<\/script>':
"")+"</body></html>"},getSelection:function(){return w.Selection.getSelection(this.document)},focus:function(){var i=this.document,j=t._4e_getWin(i);z.ie||j&&j.parent&&j.parent.focus();j&&j.focus();i&&i.body.focus();this.notifySelectionChange()},blur:function(){t._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(i){var j=this.cfg,l=this.document;j.customStyle=j.customStyle||"";j.customStyle+="\n"+i;j=l.createElement("style");l.getElementsByTagName("head")[0].appendChild(j);
if(j.styleSheet)j.styleSheet.cssText=i;else j.appendChild(l.createTextNode(i))},addCustomLink:function(i){var j=this.cfg,l=this.document;j.customLink=j.customLink||[];j.customLink.push(i);j=l.createElement("link");j.rel="stylesheet";l.getElementsByTagName("head")[0].appendChild(j);j.href=i},removeCustomLink:function(i){for(var j=this.cfg,l=v.makeArray(this.document.getElementsByTagName("link")),r=0;r<l.length;r++)l[r].href==i&&t._4e_remove(l[r]);j.customLink=j.customLink||[];j=j.customLink;i=v.indexOf(i,
j);i!=-1&&j.splice(i,1)},_setUpIFrame:function(){function i(){x=p.document;j.document=x;l.detach();x.open("text/html","replace");x.write(r);x.close()}var j=this,l=j.iframe,r=j._prepareIFrameHtml(j._UUID),p=l[0].contentWindow,x;try{x=p.document}catch(G){l[0].src=l[0].src;if(u<7){setTimeout(i,10);return}}i()},ready:function(i){this._ready?i():this.on("dataReady",i)},addPlugin:function(i,j,l){this.__plugins=this.__plugins;l=l||{};l.func=j;this.__plugins[i]=l},usePlugin:function(i){var j=this.__plugins[i];
if(j)if(!(j.status&&!j.duplicate)){i=this.Env.mods[i].requires||[];for(var l=0;l<i.length;l++)this.usePlugin(i[l]);j.func.call(j);j.status=1}},_monitor:function(){var i=this;i._monitorId&&clearTimeout(i._monitorId);i._monitorId=setTimeout(function(){var j=i.getSelection();if(j&&!j.isInvalid){var l=j.getStartElement(),r=new w.ElementPath(l);if(!i.previousPath||!i.previousPath.compare(r)){i.previousPath=r;i.fire("selectionChange",{selection:j,path:r,element:l})}}},100)},notifySelectionChange:function(){this.previousPath=
null;this._monitor()},insertElement:function(i,j,l){var r=this;if(r.getMode()===k){r.focus();var p,x=i._4e_name(),G=w.XHTML_DTD,c=w.RANGE,h=w.NODE,m=G.$block[x],y=r.getSelection(),n=y&&y.getRanges(),s,N,P,O;if(!n||n.length==0){var M=arguments,R=M.callee;setTimeout(function(){R.apply(r,M)},30)}else{r.fire("save");for(var Q=n.length-1;Q>=0;Q--){s=n[Q];s.deleteContents();p=!Q&&i||i._4e_clone(C);j&&j(p);if(m)for(;(P=s.getCommonAncestor(D,C))&&(O=G[P._4e_name()])&&!(O&&O[x]);)if(P._4e_name()in G.span)s.splitElement(P);
else if(s.checkStartOfBlock()&&s.checkEndOfBlock()){s.setStartBefore(P);s.collapse(C);P._4e_remove()}else s.splitBlock();s.insertNode(p);N||(N=p)}if(N){x=N._4e_nextSourceNode(C);G=r.document;O=w.XHTML_DTD;if(O.$inline[p._4e_name()]){x=new g(G.createTextNode(" "));x.insertAfter(N)}else if(x){if(x._4e_name()=="br"&&O[x.parent()._4e_name()].p){O=new g("<p>&nbsp;</p>",null,G);x[0].parentNode.replaceChild(O[0],x[0]);x=O}}else{O=new g("<p>&nbsp;</p>",null,G);O.insertAfter(N);x=O}s.moveToPosition(N,c.POSITION_AFTER_END);
x&&x[0].nodeType==h.NODE_ELEMENT&&s.moveToElementEditablePosition(x);y.selectRanges([s]);r.focus();p&&p._4e_scrollIntoView();r._saveLater();l&&l(p)}}}},insertHtml:function(i,j){var l=this;if(l.getMode()===k){if(l.htmlDataProcessor)i=l.htmlDataProcessor.toDataFormat(i,null,j);l.focus();l.fire("save");var r=l.document,p=0;if(u){var x=r.selection;x.type=="Control"&&x.clear();try{x.createRange().pasteHTML(i)}catch(G){v.log("insertHtml error in ie")}}else try{r.execCommand("inserthtml",D,i)}catch(c){setTimeout(function(){if(l.getSelection().getRanges().length==
0){var h=new w.Range(r),m=t._4e_first(r.body,function(y){return y[0].nodeType==1&&y._4e_name()!="br"});if(!m){m=new g(r.createElement("p"));r.body.appendChild(m[0])}h.setStartAt(m,w.RANGE.POSITION_AFTER_START);h.select()}r.execCommand("inserthtml",D,i)},p=100)}setTimeout(function(){l.getSelection().scrollIntoView()},p);l._saveLater(p)}},_saveLater:function(i){var j=this;if(j.__saveTimer){clearTimeout(j.__saveTimer);j.__saveTimer=null}j.__saveTimer=setTimeout(function(){j.fire("save")},i||0)}});w._initIFrame=
function(i){function j(n){f(function(){p.designMode="on";setTimeout(function(){p.designMode="off";c.focus();if(!arguments.callee.retry)arguments.callee.retry=C},50)},function(){p.designMode="off";t.attr(c,"contentEditable",D);t.attr(c,"contentEditable",C);!n&&j(1)})}var l=b.getInstance(i);i=l.textarea[0];var r=l.iframe[0].contentWindow,p=l.document,x=l.cfg,G=p.getElementById("ke_actscript");t._4e_remove(G);var c=p.body;if(u){c.hideFocus=C;c.disabled=C;c.contentEditable=C;c.removeAttribute("disabled")}else setTimeout(function(){if(z.gecko||
z.opera)c.contentEditable=C;else if(z.webkit)c.parentNode.contentEditable=C;else p.designMode="on"},0);if(z.webkit){d.on(p,"click",function(n){var s=new g(n.target);v.inArray(s._4e_name(),["input","select"])&&n.preventDefault()});d.on(p,"mouseup",function(n){var s=new g(n.target);v.inArray(s._4e_name(),["input","textarea"])&&n.preventDefault()})}if(z.gecko||u||z.opera){var h;h=(new g('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(i);h.on("focus",
function(){l.focus()});l.activateGecko=function(){z.gecko&&l.iframeFocus&&h[0].focus()};l.on("destroy",function(){h.detach();h.remove()})}if(p.documentMode||z.gecko||z.opera){var m=p.documentElement;d.on(m,"mousedown",function(n){if((new g(n.target))[0]==m){z.gecko&&j(D);h[0].focus()}})}d.on(r,"focus",function(){if(z.gecko)j(D);else z.opera&&c.focus();l.notifySelectionChange()});z.gecko&&d.on(l.document,"mousedown",function(){l.iframeFocus||j(D)});if(u){d.on(p,"keydown",function(n){if(n.keyCode in
{8:1,46:1}){var s=l.getSelection(),N=s.getSelectedElement();if(N){l.fire("save");var P=s.getRanges()[0].createBookmark();N._4e_remove();s.selectBookmarks([P]);l.fire("save");n.preventDefault()}}});if(p.compatMode=="CSS1Compat"){var y={33:1,34:1};d.on(p,"keydown",function(n){n.keyCode in y&&setTimeout(function(){l.getSelection().scrollIntoView()},0)})}}setTimeout(function(){u&&setTimeout(function(){if(p){c.runtimeStyle.marginBottom="0px";c.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){l.fire("dataReady");
var n=x.disableObjectResizing,s=x.disableInlineTableEditing;if(n||s)try{p.execCommand("enableObjectResizing",D,!n);p.execCommand("enableInlineTableEditing",D,!s)}catch(N){d.on(c,u?"resizestart":"resize",function(P){var O=new g(P.target);if(n||O._4e_name()==="table"&&s)P.preventDefault()})}},10);z.webkit&&d.on(p,"mousedown",function(n){n=new g(n.target);v.inArray(n._4e_name(),["img","hr","input","textarea","select"])&&l.getSelection().selectElement(n)});z.gecko&&d.on(p,"dragstart",function(n){var s=
new g(n.target);s._4e_name()==="img"&&/ke_/.test(s[0].className)&&n.preventDefault()});b.add(l)};q.documentMode>7&&function(){for(var i=v.all("link"),j=0;j<i.length;j++){var l=new g(i[j]),r=l.attr("href");r.indexOf("editor-pkg-min-mhtml.css")!=-1&&l.attr("href",r.replace(/editor-pkg-min-mhtml\.css/g,"editor-pkg-min-datauri.css"))}}()});
KISSY.Editor.add("zindex",function(){var w=KISSY.Editor;if(!w.zIndexManager){w.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};w.baseZIndex=function(C){return(w.Config.baseZIndex||1E4)+C};w.baseZIndex=w.baseZIndex;w.zIndexManager=w.zIndexManager}});
KISSY.Editor.add("dtd",function(w){w.XHTML_DTD=function(){function C(){for(var r=arguments[0],p=arguments.length-1;p>0;)KISSY.mix(r,arguments[p--]);return r}var D={isindex:1,fieldset:1},H={input:1,button:1,select:1,textarea:1,label:1},q=C({a:1},H),v=C({iframe:1},q),z={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},u={ins:1,del:1,script:1,style:1},t=C({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,
cite:1,kbd:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},u),g=C({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},t),d=C({p:1},g);H=C({iframe:1},g,H);g={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,
dir:1,map:1,dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var b=C({a:1},H),f={tr:1},o={"#":1},A=C({param:1},g),a=C({form:1},D,v,z,d),e={li:1},k={base:1,link:1,meta:1,title:1},i=C(k,{style:1,script:1}),j={head:1,body:1},l={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:C({html:1},j,
k),$block:l,$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:b,$body:C({script:1,style:1},l),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,
span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:j,head:i,style:o,body:a,base:{},link:{},meta:{},title:o,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:b,button:C(d,z),basefont:{},h5:b,h4:b,samp:b,h6:b,ol:e,h1:b,h3:b,option:o,h2:b,form:C(D,v,z,d),select:{optgroup:1,option:1},font:b,ins:b,menu:e,abbr:b,
label:b,table:{thead:1,col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:b,script:o,tfoot:f,cite:b,li:a,input:{},iframe:a,strong:b,textarea:o,noframes:a,big:b,small:b,span:b,hr:{},dt:b,sub:b,optgroup:{option:1},param:{},bdo:b,"var":b,div:a,object:A,sup:b,dd:a,strike:b,area:{},dir:e,map:C({area:1,form:1,p:1},D,u,z),applet:A,dl:{dt:1,dd:1},del:b,isindex:{},fieldset:C({legend:1},g),thead:f,ul:e,acronym:b,b:b,a:H,blockquote:a,caption:b,i:b,u:b,tbody:f,s:b,address:C(v,d),tt:b,legend:b,q:b,pre:C(t,
q),p:b,em:b,dfn:b}}();w.XHTML_DTD=w.XHTML_DTD});
KISSY.Editor.add("elementpath",function(w){function C(t){var g=v,d=v,b=[];for(t=t;t;){if(t[0].nodeType==q.NODE_ELEMENT){if(!this.lastElement)this.lastElement=t;var f=t._4e_name();if(!d){if(!g&&z[f])g=t;if(u[f]){var o;if(o=!g){if(o=f=="div"){a:{o=t;o=D._4e_unwrap(o);o=o.childNodes;for(var A=0,a=o.length;A<a;A++){var e=o[A];if(e.nodeType==q.NODE_ELEMENT&&H.$block[e.nodeName.toLowerCase()]){o=true;break a}}o=false}o=!o}o=o}if(o)g=t;else d=t}}b.push(t);if(f=="body")break}t=t.parent()}this.block=g;this.blockLimit=
d;this.elements=b}var D=KISSY.DOM,H=w.XHTML_DTD,q=w.NODE,v=null,z={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},u={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};C.prototype={compare:function(t){var g=this.elements;t=t&&t.elements;if(!t||g.length!=t.length)return false;for(var d=0;d<g.length;d++)if(!D._4e_equals(g[d],t[d]))return false;return true},contains:function(t){for(var g=this.elements,d=0;d<g.length;d++)if(g[d]._4e_name()in t)return g[d];
return v}};w.ElementPath=C});
KISSY.Editor.add("walker",function(w){function C(b,f){if(this._.end)return z;var o,A=this.range,a,e=this.guard,k=this.type,i=b?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;A.trim();if(A.collapsed){this.end();return z}}if(!b&&!this._.guardLTR){var j=A.endContainer,l=new d(j[0].childNodes[A.endOffset]);this._.guardLTR=function(G,c){return(G=g._4e_wrap(G))&&G[0]&&(!c||!g._4e_equals(j,G))&&(!l[0]||!G._4e_equals(l))&&(G[0].nodeType!=t.NODE_ELEMENT||!c||G._4e_name()!="body")}}if(b&&
!this._.guardRTL){var r=A.startContainer,p=A.startOffset>0&&new d(r[0].childNodes[A.startOffset-1]);this._.guardRTL=function(G,c){return(G=g._4e_wrap(G))&&G[0]&&(!c||!G._4e_equals(r))&&(!p[0]||!G._4e_equals(p))&&(G[0].nodeType!=t.NODE_ELEMENT||!c||G._4e_name()!="body")}}var x=b?this._.guardRTL:this._.guardLTR;a=e?function(G,c){if(x(G,c)===v)return v;return e(G,c)}:x;if(this.current)o=this.current[i](v,k,a);else if(b){o=A.endContainer;if(A.endOffset>0){o=new d(o[0].childNodes[A.endOffset-1]);if(a(o)===
v)o=z}else o=a(o,q)===v?z:o._4e_previousSourceNode(q,k,a)}else{o=A.startContainer;if((o=new d(o[0].childNodes[A.startOffset]))&&o[0]){if(a(o)===v)o=z}else o=a(A.startContainer,q)===v?z:A.startContainer._4e_nextSourceNode(q,k,a)}for(;o&&o[0]&&!this._.end;){this.current=o;if(!this.evaluator||this.evaluator(o)!==v){if(!f)return o}else if(f&&this.evaluator)return v;o=o[i](v,k,a)}this.end();return this.current=z}function D(b){for(var f,o=z;f=C.call(this,b);)o=f;return o}function H(b){this.range=b;this._=
{}}var q=true,v=false,z=null,u=KISSY,t=w.NODE,g=u.DOM,d=u.Node;u.augment(H,{end:function(){this._.end=1},next:function(){return C.call(this)},previous:function(){return C.call(this,q)},checkForward:function(){return C.call(this,v,q)!==v},checkBackward:function(){return C.call(this,q,q)!==v},lastForward:function(){return D.call(this)},lastBackward:function(){return D.call(this,q)},reset:function(){delete this.current;this._={}}});H.blockBoundary=function(b){return function(f){f=g._4e_wrap(f);return!(f&&
f[0].nodeType==t.NODE_ELEMENT&&f._4e_isBlockBoundary(b))}};H.bookmark=function(b,f){function o(A){return A&&A[0]&&A._4e_name()=="span"&&A.attr("_ke_bookmark")}return function(A){var a,e;a=A&&A[0]&&A[0].nodeType==t.NODE_TEXT&&(e=A.parent())&&o(e);a=b?a:a||o(A);return f^a}};H.whitespaces=function(b){return function(f){f=(f=f[0]||f)&&f.nodeType==t.NODE_TEXT&&!u.trim(f.nodeValue);return b^f}};H.invisible=function(b){var f=H.whitespaces();return function(o){o=f(o)||o[0].nodeType==t.NODE_ELEMENT&&!o[0].offsetHeight;
return b^o}};w.Walker=H});
KISSY.Editor.add("range",function(w){function C(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=g;this.collapsed=u;this.document=c}function D(c){var h=c[0].nodeType!=b.NODE_TEXT&&c._4e_name()in i.$removeEmpty,m=!d.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return h||m||c}function H(c){return!x(c)&&!G(c)}function q(c){var h=t,m=A.bookmark(u);return function(y){if(m(y))return u;if(y[0].nodeType==b.NODE_TEXT){if(d.trim(y[0].nodeValue).length)return t}else if(y[0].nodeType==b.NODE_ELEMENT)if(!p[y._4e_name()])if(!c&&
!k.ie&&y._4e_name()=="br"&&!h)h=u;else return t;return u}}function v(c,h){function m(y){return y&&y.nodeName=="span"&&y.getAttribute("_ke_bookmark")}return function(y){var n,s;n=y&&!y.nodeName&&(s=y.parentNode)&&m(s);n=c?n:n||m(y);return h^n}}function z(c){return function(h){h=(h=h[0]||h)&&h.nodeType==b.NODE_TEXT&&!d.trim(h.nodeValue);return c^h}}w.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,
START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};w.RANGE=w.RANGE;var u=true,t=false,g=null,d=KISSY,b=w.NODE,f=w.RANGE,o=w.POSITION,A=w.Walker,a=d.DOM,e=w.Utils.getByAddress,k=d.UA,i=w.XHTML_DTD,j=w.ElementPath,l=d.Node,r={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};C.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||this.endContainer[0].nodeName)+":"+this.endOffset);
return c.join("<br/>")};d.augment(C,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,h=this.startOffset;if(c[0].nodeType!=b.NODE_ELEMENT)if(h)h>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;h=this.endOffset;if(c[0].nodeType!=b.NODE_ELEMENT)if(h)h>=c[0].nodeValue.length&&this.setEndAfter(c);
else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,h=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,f.POSITION_BEFORE_START);h&&h._4e_name()=="span"&&h.attr("_ke_bookmark")&&
this.setEndAt(h,f.POSITION_AFTER_END)},setStart:function(c,h){if(c[0].nodeType==b.NODE_ELEMENT&&r[c._4e_name()]){c=c.parent();h=c._4e_index()}this.startContainer=c;this.startOffset=h;if(!this.endContainer){this.endContainer=c;this.endOffset=h}this.updateCollapsed()},setEnd:function(c,h){if(c[0].nodeType==b.NODE_ELEMENT&&r[c._4e_name()]){c=c.parent();h=c._4e_index()+1}this.endContainer=c;this.endOffset=h;if(!this.startContainer){this.startContainer=c;this.startOffset=h}this.updateCollapsed()},setStartAt:function(c,
h){switch(h){case f.POSITION_AFTER_START:this.setStart(c,0);break;case f.POSITION_BEFORE_END:c[0].nodeType==b.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case f.POSITION_BEFORE_START:this.setStartBefore(c);break;case f.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,h){switch(h){case f.POSITION_AFTER_START:this.setEnd(c,0);break;case f.POSITION_BEFORE_END:c[0].nodeType==b.NODE_TEXT?this.setEnd(c,c[0].nodeValue.length):
this.setEnd(c,c[0].childNodes.length);break;case f.POSITION_BEFORE_START:this.setEndBefore(c);break;case f.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,h){var m=this.startContainer,y=this.endContainer,n=this.startOffset,s=this.endOffset,N,P=this.document,O;this.optimizeBookmark();if(y[0].nodeType==b.NODE_TEXT)y=y._4e_splitText(s);else if(y[0].childNodes.length>0)if(s>=y[0].childNodes.length){y=new l(y[0].appendChild(P.createTextNode("")));O=u}else y=
new l(y[0].childNodes[s]);if(m[0].nodeType==b.NODE_TEXT){m._4e_splitText(n);if(m._4e_equals(y))y=new l(m[0].nextSibling)}else if(n)if(n>=m[0].childNodes.length){N=new l(P.createTextNode(""));m.append(N);m=N;N=u}else m=new l(m[0].childNodes[n].previousSibling);else{N=new l(P.createTextNode(""));m.prepend(N);m=N;N=u}n=m._4e_parents();s=y._4e_parents();var M,R,Q;for(M=0;M<n.length;M++){R=n[M];Q=s[M];if(!R._4e_equals(Q))break}P=h;for(var U,W,B,J=M;J<n.length;J++){U=n[J];W=P&&!U._4e_equals(m)?P.appendChild(U._4e_clone()[0]):
null;for(U=U[0].nextSibling;U;){if(a._4e_equals(s[J],U)||a._4e_equals(y,U))break;B=U.nextSibling;if(c==2)P.appendChild(U.cloneNode(u));else{a._4e_remove(U);c==1&&P.appendChild(U)}U=B}if(W)P=W}P=h;for(M=M;M<s.length;M++){U=s[M];W=P&&c>0&&!U._4e_equals(y)?P.appendChild(U._4e_clone()[0]):null;if(!n[M]||!U.parent()._4e_equals(n[M].parent()))for(U=U[0].previousSibling;U;){if(a._4e_equals(n[M],U)||a._4e_equals(m,U))break;B=U.previousSibling;if(c==2)P.insertBefore(U.cloneNode(u),P.firstChild);else{a._4e_remove(U);
c==1&&P.insertBefore(U,P.firstChild)}U=B}if(W)P=W}if(c==2){Q=this.startContainer[0];if(Q.nodeType==b.NODE_TEXT&&Q.nextSibling&&Q.nextSibling.nodeType==b.NODE_TEXT){Q.data+=Q.nextSibling.data;Q.parentNode.removeChild(Q.nextSibling)}Q=this.endContainer[0];if(Q.nodeType==b.NODE_TEXT&&Q.nextSibling&&Q.nextSibling.nodeType==b.NODE_TEXT){Q.data+=Q.nextSibling.data;Q.parentNode.removeChild(Q.nextSibling)}}else{if(R&&Q&&(!m.parent()._4e_equals(R.parent())||!y.parent()._4e_equals(Q.parent()))){R=Q._4e_index();
N&&Q.parent()._4e_equals(m.parent())&&R--;this.setStart(Q.parent(),R)}this.collapse(u)}N&&m._4e_remove();O&&y[0].parentNode&&y._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=u},clone:function(){var c=new C(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;c.endContainer=this.endContainer;c.endOffset=this.endOffset;
c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=b.NODE_ELEMENT||c.endContainer[0].nodeType!=b.NODE_ELEMENT)return g;var h=new w.Walker(c),m=v(u,undefined),y=z(u);c.evaluator=function(n){return y(n)&&m(n)};c=h.next();h.reset();h=h.previous();return c&&c._4e_equals(h)?c:g},shrink:function(c,h){if(!this.collapsed){c=c||f.SHRINK_TEXT;var m=this.clone(),y=this.startContainer,n=this.endContainer,s=this.startOffset,N=this.endOffset,
P=1,O=1;if(y&&y[0].nodeType==b.NODE_TEXT)if(s)if(s>=y[0].nodeValue.length)m.setStartAfter(y);else{m.setStartBefore(y);P=0}else m.setStartBefore(y);if(n&&n[0].nodeType==b.NODE_TEXT)if(N)if(N>=n[0].nodeValue.length)m.setEndAfter(n);else{m.setEndAfter(n);O=0}else m.setEndBefore(n);m=new A(m);m.evaluator=function(R){R=R[0]||R;return R.nodeType==(c==f.SHRINK_ELEMENT?b.NODE_ELEMENT:b.NODE_TEXT)};var M;m.guard=function(R,Q){R=R[0]||R;if(c==f.SHRINK_ELEMENT&&R.nodeType==b.NODE_TEXT)return t;if(Q&&R==M)return t;
if(!Q&&R.nodeType==b.NODE_ELEMENT)M=R;return u};if(P)(y=m[c==f.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(y,h?f.POSITION_AFTER_START:f.POSITION_BEFORE_START);if(O){m.reset();(m=m[c==f.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(m,h?f.POSITION_BEFORE_END:f.POSITION_AFTER_END)}return!!(P||O)}},createBookmark2:function(c){var h=this.startContainer,m=this.endContainer,y=this.startOffset,n=this.endOffset,s,N;if(!h||!m)return{start:0,end:0};if(c){if(h[0].nodeType==b.NODE_ELEMENT)if((s=
new l(h[0].childNodes[y]))&&s[0]&&s[0].nodeType==b.NODE_TEXT&&y>0&&s[0].previousSibling.nodeType==b.NODE_TEXT){h=s;y=0}for(;h[0].nodeType==b.NODE_TEXT&&(N=h._4e_previous())&&N[0].nodeType==b.NODE_TEXT;){h=N;y+=N[0].nodeValue.length}if(!this.collapsed){if(m[0].nodeType==b.NODE_ELEMENT)if((s=new l(m[0].childNodes[n]))&&s[0]&&s[0].nodeType==b.NODE_TEXT&&n>0&&s[0].previousSibling.nodeType==b.NODE_TEXT){m=s;n=0}for(;m[0].nodeType==b.NODE_TEXT&&(N=m._4e_previous())&&N[0].nodeType==b.NODE_TEXT;){m=N;n+=
N[0].nodeValue.length}}}return{start:h._4e_address(c),end:this.collapsed?g:m._4e_address(c),startOffset:y,endOffset:n,normalized:c,is2:u}},createBookmark:function(c){var h,m,y,n,s=this.collapsed;h=new l("<span>",g,this.document);h.attr("_ke_bookmark",1);h.css("display","none");h.html("&nbsp;");if(c){y=d.guid("ke_bm_");h.attr("id",y+"S")}if(!s){m=h._4e_clone();m.html("&nbsp;");c&&m.attr("id",y+"E");n=this.clone();n.collapse();n.insertNode(m)}n=this.clone();n.collapse(u);n.insertNode(h);if(m){this.setStartAfter(h);
this.setEndBefore(m)}else this.moveToPosition(h,f.POSITION_AFTER_END);return{startNode:c?y+"S":h,endNode:c?y+"E":m,serializable:c,collapsed:s}},moveToPosition:function(c,h){this.setStartAt(c,h);this.collapse(u)},trim:function(c,h){var m=this.startContainer,y=this.startOffset,n=this.collapsed;if((!c||n)&&m[0]&&m[0].nodeType==b.NODE_TEXT){if(y)if(y>=m[0].nodeValue.length){y=m._4e_index()+1;m=m.parent()}else{var s=m._4e_splitText(y);y=m._4e_index()+1;m=m.parent();if(a._4e_equals(this.startContainer,
this.endContainer))this.setEnd(s,this.endOffset-this.startOffset);else if(a._4e_equals(m,this.endContainer))this.endOffset+=1}else{y=m._4e_index();m=m.parent()}this.setStart(m,y);if(n){this.collapse(u);return}}m=this.endContainer;y=this.endOffset;if(!(h||n)&&m[0]&&m[0].nodeType==b.NODE_TEXT){if(y){y>=m.nodeValue.length||m._4e_splitText(y);y=m._4e_index()+1}else y=m._4e_index();m=m.parent();this.setEnd(m,y)}},insertNode:function(c){this.optimizeBookmark();this.trim(t,u);var h=this.startContainer;h[0].insertBefore(c[0]||
c,h[0].childNodes[this.startOffset]||null);a._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var h=e(this.document,c.start,c.normalized),m=c.startOffset,y=c.end&&e(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(h,m);y?this.setEnd(y,c):this.collapse(u)}else{h=(m=c.serializable)?d.one("#"+c.startNode,this.document):c.startNode;c=m?d.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(h);h._4e_remove();
if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(u)}},getCommonAncestor:function(c,h){var m=this.startContainer,y=this.endContainer;m=a._4e_equals(m,y)?c&&m[0].nodeType==b.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new l(m[0].childNodes[this.startOffset]):m:m._4e_commonAncestor(y);return h&&m[0].nodeType==b.NODE_TEXT?m.parent():m},enlarge:function(c){switch(c){case f.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var h=new l(this.document.body),m,y,n,s,
N,P=t,O,M;O=this.startContainer;M=this.startOffset;if(O[0].nodeType==b.NODE_TEXT){if(M){O=!d.trim(O[0].nodeValue.substring(0,M)).length&&O;P=!!O}if(O)if(!(s=O[0].previousSibling))n=O.parent()}else{if(M)s=O[0].childNodes[M-1]||O[0].lastChild;s||(n=O)}for(;n||s;){if(n&&!s){if(!N&&a._4e_equals(n,c))N=u;if(!h.contains(n))break;if(!P||n.css("display")!="inline"){P=t;if(N)m=n;else this.setStartBefore(n)}s=n[0].previousSibling}for(;s;){O=t;if(s.nodeType==b.NODE_TEXT){M=s.nodeValue;if(/[^\s\ufeff]/.test(M))s=
g;O=/[\s\ufeff]$/.test(M)}else if(s.offsetWidth>0&&!s.getAttribute("_ke_bookmark"))if(P&&i.$removeEmpty[s.nodeName.toLowerCase()]){M=a.text(s);if(/[^\s\ufeff]/.test(M))s=g;else for(var R=s.all||s.getElementsByTagName("*"),Q=0,U;U=R[Q++];)if(!i.$removeEmpty[U.nodeName.toLowerCase()]){s=g;break}if(s)O=!!M.length}else s=g;if(O)if(P)if(N)m=n;else n&&this.setStartBefore(n);else P=u;if(s){O=s.previousSibling;if(!n&&!O){n=new l(s);s=g;break}s=O}else n=g}if(n)n=n.parent()}O=this.endContainer;M=this.endOffset;
n=s=g;N=P=t;if(O[0].nodeType==b.NODE_TEXT){O=!d.trim(O[0].nodeValue.substring(M)).length&&O;P=!(O&&O[0].nodeValue.length);if(O)if(!(s=O[0].nextSibling))n=O.parent()}else(s=O[0].childNodes[M])||(n=O);for(;n||s;){if(n&&!s){if(!N&&a._4e_equals(n,c))N=u;if(!h.contains(n))break;if(!P||n.css("display")!="inline"){P=t;if(N)y=n;else n&&this.setEndAfter(n)}s=n[0].nextSibling}for(;s;){O=t;if(s.nodeType==b.NODE_TEXT){M=s.nodeValue;if(/[^\s\ufeff]/.test(M))s=g;O=/^[\s\ufeff]/.test(M)}else if(s.offsetWidth>0&&
!s.getAttribute("_ke_bookmark"))if(P&&i.$removeEmpty[s.nodeName.toLowerCase()]){M=a.text(s);if(/[^\s\ufeff]/.test(M))s=g;else{R=s.all||s.getElementsByTagName("*");for(Q=0;U=R[Q++];)if(!i.$removeEmpty[U.nodeName.toLowerCase()]){s=g;break}}if(s)O=!!M.length}else s=g;if(O)if(P)if(N)y=n;else this.setEndAfter(n);if(s){O=s.nextSibling;if(!n&&!O){n=new l(s);s=g;break}s=O}else n=g}if(n)n=n.parent()}if(m&&y){c=m.contains(y)?y:m;this.setStartBefore(c);this.setEndAfter(c)}break;case f.ENLARGE_BLOCK_CONTENTS:case f.ENLARGE_LIST_ITEM_CONTENTS:n=
new C(this.document);h=new l(this.document.body);n.setStartAt(h,f.POSITION_AFTER_START);n.setEnd(this.startContainer,this.startOffset);n=new A(n);var W,B,J=A.blockBoundary(c==f.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:g),E=function(I){var F=J(I);F||(W=I);return F};m=function(I){var F=E(I);if(!F&&I[0]&&I._4e_name()=="br")B=I;return F};n.guard=E;n=n.lastBackward();W=W||h;this.setStartAt(W,W._4e_name()!="br"&&(!n&&this.checkStartOfBlock()||n&&W.contains(n))?f.POSITION_AFTER_START:f.POSITION_AFTER_END);n=this.clone();
n.collapse();n.setEndAt(h,f.POSITION_BEFORE_END);n=new A(n);n.guard=c==f.ENLARGE_LIST_ITEM_CONTENTS?m:E;W=g;n=n.lastForward();W=W||h;this.setEndAt(W,!n&&this.checkEndOfBlock()||n&&W.contains(n)?f.POSITION_BEFORE_END:f.POSITION_BEFORE_START);B&&this.setEndAfter(B)}},checkStartOfBlock:function(){var c=this.startContainer,h=this.startOffset;if(h&&c[0].nodeType==b.NODE_TEXT)if(d.trim(c[0].nodeValue.substring(0,h)).length)return t;this.trim();c=new j(this.startContainer);h=this.clone();h.collapse(u);h.setStartAt(c.block||
c.blockLimit,f.POSITION_AFTER_START);c=new A(h);c.evaluator=q(u);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,h=this.endOffset;if(c[0].nodeType==b.NODE_TEXT)if(d.trim(c[0].nodeValue.substring(h)).length)return t;this.trim();c=new j(this.endContainer);h=this.clone();h.collapse(t);h.setEndAt(c.block||c.blockLimit,f.POSITION_BEFORE_END);c=new A(h);c.evaluator=q(t);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,h){var m=this.clone();m[h==f.START?"setStartAt":"setEndAt"](c,h==f.START?f.POSITION_AFTER_START:f.POSITION_BEFORE_END);m=new A(m);m.evaluator=D;return m[h==f.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,h=this.endContainer,m=this.startOffset,y=this.endOffset,n;if(c[0].nodeType==b.NODE_ELEMENT){n=c[0].childNodes.length;if(n>
m)c=new l(c[0].childNodes[m]);else if(n<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new l(c);c=c._4e_nextSourceNode()||c}}if(h[0].nodeType==b.NODE_ELEMENT){n=h[0].childNodes.length;if(n>y)h=(new l(h[0].childNodes[y]))._4e_previousSourceNode(u);else if(n<1)h=h._4e_previousSourceNode();else{for(h=h[0];h.lastChild;)h=h.lastChild;h=new l(h)}}if(c._4e_position(h)&o.POSITION_FOLLOWING)c=h;return{startNode:c,endNode:h}},fixBlock:function(c,h){var m=this.createBookmark(),y=
new l(this.document.createElement(h));this.collapse(c);this.enlarge(f.ENLARGE_BLOCK_CONTENTS);y[0].appendChild(this.extractContents());y._4e_trim();k.ie||y._4e_appendBogus();for(var n=y[0].childNodes,s=0;s<n.length;s++){var N=n[s];N.nodeType==8&&this.insertNode(new l(N))}this.insertNode(y);this.moveToBookmark(m);return y},splitBlock:function(c){var h=new j(this.startContainer),m=new j(this.endContainer),y=h.block,n=m.block,s=g;if(!h.blockLimit._4e_equals(m.blockLimit))return g;if(c!="br"){if(!y){y=
this.fixBlock(u,c);n=(new j(this.endContainer)).block}n||(n=this.fixBlock(t,c))}c=y&&this.checkStartOfBlock();h=n&&this.checkEndOfBlock();this.deleteContents();if(y&&a._4e_equals(y,n))if(h){s=new j(this.startContainer);this.moveToPosition(n,f.POSITION_AFTER_END);n=g}else if(c){s=new j(this.startContainer);this.moveToPosition(y,f.POSITION_BEFORE_START);y=g}else{n=this.splitElement(y);!k.ie&&!d.inArray(y._4e_name(),["ul","ol"])&&y._4e_appendBogus()}return{previousBlock:y,nextBlock:n,wasStartOfBlock:c,
wasEndOfBlock:h,elementPath:s}},splitElement:function(c){if(!this.collapsed)return g;this.setEndAt(c,f.POSITION_BEFORE_END);var h=this.extractContents(),m=c._4e_clone(t);m[0].appendChild(h);m.insertAfter(c);this.moveToPosition(c,f.POSITION_AFTER_END);return m},moveToElementEditablePosition:function(c,h){var m,y=w.XHTML_DTD;if(y.$empty[c._4e_name()])return t;for(;c&&c[0].nodeType==b.NODE_ELEMENT;){if(m=c._4e_isEditable())this.moveToPosition(c,h?f.POSITION_BEFORE_END:f.POSITION_AFTER_START);else if(y.$inline[c._4e_name()]){this.moveToPosition(c,
h?f.POSITION_AFTER_END:f.POSITION_BEFORE_START);return u}if((c=y.$empty[c._4e_name()]?c[h?"_4e_previous":"_4e_next"](H):h?c._4e_last(H):c._4e_first(H))&&c[0].nodeType==b.NODE_TEXT){this.moveToPosition(c,h?f.POSITION_AFTER_END:f.POSITION_BEFORE_START);return u}}return m},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,c[0].nodeType==b.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var p={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,
kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},x=new A.whitespaces,G=new A.bookmark;w.Range=C});
KISSY.Editor.add("domiterator",function(w){function C(A){if(!(arguments.length<1)){this.range=A;this.forceBrBreak=H;this.enlargeBr=D;this.enforceRealBlocks=H;this._||(this._={})}}var D=true,H=false,q=KISSY,v=q.UA,z=w.Walker,u=w.Range,t=w.RANGE,g=w.NODE,d=w.ElementPath,b=q.Node,f=q.DOM,o=/^[\r\n\t ]*$/;q.augment(C,{getNextParagraph:function(A){var a,e,k,i,j;if(!this._.lastNode){e=this.range.clone();e.shrink(t.SHRINK_ELEMENT,D);e.enlarge(this.forceBrBreak||!this.enlargeBr?t.ENLARGE_LIST_ITEM_CONTENTS:
t.ENLARGE_BLOCK_CONTENTS);var l=new z(e),r=z.bookmark(D,D);l.evaluator=r;this._.nextNode=l.next();l=new z(e);l.evaluator=r;l=l.previous();this._.lastNode=l._4e_nextSourceNode(D);if(this._.lastNode&&this._.lastNode[0].nodeType==g.NODE_TEXT&&!q.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){r=new u(e.document);r.moveToPosition(this._.lastNode,t.POSITION_AFTER_END);if(r.checkEndOfBlock()){r=new d(r.endContainer);this._.lastNode=(r.block||r.blockLimit)._4e_nextSourceNode(D)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new b(e.document.createTextNode(""));f.insertAfter(this._.lastNode[0],l[0])}e=null}r=this._.nextNode;l=this._.lastNode;for(this._.nextNode=null;r;){var p=H,x=r[0].nodeType!=g.NODE_ELEMENT,G=H;if(x){if(r[0].nodeType==g.NODE_TEXT)if(o.test(r[0].nodeValue))x=H}else{var c=r._4e_name();if(r._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(c=="br")x=D;else if(!e&&!r[0].childNodes.length&&c!="hr"){a=r;k=r._4e_equals(l);break}if(e){e.setEndAt(r,t.POSITION_BEFORE_START);if(c!="br")this._.nextNode=
r}p=D}else{if(r[0].firstChild){if(!e){e=new u(this.range.document);e.setStartAt(r,t.POSITION_BEFORE_START)}r=new b(r[0].firstChild);continue}x=D}}if(x&&!e){e=new u(this.range.document);e.setStartAt(r,t.POSITION_BEFORE_START)}k=(!p||x)&&r._4e_equals(l);if(e&&!p)for(;!r[0].nextSibling&&!k;){c=r.parent();if(c._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){p=D;k||c._4e_equals(l);break}r=c;x=D;k=r._4e_equals(l);G=D}x&&e.setEndAt(r,t.POSITION_AFTER_END);r=r._4e_nextSourceNode(G,null,l);if((k=!r)||p&&e)break}if(!a){if(!e){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new d(e.startContainer);r=a.blockLimit;p={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&p[r._4e_name()]&&e.checkStartOfBlock()&&e.checkEndOfBlock())a=r;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new b(this.range.document.createElement(A||"p"));a[0].appendChild(e.extractContents());a._4e_trim();e.insertNode(a);i=j=D}else if(a._4e_name()!="li"){if(!e.checkStartOfBlock()||!e.checkEndOfBlock()){a=a._4e_clone(H);
a[0].appendChild(e.extractContents());a._4e_trim();j=e.splitBlock();i=!j.wasStartOfBlock;j=!j.wasEndOfBlock;e.insertNode(a)}}else if(!k)this._.nextNode=a._4e_equals(l)?null:e.getBoundaryNodes().endNode._4e_nextSourceNode(D,null,l)}if(i){e=new b(a[0].previousSibling);if(e[0]&&e[0].nodeType==g.NODE_ELEMENT)if(e._4e_name()=="br")e._4e_remove();else e[0].lastChild&&f._4e_name(e[0].lastChild)=="br"&&f._4e_remove(e[0].lastChild)}if(j){e=z.bookmark(H,D);i=new b(a[0].lastChild);if(i[0]&&i[0].nodeType==g.NODE_ELEMENT&&
i._4e_name()=="br")if(v.ie||i._4e_previous(e)||i._4e_next(e))i._4e_remove()}if(!this._.nextNode)this._.nextNode=k||a._4e_equals(l)?null:a._4e_nextSourceNode(D,null,l);return a}});u.prototype.createIterator=function(){return new C(this)}});
KISSY.Editor.add("selection",function(w){function C(p){this.document=this.document=p;this._={cache:{}};if(a){var x=this.getNative().createRange();if(!x||x.item&&x.item(0).ownerDocument!=p||x.parentElement&&x.parentElement().ownerDocument!=p)this.isInvalid=q}}function D(p){p=new C(p);return!p||p.isInvalid?z:p}function H(p){function x(M){var R=w.XHTML_DTD;return M._4e_isBlockBoundary()&&R.$empty[M._4e_name()]}var G=p.document,c=new b(G.body),h=new b(G.documentElement);if(t.ie){w.Utils.ieEngine<8&&h.on("click",
function(M){(new b(M.target))._4e_name()==="html"&&p.getSelection().getNative().createRange().select()});var m,y,n=q;h.on("mousedown",function(){n=v});h.on("mouseup",function(){n=q});c.on("focusin",function(M){if((new b(M.target))._4e_name()=="body")if(m){try{n&&m.select()}catch(R){}m=z}});c.on("focus",function(){y=q;s()});c.on("beforedeactivate",function(M){if(!M.relatedTarget){y=v;n=q}});p.on("blur",function(){try{var M=document.documentElement||document.body,R=M.scrollTop,Q=M.scrollLeft;G&&G.selection.empty();
M.scrollTop=R;M.scrollLeft=Q}catch(U){}});c.on("mousedown",function(){y=v});c.on("mouseup",function(){y=q;setTimeout(function(){s(q)},0)});var s=function(M){if(y){var R=p.document,Q=p.getSelection(),U=Q&&Q.getType(),W=Q&&R.selection;if(M&&W&&U==f.SELECTION_NONE)if(!R.queryCommandEnabled("InsertImage")){setTimeout(function(){s(q)},50);return}var B;if(!(W&&W.type&&W.type!="Control"&&(B=W.createRange())&&(B=B.parentElement())&&(B=B.nodeName)&&B.toLowerCase()in{input:1,textarea:1})){m=W&&Q.getRanges()[0];
p._monitor()}}};c.on("keydown",function(){y=v});c.on("keyup",function(){y=q;setTimeout(function(){s()},0)})}else{d.on(G,"mouseup",p._monitor,p);d.on(G,"keyup",p._monitor,p)}var N=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,P=w.Walker.whitespaces(q),O=function(M){return P(M)&&M&&M[0].nodeType!=8};p.on("selectionChange",function(M){var R=M.path;M=(M=M.selection)&&M.getRanges()[0];if(!(!M||!M.collapsed||R.block)){if(R.blockLimit._4e_name()==
"body")if((R=M.fixBlock(q,"p"))&&R[0]!=c[0].lastChild){if(R._4e_outerHtml().match(N)){var Q=R._4e_next(O);if(Q&&Q[0].nodeType==A.NODE_ELEMENT&&!x[Q]){M.moveToElementEditablePosition(Q);R._4e_remove()}else if((Q=R._4e_previous(O))&&Q[0].nodeType==A.NODE_ELEMENT&&!x[Q]){M.moveToElementEditablePosition(Q,Q._4e_outerHtml().match(N)?v:q);R._4e_remove()}}M.select();a||p.notifySelectionChange()}R=new w.Range(G);R.moveToElementEditablePosition(c,q);if((new w.ElementPath(R.startContainer)).blockLimit._4e_name()!==
"body"){R=(new b(G.createElement("p"))).appendTo(c);t.ie||R._4e_appendBogus()}}})}w.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var q=true,v=false,z=null,u=KISSY,t=u.UA,g=u.DOM,d=u.Event,b=u.Node,f=w.SELECTION,o=w.RANGE,A=w.NODE,a=t.ie,e=w.Walker,k=w.Range,i={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};u.augment(C,{getNative:!a?function(){var p=this._.cache;return p.nativeSel||(p.nativeSel=
g._4e_getWin(this.document).getSelection())}:function(){var p=this._.cache;return p.nativeSel||(p.nativeSel=this.document.selection)},getType:!a?function(){var p=this._.cache;if(p.type)return p.type;var x=f.SELECTION_TEXT,G=this.getNative();if(G){if(G.rangeCount==1){G=G.getRangeAt(0);var c=G.startContainer;if(c==G.endContainer&&c.nodeType==A.NODE_ELEMENT&&Number(G.endOffset-G.startOffset)==1&&i[c.childNodes[G.startOffset].nodeName.toLowerCase()])x=f.SELECTION_ELEMENT}}else x=f.SELECTION_NONE;return p.type=
x}:function(){var p=this._.cache;if(p.type)return p.type;var x=f.SELECTION_NONE;try{var G=this.getNative(),c=G.type;if(c=="Text")x=f.SELECTION_TEXT;if(c=="Control")x=f.SELECTION_ELEMENT;if(G.createRange().parentElement)x=f.SELECTION_TEXT}catch(h){}return p.type=x},getRanges:a?function(){var p=function(x,G){x=x.duplicate();x.collapse(G);for(var c=x.parentElement(),h=c.childNodes,m,y=0;y<h.length;y++){var n=h[y];if(n.nodeType==A.NODE_ELEMENT){m=x.duplicate();m.moveToElementText(n);n=m.compareEndPoints("StartToStart",
x);var s=m.compareEndPoints("EndToStart",x);m.collapse();if(n>0)break;else if(!n||s==1&&n==-1)return{container:c,offset:y};else if(!s)return{container:c,offset:y+1};m=z}}if(!m){m=x.duplicate();m.moveToElementText(c);m.collapse(v)}m.setEndPoint("StartToStart",x);m=String(m.text).replace(/\r\n|\r/g,"\n").length;try{for(;m>0;)m-=h[--y].nodeValue.length}catch(N){m=0}return m===0?{container:c,offset:y}:{container:h[y],offset:-m}};return function(x){var G=this._.cache;if(G.ranges&&!x)return G.ranges;var c=
this.getNative();x=c&&c.createRange();var h=this.getType();if(!c)return[];if(h==f.SELECTION_TEXT){c=new k(this.document);h=p(x,q);c.setStart(new b(h.container),h.offset);h=p(x);c.setEnd(new b(h.container),h.offset);return G.ranges=[c]}else if(h==f.SELECTION_ELEMENT){G=G.ranges=[];for(h=0;h<x.length;h++){var m=x.item(h),y=m.parentNode,n=0;for(c=new k(this.document);n<y.childNodes.length&&y.childNodes[n]!=m;n++);c.setStart(new b(y),n);c.setEnd(new b(y),n+1);G.push(c)}return G}return G.ranges=[]}}():
function(p){var x=this._.cache;if(x.ranges&&!p)return x.ranges;p=[];var G=this.getNative();if(!G)return[];for(var c=0;c<G.rangeCount;c++){var h=G.getRangeAt(c),m=new k(this.document);m.setStart(new b(h.startContainer),h.startOffset);m.setEnd(new b(h.endContainer),h.endOffset);p.push(m)}return x.ranges=p},getStartElement:function(){var p=this._.cache;if(p.startElement!==undefined)return p.startElement;var x,G=this.getNative();switch(this.getType()){case f.SELECTION_ELEMENT:return this.getSelectedElement();
case f.SELECTION_TEXT:var c=this.getRanges()[0];if(c)if(!c.collapsed){for(c.optimize();q;){x=c.startContainer;if(c.startOffset==(x[0].nodeType===A.NODE_ELEMENT?x[0].childNodes.length:x[0].nodeValue.length)&&!x._4e_isBlockBoundary())c.setStartAfter(x);else break}x=c.startContainer;if(x[0].nodeType!=A.NODE_ELEMENT)return x.parent();x=new b(x[0].childNodes[c.startOffset]);if(!x[0]||x[0].nodeType!=A.NODE_ELEMENT)return c.startContainer;for(c=x[0].firstChild;c&&c.nodeType==A.NODE_ELEMENT;){x=new b(c);
c=c.firstChild}return x}if(a){c=G.createRange();c.collapse(q);x=c.parentElement()}else if((x=G.anchorNode)&&x.nodeType!=A.NODE_ELEMENT)x=x.parentNode}return p.startElement=x?g._4e_wrap(x):z},getSelectedElement:function(){var p=this,x,G=p._.cache;if(G.selectedElement!==undefined)return G.selectedElement;if(a){x=p.getNative().createRange();x=x.item&&x.item(0)}x||(x=function(){for(var c=p.getRanges()[0],h,m,y=2;y&&!((h=c.getEnclosedNode())&&h[0].nodeType==A.NODE_ELEMENT&&i[h._4e_name()]&&(m=h));y--)c.shrink(o.SHRINK_ELEMENT);
return m&&m[0]}());return G.selectedElement=g._4e_wrap(x)},reset:function(){this._.cache={}},selectElement:function(p){var x,G=this.document;if(a)try{x=G.body.createControlRange();x.addElement(p[0]);x.select()}catch(c){x=G.body.createTextRange();x.moveToElementText(p[0]);x.select()}finally{}else{x=G.createRange();x.selectNode(p[0]);p=this.getNative();p.removeAllRanges();p.addRange(x)}this.reset()},selectRanges:function(p){if(a){if(p.length>1){var x=p[p.length-1];p[0].setEnd(x.endContainer,x.endOffset);
p.length=1}p[0]&&p[0].select()}else{x=this.getNative();if(!x)return;x.removeAllRanges();for(var G=0;G<p.length;G++){var c=p[G],h=this.document.createRange(),m=c.startContainer;c.collapsed&&t.gecko&&t.gecko<1.09&&m[0].nodeType==A.NODE_ELEMENT&&!m[0].childNodes.length&&m[0].appendChild(this.document.createTextNode(""));h.setStart(m[0],c.startOffset);h.setEnd(c.endContainer[0],c.endOffset);x.addRange(h)}}this.reset()},createBookmarks2:function(p){for(var x=[],G=this.getRanges(),c=0;c<G.length;c++)x.push(G[c].createBookmark2(p));
return x},createBookmarks:function(p,x){var G=[],c=this.document,h;x=x||this.getRanges();for(var m=x.length,y=0;y<m;y++){G.push(h=x[y].createBookmark(p,q));var n=(p=h.serializable)?u.one("#"+h.startNode,c):h.startNode;h=p?u.one("#"+h.endNode,c):h.endNode;for(var s=y+1;s<m;s++){var N=x[s],P=N.startContainer,O=N.endContainer;g._4e_equals(P,n.parent())&&N.startOffset++;g._4e_equals(P,h.parent())&&N.startOffset++;g._4e_equals(O,n.parent())&&N.endOffset++;g._4e_equals(O,h.parent())&&N.endOffset++}}return G},
selectBookmarks:function(p){for(var x=[],G=0;G<p.length;G++){var c=new k(this.document);c.moveToBookmark(p[G]);x.push(c)}this.selectRanges(x);return this},getCommonAncestor:function(){var p=this.getRanges();return p[0].startContainer._4e_commonAncestor(p[p.length-1].endContainer)},scrollIntoView:function(){var p=this.getStartElement();p&&p._4e_scrollIntoView()},removeAllRanges:function(){var p=this.getNative();if(a)p&&p.clear();else p&&p.removeAllRanges()}});var j={table:1,tbody:1,tr:1},l=e.whitespaces(q),
r=/\ufeff|\u00a0/;k.prototype.select=k.prototype.select=!a?function(){var p=this.startContainer;this.collapsed&&p[0].nodeType==A.NODE_ELEMENT&&!p[0].childNodes.length&&p[0].appendChild(this.document.createTextNode(""));var x=this.document.createRange();x.setStart(p[0],this.startOffset);try{x.setEnd(this.endContainer[0],this.endOffset)}catch(G){if(G.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(q);x.setEnd(this.endContainer[0],this.endOffset)}else throw G;}p=D(this.document).getNative();
p.removeAllRanges();p.addRange(x)}:function(p){var x=this.collapsed,G,c;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var h=this.startContainer[0].childNodes[this.startOffset];if(h.nodeType==A.NODE_ELEMENT){(new C(this.document)).selectElement(new b(h));return}}if(this.startContainer[0].nodeType==A.NODE_ELEMENT&&this.startContainer._4e_name()in j||this.endContainer[0].nodeType==A.NODE_ELEMENT&&this.endContainer._4e_name()in j)this.shrink(o.SHRINK_ELEMENT,q);
var m=this.createBookmark();h=m.startNode;var y;if(!x)y=m.endNode;m=this.document.body.createTextRange();m.moveToElementText(h[0]);m.moveStart("character",1);if(y){p=this.document.body.createTextRange();p.moveToElementText(y[0]);m.setEndPoint("EndToEnd",p);m.moveEnd("character",-1)}else{for(G=h[0].nextSibling;G&&!l(G);)G=G.nextSibling;G=!(G&&G.nodeValue&&G.nodeValue.match(r))&&(p||!h[0].previousSibling||h[0].previousSibling&&g._4e_name(h[0].previousSibling)=="br");c=new b(this.document.createElement("span"));
c.html("&#65279;");c.insertBefore(h);if(G)g.insertBefore(this.document.createTextNode("\ufeff"),h[0]||h)}this.setStartBefore(h);h._4e_remove();if(x){if(G){m.moveStart("character",-1);m.select();this.document.selection.clear()}else m.select();if(c){this.moveToPosition(c,o.POSITION_BEFORE_START);c._4e_remove()}}else{this.setEndBefore(y);y._4e_remove();m.select()}};C.getSelection=D;w.Selection=C;w.on("instanceCreated",function(p){H(p.editor)})});
KISSY.Editor.add("styles",function(w){function C(B){return!B.attr("_ke_bookmark")}function D(B,J){for(var E in B)if(B.hasOwnProperty(E))if(x.isString(B[E]))B[E]=B[E].replace(W,function(I,F){return J[F]});else D(B[E],J)}function H(B,J){if(J){B=x.clone(B);D(B,J)}var E=this.element=this.element=(B.element||"*").toLowerCase();this.type=this.type=E=="#"||R[E]?h.STYLE_BLOCK:Q[E]?h.STYLE_OBJECT:h.STYLE_INLINE;this._={definition:B}}function q(B,J){var E=J?this.removeFromRange:this.applyToRange;B.body.focus();
for(var I=new y(B),F=I.getRanges(),L=0;L<F.length;L++)E.call(this,F[L]);I.selectRanges(F)}function v(B,J,E){var I=B.element;if(I=="*")I="span";J=new P(J.createElement(I));E&&E._4e_copyAttributes(J);E=B._.definition;B=E.attributes;E=H.getStyleText(E);if(B)for(var F in B)J.attr(F,B[F]);if(E)J[0].style.cssText=E;return J}function z(B){var J=B.createBookmark(l),E=B.createIterator();E.enforceRealBlocks=l;E.enlargeBr=l;for(var I,F=B.document;I=E.getNextParagraph();){var L=v(this,F,I);I=I;var K=L;L=K._4e_name==
"pre";var S=I._4e_name=="pre",T=!L&&S;if(L&&!S){S=I;K=K;T=S.html();T=u(T,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");T=T.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");T=T.replace(/([ \t\n\r]+|&nbsp;)/g," ");T=T.replace(/<br\b[^>]*>/gi,"\n");if(O.ie){S=S[0].ownerDocument.createElement("div");S.appendChild(K[0]);K[0].outerHTML="<pre>"+T+"</pre>";K=new P(S.firstChild);K._4e_remove()}else K.html(T);K=K}else if(T)K=g(t(I),K);else I._4e_moveChildren(K);I[0].parentNode.replaceChild(K[0],I[0]);if(L){I=K;L=
void 0;if((L=I._4e_previousSourceNode(l,n.NODE_ELEMENT))&&L._4e_name()=="pre"){K=u(L.html(),/\n$/,"")+"\n\n"+u(I.html(),/^\n/,"");if(O.ie)I[0].outerHTML="<pre>"+K+"</pre>";else I.html(K);L._4e_remove()}}}B.moveToBookmark(J)}function u(B,J,E){var I="",F="";B=B.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(L,K,S){K&&(I=K);S&&(F=S);return""});return I+B.replace(J,E)+F}function t(B){var J=[];u(B._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(E,I,F){return I+"</pre>"+F+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(E,I){J.push(I)});return J}function g(B,J){for(var E=J[0].ownerDocument.createDocumentFragment(),I=0;I<B.length;I++){var F=B[I];F=F.replace(/(\r\n|\r)/g,"\n");F=u(F,/^[ \t]*\n/,"");F=u(F,/\n$/,"");F=u(F,/^[ \t]+|[ \t]+$/g,function(K,S){return K.length==1?"&nbsp;":S?" "+Array(K.length).join("&nbsp;"):Array(K.length).join("&nbsp;")+" "});F=F.replace(/\n/g,"<br>");F=F.replace(/[ \t]{2,}/g,function(K){return Array(K.length).join("&nbsp;")+
" "});var L=J._4e_clone();L.html(F);E.appendChild(L[0])}return E}function d(B){var J=B.document;if(B.collapsed){J=v(this,J,undefined);B.insertNode(J);B.moveToPosition(J,m.POSITION_BEFORE_END)}else{var E=this.element,I=this._.definition,F,L=w.XHTML_DTD[E]||(F=l,w.XHTML_DTD.span),K=B.createBookmark();B.enlarge(m.ENLARGE_ELEMENT);B.trim();var S=B.createBookmark(),T=S.startNode;S=S.endNode;for(var X=T,$;X&&X[0];){var V=r;if(c._4e_equals(X,S)){X=p;V=l}else{var Z=X[0].nodeType,ca=Z==n.NODE_ELEMENT?X._4e_name():
p;if(ca&&X.attr("_ke_bookmark")){X=X._4e_nextSourceNode(l);continue}if(!ca||L[ca]&&(X._4e_position(S)|s.POSITION_PRECEDING|s.POSITION_IDENTICAL|s.POSITION_IS_CONTAINED)==s.POSITION_PRECEDING+s.POSITION_IDENTICAL+s.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(X))){var Y=X.parent();if(Y&&E=="a"&&Y._4e_name()==E){Z=v(this,J,undefined);Y._4e_moveChildren(Z);Y[0].parentNode.replaceChild(Z[0],Y[0]);Z._4e_mergeSiblings()}else if(Y&&Y[0]&&((w.XHTML_DTD[Y._4e_name()]||w.XHTML_DTD.span)[E]||F)&&(!I.parentRule||
I.parentRule(Y))){if(!$&&(!ca||!w.XHTML_DTD.$removeEmpty[ca]||(X._4e_position(S)|s.POSITION_PRECEDING|s.POSITION_IDENTICAL|s.POSITION_IS_CONTAINED)==s.POSITION_PRECEDING+s.POSITION_IDENTICAL+s.POSITION_IS_CONTAINED)){$=new N(J);$.setStartBefore(X)}if(Z==n.NODE_TEXT||Z==n.NODE_ELEMENT&&!X[0].childNodes.length){Y=X;for(var ba;(V=!Y._4e_next(C))&&(ba=Y.parent(),L[ba._4e_name()])&&(ba._4e_position(T)|s.POSITION_FOLLOWING|s.POSITION_IDENTICAL|s.POSITION_IS_CONTAINED)==s.POSITION_FOLLOWING+s.POSITION_IDENTICAL+
s.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(ba));)Y=ba;$.setEndAfter(Y)}}else V=l}else V=l;X=X._4e_nextSourceNode()}if(V&&$&&!$.collapsed){V=v(this,J,undefined);Y=$.getCommonAncestor();Z={styles:{},attrs:{},blockedStyles:{},blockedAttrs:{}};for(var aa,da,ea;V&&Y&&V[0]&&Y[0];){if(Y._4e_name()==E){for(aa in I.attributes)if(!(Z.blockedAttrs[aa]||!(ea=Y.attr(da))))if(V.attr(aa)==ea)V.removeAttr(aa);else Z.blockedAttrs[aa]=1;for(da in I.styles)if(!(Z.blockedStyles[da]||!(ea=Y._4e_style(da))))if(V._4e_style(da)==
ea)V._4e_style(da,"");else Z.blockedStyles[da]=1;if(!V._4e_hasAttributes()){V=p;break}}Y=Y.parent()}if(V){V[0].appendChild($.extractContents());k(this,V);$.insertNode(V);V._4e_mergeSiblings();O.ie||V[0].normalize()}else{V=new P(J.createElement("span"));V[0].appendChild($.extractContents());$.insertNode(V);k(this,V);V._4e_remove(true)}$=p}}T._4e_remove();S._4e_remove();B.moveToBookmark(K);B.shrink(m.SHRINK_TEXT)}}function b(B){B.enlarge(m.ENLARGE_ELEMENT);var J=B.createBookmark(),E=J.startNode;if(B.collapsed){for(var I=
new M(E.parent()),F,L=0,K;L<I.elements.length&&(K=I.elements[L]);L++){if(K==I.block||K==I.blockLimit)break;if(this.checkElementRemovable(K)){var S=B.checkBoundaryOfElement(K,m.END),T=!S&&B.checkBoundaryOfElement(K,m.START);if(T||S){F=K;F.match=T?"start":"end"}else{K._4e_mergeSiblings();if(K._4e_name()!=this.element){S=A(this);i(K,S[K._4e_name()]||S["*"])}else a(this,K)}}}if(F&&F[0]){K=E;for(L=0;;L++){S=I.elements[L];if(c._4e_equals(S,F))break;else if(S.match)continue;else S=S._4e_clone();S[0].appendChild(K[0]);
K=S}c[F.match=="start"?"insertBefore":"insertAfter"](c._4e_unwrap(K),c._4e_unwrap(F))}}else{var X=J.endNode,$=this;I=function(){for(var V=new M(E.parent()),Z=new M(X.parent()),ca=p,Y=p,ba=0;ba<V.elements.length;ba++){var aa=V.elements[ba];if(aa==V.block||aa==V.blockLimit)break;if($.checkElementRemovable(aa))ca=aa}for(ba=0;ba<Z.elements.length;ba++){aa=Z.elements[ba];if(aa==Z.block||aa==Z.blockLimit)break;if($.checkElementRemovable(aa))Y=aa}Y&&X._4e_breakParent(Y);ca&&E._4e_breakParent(ca)};I();for(F=
new P(E[0].nextSibling);F[0]!==X[0];){L=F._4e_nextSourceNode();if(F[0]&&F[0].nodeType==n.NODE_ELEMENT&&this.checkElementRemovable(F)){if(F._4e_name()==this.element)a(this,F);else{K=A(this);i(F,K[F._4e_name()]||K["*"])}if(L[0].nodeType==n.NODE_ELEMENT&&L.contains(E)){I();L=new P(E[0].nextSibling)}}F=L}}B.moveToBookmark(J)}function f(B){B=String(B);var J={};B.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(E,I,F){J[I]=F});return J}function o(B,J){var E="";if(J!==r){E=
document.createElement("span");E.style.cssText=B;E=E.style.cssText||""}else E=B;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function A(B){if(B._.overrides)return B._.overrides;var J=B._.overrides={},E=B._.definition.overrides;if(E){x.isArray(E)||(E=[E]);for(var I=0;I<E.length;I++){var F=E[I],L,K,S;if(typeof F=="string")L=F.toLowerCase();else{L=F.element?F.element.toLowerCase():B.element;K=F.attributes;S=F.styles}F=J[L]||(J[L]={});if(K){L=F.attributes=
F.attributes||[];for(var T in K)K.hasOwnProperty(T)&&L.push([T.toLowerCase(),K[T]])}if(S){F=F.styles=F.styles||[];for(var X in S)S.hasOwnProperty(X)&&F.push([X.toLowerCase(),S[X]])}}}return J}function a(B,J){var E=B._.definition,I=A(B),F=G.mix(E.attributes,(I[J._4e_name()]||I["*"]||{}).attributes);E=G.mix(E.styles,(I[J._4e_name()]||I["*"]||{}).styles);I=x.isEmptyObject(F)&&x.isEmptyObject(E);for(var L in F)if(F.hasOwnProperty(L))if(!((L=="class"||B._.definition.fullMatch)&&J.attr(L)!=e(L,F[L]))){I=
I||!!J._4e_hasAttribute(L);J.removeAttr(L)}for(var K in E)if(E.hasOwnProperty(K))if(!(B._.definition.fullMatch&&J._4e_style(K)!=e(K,E[K],l))){I=I||!!J._4e_style(K);J._4e_style(K,"")}j(J)}function e(B,J,E){var I=new P("<span>");I[E?"_4e_style":"attr"](B,J);return I[E?"_4e_style":"attr"](B)}function k(B,J){for(var E=A(B),I=J.all(B.element),F=I.length;--F>=0;)a(B,new P(I[F]));for(var L in E)if(L!=B.element){I=J.all(L);for(F=I.length-1;F>=0;F--){var K=new P(I[F]);i(K,E[L])}}}function i(B,J){var E,I=J&&
J.attributes;if(I)for(E=0;E<I.length;E++){var F=I[E][0],L;if(L=B.attr(F)){var K=I[E][1];if(K===p||K.test&&K.test(L)||typeof K=="string"&&L==K)B[0].removeAttribute(F)}}if(I=J&&J.styles)for(E=0;E<I.length;E++){F=I[E][0];if(K=B.css(F)){var S=I[E][1];if(S===p||S.test&&S.test(L)||typeof S=="string"&&K==S)B.css(F,"")}}j(B)}function j(B){if(!B._4e_hasAttributes()){var J=B[0].firstChild,E=B[0].lastChild;B._4e_remove(l);if(J){J.nodeType==n.NODE_ELEMENT&&c._4e_mergeSiblings(J);E&&J!=E&&E.nodeType==n.NODE_ELEMENT&&
c._4e_mergeSiblings(E)}}}var l=true,r=false,p=null,x=KISSY,G=w.Utils,c=x.DOM,h={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},m=w.RANGE,y=w.Selection,n=w.NODE,s=w.POSITION,N=w.Range,P=x.Node,O=x.UA,M=w.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},Q={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},U=/\s*(?:;\s*|$)/g,W=/#\((.+?)\)/g;w.STYLE=h;H.prototype={apply:function(B){q.call(this,B,r)},remove:function(B){q.call(this,B,l)},applyToRange:function(B){return(this.applyToRange=
this.type==h.STYLE_INLINE?d:this.type==h.STYLE_BLOCK?z:this.type==h.STYLE_OBJECT?p:p).call(this,B)},removeFromRange:function(B){return(this.removeFromRange=this.type==h.STYLE_INLINE?b:p).call(this,B)},checkElementRemovable:function(B,J){if(!B)return r;var E=this._.definition,I;if(B._4e_name()==this.element){if(!J&&!B._4e_hasAttributes())return l;var F=E._AC;if(F)E=F;else{F={};var L=0,K=E.attributes;if(K)for(var S in K){L++;F[S]=K[S]}if(K=H.getStyleText(E)){F.style||L++;F.style=K}F._length=L;E=E._AC=
F}if(E._length){for(var T in E)if(T!="_length"){L=B.attr(T)||"";if(T=="style")a:{F=E[T];L=o(L,r);typeof F=="string"&&(F=f(F));typeof L=="string"&&(L=f(L));K=void 0;for(K in F)if(!(K in L&&(L[K]==F[K]||F[K]=="inherit"||L[K]=="inherit"))){F=r;break a}F=l}else F=E[T]==L;if(F){if(!J)return l}else if(J)return r}if(J)return l}else return l}T=A(this);if(T=T[B._4e_name()]||T["*"]){if(!(E=T.attributes)&&!(I=T.styles))return l;if(E)for(F=0;F<E.length;F++){T=E[F][0];if(T=B.attr(T)){L=E[F][1];if(L===p||typeof L==
"string"&&T==L||L.test&&L.test(T))return l}}if(I)for(F=0;F<I.length;F++)if(T=B.css(I[F][0])){E=I[F][1];if(E===p||typeof E=="string"&&T==E||E.test&&E.test(T))return l}}return r},checkActive:function(B){switch(this.type){case h.STYLE_BLOCK:return this.checkElementRemovable(B.block||B.blockLimit,l);case h.STYLE_OBJECT:case h.STYLE_INLINE:for(var J=B.elements,E=0,I;E<J.length;E++){I=J[E];if(!(this.type==h.STYLE_INLINE&&(c._4e_equals(I,B.block)||c._4e_equals(I,B.blockLimit))))if(!(this.type==h.STYLE_OBJECT&&
!(I._4e_name()in Q)))if(this.checkElementRemovable(I,l))return l}}return r}};H.getStyleText=function(B){var J=B._ST;if(J)return J;J=B.styles;var E=B.attributes&&B.attributes.style||"",I="";if(E.length)E=E.replace(U,";");for(var F in J){var L=J[F],K=(F+":"+L).replace(U,";");if(L=="inherit")I+=K;else E+=K}if(E.length)E=o(E);E+=I;return B._ST=E};w.Style=H});
KISSY.Editor.add("htmlparser",function(){function w(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var C=KISSY,D=function(){},H=C.Editor,q=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,v={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},z=H.XHTML_DTD;C.augment(w,{onTagOpen:D,onTagClose:D,
onText:D,onCDATA:D,onComment:D,parse:function(u){for(var t,g,d=0,b;t=this._.htmlPartsRegex.exec(u);){g=t.index;if(g>d){d=u.substring(d,g);b?b.push(d):this.onText(d)}d=this._.htmlPartsRegex.lastIndex;if(g=t[1]){g=g.toLowerCase();if(b&&z.$cdata[g]){this.onCDATA(b.join(""));b=null}if(!b){this.onTagClose(g);continue}}if(b)b.push(t[0]);else if(g=t[3]){g=g.toLowerCase();if(!/="/.test(g)){var f={},o;t=t[4];var A=!!(t&&t.charAt(t.length-1)=="/");if(t)for(;o=q.exec(t);){var a=o[1].toLowerCase();o=o[2]||o[3]||
o[4]||"";f[a]=!o&&v[a]?a:o}this.onTagOpen(g,f,A);if(!b&&z.$cdata[g])b=[]}}else if(g=t[2])this.onComment(g)}u.length>d&&this.onText(u.substring(d,u.length))}});H.HtmlParser=w;H.HtmlParser=w});
KISSY.Editor.add("htmlparser-basicwriter",function(){function w(){this._={output:[]}}var C=KISSY,D=C.Editor,H=D.Utils;C.augment(w,{openTag:function(q){this._.output.push("<",q)},openTagClose:function(q,v){v?this._.output.push(" />"):this._.output.push(">")},attribute:function(q,v){if(typeof v=="string")v=H.htmlEncodeAttr(v);this._.output.push(" ",q,'="',v,'"')},closeTag:function(q){this._.output.push("</",q,">")},text:function(q){this._.output.push(q)},comment:function(q){this._.output.push("<!--",
q,"--\>")},write:function(q){this._.output.push(q)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(q){var v=this._.output.join("");q&&this.reset();return v}});D.HtmlParser.BasicWriter=w});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function w(){w.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=v;this.sortAttributes=q;this._.indent=v;this._.indentation="";this._.rules={};var z=D.XHTML_DTD,u;for(u in H.mix({},z.$nonBodyContent,z.$block,z.$listItem,z.$tableContent))this.setRules(u,{indent:q,breakBeforeOpen:q,breakAfterOpen:q,breakBeforeClose:!z[u]["#"],breakAfterClose:q});this.setRules("br",
{breakAfterOpen:q});this.setRules("title",{indent:v,breakAfterOpen:v});this.setRules("style",{indent:v,breakBeforeClose:q});this.setRules("pre",{indent:v})}var C=KISSY,D=C.Editor,H=D.Utils,q=true,v=false;C.extend(w,D.HtmlParser.BasicWriter,{openTag:function(z){var u=this._.rules[z];if(this._.indent)this.indentation();else if(u&&u.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",z)},openTagClose:function(z,u){var t=this._.rules[z];if(u)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(t&&t.indent)this._.indentation+=this.indentationChars}t&&t.breakAfterOpen&&this.lineBreak()},attribute:function(z,u){if(typeof u=="string"){this.forceSimpleAmpersand&&(u=u.replace(/&amp;/g,"&"));u=H.htmlEncodeAttr(u)}this._.output.push(" ",z,'="',u,'"')},closeTag:function(z){var u=this._.rules[z];if(u&&u.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(u&&u.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",z,">");u&&u.breakAfterClose&&this.lineBreak()},text:function(z){if(this._.indent){this.indentation();z=H.ltrim(z)}this._.output.push(z)},comment:function(z){this._.indent&&this.indentation();this._.output.push("<!--",z,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=q},indentation:function(){this._.output.push(this._.indentation);this._.indent=v},setRules:function(z,u){var t=this._.rules[z];if(t)H.mix(t,
u);else this._.rules[z]=u}});D.HtmlParser.HtmlWriter=w});
KISSY.Editor.add("htmlparser-fragment",function(){function w(){this.children=[];this.parent=H;this._={isBlockLike:C,hasInlineStarted:D}}var C=true,D=false,H=null,q=KISSY.Editor,v={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},z=KISSY,u=q.Utils,t=q.NODE,g=q.XHTML_DTD;u.mix({table:1,ul:1,ol:1,dl:1},g.table,g.ul,g.ol,g.dl);var d=g.$list,b=g.$listItem;w.FromHtml=function(f,o){function A(h){var m;if(j.length>0)for(var y=0;y<j.length;y++){var n=j[y],s=n.name,N=g[s],P=r.name&&g[r.name];
if((!P||P[s])&&(!h||!N||N[h]||!g[h])){if(!m){a();m=1}n=n.clone();n.parent=r;r=n;j.splice(y,1);y--}}}function a(){for(;l.length;)r.add(l.shift())}function e(h,m,y){m=m||r||i;if(o&&!m.type){var n,s;if((n=h.attributes&&(s=h.attributes._ke_real_element_type)?s:h.name)&&!(n in g.$body)&&!(n in g.$nonBodyContent)){s=r;r=m;k.onTagOpen({li:"ul",dt:"dl",dd:"dl"}[n]||o,{});m=r;if(y)r=s}}if(h._.isBlockLike&&h.name!="pre"){y=h.children.length;if((n=h.children[y-1])&&n.type==t.NODE_TEXT)if(s=u.rtrim(n.value))n.value=
s;else h.children.length=y-1}m.add(h);if(h.returnPoint){r=h.returnPoint;delete h.returnPoint}}var k=new q.HtmlParser,i=new w,j=[],l=[],r=i,p=D,x;k.onTagOpen=function(h,m,y){var n=new q.HtmlParser.Element(h,m);if(n.isUnknown&&y)n.isEmpty=C;if(g.$removeEmpty[h])j.push(n);else{if(String(h)==="pre")p=C;else if(String(h)==="br"&&p){r.add(new q.HtmlParser.Text("\n"));return}if(String(h)==="br")l.push(n);else{var s=r.name,N=s&&(g[s]||(r._.isBlockLike?g.div:g.span));if(N&&!n.isUnknown&&!r.isUnknown&&!N[h]){N=
D;var P;if(h in d&&s in d){s=r.children;(s=s[s.length-1])&&s.name in b||e(s=new q.HtmlParser.Element("li"),r);x=r;P=s}else if(h==s)e(r,r.parent);else{e(r,r.parent,C);!v[s]&&s in g.$inline&&j.unshift(r);N=C}r=P?P:r.returnPoint||r.parent;if(N){k.onTagOpen.apply(this,arguments);return}}A(h);a();n.parent=r;n.returnPoint=x;x=0;if(n.isEmpty)e(n);else r=n}}};k.onTagClose=function(h){for(var m=j.length-1;m>=0;m--)if(h==j[m].name){j.splice(m,1);return}for(var y=[],n=[],s=r;s.type&&s.name!=h;){s._.isBlockLike||
n.unshift(s);y.push(s);s=s.parent}if(s.type){for(m=0;m<y.length;m++){var N=y[m];e(N,N.parent)}r=s;if(r.name=="pre")p=D;s._.isBlockLike&&a();e(s,s.parent);if(s==r)r=r.parent;j=j.concat(n)}if(h=="body")o=D};k.onText=function(h){if(!r._.hasInlineStarted&&!p){h=u.ltrim(h);if(h.length===0)return}a();A();if(o&&(!r.type||r.name=="body")&&u.trim(h))this.onTagOpen(o,{});p||(h=h.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));r.add(new q.HtmlParser.Text(h))};k.onCDATA=function(h){r.add(new q.HtmlParser.cdata(h))};
k.onComment=function(h){r.add(new q.HtmlParser.Comment(h))};k.parse(f);for(a();r.type;){var G=r.parent,c=r;if(o&&(!G.type||G.name=="body")&&!g.$body[c.name]){r=G;k.onTagOpen(o,{});G=r}G.add(c);r=G}return i};z.augment(w,{add:function(f){var o=this.children.length;if(o=o>0&&this.children[o-1]||H){if(f._.isBlockLike&&o.type==t.NODE_TEXT){o.value=u.rtrim(o.value);if(o.value.length===0){this.children.pop();this.add(f);return}}o.next=f}f.previous=o;f.parent=this;this.children.push(f);this._.hasInlineStarted=
f.type==t.NODE_TEXT||f.type==t.NODE_ELEMENT&&!f._.isBlockLike},writeHtml:function(f,o){var A;this.filterChildren=this.filterChildren=function(){var a=new q.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,a,o,C);a=a.getHtml();this.children=(new w.FromHtml(a)).children;A=1};!this.name&&o&&o.onFragment(this);this.writeChildrenHtml(f,A?H:o)},writeChildrenHtml:function(f,o){for(var A=0;A<this.children.length;A++)this.children[A].writeHtml(f,o)}});q.HtmlParser.Fragment=w});
KISSY.Editor.add("htmlparser-element",function(){function w(q,v){this.name=q;this.attributes=v||(v={});this.children=[];var z=v._ke_real_element_type||q,u=C.XHTML_DTD;z=!!(u.$nonBodyContent[z]||u.$block[z]||u.$listItem[z]||u.$tableContent[z]||u.$nonEditable[z]||z=="br");var t=!!u.$empty[q];this.isEmpty=t;this.isUnknown=!u[q];this._={isBlockLike:z,hasInlineStarted:t||!z}}var C=KISSY.Editor,D=C.NODE,H=function(q,v){q=q[0];v=v[0];return q<v?-1:q>v?1:0};KISSY.augment(w,{type:D.NODE_ELEMENT,add:C.HtmlParser.Fragment.prototype.add,
clone:function(){return new w(this.name,this.attributes)},writeHtml:function(q,v){var z=this.attributes,u=this,t=u.name,g,d,b,f;u.filterChildren=function(){if(!f){var a=new C.HtmlParser.BasicWriter;C.HtmlParser.Fragment.prototype.writeChildrenHtml.call(u,a,v);u.children=(new C.HtmlParser.Fragment.FromHtml(a.getHtml())).children;f=1}};u.filterChildren=u.filterChildren;if(v){for(;;){if(!(t=v.onElementName(t)))return;u.name=t;if(!(u=v.onElement(u)))return;u.parent=this.parent;if(u.name==t)break;if(u.type!=
D.NODE_ELEMENT){u.writeHtml(q,v);return}t=u.name;if(!t){this.writeChildrenHtml.call(u,q,f?null:v);return}}z=u.attributes}q.openTag(t,z);for(var o=[],A=0;A<2;A++)for(g in z){d=g;b=z[g];if(A==1)o.push([g,b]);else if(v){for(;;)if(d=v.onAttributeName(g))if(d!=g){delete z[g];g=d}else break;else{delete z[g];break}if(d)if((b=v.onAttribute(u,d,b))===false)delete z[d];else z[d]=b}}q.sortAttributes&&o.sort(H);z=o.length;for(A=0;A<z;A++){g=o[A];q.attribute(g[0],g[1])}q.openTagClose(t,u.isEmpty);if(!u.isEmpty){this.writeChildrenHtml.call(u,
q,f?null:v);q.closeTag(t)}},writeChildrenHtml:function(){C.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});C.HtmlParser.Element=w});
KISSY.Editor.add("htmlparser-filter",function(){function w(d){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};d&&this.addRules(d,10)}function C(d,b){for(var f=0;d&&f<b.length;f++){var o=b[f];d=d.replace(o[0],o[1])}return d}function D(d,b,f){if(typeof b=="function")b=[b];var o,A;A=d.length;var a=b&&b.length;if(a){for(o=0;o<A&&d[o].pri<f;o++);for(A=a-1;A>=0;A--)if(a=b[A]){a.pri=f;d.splice(o,0,a)}}}function H(d,b,f){if(b)for(var o in b){var A=d[o];d[o]=q(A,b[o],
f);A||d.$length++}}function q(d,b,f){if(b){b.pri=f;if(d){if(d.splice)D(d,b,f);else{d=d.pri>f?[b,d]:[d,b];d.filter=v}return d}else return b.filter=b}}function v(d){for(var b=d.type||d instanceof u.HtmlParser.Fragment,f=0;f<this.length;f++){if(b)var o=d.type,A=d.name;var a=this[f].apply(window,arguments);if(a===g)return a;if(b){if(a&&(a.name!=A||a.type!=o))return a}else if(typeof a!="string")return a;a!=undefined&&(d=a)}return d}var z=KISSY,u=z.Editor,t=u.NODE,g=false;z.augment(w,{addRules:function(d,
b){if(typeof b!="number")b=10;D(this._.elementNames,d.elementNames,b);D(this._.attributeNames,d.attributeNames,b);H(this._.elements,d.elements,b);H(this._.attributes,d.attributes,b);this._.text=q(this._.text,d.text,b)||this._.text;this._.comment=q(this._.comment,d.comment,b)||this._.comment;this._.root=q(this._.root,d.root,b)||this._.root},onElementName:function(d){return C(d,this._.elementNames)},onAttributeName:function(d){return C(d,this._.attributeNames)},onText:function(d){var b=this._.text;
return b?b.filter(d):d},onComment:function(d,b){var f=this._.comment;return f?f.filter(d,b):d},onFragment:function(d){var b=this._.root;return b?b.filter(d):d},onElement:function(d){for(var b=[this._.elements["^"],this._.elements[d.name],this._.elements.$],f,o=0;o<3;o++)if(f=b[o]){f=f.filter(d,this);if(f===g)return null;if(f&&f!=d)return this.onNode(f);if(d.parent&&!d.name)break}return d},onNode:function(d){var b=d.type;return b==t.NODE_ELEMENT?this.onElement(d):b==t.NODE_TEXT?new u.HtmlParser.Text(this.onText(d.value)):
null},onAttribute:function(d,b,f){if(b=this._.attributes[b]){d=b.filter(f,d,this);if(d===g)return g;if(typeof d!="undefined")return d}return f}});u.HtmlParser.Filter=w});KISSY.Editor.add("htmlparser-text",function(){function w(q){this.value=q;this._={isBlockLike:H}}var C=KISSY,D=C.Editor,H=false;C.augment(w,{type:D.NODE.NODE_TEXT,writeHtml:function(q,v){var z=this.value;v&&!(z=v.onText(z,this))||q.text(z)}});D.HtmlParser.Text=w;D.HtmlParser.Text=w});
KISSY.Editor.add("htmlparser-cdata",function(w){w.HtmlParser.cdata=function(C){this.value=C};w.HtmlParser.cdata.prototype={type:w.NODE.NODE_TEXT,writeHtml:function(C){C.write(this.value)}}});
KISSY.Editor.add("htmlparser-comment",function(){function w(H){this.value=H;this._={isBlockLike:false}}var C=KISSY.Editor,D=C.NODE;C.HtmlParser.Comment=w;C.HtmlParser.Comment=w;w.prototype={constructor:w,type:D.NODE_COMMENT,writeHtml:function(H,q){var v=this.value;if(q){if(!(v=q.onComment(v,this)))return;if(typeof v!="string"){v.parent=this.parent;v.writeHtml(H,q);return}}H.comment(v)}}});
KISSY.Editor.add("button",function(){function w(q){if(q&&q.indexOf("<")==-1)return q;return 0}var C=KISSY,D=C.Editor;if(D.TripleButton)C.log("TripleButton attach twice","warn");else{var H=C.UIBase.create([C.UIBase.Box.Render||C.UIBase.Box],{_updateHref:function(){this.get("el").attr("href","javascript:void('"+(w(this.get("text"))||w(this.get("title")))+"')")},bindUI:function(){var q=this,v=q.get("el");v.on("click",q._action,q);v.on("mousedown",function(){q.get("state")=="off"&&v.addClass("ke-triplebutton-active")});
v.on("mouseup mouseleave",function(){q.get("state")=="off"&&v.hasClass("ke-triplebutton-active")&&setTimeout(function(){v.removeClass("ke-triplebutton-active")},300)})},_uiSetTitle:function(){this.get("el").attr("title",this.get("title"));this._updateHref()},_uiSetContentCls:function(q){var v=this.get("el");if(q!==undefined){v.html("<span class='ke-toolbar-item "+q+"' />");v._4e_unselectable()}},_uiSetText:function(q){this.get("el").html(q);this._updateHref()},_uiSetState:function(q){this["_"+q]()},
disable:function(){this._savedState=this.get("state");this.set("state","disabled")},enable:function(){this.get("state")=="disabled"&&this.set("state",this._savedState)},_action:function(q){this.fire(this.get("state")+"Click",{TripleEvent:q});this.fire("click",{TripleClickType:this.get("state")+"Click"});q&&q.preventDefault()},bon:function(){this.set("state","on")},boff:function(){this.set("state","off")},_on:function(){var q=this.get("el");q.removeClass("ke-triplebutton-off ke-triplebutton-disabled");
q.addClass("ke-triplebutton-on")},_off:function(){var q=this.get("el");q.removeClass("ke-triplebutton-on ke-triplebutton-disabled");q.addClass("ke-triplebutton-off")},_disabled:function(){var q=this.get("el");q.removeClass("ke-triplebutton-off ke-triplebutton-on");q.addClass("ke-triplebutton-disabled")}},{ATTRS:{state:{value:"off"},elCls:{value:"ke-triplebutton ke-triplebutton-off"},elTagName:{value:"a"},title:{},contentCls:{},text:{}}});H.ON="on";H.OFF="off";H.DISABLED="disabled";H.ON_CLASS="ke-triplebutton-on";
H.OFF_CLASS="ke-triplebutton-off";H.DISABLED_CLASS="ke-triplebutton-disabled";D.TripleButton=H;D.prototype.addButton=function(q,v){var z=this,u=new H({render:z.toolBarDiv,autoRender:true,title:v.title,text:v.text,contentCls:v.contentCls}),t={btn:u,editor:z,cfg:v,call:function(){var g=C.makeArray(arguments),d=g.shift();return v[d].apply(t,g)},reload:function(g){C.mix(v,g);u.enable();z.on("selectionChange",function(){z.getMode()!=D.SOURCE_MODE&&v.selectionChange&&v.selectionChange.apply(t,arguments)});
u.on("click",function(d){var b=d.TripleClickType;v[b]&&v[b].apply(t,arguments);d&&d.halt()});if(v.mode==D.WYSIWYG_MODE){z.on("wysiwygmode",u.enable,u);z.on("sourcemode",u.disable,u)}v.init&&v.init.call(t)},destroy:function(){v.destroy&&v.destroy.call(t);u.destroy()}};v.loading?u.disable():t.reload(undefined);return t}}},{attach:false});
KISSY.Editor.add("select",function(){function w(d){w.superclass.constructor.call(this,d);this._init()}function C(d){if(d&&d.indexOf("<")==-1)return d;return 0}var D=KISSY,H=D.Node,q=D.Event,v=D.DOM,z=D.Editor;if(z.Select)D.log("ke select attach more");else{w.DISABLED=0;w.ENABLED=1;var u=z.XHTML_DTD;w.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},title:{},items:{},emptyText:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){for(var d=this.el.parent();d;){var b=d._4e_name();
if(u[b]&&u[b].div)return d;d=d.parent()}return new H(document.body)}},state:{value:1}};w.decorate=function(d){for(var b=d.width(),f=[],o=d.all("option"),A=0;A<o.length;A++){var a=o[A];f.push({name:v.html(a),value:v.attr(a,"value")})}return new w({width:b+"px",title:d.attr("title"),el:d,items:f,cls:"ke-combox",value:d.val()})};var t=z.Utils.addRes,g=z.Utils.destroyRes;D.extend(w,D.Base,{_init:function(){var d=this.get("container"),b=this.get("el"),f=new H("<span class='ke-select-wrap'><a class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"),
o=f.one("a"),A=this.get("title")||"",a=this.get("cls"),e=f.one(".ke-select-text"),k=f.one(".ke-select-text-inner");f.one(".ke-select-drop");this.get("value")!==undefined?k.html(this._findNameByV(this.get("value"))):k.html(A);e.css("width",this.get("width"));f._4e_unselectable();A&&f.attr("title",A);o.attr("href","javascript:void('"+C(A)+"')");a&&f.addClass(a);if(b)b[0].parentNode.replaceChild(f[0],b[0]);else d&&f.appendTo(d);f.on("click",this._click,this);this.el=f;this.title=k;this._focusA=f.one("a.ke-select");
z.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this);this.on("afterStateChange",this._stateChange,this)},_findNameByV:function(d){var b=this.get("title")||"",f=this.get("items");if(this.get("showValue"))return d||b;for(var o=0;o<f.length;o++){var A=f[o];if(A.value==d){b=A.name;break}}return b},_valueChange:function(d){this.title.html(this._findNameByV(d.newVal))},_itemsChange:function(d){var b;b=d.newVal;d=this._selectList;d.html("");if(b&&b.length)for(var f=
0;f<b.length;f++){var o=b[f];(new H("<a class='ke-select-menu-item' href='javascript:void(\""+C(o.name)+"\")' data-value='"+o.value+"'>"+o.name+"</a>",o.attrs)).appendTo(d)._4e_unselectable()}else if(b=this.get("emptyText"))(new H("<a class='ke-select-menu-item' href='javascript:void(\""+C(b)+"\")'>"+b+"</a>")).appendTo(d)._4e_unselectable();this.as=d.all("a")},val:function(d){if(d!==undefined){this.set("value",d);return this}else return this.get("value")},_resize:function(){this.menu.get("visible")&&
this._real()},_prepare:function(){function d(k){k=new H(k.target);f.contains(k)||f._4e_equals(k)||a.hide()}var b=this,f=b.el,o=b.get("popUpWidth"),A=b._focusA,a=new z.Overlay({autoRender:true,render:b.get("menuContainer"),content:"<div>",focus4e:false,elCls:"ke-menu",width:o?o:f.width(),zIndex:z.baseZIndex(z.zIndexManager.SELECT),focusMgr:false}),e=b.get("items");t.call(b,a);o=a.get("contentEl").one("div");b.menu=a;q.on(window,"resize",b._resize,b);t.call(b,function(){q.remove(window,"resize",b._resize,
b)});b.get("title")&&(new H("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+b.get("title")+"</div>")).appendTo(o);b._selectList=(new H("<div>")).appendTo(o);b._itemsChange({newVal:e});a.on("show",function(){A.addClass("ke-select-active")});a.on("hide",function(){A.removeClass("ke-select-active")});q.on(document,"click",d);t.call(b,function(){q.remove(document,"click",d)});b.get("doc")&&q.on(b.get("doc"),"click",d);o.on("click",b._select,b);b.as=b._selectList.all("a");q.on(o[0],
"mouseenter",function(){b.as.removeClass("ke-menu-selected")});t.call(b,o);b.on("afterItemsChange",b._itemsChange,b);b.menuNode=o},_stateChange:function(d){var b=this.el;d.newVal==1?b.removeClass("ke-select-disabled"):b.addClass("ke-select-disabled")},enable:function(){this.set("state",1)},disable:function(){this.set("state",0)},_select:function(d){d&&d.halt();var b=this.menu,f=this.menuNode;if((d=(new H(d.target))._4e_ascendant(function(a){return f.contains(a)&&a._4e_name()=="a"},true))&&d._4e_hasAttribute("data-value")){var o=
this.get("value"),A=d.attr("data-value");this.set("value",A);this.fire("click",{newVal:A,prevVal:o,name:d.html()});b.hide()}},_real:function(){var d=this.el,b=d.offset(),f=D.clone(b),o=this.menu.get("el").height(),A=this.menu.get("el").width(),a=v.scrollTop(),e=v.scrollLeft(),k=v.viewportHeight(),i=v.viewportWidth();i=e+i-60;k=a+k;var j=b.top+(d.height()-2);d=b.left+d.width()-2;var l=this.get("align"),r=l[0];if(l[1]=="b"){b.top=j;if(b.top+o>k&&f.top-a>k-j)b.top=f.top-o}else{b.top=f.top-o;if(b.top<
a&&f.top-a<k-j)b.top=j}if(r=="l"){if(b.left+A>i&&d-e>i-f.left)b.left=d-A}else{b.left=d-A;if(b.left<e&&d-e<i-f.left)b.left=f.left}this.menu.set("xy",[b.left,b.top]);this.menu.show()},_click:function(d){if(!this.loading){d&&d.preventDefault();var b=this;d=b.el;var f=b.get("value");if(!d.hasClass("ke-select-disabled"))if(b._focusA.hasClass("ke-select-active"))b.menu&&b.menu.hide();else{b.loading=true;z.use("overlay",function(){b.loading=false;b.fire("select");b._prepare();f&&b.menu&&b.as.each(function(o){o.attr("data-value")==
f?o.addClass("ke-menu-selected"):o.removeClass("ke-menu-selected")})})}}},destroy:function(){g.call(this);this.el.detach();this.el.remove()}});z.Select=w;z.prototype.addSelect=function(d,b){var f=this;b=D.mix({container:f.toolBarDiv,doc:f.document,menuContainer:new H(document.body)},b);var o=new w(b),A={btn:o,editor:f,cfg:b,call:function(){var a=D.makeArray(arguments),e=a.shift();return b[e].apply(A,a)},reload:function(a){D.mix(b,a);o.enable();f.on("selectionChange",function(){f.getMode()!=z.SOURCE_MODE&&
b.selectionChange&&b.selectionChange.apply(A,arguments)});o.on("click",function(e){var k=e.type;b[k]&&b[k].apply(A,arguments);e&&e.halt()});if(b.mode==z.WYSIWYG_MODE){f.on("wysiwygmode",o.enable,o);f.on("sourcemode",o.disable,o)}b.init&&b.init.call(A)},destroy:function(){b.destroy&&b.destroy.call(A);o.destroy()}};b.loading?o.disable():A.reload(undefined);return A}}},{attach:false});
