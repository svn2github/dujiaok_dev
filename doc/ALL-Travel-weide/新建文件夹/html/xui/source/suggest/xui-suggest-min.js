xui.widgets.Suggest=function(b,a){this.id=b;this._events={};this.selectNode;this.ops=[];this.x=0;this.y=0;this.selectRowIndex=-1;if(a){this.attributes=a;if(this.attributes.width){this.width=this.attributes.width}if(this.attributes.height){this.height=this.attributes.height}if(this.attributes.x){this.x=this.attributes.x}if(this.attributes.y){this.y=this.attributes.y}if(this.attributes.renderer){this.renderer=this.attributes.renderer}if(this.attributes.emptyMeg){this.emptyMeg=this.attributes.emptyMeg}if(this.attributes.gbk){this.gbk=this.attributes.gbk}}this.anyMatch=(this.attributes&&this.attributes.anyMatch)?this.attributes.anyMatch:false;this.suffix=(this.attributes&&this.attributes.suffix)?this.attributes.suffix:false};xui.widgets.Suggest.prototype={_formatUrl:function(b,a){if(b.indexOf("?")>-1){return b+="&"+a}else{return b+="?"+a}},_getData:function(){var keyValue=xui.util.StringUtil.trim($(this.id).value);this.ops=[];if(keyValue.length>0){if(this.gbk){var str=xui.util.Ajax.syncGet(this._formatUrl(this.dataUrl,"keyValue="+encodeURIComponent(encodeURIComponent(keyValue))))}else{var str=xui.util.Ajax.syncGet(this._formatUrl(this.dataUrl,"keyValue="+encodeURIComponent(keyValue)))}try{this.ops=eval("("+str+")")}catch(e){}}else{return}return this.ops},_hiddenContainer:function(){if(this.container){this.container.style.display="none"}},_showContainer:function(){if(this.container){this.container.style.display="block"}},_rendOps:function(){var e=[];var c=[];var f=this;if(this.ops){var a=this.ops.length;for(var d=0;d<a;d++){var b=document.createElement("div");xui.util.Dom.addClass(b,"xui-suggest-list-item");if(this.renderer){b.innerHTML=this.renderer(this.ops[d])}else{b.innerHTML=xui.util.StringUtil.htmlEncode(this.ops[d].text)}b.title=this.ops[d].text;e[d]=b;xui.util.Event.on(b,"mouseover",function(){xui.util.Dom.addClass(arguments[1],"xui-suggest-ops")},b);xui.util.Event.on(b,"mouseout",function(){xui.util.Dom.removeClass(arguments[1],"xui-suggest-ops")},b);xui.util.Event.on(b,"click",function(){f._clickNode(arguments[1][1],arguments[1][2])},[b,f.ops[d],d])}}return e},_clickNode:function(b,a){$(this.id).value=b.text;this.selectNode=b;this._fire("nodeclick",this.selectNode.text);this._hiddenContainer();this.selectRowIndex=-1},_render:function(){var g=this;var c=xui.util.Dom.getX(this.id);var b=xui.util.Dom.getY(this.id);var f=22;if(!this.container){this.container=document.createElement("div");xui.util.Dom.addClass(this.container,"xui-suggest");this.container.style.width=this.width+"px";this.container.style.height=this.height+"px";this.container.style.left=c+this.x+"px";this.container.style.top=b+f+this.y+"px";document.body.appendChild(this.container);xui.util.Event.on(this.container,"click",function(){if(g.selectNode){g._fire("click",g.selectNode.text)}})}this._showContainer();this.container.innerHTML="";this.nodes=this._rendOps();var a=this.nodes.length;if(a>0){for(var d=0;d<a;d++){this.container.appendChild(this.nodes[d])}}else{var e=xui.util.StringUtil.trim($(this.id).value);if(e&&e.length>0){this.container.innerHTML=this.emptyMeg}else{this._hiddenContainer()}}},filter:function(){var c=xui.util.StringUtil.trim($(this.id).value);var a=this.ops.length;for(var b=0;b<a;b++){if(this.suffix){this.ops[b].text=c+this.ops[b].text}else{if(this.anyMatch){if(this.ops[b].text.indexOf(c)<0){this.ops.splice(b,1);b--;a--}}else{if(!(this.ops[b].text.indexOf(c)==0)){this.ops.splice(b,1);b--;a--}}}}return this.ops},init:function(a){this.dataUrl=a;if(this.dataUrl instanceof Array){this.datas=[];for(var b=0;b<this.dataUrl.length;b++){this.datas[b]={text:this.dataUrl[b].text,value:this.dataUrl[b].value}}}this._initEnvents("click");this._initEnvents("nodeclick");var f=this;xui.util.Event.on(this.id,"keyup",function(g){if(g.keyCode==38||g.keyCode==40||g.keyCode==13){return}if(f.dataUrl instanceof Array){f.ops=[];for(var h=0;h<f.datas.length;h++){f.ops[h]={text:f.datas[h].text,value:f.datas[h].value}}f.filter()}else{f._getData()}f._render()});xui.util.Event.on(document,"click",function(g){var h=g.srcElement||g.target;if(h.id!=f.id){f._hiddenContainer()}});var c=new xui.util.KeyListener(this.id,{keys:40},{fn:f.selectNext,scope:f,correctScope:true});c.enable();var e=new xui.util.KeyListener(this.id,{keys:38},{fn:f.selectPre,scope:f,correctScope:true});e.enable();var d=new xui.util.KeyListener(this.id,{keys:13},{fn:function(){arguments[1][1].cancelBubble=true;var g=f.selectRowIndex;var h=f.ops[g];f._clickNode(h,g);return false},scope:f,correctScope:true});d.enable()},selectNodeByIndex:function(a){if(this.ops[a]){xui.util.Dom.removeClass(this.nodes[this.selectRowIndex],"xui-suggest-ops");this.selectRowIndex=a;this.selectNode=this.ops[a];xui.util.Dom.addClass(this.nodes[a],"xui-suggest-ops")}},selectNext:function(c,b){var a=((this.selectRowIndex+1)>=this.ops.length)?(this.ops.length-1):(this.selectRowIndex+1);this.selectNodeByIndex(a)},selectPre:function(){var a=((this.selectRowIndex-1)>=0)?(this.selectRowIndex-1):0;this.selectNodeByIndex(a)},on:function(a,b){this._events[a].subscribe(b,this)},_initEnvents:function(a){this._events[a]=new YAHOO.util.CustomEvent(a,this)},_fire:function(b,a){this._events[b].fire(a)}};
