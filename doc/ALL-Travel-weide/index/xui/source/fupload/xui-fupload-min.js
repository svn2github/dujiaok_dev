xui.widgets.FUploadProgress=function(d,e,b){var f=this;this._events={};this.file=d;this.ownerFUpload=e;this.container=e.container;this.fileProgressID=d.id;this.fileProgressWrapper=document.createElement("li");this.fileProgressWrapper.className="xui-fupload-progress";if(b){xui.util.Dom.addClass(this.fileProgressWrapper,"xui-fupload-progressError")}this.fileProgressWrapper.id=this.fileProgressID;this.progressDetail=document.createElement("div");this.progressDetail.className="xui-fupload-progressDetail";this.progressFile=document.createElement("span");this.progressFile.className="xui-fupload-file";var a=this.getFileClassByType(d.type);xui.util.Dom.addClass(this.progressFile,a);this.progressFileName=document.createElement("span");this.progressFileName.className="xui-fupload-progressFileName";this.progressUrl=document.createElement("a");this.progressUrl.target="_blank";this.progressUrl.innerHTML=d.name;this.progressUrl.title=d.name;this.progressFileName.appendChild(this.progressUrl);this.progressSize=document.createElement("span");var c=this.getSize(d.size);this.progressSize.innerHTML="("+c+")";this.progressSize.className="xui-fupload-progressSize";this.progressBtn=document.createElement("button");this.progressBtn.className="xui-fupload-btn";this.progressBtn.innerHTML="&nbsp;";this.progressBarInProgress=document.createElement("div");this.progressBarInProgress.className="xui-fupload-progressBarInProgress";if(b){this.progressErrorMessage=document.createElement("div");this.progressErrorMessage.className="xui-fupload-progressErrorMessage";this.progressErrorMessage.innerHTML=b}this.progressDetail.appendChild(this.progressFile);this.progressDetail.appendChild(this.progressFileName);this.progressDetail.appendChild(this.progressSize);this.progressDetail.appendChild(this.progressBtn);this.fileProgressWrapper.appendChild(this.progressDetail);this.fileProgressWrapper.appendChild(this.progressBarInProgress);if(b){this.setComplete();this.fileProgressWrapper.appendChild(this.progressErrorMessage)}this.container.appendChild(this.fileProgressWrapper);this._initEnvents("removeProgress");xui.util.Event.on(this.progressBtn,"click",function(){f.removeProgress()});if(d.url){this.setUrl(d.url)}};xui.widgets.FUploadProgress.prototype={getFileClassByType:function(b){var a=b.toLowerCase();switch(a){case".eml":return"eml";case".docx":return"xui-fupload-file-docS";case".doc":return"xui-fupload-file-docS";case".xlsx":return"xui-fupload-file-xlsS";case".xls":return"xui-fupload-file-xlsS";case".txt":return"xui-fupload-file-txtS";case".gif":return"xui-fupload-file-gifS";case".png":return"xui-fupload-file-pngS";case".jpg":return"xui-fupload-file-jpgS";case".bmp":return"xui-fupload-file-bmpS";case".pdf":return"xui-fupload-file-pdfS";case".pptx":return"xui-fupload-file-pptS";case".ppt":return"xui-fupload-file-pptS";case".zip":return"xui-fupload-file-zipS";case".rar":return"xui-fupload-file-zipS";default:return"xui-fupload-file-defaultIconS"}},getSize:function(a){if(typeof a=="string"){var a=a.toUpperCase();if((a.indexOf("MB")>-1)){a=parseInt(a,10)*1048576}else{if((a.indexOf("KB")>-1)){a=parseInt(a,10)*1024}else{a=parseInt(a,10)}}}if(a>1073741824){return(a/1073741824).toFixed(2)+" GB"}else{if(a>1048576){return(a/1048576).toFixed(2)+" MB"}else{if(a>1024){return(a/1024).toFixed(2)+" KB"}else{return a+" B"}}}},setProgress:function(a){this.progressBarInProgress.style.width=a+"%"},setComplete:function(){this.progressBarInProgress.style.display="none"},setUrl:function(a){this.progressUrl.href=a;this.setComplete()},removeProgress:function(){var a=this;this.container.removeChild(this.fileProgressWrapper);this._fire("removeProgress",a.file)},on:function(a,b){var c=this;this._events[a].subscribe(b,c)},_initEnvents:function(a){var b=this;this._events[a]=new xui.util.CustomEvent(a,b)},_fire:function(b,a){this._events[b].fire(a)}};SWFUpload.QUEUE_ERROR.QUEUE_TOTALLIMIT_EXCEEDED=110;xui.widgets.FUpload=function(c,a){this.id=c;this.settings={prevent_swf_caching:true,flash_url:"",upload_url:"",delete_url:"",button_placeholder_id:this.id,button_width:61,button_height:18,button_text_left_padding:2,button_text_top_padding:0,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,button_text_style:".button_text_style { text-decoration:underline;color:#006699 }",file_types_description:"All Files",file_types:"*.*",file_size_limit:"10 MB",total_size_limit:"10 MB",file_upload_limit:0,file_queue_limit:0};this.container=$(a.container_id);if(a.button_text){a.button_text='<span class="button_text_style">'+a.button_text+"</span>"}for(var b in a){this.settings[b]=a[b]}this._events={};this.queFilesHash={};this.uploadFilesHash={};this.progressHash={};this.isQueueComplete=true};xui.widgets.FUpload.prototype={init:function(b){var a=this;this.existFiles=b;this._initEnvents("file_queued_handler");this._initEnvents("upload_success_handler");this._initEnvents("file_queue_error_handler");this._initEnvents("swfupload_load_failed_handler");this.swfu=new SWFUpload(this.settings);this.swfu.settings.swfupload_load_failed_handler=function(){a._fire("swfupload_load_failed_handler")};this.swfu.settings.swfupload_loaded_handler=function(){a._initFiles()};this.swfu.settings.file_queued_handler=function(c){a._fire("file_queued_handler",c)};this.swfu.settings.file_dialog_complete_handler=function(c,d){a.startUpload()};this.swfu.settings.file_queue_error_handler=function(c,e,d){a._fileQueueError(e,c)};this.swfu.settings.upload_start_handler=function(c){if(a._checkTotalSize(c)){a.createProgress(c);a._registerQueFilesHash(c)}else{a._fileQueueError(110,c);a.cancelUpload(c.id)}return a._checkTotalSize(c)};this.swfu.settings.upload_progress_handler=function(c,e,d){a.isQueueComplete=false;a.setProgress(c,e,d)};this.swfu.settings.upload_success_handler=function(d,c){a.setComplete(d);a._uploadSuccess(d,c);a._fire("upload_success_handler",d);a.isQueueComplete=true};this.swfu.settings.upload_error_handler=function(d,c,e){};this.swfu.settings.upload_complete_handler=function(c){a.startUpload()}},_initFiles:function(){if(this.existFiles){var b=0;var a=this.swfu.getStats();for(key in this.existFiles){this.existFiles[key].id=this.existFiles[key].fileId;this.existFiles[key].size=this._initSize(this.existFiles[key].size);this.createProgress(this.existFiles[key]);this._registerUploadFile(this.existFiles[key]);a.successful_uploads++}this.swfu.setStats(a)}},_initSize:function(a){if(typeof a=="string"){var a=a.toUpperCase();if((a.indexOf("MB")>-1)){a=parseInt(a,10)*1048576}else{if((a.indexOf("KB")>-1)){a=parseInt(a,10)*1024}else{a=parseInt(a,10)}}}return a},on:function(a,b){var c=this;this._events[a].subscribe(b,c)},getUploadFiles:function(){return this.uploadFilesHash},getQueueState:function(){return this.isQueueComplete},getNumUploadFiles:function(){var a=0;for(key in this.uploadFilesHash){a++}return a},_initEnvents:function(a){var b=this;this._events[a]=new xui.util.CustomEvent(a,b)},_fire:function(b,a){this._events[b].fire(a)},_uploadSuccess:function(file,serverData){this._registerUploadFile(file);this._unRegisterQueFilesHash(file);if(serverData){var oServerData=eval("("+serverData+")");if(oServerData.isSuccess){var url=oServerData.data.url;this.uploadFilesHash[file.id].fileId=oServerData.data.fileId;this.uploadFilesHash[file.id].url=url;this.progressHash[file.id].file.fileId=oServerData.data.fileId;this.progressHash[file.id].setUrl(url)}}},_fileQueueError:function(d,b){this._fire("file_queue_error_handler",[b,d]);try{switch(d){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:var a="\u7035\u901b\u7b09\u74a7\u51e4\u7d1d\u93ae\u3124\u7b02\u6d7c\u72b5\u6b91\u93c2\u56e6\u6b22\u6fb6\ue044\u3047\u6d5c\ufffd";this.createProgress(b,a);break;case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE:var a="\u7035\u901b\u7b09\u74a7\u51e4\u7d1d\u6d93\u5d88\u5158\u6d93\u5a41\u7d360KB\u6fb6\u0443\u76ac\u9428\u52ec\u6783\u6d60\ufffd";this.createProgress(b,a);break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:var a="\u6d93\u5d86\u656e\u93b8\u4f7a\u6b91\u93c2\u56e6\u6b22\u7eeb\u8bf2\u7037";this.createProgress(b,a);break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:var a="\u7035\u901b\u7b09\u74a7\u51e4\u7d1d\u93c2\u56e6\u6b22\u93c1\u626e\u6d30\u6769\u56e7\ue63f";this.createProgress(b,a);case SWFUpload.QUEUE_ERROR.QUEUE_TOTALLIMIT_EXCEEDED:var a="\u7035\u901b\u7b09\u74a7\u51e4\u7d1d\u74d2\u5470\u7e43\u6d93\u5a41\u7d36\u93ac\u8bf2\ue190\u95b2\ufffd";this.createProgress(b,a);break;default:break}}catch(c){}},_checkTotalSize:function(b){var a=(this.settings.total_size_limit).toUpperCase();if((a.indexOf("MB")>-1)){a=parseInt(a,10)*1048576}else{if((a.indexOf("KB")>-1)){a=parseInt(a,10)*1024}else{a=parseInt(a,10)}}return((xui.util.NumberUtil.add(this._getUploadFilesSize(),b.size,"+"))>a)?false:true},_getUploadFilesSize:function(){var a=0;for(var b in this.uploadFilesHash){a+=parseInt(this.uploadFilesHash[b].size,10)}return a},createProgress:function(c,b){var d=this;var a=new xui.widgets.FUploadProgress(c,this,b);this._registerProgressFile(c,a);a.on("removeProgress",function(){var e=arguments[1][0];d._unRegisterUploadFile(e);d._unRegisterProgressFile(e);if(e.fileId){d._deleteFile(e.fileId)}})},_deleteFile:function(d){if(this.settings.delete_url.indexOf("?")>0){var a=this.settings.delete_url+"&id="+d}else{var a=this.settings.delete_url+"?id="+d}try{var b=this.swfu.getStats();b.successful_uploads--;this.swfu.setStats(b);xui.util.Ajax.asyncGET(a)}catch(c){}},setProgress:function(a,d,c){var b=0;if(d!=0){b=Math.ceil((c/d)*100)}this.progressHash[a.id].setProgress(b)},setComplete:function(a){this.progressHash[a.id].setComplete()},startUpload:function(a){this.swfu.startUpload(a)},cancelUpload:function(a){this.swfu.cancelUpload(a)},_registerQueFilesHash:function(a){this.queFilesHash[a.id]=a},_unRegisterQueFilesHash:function(a){delete this.queFilesHash[a.id]},_registerUploadFile:function(a){this.uploadFilesHash[a.id]=a},_unRegisterUploadFile:function(a){delete this.uploadFilesHash[a.id]},_registerProgressFile:function(b,a){this.progressHash[b.id]=a},_unRegisterProgressFile:function(a){delete this.progressHash[a.id]}};
